package com.fishingspot;

import lombok.AllArgsConstructor;
import lombok.Value;
import net.runelite.api.coords.WorldPoint;

import java.time.Instant;

@AllArgsConstructor
@Value
class FishingSpotSpawn
{
    WorldPoint loc;
    Instant time;
}

package com.fishingspot;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.Units;

@ConfigGroup("fishingspottimer")
public interface FishingSpotTimerConfig extends Config
{
    @ConfigItem(
            position = 1,
            keyName = "maxMoveTime",
            name = "Max move time",
            description = "The maximum expected time after which a fishing spot will move in seconds."
    )
    @Units(Units.SECONDS)
    default int maxMoveTime()
    {
        return 300;
    }

    @ConfigItem(
            position = 2,
            keyName = "minMoveTime",
            name = "Min move time",
            description = "The minimum expected time after which a fishing spot will move in seconds."
    )
    @Units(Units.SECONDS)
    default int minMoveTime()
    {
        return 150;
    }
}

package com.fishingspot;

import net.runelite.api.Client;
import net.runelite.api.NPC;
import net.runelite.api.Perspective;
import net.runelite.api.Point;
import net.runelite.api.coords.LocalPoint;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.ProgressPieComponent;

import javax.inject.Inject;
import java.awt.*;
import java.time.Duration;
import java.time.Instant;

public class FishingSpotTimerOverlay extends Overlay
{
    private final FishingSpotTimerPlugin plugin;
    private final FishingSpotTimerConfig config;
    private final Client client;

    @Inject
    private FishingSpotTimerOverlay(FishingSpotTimerPlugin plugin, FishingSpotTimerConfig config, Client client)
    {
        setPosition(OverlayPosition.DYNAMIC);
        setLayer(OverlayLayer.ABOVE_SCENE);
        this.plugin = plugin;
        this.config = config;
        this.client = client;
    }

    @Override
    public Dimension render(Graphics2D graphics) {
        Color color;
        long maxMoveTime = Duration.ofSeconds(config.maxMoveTime()).toMillis();
        long minMoveTime = Duration.ofSeconds(config.minMoveTime()).toMillis();
        for (NPC npc : plugin.getFishingSpots()) {
            color = Color.GREEN;
            FishingSpotSpawn spawn = plugin.getFishingSpotSpawns().get(npc.getIndex());
            if (spawn != null) {
                long millisLeft = maxMoveTime - Duration.between(spawn.getTime(), Instant.now()).toMillis();
                if (millisLeft < 0){
                    millisLeft = 0;
                    color = Color.RED;
                }
                else if (millisLeft < minMoveTime){
                    color = Color.YELLOW;
                }

                LocalPoint localPoint = npc.getLocalLocation();
                Point location = Perspective.localToCanvas(client, localPoint, client.getPlane());

                if (location != null) {
                    ProgressPieComponent pie = new ProgressPieComponent();
                    pie.setFill(color);
                    pie.setBorderColor(color);
                    pie.setPosition(location);
                    pie.setProgress((float) millisLeft / maxMoveTime);
                    pie.render(graphics);
                }
            }
        }

        return null;
    }
}

package com.fishingspot;

import com.google.inject.Provides;
import javax.inject.Inject;

import lombok.AccessLevel;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.NPC;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.NpcDespawned;
import net.runelite.api.events.NpcSpawned;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.game.FishingSpot;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import java.time.Instant;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Slf4j
@PluginDescriptor(
	name = "Fishing Spot Timer",
    description = "Display a timer above fishing spots. The timer is not exact, it runs until a configurable expected move time.",
    tags = {"overlay", "fishing"}
)
public class FishingSpotTimerPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private FishingSpotTimerConfig config;

    @Inject
    private FishingSpotTimerOverlay spotOverlay;

    @Inject
    private OverlayManager overlayManager;

    @Getter(AccessLevel.PACKAGE)
    private final List<NPC> fishingSpots = new ArrayList<>();

    @Getter(AccessLevel.PACKAGE)
    private final Map<Integer, FishingSpotSpawn> fishingSpotSpawns = new HashMap<>();

	@Override
	protected void startUp() throws Exception
	{
        overlayManager.add(spotOverlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
        overlayManager.remove(spotOverlay);
        fishingSpots.clear();
        fishingSpotSpawns.clear();
	}

    @Subscribe
    public void onGameStateChanged(GameStateChanged gameStateChanged)
    {
        GameState gameState = gameStateChanged.getGameState();
        if (gameState == GameState.CONNECTION_LOST || gameState == GameState.LOGIN_SCREEN || gameState == GameState.HOPPING)
        {
            fishingSpots.clear();
            fishingSpotSpawns.clear();
        }
    }

    @Subscribe
    public void onGameTick(GameTick event) {
        for (NPC npc : fishingSpots)
        {
            final int id = npc.getIndex();
            final FishingSpotSpawn spawn = fishingSpotSpawns.get(id);

            if (spawn == null || !spawn.getLoc().equals(npc.getWorldLocation()))
            {
                fishingSpotSpawns.put(id, new FishingSpotSpawn(npc.getWorldLocation(), Instant.now()));
            }
        }
    }

    @Subscribe
    public void onNpcSpawned(NpcSpawned event)
    {
        final NPC npc = event.getNpc();

        if (FishingSpot.findSpot(npc.getId()) == null)
        {
            return;
        }

        fishingSpots.add(npc);
    }

    @Subscribe
    public void onNpcDespawned(NpcDespawned npcDespawned)
    {
        final NPC npc = npcDespawned.getNpc();

        fishingSpots.remove(npc);
        fishingSpotSpawns.remove(npc.getIndex());
    }

	@Provides
    FishingSpotTimerConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(FishingSpotTimerConfig.class);
	}
}

package com.fishingspot;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class FishingSpotTimerTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(FishingSpotTimerPlugin.class);
		RuneLite.main(args);
	}
}
