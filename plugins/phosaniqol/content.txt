package com.phosaniqol;

import java.util.HashMap;
import java.util.Map;
import lombok.Getter;
import lombok.Setter;
import net.runelite.api.NPC;
import net.runelite.api.gameval.NpcID;

@Getter
@Setter
public class PhosaniAdd extends PhosaniNpc
{
	private final Map<Integer, PhosaniQolConfig.HighlightStyle> HIGHLIGHT_STYLE_MAP;

	public PhosaniAdd(NPC npc, PhosaniQolConfig config)
	{
		super.setNpc(npc);
		this.HIGHLIGHT_STYLE_MAP = new HashMap<>();
		this.HIGHLIGHT_STYLE_MAP.put(NpcID.NIGHTMARE_CHALLENGE_PARASITE, config.highlightParasite());
		this.HIGHLIGHT_STYLE_MAP.put(NpcID.NIGHTMARE_CHALLENGE_PARASITE_WEAK, config.highlightParasite());
		this.HIGHLIGHT_STYLE_MAP.put(NpcID.NIGHTMARE_CHALLENGE_HUSK_RANGED, config.highlightRangedHusk());
		this.HIGHLIGHT_STYLE_MAP.put(NpcID.NIGHTMARE_CHALLENGE_HUSK_MAGIC, config.highlightMagicHusk());
		this.HIGHLIGHT_STYLE_MAP.put(NpcID.NIGHTMARE_CHALLENGE_SLEEPWALKER, config.highlightSleepwalkers());
		setHighlightConfig(config);
	}

	public void setHighlightConfig(PhosaniQolConfig config)
	{
		super.setHighlightConfig(
			HIGHLIGHT_STYLE_MAP.get(super.getNpc().getId()),
			config.addsBorderWidth(),
			config.addsBorderColor(),
			config.addsFillColor(),
			PhosaniQolConfig.OverlayType.NONE,
			null,
			0,
			null
		);
	}
}
package com.phosaniqol;

import lombok.Getter;
import lombok.Setter;
import net.runelite.api.NPC;

@Getter
@Setter
public class PhosaniBoss extends PhosaniNpc
{
	private int shield;

	public PhosaniBoss(NPC npc, int shield, PhosaniQolConfig config)
	{
		super.setNpc(npc);
		this.shield = shield;
		setHighlightConfig(config);
	}
 
	public void setHighlightConfig(PhosaniQolConfig config)
	{
		super.setHighlightConfig(
			null,
			null,
			null,
			null,
			config.phosaniShieldOverlay(),
			config.phosaniShieldOverlayFont().getFont(),
			config.phosaniShieldOverlayOffset(),
			config.phosaniShieldOverlayColor()
		);
	}
}

package com.phosaniqol;

import java.awt.Color;
import java.awt.Font;
import lombok.Getter;
import lombok.Setter;
import net.runelite.api.NPC;

@Getter
@Setter
public class PhosaniNpc
{
	private NPC npc;

	private PhosaniQolConfig.HighlightStyle highlightStyle;
	private Double borderWidth;
	private Color borderColor;
	private Color fillColor;

	private PhosaniQolConfig.OverlayType textOverlay;
	private Font textOverlayFont;
	private int textOverlayOffset;
	private Color textOverlayColor;

	public void setHighlightConfig(PhosaniQolConfig.HighlightStyle highlightStyle, Double borderWidth, Color borderColor, Color fillColor,
								   PhosaniQolConfig.OverlayType textOverlay, Font textOverlayFont, int textOverlayOffset, Color textColor)
	{
		this.highlightStyle = highlightStyle;
		this.borderWidth = borderWidth;
		this.borderColor = borderColor;
		this.fillColor = fillColor;
		this.textOverlay = textOverlay;
		this.textOverlayFont = textOverlayFont;
		this.textOverlayOffset = textOverlayOffset;
		this.textOverlayColor = textColor;
	}
}

package com.phosaniqol;

import java.awt.Color;
import java.awt.Font;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import net.runelite.client.config.Alpha;
import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;
import net.runelite.client.ui.FontManager;

@ConfigGroup(PhosaniQolConfig.CONFIG_GROUP)
public interface PhosaniQolConfig extends Config
{
	String CONFIG_GROUP = "PhosaniQol";

	@ConfigSection(
		position = 0,
		name = "Totem Settings",
		description = "Settings related to the totems",
		closedByDefault = true
	)
	String totemSettings = "totemSettings";

	@ConfigItem(
		position = 0,
		keyName = "highlightChargedTotems",
		name = "Highlight Charged",
		description = "Sets the highlight style for totems that are fully charged",
		section = totemSettings
	)
	default HighlightStyle highlightChargedTotems()
	{
		return HighlightStyle.TILE;
	}

	@ConfigItem(
		position = 1,
		keyName = "chargedBorderWidth",
		name = "Border Width",
		description = "Sets the width of the lines highlighting charged totems",
		section = totemSettings
	)
	default double chargedBorderWidth()
	{
		return 1.0;
	}

	@Alpha
	@ConfigItem(
		position = 2,
		keyName = "chargedBorderColor",
		name = "Charged Border Color",
		description = "Sets the border color highlighting charged totems",
		section = totemSettings
	)
	default Color chargedBorderColor()
	{
		return new Color(0, 225, 255);
	}

	@Alpha
	@ConfigItem(
		position = 3,
		keyName = "chargedFillColor",
		name = "Charged Fill Color",
		description = "Sets the fill color for highlighting charged totems",
		section = totemSettings
	)
	default Color chargedFillColor()
	{
		return new Color(0, 225, 255, 30);
	}

	@ConfigItem(
		position = 4,
		keyName = "totemChargeOverlay",
		name = "Charge Overlay",
		description = "Draws an overlay over totems showing their current charge",
		section = totemSettings
	)
	default OverlayType totemChargeOverlay()
	{
		return OverlayType.NONE;
	}

	@ConfigItem(
		position = 5,
		keyName = "totemChargeOverlayFont",
		name = "Overlay Font",
		description = "Sets the font to use for drawing totem charge overlays",
		section = totemSettings
	)
	default Fonts totemChargeOverlayFont()
	{
		return Fonts.REGULAR;
	}

	@ConfigItem(
		position = 6,
		keyName = "totemChargeOverlayOffset",
		name = "Overlay Z-Offset",
		description = "Sets the z-offset for drawing totem charge overlays",
		section = totemSettings
	)
	default int totemChargeOverlayOffset()
	{
		return 0;
	}

	@Alpha
	@ConfigItem(
		position = 7,
		keyName = "totemChargeOverlayColor",
		name = "Overlay Color",
		description = "Sets the color to use for drawing totem charge overlays",
		section = totemSettings
	)
	default Color totemChargeOverlayColor()
	{
		return new Color(255, 255, 0);
	}

	@ConfigSection(
		position = 1,
		name = "Boss Settings",
		description = "Settings related to the boss",
		closedByDefault = true
	)
	String bossSettings = "bossSettings";

	@ConfigItem(
		position = 0,
		keyName = "phosaniShieldOverlay",
		name = "Shield Overlay",
		description = "Draws an overlay over Phosani showing her current shield amount",
		section = bossSettings
	)
	default OverlayType phosaniShieldOverlay()
	{
		return OverlayType.NONE;
	}

	@ConfigItem(
		position = 1,
		keyName = "phosaniShieldOverlayFont",
		name = "Overlay Font",
		description = "Sets the font to use for drawing Phosani's shield overlay",
		section = bossSettings
	)
	default Fonts phosaniShieldOverlayFont()
	{
		return Fonts.REGULAR;
	}

	@ConfigItem(
		position = 2,
		keyName = "phosaniShieldOverlayOffset",
		name = "Overlay Z-Offset",
		description = "Sets the z-offset for drawing Phosani's shield overlay",
		section = bossSettings
	)
	default int phosaniShieldOverlayOffset()
	{
		return 0;
	}

	@Alpha
	@ConfigItem(
		position = 3,
		keyName = "phosaniShieldOverlayColor",
		name = "Overlay Color",
		description = "Sets the color to use for drawing Phosani's shield overlay",
		section = bossSettings
	)
	default Color phosaniShieldOverlayColor()
	{
		return new Color(255, 255, 0);
	}

	@ConfigItem(
		position = 4,
		keyName = "hideHealthOverlay",
		name = "Hide Jagex HP HUD",
		description = "Force hides the in-game boss HP HUD",
		section = bossSettings
	)
	default boolean hideHealthOverlay()
	{
		return false;
	}

	@ConfigSection(
		position = 2,
		name = "Adds Settings",
		description = "Settings related to adds spawned by the boss",
		closedByDefault = true
	)
	String addsSettings = "addsSettings";

	@ConfigItem(
		position = 0,
		keyName = "highlightRangedHusk",
		name = "Highlight Ranged Husk",
		description = "Sets the highlight style for the ranged husk",
		section = addsSettings
	)
	default HighlightStyle highlightRangedHusk()
	{
		return HighlightStyle.CLICKBOX;
	}

	@ConfigItem(
		position = 1,
		keyName = "highlightMagicHusk",
		name = "Highlight Magic Husk",
		description = "Sets the highlight style for the magic husk",
		section = addsSettings
	)
	default HighlightStyle highlightMagicHusk()
	{
		return HighlightStyle.CLICKBOX;
	}

	@ConfigItem(
		position = 2,
		keyName = "highlightParasite",
		name = "Highlight Parasite",
		description = "Sets the highlight style for parasites",
		section = addsSettings
	)
	default HighlightStyle highlightParasite()
	{
		return HighlightStyle.CLICKBOX;
	}

	@ConfigItem(
		position = 3,
		keyName = "highlightSleepwalkers",
		name = "Highlight Sleepwalkers",
		description = "Sets the highlight style for sleepwalkers",
		section = addsSettings
	)
	default HighlightStyle highlightSleepwalkers()
	{
		return HighlightStyle.CLICKBOX;
	}

	@ConfigItem(
		position = 4,
		keyName = "addsBorderWidth",
		name = "Border Width",
		description = "Sets the width of the lines highlighting adds.",
		section = addsSettings
	)
	default double addsBorderWidth()
	{
		return 1.0;
	}

	@Alpha
	@ConfigItem(
		position = 5,
		keyName = "addsBorderColor",
		name = "Border Color",
		description = "Sets the border color highlighting adds",
		section = addsSettings
	)
	default Color addsBorderColor()
	{
		return new Color(0, 225, 255);
	}

	@Alpha
	@ConfigItem(
		position = 6,
		keyName = "addsFillColor",
		name = "Fill Color",
		description = "Sets the fill color for highlighting adds",
		section = addsSettings
	)
	default Color addsFillColor()
	{
		return new Color(0, 225, 255, 30);
	}

	@Getter
	@RequiredArgsConstructor
	enum HighlightStyle
	{
		NONE("None"),
		TILE("Tile"),
		HULL("Hull"),
		OUTLINE("Outline"),
		CLICKBOX("Clickbox");

		private final String highlightStyle;
	}

	@Getter
	@RequiredArgsConstructor
	enum Fonts
	{
		SMALL(FontManager.getRunescapeSmallFont()),
		REGULAR(FontManager.getRunescapeFont()),
		BOLD(FontManager.getRunescapeBoldFont());

		private final Font font;
	}

	@Getter
	@RequiredArgsConstructor
	enum OverlayType
	{
		NONE("None"),
		VALUE("Value"),
		PERCENTAGE("Percentage");

		private final String overlayType;
	}
}

package com.phosaniqol;

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Graphics2D;
import java.awt.RenderingHints;
import java.awt.Shape;
import java.util.Map;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.NPC;
import net.runelite.api.Perspective;
import net.runelite.api.Point;
import net.runelite.api.coords.LocalPoint;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.outline.ModelOutlineRenderer;

@Slf4j
public class PhosaniQolOverlay extends Overlay
{
	private final Client client;
	private final PhosaniQolPlugin plugin;
	private final ModelOutlineRenderer renderer;

	@Inject
	private PhosaniQolOverlay(Client client, PhosaniQolPlugin plugin, ModelOutlineRenderer renderer)
	{
		this.client = client;
		this.plugin = plugin;
		this.renderer = renderer;
		setPosition(OverlayPosition.DYNAMIC);
		setPriority(Overlay.PRIORITY_HIGHEST);
		setLayer(OverlayLayer.UNDER_WIDGETS);
	}

	@Override
	public Dimension render(Graphics2D graphics2D)
	{
		PhosaniBoss phosaniBoss = plugin.getPhosaniBoss();
		highlightNpc(graphics2D, phosaniBoss);

		Map<Integer, PhosaniTotem> totems = plugin.getTotems();
		totems.forEach((npcId, totem) ->
		{
			if (plugin.getREADY_TOTEMS().contains(npcId))
			{
				highlightNpc(graphics2D, totem);
			}
		});

		Map<Integer, PhosaniAdd> adds = plugin.getAdds();
		adds.forEach((npcId, add) -> highlightNpc(graphics2D, add));

		return null;
	}

	private void highlightNpc(Graphics2D graphics2D, PhosaniNpc phosaniNpc)
	{
		if (phosaniNpc == null)
		{
			return;
		}

		NPC npc = phosaniNpc.getNpc();

		if (phosaniNpc.getTextOverlay() != PhosaniQolConfig.OverlayType.NONE && npc != null)
		{
			String text = null;
			Color textOverlayColor = phosaniNpc.getTextOverlayColor();
			Font textOverlayFont = phosaniNpc.getTextOverlayFont();
			int textOverlayOffset = phosaniNpc.getTextOverlayOffset();
			if (phosaniNpc instanceof PhosaniTotem)
			{
				int charge = ((PhosaniTotem) phosaniNpc).getCharge();
				if (charge >= 0)
				{
					if (phosaniNpc.getTextOverlay() == PhosaniQolConfig.OverlayType.PERCENTAGE)
					{
						charge = charge / 2;
						text = charge + "%";
					}
					else
					{
						text = String.valueOf(charge);
					}
				}
			}
			else if (phosaniNpc instanceof PhosaniBoss)
			{
				int shield = ((PhosaniBoss) phosaniNpc).getShield();
				if (shield > 0)
				{
					if (phosaniNpc.getTextOverlay() == PhosaniQolConfig.OverlayType.PERCENTAGE)
					{
						shield = (npc.getHealthRatio() * 100) / npc.getHealthScale();
						text = shield + "%";
					}
					else
					{
						text = String.valueOf(shield);
					}
				}
			}
			if (text != null)
			{
				Point textLocation = npc.getCanvasTextLocation(graphics2D, text, textOverlayOffset);
				if (textLocation != null)
				{
					graphics2D.setFont(textOverlayFont);
					graphics2D.setColor(textOverlayColor);
					graphics2D.drawString(text, textLocation.getX(), textLocation.getY());
				}
			}
		}

		if (phosaniNpc.getHighlightStyle() == PhosaniQolConfig.HighlightStyle.NONE)
		{
			return;
		}
		if (phosaniNpc instanceof PhosaniTotem && ((PhosaniTotem) phosaniNpc).getCharge() < 200)
		{
			return;
		}

		LocalPoint localPoint;
		int size;
		if (npc != null)
		{
			localPoint = npc.getLocalLocation();
			size = npc.getComposition().getSize();
		}
		else
		{
			return;
		}

		PhosaniQolConfig.HighlightStyle highlightStyle = phosaniNpc.getHighlightStyle();
		Color borderColor = phosaniNpc.getBorderColor();
		Color fillColor = phosaniNpc.getFillColor();
		Double width = phosaniNpc.getBorderWidth();

		Shape shape = null;
		if (highlightStyle == PhosaniQolConfig.HighlightStyle.TILE)
		{
			shape = Perspective.getCanvasTileAreaPoly(client, localPoint, size);
		}
		else if (highlightStyle == PhosaniQolConfig.HighlightStyle.HULL)
		{
			shape = npc.getConvexHull();
		}
		else if (highlightStyle == PhosaniQolConfig.HighlightStyle.CLICKBOX)
		{
			shape = Perspective.getClickbox(client, client.getTopLevelWorldView(), npc.getModel(), npc.getCurrentOrientation(), localPoint.getX(), localPoint.getY(),
				Perspective.getTileHeight(client, localPoint, npc.getWorldLocation().getPlane()));
		}
		else if (highlightStyle == PhosaniQolConfig.HighlightStyle.OUTLINE)
		{
			renderer.drawOutline(npc, width.intValue(), borderColor, 5);
		}

		if (shape != null)
		{
			graphics2D.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
			graphics2D.setColor(borderColor);
			graphics2D.setStroke(new BasicStroke(width.floatValue()));
			graphics2D.draw(shape);
			if (fillColor != null)
			{
				graphics2D.setColor(fillColor);
				graphics2D.fill(shape);
			}
		}
	}
}

package com.phosaniqol;

import com.google.common.collect.ImmutableSet;
import com.google.inject.Provides;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import javax.inject.Inject;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Actor;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.HitsplatID;
import net.runelite.api.NPC;
import net.runelite.api.NPCComposition;
import net.runelite.api.Player;
import net.runelite.api.Skill;
import net.runelite.api.events.FakeXpDrop;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.events.HitsplatApplied;
import net.runelite.api.events.NpcChanged;
import net.runelite.api.events.NpcDespawned;
import net.runelite.api.events.NpcSpawned;
import net.runelite.api.events.VarbitChanged;
import net.runelite.api.events.WidgetLoaded;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.api.gameval.NpcID;
import net.runelite.api.gameval.VarbitID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.game.NPCManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

@Slf4j
@PluginDescriptor(name = "Phosani QoL")
public class PhosaniQolPlugin extends Plugin
{
	// 1 = SW, 2 = SW, 3 = NW, 4 = NE
	private final Set<Integer> DORMANT_TOTEMS = ImmutableSet.of(
		NpcID.NIGHTMARE_TOTEM_1_DORMANT,
		NpcID.NIGHTMARE_TOTEM_2_DORMANT,
		NpcID.NIGHTMARE_TOTEM_3_DORMANT,
		NpcID.NIGHTMARE_TOTEM_4_DORMANT
	);

	@Getter
	private final Set<Integer> READY_TOTEMS = ImmutableSet.of(
		NpcID.NIGHTMARE_TOTEM_1_READY,
		NpcID.NIGHTMARE_TOTEM_2_READY,
		NpcID.NIGHTMARE_TOTEM_3_READY,
		NpcID.NIGHTMARE_TOTEM_4_READY
	);

	private final Set<Integer> CHARGED_TOTEMS = ImmutableSet.of(
		NpcID.NIGHTMARE_TOTEM_1_CHARGED,
		NpcID.NIGHTMARE_TOTEM_2_CHARGED,
		NpcID.NIGHTMARE_TOTEM_3_CHARGED,
		NpcID.NIGHTMARE_TOTEM_4_CHARGED
	);

	private final Set<Integer> PHOSANI_PHASES = ImmutableSet.of(
		NpcID.NIGHTMARE_CHALLENGE_PHASE_01,
		NpcID.NIGHTMARE_CHALLENGE_PHASE_02,
		NpcID.NIGHTMARE_CHALLENGE_PHASE_03,
		NpcID.NIGHTMARE_CHALLENGE_PHASE_04,
		NpcID.NIGHTMARE_CHALLENGE_WEAK_PHASE_01,
		NpcID.NIGHTMARE_CHALLENGE_WEAK_PHASE_02,
		NpcID.NIGHTMARE_CHALLENGE_WEAK_PHASE_03,
		NpcID.NIGHTMARE_CHALLENGE_WEAK_PHASE_04,
		NpcID.NIGHTMARE_CHALLENGE_INITIAL,
		NpcID.NIGHTMARE_CHALLENGE_PHASE_05,
		NpcID.NIGHTMARE_CHALLENGE_DYING,
		NpcID.NIGHTMARE_CHALLENGE_DEAD,
		NpcID.NIGHTMARE_CHALLENGE_BLAST
	);

	private final Set<Integer> PHOSANI_ADDS = ImmutableSet.of(
		NpcID.NIGHTMARE_CHALLENGE_PARASITE,
		NpcID.NIGHTMARE_CHALLENGE_PARASITE_WEAK,
		NpcID.NIGHTMARE_CHALLENGE_HUSK_RANGED,
		NpcID.NIGHTMARE_CHALLENGE_HUSK_MAGIC,
		NpcID.NIGHTMARE_CHALLENGE_SLEEPWALKER
	);

	private final int HPBAR_HUD = 6099;

	@Inject
	private Client client;

	@Inject
	private ClientThread clientThread;

	@Inject
	private PhosaniQolConfig config;

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private NPCManager npcManager;

	@Inject
	private PhosaniQolOverlay overlay;

	@Getter
	private final Map<Integer, PhosaniTotem> totems = new HashMap<>();
	@Getter
	private PhosaniBoss phosaniBoss = null;
	@Getter
	private final Map<Integer, PhosaniAdd> adds = new HashMap<>();
	private final Set<Skill> xpDrops = new HashSet<>();

	@Override
	protected void startUp() throws Exception
	{
		overlayManager.add(overlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(overlay);
		clearAll();
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (event.getGroup().equals(PhosaniQolConfig.CONFIG_GROUP))
		{
			switch (event.getKey())
			{
				case "highlightChargedTotems":
				case "chargedBorderWidth":
				case "chargedBorderColor":
				case "chargedFillColor":
				case "totemChargeOverlay":
				case "totemChargeOverlayFont":
				case "totemChargeOverlayOffset":
				case "totemChargeOverlayColor":
					totems.forEach((npcId, totem) -> totem.setHighlightConfig(config));
					break;
				case "phosaniShieldOverlay":
				case "phosaniShieldOverlayFont":
				case "phosaniShieldOverlayOffset":
				case "phosaniShieldOverlayColor":
					if (phosaniBoss != null)
					{
						phosaniBoss.setHighlightConfig(config);
					}
					break;
				case "highlightRangedHusk":
				case "highlightMagicHusk":
				case "highlightParasite":
				case "highlightSleepwalkers":
				case "addsBorderWidth":
				case "addsBorderColor":
				case "addsFillColor":
					adds.forEach((npcId, add) -> add.setHighlightConfig(config));
					break;
				case "hideHealthOverlay":
					Widget healthBar = client.getWidget(InterfaceID.HpbarHud.HP);
					if (healthBar != null)
					{
						healthBar.setHidden(config.hideHealthOverlay());
					}
			}
		}
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged event)
	{
		if (event.getGameState() != GameState.LOGGED_IN)
		{
			clearAll();
		}
	}

	@Subscribe
	public void onFakeXpDrop(FakeXpDrop event)
	{
		Skill skill = event.getSkill();
		xpDrops.add(skill);

		if (skill == Skill.HITPOINTS)
		{
			Player player = client.getLocalPlayer();
			Actor actor = player.getInteracting();
			if (actor instanceof NPC)
			{
				int npcId = ((NPC) actor).getId();
				if (READY_TOTEMS.contains(npcId))
				{
					int hit = (event.getXp() == 0) ? 1 : (int) Math.round(event.getXp() * (3.0d / 4.0d));
					int multiplier = (xpDrops.contains(Skill.MAGIC)) ? 2 : 1;
					int charge = totems.get(npcId).getCharge() + (hit * multiplier);
					if (charge > 200)
					{
						charge = 200;
					}
					totems.get(npcId).setCharge(charge);
				}
			}
			xpDrops.clear();
		}
	}

	@Subscribe
	public void onHitsplatApplied(HitsplatApplied event)
	{
		Actor actor = event.getActor();
		if (actor instanceof NPC)
		{
			int npcId = ((NPC) actor).getId();
			int hitsplatType = event.getHitsplat().getHitsplatType();
			int hitsplatAmount = event.getHitsplat().getAmount();

			if (hitsplatType == HitsplatID.DAMAGE_OTHER_WHITE && READY_TOTEMS.contains(npcId))
			{
				int charge = Math.max(0, totems.get(npcId).getCharge() - hitsplatAmount);
				totems.get(npcId).setCharge(charge);
			}
			else
			{
				if (READY_TOTEMS.contains(npcId))
				{
					int charge = Math.min(200, recalculateCharge(actor) + hitsplatAmount);
					// to avoid double counting the hit processed from xp drop
					if (charge > -1 && charge > totems.get(npcId).getCharge())
					{
						totems.get(npcId).setCharge(charge);
					}
				}
			}
		}
	}

	@Subscribe
	public void onVarbitChanged(VarbitChanged event)
	{
		if (event.getVarbitId() != HPBAR_HUD)
		{
			return;
		}
		if (client.getVarbitValue(VarbitID.PLAYER_IS_IN_NIGHTMARE_CHALLENGE) == 1 && phosaniBoss != null && phosaniBoss.getShield() > 0)
		{
			int shield = client.getVarbitValue(HPBAR_HUD);
			phosaniBoss.setShield(shield);
		}
	}

	@Subscribe
	public void onNpcChanged(NpcChanged event)
	{
		NPCComposition oldNpc = event.getOld();
		NPC newNpc = event.getNpc();
		int oldNpcId = oldNpc.getId();
		int newNpcId = newNpc.getId();

		if (DORMANT_TOTEMS.contains(oldNpcId) || READY_TOTEMS.contains(oldNpcId) || CHARGED_TOTEMS.contains(oldNpcId))
		{
			totems.remove(oldNpcId);
			int charge = (CHARGED_TOTEMS.contains(newNpcId)) ? 200
				: (READY_TOTEMS.contains(newNpcId)) ? 0
				: -1;
			totems.put(newNpcId, new PhosaniTotem(newNpc, charge, config));
		}
		else if (PHOSANI_PHASES.contains(newNpcId))
		{
			phosaniBoss.setNpc(newNpc);
			int shield = -1;
			switch (newNpcId)
			{
				case NpcID.NIGHTMARE_CHALLENGE_PHASE_01:
					shield = 400;
					break;
				case NpcID.NIGHTMARE_CHALLENGE_PHASE_02:
					shield = 400;
					break;
				case NpcID.NIGHTMARE_CHALLENGE_PHASE_03:
					shield = 400;
					break;
				case NpcID.NIGHTMARE_CHALLENGE_PHASE_04:
					shield = 400;
					break;
				case NpcID.NIGHTMARE_CHALLENGE_PHASE_05:
					shield = 150;
					break;
			}
			phosaniBoss.setShield(shield);
			phosaniBoss.setHighlightConfig(config);
		}
	}

	@Subscribe
	public void onNpcSpawned(NpcSpawned event)
	{
		NPC npc = event.getNpc();
		int npcId = npc.getId();
		if (DORMANT_TOTEMS.contains(npcId))
		{
			totems.put(npcId, new PhosaniTotem(npc, -1, config));
		}
		else if (READY_TOTEMS.contains(npcId))
		{
			totems.put(npcId, new PhosaniTotem(npc, 0, config));
		}
		else if (CHARGED_TOTEMS.contains(npcId))
		{
			totems.put(npcId, new PhosaniTotem(npc, 200, config));
		}
		else if (PHOSANI_PHASES.contains(npcId))
		{
			int shield = -1;
			if (client.getVarbitValue(VarbitID.PLAYER_IS_IN_NIGHTMARE_CHALLENGE) == 1 && npcId != NpcID.NIGHTMARE_CHALLENGE_INITIAL)
			{
				shield = client.getVarbitValue(HPBAR_HUD);
			}
			phosaniBoss = new PhosaniBoss(npc, shield, config);
		}
		else if (PHOSANI_ADDS.contains(npcId))
		{
			int index = npc.getIndex();
			int key = -(npcId + index);
			adds.put(key, new PhosaniAdd(npc, config));
		}
	}

	@Subscribe
	public void onNpcDespawned(NpcDespawned event)
	{
		NPC npc = event.getNpc();
		int npcId = npc.getId();
		if (PHOSANI_ADDS.contains(npcId))
		{
			int index = npc.getIndex();
			int key = -(npcId + index);
			adds.remove(key);
		}
	}

	@Subscribe
	public void onWidgetLoaded(WidgetLoaded event)
	{
		if (client.getVarbitValue(VarbitID.PLAYER_IS_IN_NIGHTMARE_CHALLENGE) == 1)
		{
			Widget healthBar = client.getWidget(InterfaceID.HpbarHud.HP);
			if (healthBar != null)
			{
				healthBar.setHidden(config.hideHealthOverlay());
			}
		}
	}

	// copied from opponentInfo plugin
	private int recalculateCharge(Actor actor)
	{
		if (!(actor instanceof NPC))
		{
			return -1;
		}

		//int npcId = ((NPC) actor).getId();
		int chargeRatio = actor.getHealthRatio();
		int chargeScale = actor.getHealthScale();
		int maxCharge = 200;
		if (chargeRatio >= 0 && chargeScale > 0)
		{
			// This is the reverse of the calculation of chargeRatio done by the server
			// which is: chargeRatio = 1 + (chargeScale - 1) * charge / maxCharge (if charge > 0, 0 otherwise)
			// It's able to recover the exact charge if maxCharge <= chargeScale.
			int floor = 0;
			int ceiling;
			if (chargeRatio > 1)
			{
				// This doesn't apply if chargeRatio = 1, because of the special case in the server calculation that
				// charge = 0 forces chargeRatio = 0 instead of the expected chargeRatio = 1
				floor = (maxCharge * (chargeRatio - 1) + chargeScale - 2) / (chargeScale - 1);
			}
			ceiling = (maxCharge * chargeRatio - 1) / (chargeScale - 1);
			if (ceiling > maxCharge)
			{
				ceiling = maxCharge;
			}
			// Take the average of min and max possible charges
			return (floor + ceiling + 1) / 2;
		}

		return -1;
	}

	private void clearAll()
	{
		totems.clear();
		phosaniBoss = null;
		xpDrops.clear();
	}

	@Provides
	PhosaniQolConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(PhosaniQolConfig.class);
	}
}

package com.phosaniqol;

import lombok.Getter;
import lombok.Setter;
import net.runelite.api.NPC;

@Getter
@Setter
public class PhosaniTotem extends PhosaniNpc
{
	private int charge;

	public PhosaniTotem(NPC npc, int charge, PhosaniQolConfig config)
	{
		super.setNpc(npc);
		this.charge = charge;
		setHighlightConfig(config);
	}

	public void setHighlightConfig(PhosaniQolConfig config)
	{
		super.setHighlightConfig(
			(charge >= 0) ? config.highlightChargedTotems() : PhosaniQolConfig.HighlightStyle.NONE,
			config.chargedBorderWidth(),
			config.chargedBorderColor(),
			config.chargedFillColor(),
			config.totemChargeOverlay(),
			config.totemChargeOverlayFont().getFont(),
			config.totemChargeOverlayOffset(),
			config.totemChargeOverlayColor()
		);
	}
}

package com.phosaniqol;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ExamplePluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(PhosaniQolPlugin.class);
		RuneLite.main(args);
	}
}
