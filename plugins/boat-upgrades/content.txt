package com.boatupgrades;

import com.boatupgrades.utils.SchematicUtils;
import com.boatupgrades.utils.UpgradeVisibilityUtils;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.client.game.ItemManager;
import net.runelite.client.ui.ColorScheme;
import net.runelite.client.ui.FontManager;
import net.runelite.client.ui.PluginPanel;
import net.runelite.client.util.ImageUtil;
import net.runelite.client.util.LinkBrowser;

import javax.inject.Inject;
import javax.inject.Singleton;
import javax.swing.*;
import javax.swing.border.Border;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.image.BufferedImage;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Singleton
@Slf4j
public class BoatUpgradesPanel extends PluginPanel
{
    private static final String TAB_AVAILABLE = "AVAILABLE";
    private static final String TAB_MY_LIST = "MY_LIST";
    private String activeTab = TAB_AVAILABLE;

    private static final Border ACTIVE_TAB_BORDER =
            BorderFactory.createMatteBorder(0, 0, 1, 0, ColorScheme.BRAND_ORANGE);
    private static final Border INACTIVE_TAB_BORDER =
            BorderFactory.createMatteBorder(0, 0, 1, 0, ColorScheme.DARK_GRAY_COLOR);

    private final CardLayout cardLayout = new CardLayout();

    public final JPanel cardContainer = new JPanel(cardLayout);
    public JPanel availableUpgradesContainer;

    private JLabel availableTab;
    private JLabel myListTab;

    private final Map<String, ImageIcon> imageCache = new HashMap<>();
    private final Map<UpgradeData.UpgradeOption, Boolean> schematicUnlockedMap = new HashMap<>();


    private ItemManager itemManager;
    private BoatUpgradesOverlay boatUpgradesOverlay;
    private final BoatUpgradesConfig config;
    private Client client;
    @Inject
    private SchematicUtils schematicUtils;
    @Inject
    private AvailableUpgradesService availableUpgradesService;
    @Inject
    private UpgradeVisibilityUtils upgradeVisibilityUtils;

    @Inject
    public BoatUpgradesPanel(Client client, ItemManager itemManager, BoatUpgradesConfig config)
    {
        super(false);
        this.itemManager = itemManager;
        this.config = config;
        this.client = client;

        setLayout(new BorderLayout());
        setBackground(ColorScheme.DARK_GRAY_COLOR);

        add(buildHeader(), BorderLayout.NORTH);
        add(buildCards(), BorderLayout.CENTER);
    }

    public void onAvailableUpgradesChanged()
    {
        List<UpgradeData.UpgradeOption> options = availableUpgradesService.get();

        schematicUnlockedMap.clear();
        for (UpgradeData.UpgradeOption opt : options)
        {
            schematicUnlockedMap.put(opt, schematicUtils.hasSchematic(opt.displayName));
        }

        List<UpgradeData.UpgradeOption> filteredOptions = options.stream()
                .filter(upgradeVisibilityUtils::shouldShowUpgrade)
                .collect(Collectors.toList());

        SwingUtilities.invokeLater(() ->
        {
            updateAvailableUpgrades(filteredOptions);
        });
    }

    private JPanel buildHeader()
    {
        JPanel header = new JPanel();
        header.setLayout(new BoxLayout(header, BoxLayout.Y_AXIS));
        header.setBorder(new EmptyBorder(10, 10, 10, 10));
        header.setBackground(ColorScheme.DARK_GRAY_COLOR);

        JPanel titleRow = new JPanel();
        titleRow.setLayout(new BoxLayout(titleRow, BoxLayout.X_AXIS));
        titleRow.setOpaque(false);
        titleRow.setAlignmentX(Component.CENTER_ALIGNMENT);

        JLabel iconLabel = new JLabel(loadHeaderIcon());
        iconLabel.setBorder(new EmptyBorder(0, 0, 0, 6));

        JLabel title = new JLabel("Boat Upgrades");
        title.setFont(FontManager.getRunescapeBoldFont());
        title.setForeground(Color.WHITE);

        titleRow.add(iconLabel);
        titleRow.add(title);

        header.add(titleRow);
        header.add(Box.createVerticalStrut(8));
        header.add(buildTabBar());

        return header;
    }

    private ImageIcon loadHeaderIcon()
    {
        BufferedImage image = ImageUtil.loadImageResource(
                getClass(),
                "icon.png"
        );

        //Image scaled = image.getScaledInstance(18, 18, Image.SCALE_SMOOTH);
        return new ImageIcon(image);
    }

    private ImageIcon getUpgradeIcon(UpgradeData.UpgradeOption opt)
    {
        String key = opt.displayName + ":" + opt.boatType;

        return imageCache.computeIfAbsent(key, k -> {
            BufferedImage img = loadUpgradeImage(opt);
            if (img != null) {
                return new ImageIcon(img);
            } else {
                return (ImageIcon) UIManager.getIcon("OptionPane.warningIcon");
            }
        });
    }

    private BufferedImage loadUpgradeImage(UpgradeData.UpgradeOption opt)
    {
        String basePath = "/com/boatupgrades/ui/";

        List<String> candidates = new ArrayList<>();

        if (opt.boatType >= 0)
        {
            candidates.add(opt.displayName + " " + opt.boatType + ".png");
        }
        candidates.add(opt.displayName + ".png");

        for (String name : candidates)
        {
            BufferedImage image = ImageUtil.loadImageResource(
                    getClass(),
                    basePath + name
            );

            if (image != null)
            {
                return image;
            }
        }

        return null;
    }

    private JPanel buildTabBar()
    {
        JPanel tabBar = new JPanel(new GridLayout(1, 2));
        tabBar.setBackground(ColorScheme.DARK_GRAY_COLOR);

        availableTab = createTabLabel("Available upgrades", TAB_AVAILABLE);
        myListTab = createTabLabel("My list", TAB_MY_LIST);

        tabBar.add(availableTab);
        tabBar.add(myListTab);

        updateTabStyles();

        return tabBar;
    }

    private JLabel createTabLabel(String text, String tabKey)
    {
        JLabel label = new JLabel(text, SwingConstants.CENTER);
        label.setFont(FontManager.getRunescapeFont());
        label.setForeground(Color.WHITE);
        label.setBorder(new EmptyBorder(6, 4, 6, 4));
        label.setOpaque(true);
        label.setBackground(ColorScheme.DARK_GRAY_COLOR);

        label.addMouseListener(new MouseAdapter()
        {
            @Override
            public void mousePressed(MouseEvent e)
            {
                activeTab = tabKey;
                cardLayout.show(cardContainer, tabKey);
                updateTabStyles();
            }

            @Override
            public void mouseEntered(MouseEvent e)
            {
                if (!activeTab.equals(tabKey))
                {
                    label.setForeground(ColorScheme.BRAND_ORANGE);
                }
            }

            @Override
            public void mouseExited(MouseEvent e)
            {
                updateTabStyles();
            }
        });

        return label;
    }

    private void updateTabStyles()
    {
        styleTab(availableTab, TAB_AVAILABLE);
        styleTab(myListTab, TAB_MY_LIST);
    }

    private void styleTab(JLabel tab, String tabKey)
    {
        boolean active = activeTab.equals(tabKey);

        tab.setForeground(Color.WHITE);
        tab.setBackground(ColorScheme.DARK_GRAY_COLOR);
        tab.setBorder(active ? ACTIVE_TAB_BORDER : INACTIVE_TAB_BORDER);
    }

    private JPanel buildCards()
    {
        cardContainer.setBackground(ColorScheme.DARKER_GRAY_COLOR);

        cardContainer.add(buildAvailableUpgradesCard(), TAB_AVAILABLE);
        cardContainer.add(buildPlaceholderPanel("Under development"), TAB_MY_LIST);

        cardLayout.show(cardContainer, TAB_AVAILABLE);

        return cardContainer;
    }

    private JPanel buildPlaceholderPanel(String text)
    {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        panel.setBorder(new EmptyBorder(15, 10, 10, 10));

        JLabel label = new JLabel(text);
        label.setForeground(Color.WHITE);
        label.setFont(FontManager.getRunescapeFont());

        panel.add(label, BorderLayout.NORTH);
        return panel;
    }

    private JPanel buildAvailableUpgradesCard()
    {
        availableUpgradesContainer = new JPanel();
        availableUpgradesContainer.setLayout(new BoxLayout(availableUpgradesContainer, BoxLayout.Y_AXIS));
        availableUpgradesContainer.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        availableUpgradesContainer.setBorder(new EmptyBorder(10, 10, 10, 10));
        availableUpgradesContainer.setAlignmentX(Component.LEFT_ALIGNMENT);


        JScrollPane scroll = new JScrollPane(availableUpgradesContainer);
        scroll.setBorder(null);
        scroll.getVerticalScrollBar().setUnitIncrement(16);
        scroll.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
        scroll.setBackground(ColorScheme.DARKER_GRAY_COLOR);

        JPanel wrapper = new JPanel(new BorderLayout());
        wrapper.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        wrapper.add(scroll, BorderLayout.CENTER);

        return wrapper;
    }

    public void updateAvailableUpgrades(List<UpgradeData.UpgradeOption> options)
    {
        availableUpgradesContainer.removeAll();

        if (options.isEmpty())
        {
            availableUpgradesContainer.add(buildEmptyState("No available upgrades"));
        }
        else
        {
            for (UpgradeData.UpgradeOption opt : options)
            {
                availableUpgradesContainer.add(buildUpgradeRow(opt));
                availableUpgradesContainer.add(Box.createVerticalStrut(8));
            }
        }

        availableUpgradesContainer.revalidate();
        availableUpgradesContainer.repaint();
    }

    private JPanel buildUpgradeRow(UpgradeData.UpgradeOption opt)
    {
        JPanel row = new JPanel(new BorderLayout(10, 0));
        row.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        row.setBorder(new EmptyBorder(6, 6, 6, 6));
        row.setAlignmentX(Component.LEFT_ALIGNMENT);

        JLabel imageLabel = new JLabel(getUpgradeIcon(opt));
        imageLabel.setPreferredSize(new Dimension(50, 50));
        row.add(imageLabel, BorderLayout.WEST);

        JPanel textCol = new JPanel();
        textCol.setLayout(new BoxLayout(textCol, BoxLayout.Y_AXIS));
        textCol.setBackground(ColorScheme.DARKER_GRAY_COLOR);

        JTextArea title = new JTextArea(opt.displayName);
        title.setFont(FontManager.getRunescapeBoldFont());
        title.setForeground(Color.WHITE);
        title.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        title.setAlignmentX(Component.LEFT_ALIGNMENT);
        title.setMargin(new Insets(0, 0, 0, 0));
        title.setLineWrap(true);
        title.setWrapStyleWord(true);
        title.setEditable(false);
        title.setFocusable(false);
        title.setOpaque(false);

        title.setSize(100, Short.MAX_VALUE);
        Dimension titlePreferredSize = title.getPreferredSize();
        title.setMaximumSize(new Dimension(100, titlePreferredSize.height));

        makeClickable(title, opt.displayName);
        textCol.add(title);

        textCol.add(Box.createVerticalStrut(2));

        for (UpgradeData.Material material : opt.materials)
        {
            JLabel matLabel = new JLabel(String.valueOf(material));
            matLabel.setFont(FontManager.getRunescapeSmallFont());
            matLabel.setForeground(Color.LIGHT_GRAY);
            matLabel.setAlignmentX(Component.LEFT_ALIGNMENT);

            makeClickable(matLabel, material.name);
            textCol.add(matLabel);
        }

        boolean hasSchematic = schematicUnlockedMap.getOrDefault(opt, true);

        if (!hasSchematic && !config.filterSchematicRequirement())
        {
            textCol.add(Box.createVerticalStrut(2));

            String schematicName = schematicUtils.getSchematicNameForUpgrade(opt.displayName);
            if (schematicName == null)
            {
                schematicName = "schematic";
            }

            JTextArea schematicLabel = new JTextArea("Requires " + schematicName);
            schematicLabel.setFont(FontManager.getRunescapeSmallFont());
            schematicLabel.setForeground(Color.YELLOW);
            schematicLabel.setAlignmentX(Component.LEFT_ALIGNMENT);
            schematicLabel.setMargin(new Insets(0, 0, 0, 0));
            schematicLabel.setLineWrap(true);
            schematicLabel.setWrapStyleWord(true);
            schematicLabel.setEditable(false);
            schematicLabel.setFocusable(false);
            schematicLabel.setOpaque(false);

            schematicLabel.setSize(160, Short.MAX_VALUE);
            Dimension schematicLabelPreferredSize = schematicLabel.getPreferredSize();
            schematicLabel.setMaximumSize(new Dimension(160, schematicLabelPreferredSize.height));

            makeClickable(schematicLabel, schematicName);

            textCol.add(schematicLabel);
        }

        boolean meetsConstruction = upgradeVisibilityUtils.meetsConstructionRequirement(opt);

        if (!meetsConstruction && !config.filterConstructionRequirement())
        {
            textCol.add(Box.createVerticalStrut(2));

            JLabel constructionLabel = new JLabel("Requires " + opt.requiredConstructionLevel + " Construction");
            constructionLabel.setFont(FontManager.getRunescapeSmallFont());
            constructionLabel.setForeground(Color.YELLOW);
            constructionLabel.setAlignmentX(Component.LEFT_ALIGNMENT);

            //makeClickable(constructionLabel, "Construction");

            textCol.add(constructionLabel);
        }

        row.add(textCol, BorderLayout.CENTER);

        Dimension rowPreferredSize = row.getPreferredSize();
        row.setMaximumSize(new Dimension(Integer.MAX_VALUE, rowPreferredSize.height));

        return row;
    }

    private void makeClickable(JComponent component, String name)
    {
        Color originalColor = component.getForeground();
        component.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
        component.addMouseListener(new MouseAdapter()
        {
            @Override
            public void mousePressed(MouseEvent e)
            {
                try
                {
                    String wikiName = name;

                    if (wikiName.equals("Teleport focus") ||
                            wikiName.equals("Greater teleport focus") ||
                            wikiName.equals("Anchor") ||
                            wikiName.equals("Range") ||
                            wikiName.equals("Keg"))
                    {
                        wikiName += " (facility)";
                    }

                    if (!wikiName.equals("Rosewood & cotton sails schematic"))
                    {
                        wikiName = wikiName.replace("&", "and");
                    }

                    wikiName = URLEncoder.encode(wikiName.replace(" ", "_"), StandardCharsets.UTF_8);

                    LinkBrowser.browse("https://oldschool.runescape.wiki/w/" + wikiName);


                }
                catch (Exception ex)
                {
                    ex.printStackTrace();
                }
            }

            @Override
            public void mouseEntered(MouseEvent e)
            {
                component.setForeground(ColorScheme.BRAND_ORANGE);
            }

            @Override
            public void mouseExited(MouseEvent e)
            {
                component.setForeground(originalColor);
            }
        });
    }

    private JPanel buildEmptyState(String text)
    {
        JPanel panel = new JPanel();
        panel.setLayout(new BoxLayout(panel, BoxLayout.Y_AXIS));
        panel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        panel.setBorder(new EmptyBorder(20, 10, 10, 10));
        panel.setAlignmentX(Component.LEFT_ALIGNMENT);

        JLabel label = new JLabel(text);
        label.setFont(FontManager.getRunescapeFont());
        label.setForeground(Color.GRAY);
        label.setAlignmentX(Component.CENTER_ALIGNMENT);

        panel.add(label);

        return panel;
    }
}
package com.boatupgrades;

import javax.inject.Singleton;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

@Singleton
public class AvailableUpgradesService
{
    private List<UpgradeData.UpgradeOption> lastPublished = Collections.emptyList();

    public boolean updateIfChanged(List<UpgradeData.UpgradeOption> newList)
    {
        if (equalsByContent(lastPublished, newList))
        {
            return false;
        }

        lastPublished = new ArrayList<>(newList);
        return true;
    }

    public List<UpgradeData.UpgradeOption> get()
    {
        return lastPublished;
    }

    private boolean equalsByContent(
            List<UpgradeData.UpgradeOption> a,
            List<UpgradeData.UpgradeOption> b
    )
    {
        if (a.size() != b.size())
        {
            return false;
        }

        for (int i = 0; i < a.size(); i++)
        {
            if (!a.get(i).equals(b.get(i)))
            {
                return false;
            }
        }

        return true;
    }
}
package com.boatupgrades.utils;

import com.boatupgrades.BoatUpgradesConfig;
import com.boatupgrades.UpgradeData;
import net.runelite.api.Client;
import net.runelite.api.Skill;

import javax.inject.Inject;
import java.util.*;

public class UpgradeVisibilityUtils
{
    private final Client client;
    private final BoatUpgradesConfig config;
    private final SchematicUtils schematicUtils;

    @Inject
    public UpgradeVisibilityUtils(
            Client client,
            BoatUpgradesConfig config,
            SchematicUtils schematicUtils
    )
    {
        this.client = client;
        this.config = config;
        this.schematicUtils = schematicUtils;
    }

    public boolean meetsConstructionRequirement(UpgradeData.UpgradeOption opt)
    {
        int constructionLevel = client.getBoostedSkillLevel(Skill.CONSTRUCTION);
        return constructionLevel >= opt.requiredConstructionLevel;
    }

    public boolean shouldShowUpgrade(UpgradeData.UpgradeOption opt)
    {
        boolean hasSchematic = schematicUtils.hasSchematic(opt.displayName);
        boolean meetsConstruction = meetsConstructionRequirement(opt);

        if (config.filterSchematicRequirement() && !hasSchematic)
        {
            return false;
        }

        if (config.filterConstructionRequirement() && !meetsConstruction)
        {
            return false;
        }

        return true;
    }

    public List<UpgradeData.UpgradeOption> getVisibleUpgrades(List<UpgradeData.UpgradeOption> options)
    {
        if (options == null || options.isEmpty())
        {
            return Collections.emptyList();
        }

        List<UpgradeData.UpgradeOption> visible = new ArrayList<>();

        for (UpgradeData.UpgradeOption opt : options)
        {
            if (!isConfigEnabled(opt.partName))
            {
                continue;
            }

            boolean hasSchematic = schematicUtils.hasSchematic(opt.displayName);
            boolean meetsConstruction = meetsConstructionRequirement(opt);

            if (config.filterSchematicRequirement() && !hasSchematic)
            {
                continue;
            }

            if (config.filterConstructionRequirement() && !meetsConstruction)
            {
                continue;
            }

            visible.add(opt);
        }

        if (!config.hideLowerTiers())
        {
            return visible;
        }

        Map<String, UpgradeData.UpgradeOption> best = new LinkedHashMap<>();
        for (UpgradeData.UpgradeOption opt : visible)
        {
            best.merge(
                    opt.partName,
                    opt,
                    (a, b) -> b.targetTier > a.targetTier ? b : a
            );
        }

        List<UpgradeData.UpgradeOption> result = new ArrayList<>(best.values());

        result.sort(Comparator.comparingInt(o -> o.requiredSailingLevel));

        return result;
    }

    public boolean isConfigEnabled(String partName)
    {
        switch (partName)
        {
            case "Base":
            case "Hull": return config.showBaseHull();
            case "Helm": return config.showHelm();
            case "Sails": return config.showSails();
            case "Keel": return config.showKeel();
            case "Salvaging Hook": return config.showSalvagingHook();
            case "Cargo Hold": return config.showCargoHold();
            case "Cannon": return config.showCannon();
            case "Teleport Focus": return config.showTeleportFocus();
            case "Wind Device": return config.showWindDevice();
            case "Trawling Net": return config.showTrawlingNet();
            case "Chum Station": return config.showChumStation();
            case "Fathom Device": return config.showFathomDevice();
            case "Range": return config.showRange();
            case "Keg": return config.showKeg();
            case "Anchor": return config.showAnchor();
            case "Inoculation Station": return config.showInoculationStation();
            case "Salvaging Station": return config.showSalvagingStation();
            case "Crystal Extractor": return config.showCrystalExtractor();
            case "Eternal Brazier": return config.showEternalBrazier();
            default: return true;
        }
    }
}

package com.boatupgrades.utils;

public class SchematicEntry
{
    private final String schematicName;
    private final String upgradeName;
    private final int varbit;

    public SchematicEntry(String schematicName, String upgradeName, int varbitID)
    {
        this.schematicName = schematicName;
        this.upgradeName = upgradeName;
        this.varbit = varbitID;
    }

    public String getSchematicName()
    {
        return schematicName;
    }

    public String getUpgradeName()
    {
        return upgradeName;
    }

    public int getVarbit()
    {
        return varbit;
    }
}


package com.boatupgrades.utils;

import net.runelite.api.Client;
import net.runelite.api.gameval.VarbitID;

import javax.inject.Inject;
import java.util.*;

public class SchematicUtils
{
    private final Client client;

    @Inject
    public SchematicUtils(Client client)
    {
        this.client = client;
    }

    private static final List<SchematicEntry> SCHEMATICS = Arrays.asList(
            new SchematicEntry("Salvaging station schematic", "Salvaging station", VarbitID.LOST_SCHEMATIC_SALVAGING_STATION),
            new SchematicEntry("Gale catcher schematic", "Gale catcher", VarbitID.LOST_SCHEMATIC_GALE_CATCHER),
            new SchematicEntry("Rosewood hull schematic", "Rosewood hull", VarbitID.LOST_SCHEMATIC_ROSEWOOD_HULL),
            new SchematicEntry("Rosewood cargo hold schematic", "Rosewood cargo hold", VarbitID.LOST_SCHEMATIC_ROSEWOOD_CARGO_HOLD),
            new SchematicEntry("Dragon helm schematic", "Dragon helm", VarbitID.LOST_SCHEMATIC_DRAGON_TILLER),
            new SchematicEntry("Dragon salvaging hook schematic", "Dragon salvaging hook", VarbitID.LOST_SCHEMATIC_DRAGON_SALVAGING_HOOK),
            new SchematicEntry("Eternal brazier schematic", "Eternal brazier", VarbitID.LOST_SCHEMATIC_ETERNAL_BRAZIER),
            new SchematicEntry("Dragon cannon schematic", "Dragon cannon", VarbitID.LOST_SCHEMATIC_DRAGON_CANNON),
            new SchematicEntry("Rosewood & cotton sails schematic", "Rosewood mast & cotton sails", VarbitID.LOST_SCHEMATIC_ROSEWOOD_SAIL),
            new SchematicEntry("Dragon keel schematic", "Dragon keel", VarbitID.LOST_SCHEMATIC_DRAGON_KEEL)
    );

    public boolean hasSchematic(String upgradeName)
    {
        Optional<SchematicEntry> entry = SCHEMATICS.stream()
                .filter(s -> s.getUpgradeName().equals(upgradeName))
                .findFirst();

        return entry.map(schematicEntry -> client.getVarbitValue(schematicEntry.getVarbit()) == 1).orElse(true);

    }

    public String getSchematicNameForUpgrade(String upgradeName)
    {
        return SCHEMATICS.stream()
                .filter(s -> s.getUpgradeName().equals(upgradeName))
                .map(SchematicEntry::getSchematicName)
                .findFirst()
                .orElse(null);
    }
}
package com.boatupgrades;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.*;
import net.runelite.api.events.GameObjectSpawned;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.VarbitChanged;
import net.runelite.api.gameval.ObjectID;
import net.runelite.client.eventbus.EventBus;
import net.runelite.client.eventbus.Subscribe;

import javax.inject.Inject;
import javax.inject.Singleton;
import java.util.*;

import static net.runelite.api.gameval.VarbitID.SAILING_BOARDED_BOAT;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_SHIPYARD_MODE;

/**
 * FacilityService scans game objects within your boat's world entity to detect boat facilities
 * Ideally, the end goal is to find all the varbit values for each hotspot for each boat type to detect the facilities
 * For now, this will have to suffice
 */
@Singleton
@Slf4j
public class FacilityService
{
    private final Client client;
    private final EventBus eventBus;

    private final Map<String, Integer> highestDetected = new HashMap<>();
    private int pendingScanTicks = -1;
    public boolean detectedFacilitiesComplete;

    @Inject
    public FacilityService(Client client, EventBus eventBus)
    {
        this.client = client;
        this.eventBus = eventBus;

        List<String> facilities = Arrays.asList(
                "Salvaging Hook",
                "Cargo Hold",
                "Cannon",
                "Teleport Focus",
                "Wind Device",
                "Trawling Net",
                "Chum Station",
                "Fathom Device",
                "Range",
                "Keg",
                "Anchor",
                "Inoculation Station",
                "Salvaging Station",
                "Crystal Extractor",
                "Eternal Brazier"
        );
        for (String f : facilities)
        {
            highestDetected.put(f, -1);
        }
    }

    public void start()
    {
        eventBus.register(this);
    }
    public void stop()
    {
        eventBus.unregister(this);
    }

    private void processSceneGameObject(GameObject go)
    {
        try
        {
            final int id = go.getId();
            final String name = client.getObjectDefinition(id).getName();

            if (!name.equals("null"))
            {
                log.debug("Boat GameObject detected: id={}, name='{}'", id, name);
            }

            if (SALVAGING_HOOK_BRONZE.contains(id) || SALVAGING_HOOK_IRON.contains(id) || SALVAGING_HOOK_STEEL.contains(id)
                    || SALVAGING_HOOK_MITHRIL.contains(id) || SALVAGING_HOOK_ADAMANT.contains(id)
                    || SALVAGING_HOOK_RUNE.contains(id) || SALVAGING_HOOK_DRAGON.contains(id)) {
                updateHighest("Salvaging Hook", salvageHookIdToTier(id));
                return;
            }

            if (CARGO_HOLD_REGULAR.contains(id) || CARGO_HOLD_OAK.contains(id) || CARGO_HOLD_TEAK.contains(id)
                    || CARGO_HOLD_MAHOGANY.contains(id) || CARGO_HOLD_CAMPHOR.contains(id)
                    || CARGO_HOLD_IRONWOOD.contains(id) || CARGO_HOLD_ROSEWOOD.contains(id)) {
                updateHighest("Cargo Hold", cargoIdToTier(id));
                return;
            }

            if (CANNON_BRONZE.contains(id) || CANNON_IRON.contains(id) || CANNON_STEEL.contains(id)
                    || CANNON_MITHRIL.contains(id) || CANNON_ADAMANT.contains(id)
                    || CANNON_RUNE.contains(id) || CANNON_DRAGON.contains(id)) {
                updateHighest("Cannon", cannonIdToTier(id));
                return;
            }

            if (TELEPORT_FOCUS.contains(id) || TELEPORT_FOCUS_GREATER.contains(id)) {
                updateHighest("Teleport Focus", teleportFocusIdToTier(id));
                return;
            }

            if (WIND_CATCHER.contains(id) || GALE_CATCHER.contains(id)) {
                updateHighest("Wind Device", windIdToTier(id));
                return;
            }

            if (TRAWLING_NET_ROPE.contains(id) || TRAWLING_NET_LINEN.contains(id)
                    || TRAWLING_NET_HEMP.contains(id) || TRAWLING_NET_COTTON.contains(id)) {
                updateHighest("Trawling Net", trawlingIdToTier(id));
                return;
            }

            if (CHUM_STATION.contains(id) || CHUM_STATION_ADVANCED.contains(id) || CHUM_SPREADER.contains(id)) {
                updateHighest("Chum Station", chumIdToTier(id));
                return;
            }

            if (FATHOM_STONE.contains(id) || FATHOM_PEARL.contains(id)) {
                updateHighest("Fathom Device", fathomIdToTier(id));
                return;
            }

            if (RANGE.contains(id)) {
                updateHighest("Range", 0);
                return;
            }

            if (KEG.contains(id)) {
                updateHighest("Keg", 0);
                return;
            }

            if (ANCHOR.contains(id)) {
                updateHighest("Anchor", 0);
                return;
            }

            if (INOCULATION_STATION.contains(id)) {
                updateHighest("Inoculation Station", 0);
                return;
            }

            if (SALVAGING_STATION.contains(id)) {
                updateHighest("Salvaging Station", 0);
                return;
            }

            if (CRYSTAL_EXTRACTOR.contains(id)) {
                updateHighest("Crystal Extractor", 0);
                return;
            }

            if (ETERNAL_BRAZIER.contains(id)) {
                updateHighest("Eternal Brazier", 0);
            }
        }
        catch (Throwable t)
        {
            log.debug("processSceneGameObject failed", t);
        }
    }

    public void scanBoatWorldEntity()
    {
        WorldView top = client.getTopLevelWorldView();
        if (top == null)
        {
            log.debug("No top-level worldview");
            return;
        }

        var entities = top.worldEntities();
        if (entities == null)
        {
            log.debug("No world entities");
            return;
        }

        for (WorldEntity entity : entities)
        {
            if (entity.getOwnerType() != WorldEntity.OWNER_TYPE_SELF_PLAYER)
            {
                continue;
            }

            WorldView boatView = entity.getWorldView();
            if (boatView == null)
            {
                continue;
            }

            Scene scene = boatView.getScene();
            if (scene == null)
            {
                continue;
            }

            scanScene(scene);
        }
    }

    private void scanScene(Scene scene)
    {
        Tile[][][] tiles = scene.getTiles();
        if (tiles == null)
        {
            return;
        }

        for (int plane = 0; plane < tiles.length; plane++)
        {
            Tile[][] planeTiles = tiles[plane];
            if (planeTiles == null)
            {
                continue;
            }

            for (int x = 0; x < planeTiles.length; x++)
            {
                Tile[] col = planeTiles[x];
                if (col == null)
                {
                    continue;
                }

                for (int y = 0; y < col.length; y++)
                {
                    Tile tile = col[y];
                    if (tile == null)
                    {
                        continue;
                    }

                    for (GameObject go : tile.getGameObjects())
                    {
                        if (go != null)
                        {
                            processSceneGameObject(go);
                        }
                    }
                }
            }
        }
        detectedFacilitiesComplete = true;
    }

    @Subscribe
    public void onVarbitChanged(VarbitChanged ev)
    {
        try
        {
            final int changedVarbit = ev.getVarbitId();

            if (changedVarbit != SAILING_BOARDED_BOAT &&
                    changedVarbit != SAILING_SIDEPANEL_SHIPYARD_MODE)
            {
                return;
            }

            final int boarded = client.getVarbitValue(SAILING_BOARDED_BOAT);
            final int shipyardMode = client.getVarbitValue(SAILING_SIDEPANEL_SHIPYARD_MODE);

            if (changedVarbit == SAILING_BOARDED_BOAT && shipyardMode != 0)
            {
                return;
            }

            final boolean nowActive = (boarded != 0) || (shipyardMode != 0);

            if (nowActive)
            {
                pendingScanTicks = 2;

                log.debug(
                        "FacilityService: sailing varbit {} changed -> active (boarded={}, shipyard={}), scheduling scan",
                        changedVarbit, boarded, shipyardMode
                );
            }
            else
            {
                pendingScanTicks = -1;

                log.debug(
                        "FacilityService: sailing varbits inactive (boarded={}, shipyard={}), reset",
                        boarded, shipyardMode
                );
            }
        }
        catch (Throwable t)
        {
            log.warn("onVarbitChanged error", t);
        }
    }

    @Subscribe
    public void onGameTick(GameTick tick)
    {
        if (pendingScanTicks < 0)
        {
            return;
        }

        pendingScanTicks--;

        if (pendingScanTicks == 0)
        {
            scanBoatWorldEntity();
            pendingScanTicks = -1;
        }
    }

    @Subscribe
    public void onGameObjectSpawned(GameObjectSpawned event)
    {
        final int shipyardMode = client.getVarbitValue(SAILING_SIDEPANEL_SHIPYARD_MODE);
        final boolean inShipyard = shipyardMode != 0;

        if (inShipyard && pendingScanTicks == -1) // Avoids calls while entering shipyard
        {
            resetAllDetectedTiers();
            scanBoatWorldEntity();
            //log.info("Game object spawned");
        }
    }

    public int getHighestTier(String partName)
    {
            return highestDetected.getOrDefault(partName, -1);
    }

    public Map<String, Integer> getAllHighestTiers()
    {
        return new HashMap<>(highestDetected);
    }

    public boolean hasDetectedAllFacilities()
    {
        return detectedFacilitiesComplete;
    }


    private void updateHighest(String partName, int tier)
    {
        if (partName == null || tier < 0)
        {
            return;
        }

            Integer cur = highestDetected.get(partName);
            if (cur == null)
            {
                highestDetected.put(partName, tier);
                return;
            }

            if (tier > cur)
            {
                highestDetected.put(partName, tier);
                log.debug("FacilityService: updated {} -> {}", partName, tier);
            }
    }

    public void resetAllDetectedTiers()
    {
            for (String key : highestDetected.keySet())
            {
                highestDetected.put(key, -1);
            }
            log.debug("FacilityService: Reset all detected tiers to -1");
    }

    private int salvageHookIdToTier(int id)
    {
        if (SALVAGING_HOOK_BRONZE.contains(id)) return 0;
        if (SALVAGING_HOOK_IRON.contains(id)) return 1;
        if (SALVAGING_HOOK_STEEL.contains(id)) return 2;
        if (SALVAGING_HOOK_MITHRIL.contains(id)) return 3;
        if (SALVAGING_HOOK_ADAMANT.contains(id)) return 4;
        if (SALVAGING_HOOK_RUNE.contains(id)) return 5;
        if (SALVAGING_HOOK_DRAGON.contains(id)) return 6;
        return -1;
    }

    private int cargoIdToTier(int id)
    {
        if (CARGO_HOLD_REGULAR.contains(id)) return 0;
        if (CARGO_HOLD_OAK.contains(id)) return 1;
        if (CARGO_HOLD_TEAK.contains(id)) return 2;
        if (CARGO_HOLD_MAHOGANY.contains(id)) return 3;
        if (CARGO_HOLD_CAMPHOR.contains(id)) return 4;
        if (CARGO_HOLD_IRONWOOD.contains(id)) return 5;
        if (CARGO_HOLD_ROSEWOOD.contains(id)) return 6;
        return -1;
    }

    private int cannonIdToTier(int id)
    {
        if (CANNON_BRONZE.contains(id)) return 0;
        if (CANNON_IRON.contains(id)) return 1;
        if (CANNON_STEEL.contains(id)) return 2;
        if (CANNON_MITHRIL.contains(id)) return 3;
        if (CANNON_ADAMANT.contains(id)) return 4;
        if (CANNON_RUNE.contains(id)) return 5;
        if (CANNON_DRAGON.contains(id)) return 6;
        return -1;
    }

    private int teleportFocusIdToTier(int id)
    {
        if (TELEPORT_FOCUS.contains(id)) return 0;
        if (TELEPORT_FOCUS_GREATER.contains(id)) return 1;
        return -1;
    }

    private int windIdToTier(int id)
    {
        if (WIND_CATCHER.contains(id)) return 0;
        if (GALE_CATCHER.contains(id)) return 1;
        return -1;
    }

    private int trawlingIdToTier(int id)
    {
        if (TRAWLING_NET_ROPE.contains(id)) return 0;
        if (TRAWLING_NET_LINEN.contains(id)) return 1;
        if (TRAWLING_NET_HEMP.contains(id)) return 2;
        if (TRAWLING_NET_COTTON.contains(id)) return 3;
        return -1;
    }

    private int chumIdToTier(int id)
    {
        if (CHUM_STATION.contains(id)) return 0;
        if (CHUM_STATION_ADVANCED.contains(id)) return 1;
        if (CHUM_SPREADER.contains(id)) return 2;
        return -1;
    }

    private int fathomIdToTier(int id)
    {
        if (FATHOM_PEARL.contains(id)) return 0;
        if (FATHOM_STONE.contains(id)) return 1;
        return -1;
    }

    private static final Set<Integer> SALVAGING_HOOK_BRONZE = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_BRONZE,
            ObjectID.SALVAGING_HOOK_BRONZE,
            ObjectID.SALVAGING_HOOK_LARGE_BRONZE,
            ObjectID.SALVAGING_HOOK_LARGE_BRONZE_B
    );
    private static final Set<Integer> SALVAGING_HOOK_IRON = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_IRON,
            ObjectID.SALVAGING_HOOK_IRON,
            ObjectID.SALVAGING_HOOK_LARGE_IRON,
            ObjectID.SALVAGING_HOOK_LARGE_IRON_B
    );
    private static final Set<Integer> SALVAGING_HOOK_STEEL = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_STEEL,
            ObjectID.SALVAGING_HOOK_STEEL,
            ObjectID.SALVAGING_HOOK_LARGE_STEEL,
            ObjectID.SALVAGING_HOOK_LARGE_STEEL_B
    );
    private static final Set<Integer> SALVAGING_HOOK_MITHRIL = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_MITHRIL,
            ObjectID.SALVAGING_HOOK_MITHRIL,
            ObjectID.SALVAGING_HOOK_LARGE_MITHRIL,
            ObjectID.SALVAGING_HOOK_LARGE_MITHRIL_B
    );
    private static final Set<Integer> SALVAGING_HOOK_ADAMANT = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_ADAMANT,
            ObjectID.SALVAGING_HOOK_ADAMANT,
            ObjectID.SALVAGING_HOOK_LARGE_ADAMANT,
            ObjectID.SALVAGING_HOOK_LARGE_ADAMANT_B
    );
    private static final Set<Integer> SALVAGING_HOOK_RUNE = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_RUNE,
            ObjectID.SALVAGING_HOOK_RUNE,
            ObjectID.SALVAGING_HOOK_LARGE_RUNE,
            ObjectID.SALVAGING_HOOK_LARGE_RUNE_B
    );
    private static final Set<Integer> SALVAGING_HOOK_DRAGON = Set.of(
            ObjectID.SALVAGING_HOOK_RAFT_DRAGON,
            ObjectID.SALVAGING_HOOK_DRAGON,
            ObjectID.SALVAGING_HOOK_LARGE_DRAGON,
            ObjectID.SALVAGING_HOOK_LARGE_DRAGON_B
    );

    private static final Set<Integer> CARGO_HOLD_REGULAR = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_REGULAR_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_OAK = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_OAK_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_TEAK = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_TEAK_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_MAHOGANY = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_MAHOGANY_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_CAMPHOR = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_CAMPHOR_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_IRONWOOD = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_IRONWOOD_LARGE_OPEN
    );
    private static final Set<Integer> CARGO_HOLD_ROSEWOOD = Set.of(
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_RAFT,
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_RAFT_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_2X5,
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_2X5_OPEN,
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_LARGE,
            ObjectID.SAILING_BOAT_CARGO_HOLD_ROSEWOOD_LARGE_OPEN
    );

    private static final Set<Integer> TELEPORT_FOCUS = Set.of(ObjectID.SAILING_TELEPORTATION_FOCUS);
    private static final Set<Integer> TELEPORT_FOCUS_GREATER = Set.of(ObjectID.SAILING_TELEPORTATION_FOCUS_GREATER);

    private static final Set<Integer> CANNON_BRONZE = Set.of(ObjectID.SAILING_BRONZE_CANNON);
    private static final Set<Integer> CANNON_IRON = Set.of(ObjectID.SAILING_IRON_CANNON);
    private static final Set<Integer> CANNON_STEEL = Set.of(ObjectID.SAILING_STEEL_CANNON);
    private static final Set<Integer> CANNON_MITHRIL = Set.of(ObjectID.SAILING_MITHRIL_CANNON);
    private static final Set<Integer> CANNON_ADAMANT = Set.of(ObjectID.SAILING_ADAMANT_CANNON);
    private static final Set<Integer> CANNON_RUNE = Set.of(ObjectID.SAILING_RUNE_CANNON);
    private static final Set<Integer> CANNON_DRAGON = Set.of(ObjectID.SAILING_DRAGON_CANNON);
    private static final Set<Integer> WIND_CATCHER = Set.of(
            ObjectID.SAILING_WIND_CATCHER_ACTIVATED,
            ObjectID.SAILING_WIND_CATCHER_DEACTIVATED
    );
    private static final Set<Integer> GALE_CATCHER = Set.of(
            ObjectID.SAILING_GALE_CATCHER_ACTIVATED,
            ObjectID.SAILING_GALE_CATCHER_DEACTIVATED
    );

    private static final Set<Integer> TRAWLING_NET_ROPE = Set.of(
            ObjectID.SAILING_ROPE_TRAWLING_NET,
            ObjectID.SAILING_ROPE_TRAWLING_NET_3X8_STARBOARD,
            ObjectID.SAILING_ROPE_TRAWLING_NET_3X8_PORT
    );
    private static final Set<Integer> TRAWLING_NET_LINEN = Set.of(
            ObjectID.SAILING_LINEN_TRAWLING_NET,
            ObjectID.SAILING_LINEN_TRAWLING_NET_3X8_STARBOARD,
            ObjectID.SAILING_LINEN_TRAWLING_NET_3X8_PORT
    );
    private static final Set<Integer> TRAWLING_NET_HEMP = Set.of(
            ObjectID.SAILING_HEMP_TRAWLING_NET,
            ObjectID.SAILING_HEMP_TRAWLING_NET_3X8_STARBOARD,
            ObjectID.SAILING_HEMP_TRAWLING_NET_3X8_PORT
    );
    private static final Set<Integer> TRAWLING_NET_COTTON = Set.of(
            ObjectID.SAILING_COTTON_TRAWLING_NET,
            ObjectID.SAILING_COTTON_TRAWLING_NET_3X8_STARBOARD,
            ObjectID.SAILING_COTTON_TRAWLING_NET_3X8_PORT
    );
    private static final Set<Integer> CHUM_STATION = Set.of(
            ObjectID.CHUM_STATION_2X5A,
            ObjectID.CHUM_STATION_2X5B,
            ObjectID.CHUM_STATION_3X8A,
            ObjectID.CHUM_STATION_3X8B
    );
    private static final Set<Integer> CHUM_STATION_ADVANCED = Set.of(
            ObjectID.CHUM_STATION_ADVANCED_2X5A,
            ObjectID.CHUM_STATION_ADVANCED_2X5B,
            ObjectID.CHUM_STATION_ADVANCED_3X8A,
            ObjectID.CHUM_STATION_ADVANCED_3X8B
    );
    private static final Set<Integer> CHUM_SPREADER = Set.of(
            ObjectID.CHUM_SPREADER_2X5A,
            ObjectID.CHUM_SPREADER_2X5B,
            ObjectID.CHUM_SPREADER_3X8A,
            ObjectID.CHUM_SPREADER_3X8B
    );
    private static final Set<Integer> FATHOM_STONE = Set.of(ObjectID.SAILING_FATHOM_STONE);
    private static final Set<Integer> FATHOM_PEARL = Set.of(ObjectID.SAILING_FATHOM_PEARL);
    private static final Set<Integer> RANGE = Set.of(ObjectID.SAILING_FACILITY_RANGE);
    private static final Set<Integer> KEG = Set.of(
            ObjectID.SAILING_KEG_EMPTY,
            ObjectID.SAILING_KEG_GROG,
            ObjectID.SAILING_KEG_CIDER,
            ObjectID.SAILING_KEG_WHIRLPOOL_SURPRISE,
            ObjectID.SAILING_KEG_KRAKEN_INK_STOUT,
            ObjectID.SAILING_KEG_PERILDANCE_BITTER,
            ObjectID.SAILING_KEG_TRAWLERS_TRUST,
            ObjectID.SAILING_KEG_HORIZONS_LURE
    );
    private static final Set<Integer> ANCHOR = Set.of(
            ObjectID.SAILING_ANCHOR_RAISED_2X5,
            ObjectID.SAILING_ANCHOR_LOWERED_2X5,
            ObjectID.SAILING_ANCHOR_RAISED_3X8,
            ObjectID.SAILING_ANCHOR_LOWERED_3X8
    );
    private static final Set<Integer> INOCULATION_STATION = Set.of(
            ObjectID.SAILING_FACILITY_2X5_INOCULATION_STATION,
            ObjectID.SAILING_FACILITY_2X5_INOCULATION_STATION_NOOP,
            ObjectID.SAILING_FACILITY_3X8_INOCULATION_STATION
    );
    private static final Set<Integer> SALVAGING_STATION = Set.of(
            ObjectID.SAILING_SALVAGING_STATION_2X5A,
            ObjectID.SAILING_SALVAGING_STATION_2X5B,
            ObjectID.SAILING_SALVAGING_STATION_3X8
    );
    private static final Set<Integer> CRYSTAL_EXTRACTOR = Set.of(
            ObjectID.SAILING_CRYSTAL_EXTRACTOR_ACTIVATED,
            ObjectID.SAILING_CRYSTAL_EXTRACTOR_DEACTIVATED
    );
    private static final Set<Integer> ETERNAL_BRAZIER = Set.of(
            ObjectID.SAILING_BOAT_1X3_ETERNAL_BRAZIER,
            ObjectID.SAILING_BOAT_SKIFF_ETERNAL_BRAZIER,
            ObjectID.SAILING_BOAT_SLOOP_ETERNAL_BRAZIER,
            ObjectID.SAILING_BOAT_ETERNAL_BRAZIER_UI
    );
}
package com.boatupgrades;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;

import javax.inject.Inject;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.*;

@Slf4j
public class ChangelogService
{
    private final Client client;
    @Inject
    private BoatUpgradesConfig config;

    @Inject
    public ChangelogService(Client client, BoatUpgradesConfig config)
    {
        this.client = client;
        this.config = config;
    }

    private static final String PLUGIN_VERSION = "1.2.0";
    private static final String CHANGELOG_RESOURCE = "/changelog.md";
    private boolean changelogShownThisSession = false;
    public void showChangelogIfNeeded()
    {
        if (changelogShownThisSession)
        {
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        String lastSeen = config.lastSeenChangelogVersion();

        if (lastSeen.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        if (PLUGIN_VERSION.equals(lastSeen))
        {
            changelogShownThisSession = true;
            return;
        }

        Map<String, List<String>> changelog = loadChangelogFromResource();
        if (changelog.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        List<String> toShowVersions = new ArrayList<>();
        for (String version : changelog.keySet())
        {
            if (version.equals(lastSeen))
            {
                break;
            }
            toShowVersions.add(version);
        }

        if (toShowVersions.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "<col=0051c9>Boat Upgrades Updated", null);
        for (String version : toShowVersions)
        {
            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "<col=0051c9>v" + version + ":", null);
            List<String> lines = changelog.get(version);
            for (String line : lines)
            {
                client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "  <col=0051c9>" + line, null);
            }
        }

        changelogShownThisSession = true;
        config.setLastSeenChangelogVersion(PLUGIN_VERSION);
    }

    public Map<String, List<String>> loadChangelogFromResource()
    {
        Map<String, List<String>> out = new LinkedHashMap<>();
        try (InputStream is = getClass().getResourceAsStream(CHANGELOG_RESOURCE))
        {
            if (is == null)
            {
                log.debug("Changelog resource not found at {}", CHANGELOG_RESOURCE);
                return Collections.emptyMap();
            }

            BufferedReader r = new BufferedReader(new InputStreamReader(is, StandardCharsets.UTF_8));
            String line;
            String currentVersion = null;
            List<String> currentLines = null;

            while ((line = r.readLine()) != null)
            {
                line = line.trim();
                if (line.startsWith("## "))
                {
                    if (currentVersion != null && currentLines != null)
                    {
                        out.put(currentVersion, currentLines);
                    }
                    currentVersion = line.substring(3).trim();
                    currentLines = new ArrayList<>();
                }
                else
                {
                    if (currentVersion != null)
                    {
                        if (!line.isEmpty())
                        {
                            currentLines.add(line);
                        }
                    }
                }
            }

            if (currentVersion != null && currentLines != null)
            {
                out.put(currentVersion, currentLines);
            }
        }
        catch (IOException ex)
        {
            log.warn("Failed to read changelog resource", ex);
            return Collections.emptyMap();
        }

        return out;
    }
}
package com.boatupgrades;

import java.util.*;

public final class UpgradeData
{
    private UpgradeData() {}

    public static final class Material
    {
        public final String name;
        public final int qty;

        public Material(String name, int qty)
        {
            this.name = name;
            this.qty = qty;
        }

        @Override
        public String toString()
        {
            return qty + " x " + name;
        }
    }

    public static final class UpgradeOption
    {
        public final String partName;
        public final int boatType;
        public final int targetTier;
        public final int requiredSailingLevel;
        public final int requiredConstructionLevel;
        public final String displayName;
        public final List<Material> materials;

        public UpgradeOption(String partName, int boatType, int targetTier, int requiredSailingLevel, int requiredConstructionLevel, String displayName, List<Material> materials)
        {
            this.partName = partName;
            this.boatType = boatType;
            this.targetTier = targetTier;
            this.requiredSailingLevel = requiredSailingLevel;
            this.requiredConstructionLevel = requiredConstructionLevel;
            this.displayName = displayName;
            this.materials = materials == null ? Collections.emptyList() : materials;
        }
    }

    private static final List<UpgradeOption> OPTIONS = new ArrayList<>();
    private static final Set<String> RAFT_EXCLUDED_FACILITIES = Set.of(
            "Inoculation Station",
            "Trawling Net",
            "Chum Station",
            "Anchor",
            "Fathom Device",
            "Salvaging Station",
            "Crystal Extractor"
    );

    static
    {
    // Core boat parts
        // Wooden base/hull (tier 0)
        OPTIONS.add(new UpgradeOption("Base", 0, 0, 1, 1, "Wooden base",
                Arrays.asList(new Material("Logs",10), new Material("Rope",6), new Material("Swamp tar",10))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 0, 1, 1, "Wooden hull",
                Arrays.asList(new Material("Wooden hull parts",10), new Material("Bronze nails",300), new Material("Swamp tar",20))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 0, 1, 1, "Wooden hull",
                Arrays.asList(new Material("Large wooden hull parts",16), new Material("Bronze nails",600), new Material("Swamp tar",25))));

        // Bronze helm (tier 0)
        OPTIONS.add(new UpgradeOption("Helm", 0, 0, 1, 1, "Bronze helm",
                Arrays.asList(new Material("Plank",2), new Material("Bronze bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 0, 1, 1, "Bronze helm",
                Arrays.asList(new Material("Plank",3), new Material("Bronze bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 0, 1, 1, "Bronze helm",
                Arrays.asList(new Material("Plank",4), new Material("Bronze bar",8))));

        // Wooden sails (tier 0)
        OPTIONS.add(new UpgradeOption("Sails", 0, 0, 1, 1, "Wooden mast & linen sails",
                Arrays.asList(new Material("Logs",5), new Material("Bronze nails",20), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 0, 1, 1, "Wooden mast & linen sails",
                Arrays.asList(new Material("Logs",10), new Material("Bronze nails",40), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 0, 1, 1, "Wooden mast & linen sails",
                Arrays.asList(new Material("Logs",15), new Material("Bronze nails",60), new Material("Bolt of linen",10))));

        // Bronze keel (tier 0)
        OPTIONS.add(new UpgradeOption("Keel", 1, 0, 1, 1, "Bronze keel",
                Arrays.asList(new Material("Bronze keel parts",10))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 0, 1, 1, "Bronze keel",
                Arrays.asList(new Material("Large bronze keel parts",16))));

        // Iron helm (tier 1)
        OPTIONS.add(new UpgradeOption("Helm", 0, 1, 17, 14, "Iron helm",
                Arrays.asList(new Material("Oak plank",2), new Material("Iron bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 1, 17, 14, "Iron helm",
                Arrays.asList(new Material("Oak plank",3), new Material("Iron bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 1, 17, 14, "Iron helm",
                Arrays.asList(new Material("Oak plank",4), new Material("Iron bar",8))));

        // Oak base/hull (tier 1)
        OPTIONS.add(new UpgradeOption("Base", 0, 1, 20, 8, "Oak base",
                Arrays.asList(new Material("Oak logs",10), new Material("Rope",6), new Material("Swamp tar",10))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 1, 20, 8, "Oak hull",
                Arrays.asList(new Material("Oak hull parts",10), new Material("Iron nails",300), new Material("Swamp tar",20))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 1, 20, 8, "Oak hull",
                Arrays.asList(new Material("Large oak hull parts",16), new Material("Iron nails",600), new Material("Swamp tar",25))));

        // Iron keel (tier 1)
        OPTIONS.add(new UpgradeOption("Keel", 1, 1, 22, 17, "Iron keel",
                Arrays.asList(new Material("Iron keel parts",10))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 1, 22, 17, "Iron keel",
                Arrays.asList(new Material("Large iron keel parts",16))));

        // Oak sails (tier 1)
        OPTIONS.add(new UpgradeOption("Sails", 0, 1, 24, 11, "Oak mast & linen sails",
                Arrays.asList(new Material("Oak logs",5), new Material("Iron nails",20), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 1, 24, 11, "Oak mast & linen sails",
                Arrays.asList(new Material("Oak logs",10), new Material("Iron nails",40), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 1, 24, 11, "Oak mast & linen sails",
                Arrays.asList(new Material("Oak logs",15), new Material("Iron nails",60), new Material("Bolt of linen",10))));

        // Teak base/hull (tier 2)
        OPTIONS.add(new UpgradeOption("Base", 0, 2, 31, 23, "Teak base",
                Arrays.asList(new Material("Teak logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 2, 31, 23, "Teak hull",
                Arrays.asList(new Material("Teak hull parts",10), new Material("Steel nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 2, 31, 23, "Teak hull",
                Arrays.asList(new Material("Large teak hull parts",16), new Material("Steel nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Teak sails (tier 2)
        OPTIONS.add(new UpgradeOption("Sails", 0, 2, 36, 26, "Teak mast & canvas sails",
                Arrays.asList(new Material("Teak logs",5), new Material("Steel nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 2, 36, 26, "Teak mast & canvas sails",
                Arrays.asList(new Material("Teak logs",10), new Material("Steel nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 2, 36, 26, "Teak mast & canvas sails",
                Arrays.asList(new Material("Teak logs",15), new Material("Steel nails",60), new Material("Bolt of canvas",10))));

        // Steel helm (tier 2)
        OPTIONS.add(new UpgradeOption("Helm", 0, 2, 38, 30, "Steel helm",
                Arrays.asList(new Material("Teak plank",2), new Material("Steel bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 2, 38, 30, "Steel helm",
                Arrays.asList(new Material("Teak plank",3), new Material("Steel bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 2, 38, 30, "Steel helm",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel bar",8))));

        // Steel keel (tier 2)
        OPTIONS.add(new UpgradeOption("Keel", 1, 2, 39, 32, "Steel keel",
                Arrays.asList(new Material("Steel keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 2, 39, 32, "Steel keel",
                Arrays.asList(new Material("Large steel keel parts",16), new Material("Lead bar",5))));

        // Mahogany base/hull (tier 3)
        OPTIONS.add(new UpgradeOption("Base", 0, 3, 48, 41, "Mahogany base",
                Arrays.asList(new Material("Mahogany logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 3, 48, 41, "Mahogany hull",
                Arrays.asList(new Material("Mahogany hull parts",10), new Material("Mithril nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 3, 48, 41, "Mahogany hull",
                Arrays.asList(new Material("Large mahogany hull parts",16), new Material("Mithril nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Mahogany sails (tier 3)
        OPTIONS.add(new UpgradeOption("Sails", 0, 3, 52, 45, "Mahogany mast & canvas sails",
                Arrays.asList(new Material("Mahogany logs",5), new Material("Mithril nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 3, 52, 45, "Mahogany mast & canvas sails",
                Arrays.asList(new Material("Mahogany logs",10), new Material("Mithril nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 3, 52, 45, "Mahogany mast & canvas sails",
                Arrays.asList(new Material("Mahogany logs",15), new Material("Mithril nails",60), new Material("Bolt of canvas",10))));

        // Mithril keel (tier 3)
        OPTIONS.add(new UpgradeOption("Keel", 1, 3, 54, 50, "Mithril keel",
                Arrays.asList(new Material("Mithril keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 3, 54, 50, "Mithril keel",
                Arrays.asList(new Material("Large mithril keel parts",16), new Material("Lead bar",5))));

        // Mithril helm (tier 3)
        OPTIONS.add(new UpgradeOption("Helm", 0, 3, 55, 47, "Mithril helm",
                Arrays.asList(new Material("Mahogany plank",2), new Material("Mithril bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 3, 55, 47, "Mithril helm",
                Arrays.asList(new Material("Mahogany plank",3), new Material("Mithril bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 3, 55, 47, "Mithril helm",
                Arrays.asList(new Material("Mahogany plank",4), new Material("Mithril bar",8))));

        // Adamant keel (tier 4)
        OPTIONS.add(new UpgradeOption("Keel", 1, 4, 66, 62, "Adamant keel",
                Arrays.asList(new Material("Adamant keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 4, 66, 62, "Adamant keel",
                Arrays.asList(new Material("Large adamant keel parts",16), new Material("Lead bar",5))));

        // Camphor base/hull (tier 4)
        OPTIONS.add(new UpgradeOption("Base", 0, 4, 67, 59, "Camphor base",
                Arrays.asList(new Material("Camphor logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 4, 67, 59, "Camphor hull",
                Arrays.asList(new Material("Camphor hull parts",10), new Material("Adamantite nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 4, 67, 59, "Camphor hull",
                Arrays.asList(new Material("Large camphor hull parts",16), new Material("Adamantite nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Camphor sails (tier 4)
        OPTIONS.add(new UpgradeOption("Sails", 0, 4, 68, 60, "Camphor mast & canvas sails",
                Arrays.asList(new Material("Camphor logs",5), new Material("Adamantite nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 4, 68, 60, "Camphor mast & canvas sails",
                Arrays.asList(new Material("Camphor logs",10), new Material("Adamantite nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 4, 68, 60, "Camphor mast & canvas sails",
                Arrays.asList(new Material("Camphor logs",15), new Material("Adamantite nails",60), new Material("Bolt of canvas",10))));

        // Adamant helm (tier 4)
        OPTIONS.add(new UpgradeOption("Helm", 0, 4, 72, 59, "Adamant helm",
                Arrays.asList(new Material("Camphor plank",2), new Material("Adamantite bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 4, 72, 59, "Adamant helm",
                Arrays.asList(new Material("Camphor plank",3), new Material("Adamantite bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 4, 72, 59, "Adamant helm",
                Arrays.asList(new Material("Camphor plank",4), new Material("Adamantite bar",8))));

        // Ironwood base/hull (tier 5)
        OPTIONS.add(new UpgradeOption("Base", 0, 5, 81,75,  "Ironwood base",
                Arrays.asList(new Material("Ironwood logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 5, 81, 75, "Ironwood hull",
                Arrays.asList(new Material("Ironwood hull parts",10), new Material("Rune nails",300), new Material("Swamp tar",20), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 5, 81, 75, "Ironwood hull",
                Arrays.asList(new Material("Large ironwood hull parts",16), new Material("Rune nails",600), new Material("Swamp tar",25), new Material("Cupronickel bar",5))));

        // Ironwood sails (tier 5)
        OPTIONS.add(new UpgradeOption("Sails", 0, 5, 83, 77, "Ironwood mast & cotton sails",
                Arrays.asList(new Material("Ironwood logs",5), new Material("Rune nails",20), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 5, 83, 77, "Ironwood mast & cotton sails",
                Arrays.asList(new Material("Ironwood logs",10), new Material("Rune nails",40), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 5, 83, 77, "Ironwood mast & cotton sails",
                Arrays.asList(new Material("Ironwood logs",15), new Material("Rune nails",60), new Material("Bolt of cotton",10))));

        // Rune keel (tier 5)
        OPTIONS.add(new UpgradeOption("Keel", 1, 5, 85, 78, "Rune keel",
                Arrays.asList(new Material("Rune keel parts",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 5, 85, 78, "Rune keel",
                Arrays.asList(new Material("Large rune keel parts",16), new Material("Cupronickel bar",5))));

        // Rune helm (tier 5)
        OPTIONS.add(new UpgradeOption("Helm", 0, 5, 87, 81, "Rune helm",
                Arrays.asList(new Material("Ironwood plank",2), new Material("Runite bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 5, 87, 81, "Rune helm",
                Arrays.asList(new Material("Ironwood plank",3), new Material("Runite bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 5, 87, 81, "Rune helm",
                Arrays.asList(new Material("Ironwood plank",4), new Material("Runite bar",8))));

        // Rosewood base/hull (tier 6)
        OPTIONS.add(new UpgradeOption("Base", 0, 6, 93, 84, "Rosewood base",
                Arrays.asList(new Material("Rosewood logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 6, 93, 84, "Rosewood hull",
                Arrays.asList(new Material("Rosewood hull parts",10), new Material("Dragon nails",300), new Material("Swamp tar",20), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 6, 93, 84, "Rosewood hull",
                Arrays.asList(new Material("Large rosewood hull parts",16), new Material("Dragon nails",600), new Material("Swamp tar",25), new Material("Cupronickel bar",5))));

        // Rosewood sails (tier 6)
        OPTIONS.add(new UpgradeOption("Sails", 0, 6, 94, 85, "Rosewood mast & cotton sails",
                Arrays.asList(new Material("Rosewood logs",5), new Material("Dragon nails",20), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 6, 94, 85, "Rosewood mast & cotton sails",
                Arrays.asList(new Material("Rosewood logs",10), new Material("Dragon nails",40), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 6, 94, 85, "Rosewood mast & cotton sails",
                Arrays.asList(new Material("Rosewood logs",15), new Material("Dragon nails",60), new Material("Bolt of cotton",10))));

        // Dragon helm (tier 6)
        OPTIONS.add(new UpgradeOption("Helm", 0, 6, 96, 86, "Dragon helm",
                Arrays.asList(new Material("Rosewood plank",2), new Material("Dragon metal sheet",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 6, 96, 86, "Dragon helm",
                Arrays.asList(new Material("Rosewood plank",3), new Material("Dragon metal sheet",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 6, 96, 86, "Dragon helm",
                Arrays.asList(new Material("Rosewood plank",4), new Material("Dragon metal sheet",8))));

        // Dragon keel (tier 6)
        OPTIONS.add(new UpgradeOption("Keel", 1, 6, 97, 87, "Dragon keel",
                Arrays.asList(new Material("Dragon keel parts",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 6, 97, 87, "Dragon keel",
                Arrays.asList(new Material("Large dragon keel parts",16), new Material("Cupronickel bar",5))));

    // Facilities

        // Cargo hold
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 0, 1, 1, "Wooden cargo hold",
                Arrays.asList(new Material("Plank",8), new Material("Bronze nails",32))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 1, 20, 11, "Oak cargo hold",
                Arrays.asList(new Material("Oak plank",8), new Material("Iron nails",32))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 2, 31, 21, "Teak cargo hold",
                Arrays.asList(new Material("Teak plank",8), new Material("Steel nails",32), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 3, 48, 41, "Mahogany cargo hold",
                Arrays.asList(new Material("Mahogany plank",8), new Material("Mithril nails",32), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 4, 67, 53, "Camphor cargo hold",
                Arrays.asList(new Material("Camphor plank",8), new Material("Adamantite nails",32), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 5, 81, 77, "Ironwood cargo hold",
                Arrays.asList(new Material("Ironwood plank",8), new Material("Rune nails",32), new Material("Cupronickel bar",3))));
        OPTIONS.add(new UpgradeOption("Cargo Hold", -1, 6, 93, 84, "Rosewood cargo hold",
                Arrays.asList(new Material("Rosewood plank",8), new Material("Dragon nails",32), new Material("Cupronickel bar",3))));

        // Salvaging hook
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 0, 15, 1, "Bronze salvaging hook",
                Arrays.asList(new Material("Plank",4), new Material("Bronze nails",16), new Material("Bronze bar",6), new Material("Rope",1))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 1, 21, 9, "Iron salvaging hook",
                Arrays.asList(new Material("Oak plank",4), new Material("Iron nails",16), new Material("Iron bar",6), new Material("Rope",1))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 2, 27, 18, "Steel salvaging hook",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel nails",16), new Material("Steel bar",8), new Material("Rope",1), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 3, 44, 30, "Mithril salvaging hook",
                Arrays.asList(new Material("Mahogany plank",4), new Material("Mithril nails",16), new Material("Mithril bar",6), new Material("Rope",1), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 4, 59, 52, "Adamant salvaging hook",
                Arrays.asList(new Material("Camphor plank",4), new Material("Adamantite nails",16), new Material("Adamantite",6), new Material("Rope",1), new Material("Lead bar",3))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 5, 74, 66, "Rune salvaging hook",
                Arrays.asList(new Material("Ironwood plank",4), new Material("Rune nails",16), new Material("Runite bar",6), new Material("Rope",1), new Material("Lead bar",4), new Material("Cupronickel bar",4))));
        OPTIONS.add(new UpgradeOption("Salvaging Hook", -1, 6, 86, 78, "Dragon salvaging hook",
                Arrays.asList(new Material("Rosewood plank",4), new Material("Dragon nails",16), new Material("Dragon metal sheet",6), new Material("Rope",1), new Material("Cupronickel bar",4), new Material("Broken dragon hook",1))));

        // Cannon
        OPTIONS.add(new UpgradeOption("Cannon", -1, 0, 28, 21, "Bronze cannon",
                Arrays.asList(new Material("Plank",4), new Material("Bronze nails",16), new Material("Bronze bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 1, 35, 28, "Iron cannon",
                Arrays.asList(new Material("Oak plank",4), new Material("Iron nails",16), new Material("Iron bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 2, 47, 39, "Steel cannon",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel nails",16), new Material("Steel bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 3, 57, 50, "Mithril cannon",
                Arrays.asList(new Material("Mahogany plank",4), new Material("Mithril nails",16), new Material("Mithril bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 4, 69, 61, "Adamant cannon",
                Arrays.asList(new Material("Camphor plank",4), new Material("Adamantite nails",16), new Material("Adamantite bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 5, 80, 76, "Rune cannon",
                Arrays.asList(new Material("Ironwood plank",4), new Material("Rune nails",16), new Material("Runite bar",8))));
        OPTIONS.add(new UpgradeOption("Cannon", -1, 6, 92, 84, "Dragon cannon",
                Arrays.asList(new Material("Rosewood plank",4), new Material("Dragon nails",16), new Material("Dragon metal sheet",8), new Material("Dragon cannon barrel",1))));

        // Teleport focus
        OPTIONS.add(new UpgradeOption("Teleport Focus", -1, 0, 55, 49, "Teleport focus",
                Arrays.asList(new Material("Mahogany plank",8), new Material("Mithril nails",32), new Material("Lead bar",4), new Material("Magic stone",1))));
        OPTIONS.add(new UpgradeOption("Teleport Focus", -1, 1, 75, 69, "Greater teleport focus",
                Arrays.asList(new Material("Ironwood plank",8), new Material("Rune nails",32), new Material("Cupronickel bar",4), new Material("Magic stone",2), new Material("Bottled storm",1))));

        // Wind/Gale catcher
        OPTIONS.add(new UpgradeOption("Wind Device", -1, 0, 53, 47, "Wind catcher",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel nails",16), new Material("Steel bar",8), new Material("Lead bar",4), new Material("Air rune",10000), new Material("Captured wind mote",1))));
        OPTIONS.add(new UpgradeOption("Wind Device", -1, 1, 79, 70, "Gale catcher",
                Arrays.asList(new Material("Camphor plank",4), new Material("Adamantite nails",16), new Material("Adamantite bar",8), new Material("Cupronickel bar",4), new Material("Air rune",25000), new Material("Captured wind mote",1), new Material("Swift albatross feather",5))));

        // Trawling net
        OPTIONS.add(new UpgradeOption("Trawling Net", -1, 0, 56, 45, "Rope trawling net",
                Arrays.asList(new Material("Rope",7), new Material("Teak plank",4), new Material("Steel bar",4), new Material("Lead bar",2))));
        OPTIONS.add(new UpgradeOption("Trawling Net", 1, 1, 68, 53, "Linen trawling net",
                Arrays.asList(new Material("Linen yarn",6), new Material("Mahogany plank",4), new Material("Rope",1), new Material("Mithril bar",4), new Material("Lead bar",2))));
        OPTIONS.add(new UpgradeOption("Trawling Net", 2, 1, 68, 61, "Linen trawling net",
                Arrays.asList(new Material("Linen yarn",6), new Material("Mahogany plank",4), new Material("Rope",1), new Material("Mithril bar",4), new Material("Lead bar",2))));
        OPTIONS.add(new UpgradeOption("Trawling Net", 1, 2, 79, 73, "Hemp trawling net",
                Arrays.asList(new Material("Hemp yarn",6), new Material("Camphor plank",4), new Material("Rope",1), new Material("Adamantite bar",4), new Material("Cupronickel bar",2), new Material("Ray barbs",4))));
        OPTIONS.add(new UpgradeOption("Trawling Net", 2, 2, 79, 65, "Hemp trawling net",
                Arrays.asList(new Material("Hemp yarn",6), new Material("Camphor plank",4), new Material("Rope",1), new Material("Adamantite bar",4), new Material("Cupronickel bar",2), new Material("Ray barbs",4))));
        OPTIONS.add(new UpgradeOption("Trawling Net", -1, 3, 84, 73, "Cotton trawling net",
                Arrays.asList(new Material("Cotton yarn",6), new Material("Ironwood plank",4), new Material("Rope",1), new Material("Runite bar",4), new Material("Cupronickel bar",2), new Material("Ray barbs",8))));

        // Chum station/spreader
        OPTIONS.add(new UpgradeOption("Chum Station", -1, 0, 56, 45, "Chum station",
                Arrays.asList(new Material("Mahogany plank",10), new Material("Mithril nails",40), new Material("Steel bar",2), new Material("Fishing bait",1000), new Material("Knife",1))));
        OPTIONS.add(new UpgradeOption("Chum Station", -1, 1, 68, 61, "Advanced chum station",
                Arrays.asList(new Material("Camphor plank",10), new Material("Adamantite nails",40), new Material("Steel bar",2), new Material("Fishing bait",1000), new Material("Knife",1))));
        OPTIONS.add(new UpgradeOption("Chum Station", -1, 2, 82, 74, "Chum spreader",
                Arrays.asList(new Material("Ironwood plank",10), new Material("Rune nails",40), new Material("Cupronickel bar",5), new Material("Fishing bait",10000), new Material("Narwhal horn knife",1))));

        // Fathom stone/pearl
        OPTIONS.add(new UpgradeOption("Fathom Device", -1, 0, 70, 62, "Fathom stone",
                Arrays.asList(new Material("Camphor plank",10), new Material("Adamantite nails",40), new Material("Molten glass",4), new Material("Cupronickel bar",2))));
        OPTIONS.add(new UpgradeOption("Fathom Device", -1, 1, 91, 83, "Fathom pearl",
                Arrays.asList(new Material("Rosewood plank",10), new Material("Dragon nails",40), new Material("Dragon metal sheet",2), new Material("Echo pearl",1))));

        // Misc
        OPTIONS.add(new UpgradeOption("Range", -1, 0, 16, 6, "Range",
                Arrays.asList(new Material("Steel bar",4), new Material("Charcoal",2), new Material("Tinderbox",1))));
        OPTIONS.add(new UpgradeOption("Keg", -1, 0, 33, 25, "Keg",
                Arrays.asList(new Material("Oak plank",5), new Material("Iron nails",20), new Material("Barrel stand",1))));
        OPTIONS.add(new UpgradeOption("Anchor", -1, 0, 37, 29, "Anchor",
                Arrays.asList(new Material("Steel bar",8), new Material("Lead bar",6), new Material("Rope",1))));
        OPTIONS.add(new UpgradeOption("Inoculation Station", -1, 0, 40, 37, "Inoculation station",
                Arrays.asList(new Material("Teak plank",8), new Material("Steel nails",32), new Material("Relicym's balm(4)",6))));
        OPTIONS.add(new UpgradeOption("Salvaging Station", -1, 0, 42, 34, "Salvaging station",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel nails",16))));
        OPTIONS.add(new UpgradeOption("Crystal Extractor", -1, 0, 73, 67, "Crystal extractor",
                Arrays.asList(new Material("Ironwood plank",6), new Material("Cupronickel bar",5), new Material("Magic stone",2), new Material("Heart of ithell",1))));
        OPTIONS.add(new UpgradeOption("Eternal Brazier", -1, 0, 78, 72, "Eternal brazier",
                Arrays.asList(new Material("Ironwood plank",4), new Material("Rune nails",16), new Material("Runite bar",6), new Material("Cupronickel bar",6), new Material("Te salt",250), new Material("Efh salt",250), new Material("Urt salt",250))));
    }

    public static List<UpgradeOption> getAvailableOptions(
            int boatType,
            Map<String, Integer> currentTiers,
            int playerSailingLevel,
            int playerConstructionLevel,
            BoatUpgradesConfig config
    )
    {
        List<UpgradeOption> out = new ArrayList<>();

        boolean isRaft = boatType == 0;
        boolean filterConstruction = config.filterConstructionRequirement();

        for (UpgradeOption o : OPTIONS)
        {
            if (o.boatType != -1 && o.boatType != boatType)
            {
                continue;
            }

            if (isRaft && RAFT_EXCLUDED_FACILITIES.contains(o.partName))
            {
                continue;
            }

            Integer cur = currentTiers.get(o.partName);
            int curTier = cur == null ? -1 : cur;

            if (o.targetTier <= curTier)
            {
                continue;
            }

            if (playerSailingLevel < o.requiredSailingLevel)
            {
                continue;
            }

            if (filterConstruction && playerConstructionLevel < o.requiredConstructionLevel)
            {
                continue;
            }

            out.add(o);
        }

        out.sort(Comparator.comparingInt(o -> o.requiredSailingLevel));
        return out;
    }
}
package com.boatupgrades;

import com.google.inject.Provides;
import javax.inject.Inject;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.events.CommandExecuted;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.gameval.VarbitID;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.EventBus;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.ClientToolbar;
import net.runelite.client.ui.NavigationButton;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.util.ImageUtil;

import java.awt.*;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;
import java.awt.image.BufferedImage;

@Slf4j
@PluginDescriptor(
	name = "Boat Upgrades",
	description = "Display currently available upgrades for your boat when you board or enter the shipyard",
	tags = {"sailing", "ship", "facility", "pimp my ride"}
)
public class BoatUpgradesPlugin extends Plugin
{
	@Inject
	private Client client;
	@Inject
	private BoatUpgradesConfig config;
	private BoatUpgradesOverlay boatUpgradesOverlay;
	@Inject
	private OverlayManager overlayManager;
	@Inject
	private ChangelogService changelogService;
	@Inject
	private ClientThread clientThread;
	@Inject
	private EventBus eventBus;
	@Inject
	private FacilityService facilityService;
	@Inject
	private ClientToolbar clientToolbar;
	private BoatUpgradesPanel panel;
	private NavigationButton navButton;

	private long lastAccountHash = -1;

	@Override
	protected void startUp() throws Exception
	{
		// Inject after startup so that the BoatUpgradesPanel dependency is created
		// after default SwingUI styling is applied
		if (boatUpgradesOverlay == null) boatUpgradesOverlay = injector.getInstance(BoatUpgradesOverlay.class);
		overlayManager.add(boatUpgradesOverlay);
		facilityService.start();
		log.info("Boat Upgrades started");

		panel = injector.getInstance(BoatUpgradesPanel.class);
		final BufferedImage icon = ImageUtil.loadImageResource(getClass(), "icon.png");


		navButton = NavigationButton.builder()
				.tooltip("Boat Upgrades")
				.icon(icon)
				.panel(panel)
				.priority(config.panelPosition())
				.build();

		clientToolbar.addNavigation(navButton);
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(boatUpgradesOverlay);
		facilityService.stop();
		log.info("Boat Upgrades stopped");

		if (navButton != null)
		{
			clientToolbar.removeNavigation(navButton);
		}
	}

	@Subscribe
	public void onCommandExecuted(CommandExecuted event)
	{
		if (event.getCommand().equalsIgnoreCase("boatvars"))
		{
			int[] values = new int[]
			{
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT0),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT1),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT2),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT3),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT4),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT5),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT6),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT7),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT8),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT9),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT10)
			};

			StringBuilder sb = new StringBuilder();
			sb.append("Hotspot Varbits:");
			for (int i = 0; i < values.length; i++)
			{
				sb.append(System.lineSeparator()).append("Hotspot ").append(i).append(": ").append(values[i]);
			}

			final String output = sb.toString();

			try
			{
				StringSelection selection = new StringSelection(output);
				Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();
				clipboard.setContents(selection, selection);

				client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Hotspot varbits copied to clipboard!", null);
				log.info("Hotspot varbits copied to clipboard!");
				log.info("Hotspot varbits:\n{}", output);
			}
			catch (Throwable ex)
			{
				log.warn("Failed to copy hotspot varbits to clipboard", ex);
			}
		}
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (!"boatupgrades".equals(event.getGroup()))
		{
			return;
		}

		if ("persistMinutes".equals(event.getKey()))
		{
			boatUpgradesOverlay.refreshCacheExpiry();
		}
		if ("filterSchematicRequirement".equals(event.getKey()) || "filterConstructionRequirement".equals(event.getKey()))
		{
			clientThread.invokeLater(() ->
			{
				panel.onAvailableUpgradesChanged();
			});
		}
		if (event.getKey().equals("panelPosition"))
		{
			panel = injector.getInstance(BoatUpgradesPanel.class);
			final BufferedImage icon = ImageUtil.loadImageResource(getClass(), "icon.png");

				clientToolbar.removeNavigation(navButton);

				navButton = NavigationButton.builder()
						.tooltip("Boat Upgrades")
						.icon(icon)
						.panel(panel)
						.priority(config.panelPosition())
						.build();

				clientToolbar.addNavigation(navButton);
		}
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged event)
	{
		GameState state = event.getGameState();

		if (state == GameState.LOGGED_IN && client.getAccountHash() != lastAccountHash)
		{
			clientThread.invokeLater(() ->
			{
				lastAccountHash = client.getAccountHash();
				changelogService.showChangelogIfNeeded();
			});
		}
	}

	@Provides
	BoatUpgradesConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(BoatUpgradesConfig.class);
	}
}
package com.boatupgrades;

import com.boatupgrades.utils.SchematicUtils;
import com.boatupgrades.utils.UpgradeVisibilityUtils;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.Skill;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.LineComponent;
import net.runelite.client.ui.overlay.components.PanelComponent;
import net.runelite.client.ui.overlay.components.TitleComponent;

import javax.inject.Inject;
import java.awt.*;
import java.util.*;
import java.util.List;
import java.util.stream.Collectors;

import static net.runelite.api.gameval.VarbitID.SAILING_BOARDED_BOAT;
import static net.runelite.api.gameval.VarbitID.SAILING_BOARDED_BOAT_TYPE;
import static net.runelite.api.gameval.VarbitID.SAILING_PREVIOUS_BOAT_TYPE_ID;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_SAIL;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_HELM;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_KEEL;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_HULL;
import static net.runelite.api.gameval.VarClientID.SAILING_SIDEPANEL_CAPTAIN_NAME;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_SHIPYARD_MODE;

@Slf4j
public class BoatUpgradesOverlay extends Overlay
{
    private final Client client;
    private final BoatUpgradesConfig config;
    private final FacilityService facilityService;
    private BoatUpgradesPanel panel;
    private final AvailableUpgradesService availableUpgradesService;
    @Inject
    private UpgradeVisibilityUtils upgradeVisibilityUtils;
    @Inject
    private SchematicUtils schematicUtils;

    private final PanelComponent panelComponent = new PanelComponent();
    private List<UpgradeData.UpgradeOption> cachedAvailable = new ArrayList<>();
    private long cacheExpiryMillis = 0L;
    private boolean prevActive = false;
    private String lastCaptainName = "";
    private int lastBoatTypeRaw = -1;
    int constructionLevel;
    private String lastRenderSignature = "";
    private boolean lastActiveWasShipyard = false;



    @Inject
    public BoatUpgradesOverlay(Client client, BoatUpgradesConfig config, FacilityService facilityService, BoatUpgradesPanel panel, AvailableUpgradesService availableUpgradesService)
    {
        this.client = client;
        this.config = config;
        this.facilityService = facilityService;
        this.panel = panel;
        this.availableUpgradesService = availableUpgradesService;
        setPosition(OverlayPosition.TOP_LEFT);
        //setLayer(OverlayLayer.ABOVE_WIDGETS);
    }

    @Override
    public Dimension render(Graphics2D graphics)
    {
        panelComponent.getChildren().clear();

        final long now = System.currentTimeMillis();

        int boarded = client.getVarbitValue(SAILING_BOARDED_BOAT);
        int shipyardMode = client.getVarbitValue(SAILING_SIDEPANEL_SHIPYARD_MODE);

        boolean isBoarded = boarded != 0;
        boolean isInShipyard = shipyardMode != 0;

        boolean isActive = isBoarded || isInShipyard;

        String captain = client.getVarcStrValue(SAILING_SIDEPANEL_CAPTAIN_NAME).replace('\u00A0', ' ').trim();

        String localName = client.getLocalPlayer().getName();

        boolean userIsCaptain = localName != null && localName.equalsIgnoreCase(captain);
        if (isActive && !userIsCaptain)
        {
            prevActive = true;
            return panelComponent.render(graphics);
        }

        if (isActive)
        {
            int boatTypeRaw;
            if (isBoarded)
            {
                boatTypeRaw = client.getVarbitValue(SAILING_BOARDED_BOAT_TYPE);
            }
            else
            {
                boatTypeRaw = client.getVarbitValue(SAILING_PREVIOUS_BOAT_TYPE_ID);
            }

            int sailingLevel = client.getBoostedSkillLevel(Skill.SAILING);
            constructionLevel = client.getBoostedSkillLevel(Skill.CONSTRUCTION);

            int sailTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_SAIL);
            int helmTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_HELM);
            int keelTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_KEEL);
            int hullTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_HULL);

            java.util.Map<String, Integer> currentTiers = new java.util.HashMap<>();

            currentTiers.put("Sails", sailTier);
            currentTiers.put("Helm", helmTier);
            currentTiers.put("Keel", keelTier);
            currentTiers.put("Hull", hullTier);
            currentTiers.put("Base", hullTier);

            currentTiers.putAll(facilityService.getAllHighestTiers());

            List<UpgradeData.UpgradeOption> liveAvailable =
                    UpgradeData.getAvailableOptions(
                            boatTypeRaw,
                            currentTiers,
                            sailingLevel,
                            constructionLevel,
                            config
                    );

            List<UpgradeData.UpgradeOption> toDisplayLive = upgradeVisibilityUtils.getVisibleUpgrades(liveAvailable);

            checkRequirementSignatureChanged(toDisplayLive);

            boolean facilitiesReady = facilityService.hasDetectedAllFacilities();

            if (!facilitiesReady)
            {
                return null;
            }

            boolean changed = availableUpgradesService.updateIfChanged(toDisplayLive);

            if (changed && panel != null)
            {
                log.debug("[Overlay] Notifying panel of upgrade change");
                panel.onAvailableUpgradesChanged();
            }
            else if (panel == null)
            {
                log.warn("[Overlay] Panel is NULL  cannot notify");
            }

            if (!liveAvailable.isEmpty())
            {
                cachedAvailable = new ArrayList<>(liveAvailable);
                cacheExpiryMillis = Long.MAX_VALUE;
                lastCaptainName = captain;
                lastBoatTypeRaw = boatTypeRaw;
                if (isInShipyard)
                {
                    lastActiveWasShipyard = true;
                }
                else
                {
                    lastActiveWasShipyard = false;
                }
            }
            else
            {
                cachedAvailable.clear();
                cacheExpiryMillis = 0L;
                lastCaptainName = "";
                lastBoatTypeRaw = -1;
                lastActiveWasShipyard = false;
            }

            prevActive = true;

            if (liveAvailable.isEmpty())
            {
                return null;
            }
            if (toDisplayLive.isEmpty())
            {
                return null;
            }

            if (!config.displayOverlay())
            {
                return null;
            }

            if (config.overlayOnlyInShipyard() && !isInShipyard)
            {
                return null;
            }

            renderHeaderAndOptions(graphics, toDisplayLive);

            return panelComponent.render(graphics);
        }
        else
        {
            if (prevActive)
            {
                if (!cachedAvailable.isEmpty())
                {
                    int minutes = Math.max(0, config.persistMinutes());
                    cacheExpiryMillis = now + (minutes * 60L * 1000L);
                    facilityService.resetAllDetectedTiers();
                }
                else
                {
                    cacheExpiryMillis = 0L;
                }
            }

            prevActive = false;

            List<UpgradeData.UpgradeOption> toDisplayCached = upgradeVisibilityUtils.getVisibleUpgrades(cachedAvailable);

            checkRequirementSignatureChanged(toDisplayCached);

            boolean changed = availableUpgradesService.updateIfChanged(toDisplayCached);

            if (changed && panel != null)
            {
                log.debug("[Overlay] Notifying panel of upgrade change");
                panel.onAvailableUpgradesChanged();
            }
            else if (panel == null)
            {
                log.warn("[Overlay] Panel is NULL  cannot notify");
            }
            facilityService.detectedFacilitiesComplete = false;

            if (!cachedAvailable.isEmpty() && now <= cacheExpiryMillis)
            {
                String showCaptain = lastCaptainName == null ? "" : lastCaptainName;

                if (showCaptain.isEmpty() || localName.isEmpty() || !localName.equalsIgnoreCase(showCaptain))
                {
                    return panelComponent.render(graphics);
                }

                if (!config.displayOverlay())
                {
                    return null;
                }

                if (config.overlayOnlyInShipyard() && !lastActiveWasShipyard)
                {
                    return null;
                }

                if (toDisplayCached.isEmpty())
                {
                    return null;
                }

                renderHeaderAndOptions(graphics, toDisplayCached);
                return panelComponent.render(graphics);
            }

            return panelComponent.render(graphics);
        }
    }

    private void renderHeaderAndOptions(Graphics2D graphics, List<UpgradeData.UpgradeOption> options)
    {
        panelComponent.getChildren().add(
                TitleComponent.builder().text("Boat Upgrades").build()
        );

        panelComponent.getChildren().add(
                LineComponent.builder().left("Current available upgrades:").build()
        );

        for (UpgradeData.UpgradeOption opt : options)
        {
            boolean hasSchematic = schematicUtils.hasSchematic(opt.displayName);
            boolean meetsConstruction = upgradeVisibilityUtils.meetsConstructionRequirement(opt);

            panelComponent.getChildren().add(
                    LineComponent.builder()
                            .left(" ")
                            .build()
            );

            panelComponent.getChildren().add(
                    LineComponent.builder()
                            .left(opt.displayName + ":")
                            .build()
            );

            String mats = opt.materials.stream()
                    .map(Object::toString)
                    .collect(Collectors.joining(", "));

            panelComponent.getChildren().add(
                    LineComponent.builder().left(mats).build()
            );

            if (!hasSchematic && !config.filterSchematicRequirement())
            {
                panelComponent.getChildren().add(
                        LineComponent.builder()
                                .left("(Requires schematic)")
                                .leftColor(Color.YELLOW)
                                .build()
                );
            }

            if (!meetsConstruction && !config.filterConstructionRequirement())
            {
                panelComponent.getChildren().add(
                        LineComponent.builder()
                                .left("(Requires " + opt.requiredConstructionLevel + " Con)")
                                .leftColor(Color.YELLOW)
                                .build()
                );
            }
        }
    }

    public void refreshCacheExpiry()
    {
        if (cachedAvailable == null || cachedAvailable.isEmpty())
        {
            return;
        }

        if (cacheExpiryMillis == Long.MAX_VALUE)
        {
            return;
        }

        long now = System.currentTimeMillis();
        int minutes = Math.max(0, config.persistMinutes());
        cacheExpiryMillis = now + (minutes * 60L * 1000L);
    }
    private String computeRequirementSignature(List<UpgradeData.UpgradeOption> options)
    {
        List<String> sig = new ArrayList<>();

        for (UpgradeData.UpgradeOption opt : options)
        {
            sig.add(opt.displayName);

            boolean hasSchematic = schematicUtils.hasSchematic(opt.displayName);
            boolean meetsConstruction = upgradeVisibilityUtils.meetsConstructionRequirement(opt);

            if (!hasSchematic && !config.filterSchematicRequirement())
            {
                sig.add("REQ_SCHEMATIC");
            }

            if (!meetsConstruction && !config.filterConstructionRequirement())
            {
                sig.add("REQ_CON");
            }
        }

        return String.join("|", sig);
    }

    private void checkRequirementSignatureChanged(List<UpgradeData.UpgradeOption> options)
    {
        String newSignature = computeRequirementSignature(options);

        if (!newSignature.equals(lastRenderSignature))
        {
            lastRenderSignature = newSignature;

            if (panel != null)
            {
                panel.onAvailableUpgradesChanged();
            }
        }
    }

}
package com.boatupgrades;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;

@ConfigGroup("boatupgrades")
public interface BoatUpgradesConfig extends Config
{

	@ConfigSection(
			name = "Text overlay",
			description = "Toggle for text overlay visibility",
			position = 100
	)
	String overlaySection = "overlaySection";

	@ConfigSection(
			name = "Side panel",
			description = "Side panel position",
			position = 200
	)
	String sidePanelSection = "sidePanelSection";

	@ConfigSection(
			name = "Core boat parts",
			description = "Toggle which core boat parts are shown in the overlay",
			position = 300
	)
	String coreBoatPartsSection = "coreBoatPartsSection";

	@ConfigSection(
			name = "Boat facilities",
			description = "Toggle which boat facilities are shown in the overlay",
			position = 400
	)
	String facilitiesSection = "facilitiesSection";

	@ConfigItem(
			keyName = "displayOverlay",
			name = "Display overlay",
			description = "Enable to display the overlay when boarding your boat or entering shipyard - disable to hide it",
			section = overlaySection
	)
	default boolean displayOverlay()
	{
		return true;
	}
	@ConfigItem(
			keyName = "filterConstructionRequirement",
			name = "Filter construction requirement",
			description = "Enable to hide upgrades that you don't meet the construction level for",
			section = overlaySection
	)
	default boolean filterConstructionRequirement()
	{
		return false;
	}

	@ConfigItem(
			keyName = "filterSchematicRequirement",
			name = "Filter schematic requirement",
			description = "Enable to hide upgrades that you haven't discovered the schematic for",
			section = overlaySection
	)
	default boolean filterSchematicRequirement()
	{
		return false;
	}

	@ConfigItem(
			keyName = "hideLowerTiers",
			name = "Hide lower tiers",
			description = "Hide lower tier upgrades from the overlay when a higher tier upgrade is available for the same boat part or facility",
			section = overlaySection
	)
	default boolean hideLowerTiers()
	{
		return false;
	}

	@ConfigItem(
			keyName = "persistMinutes",
			name = "Persist overlay",
			description = "Number of minutes the overlay persists after disembarking your boat/leaving shipyard (0 will hide it immediately)",
			section = overlaySection
	)
	default int persistMinutes()
	{
		return 10;
	}

	@ConfigItem(
			keyName = "overlayOnlyInShipyard",
			name = "Show only in shipyard",
			description = "Show the text overlay only when you are in the shipyard",
			section = overlaySection
	)
	default boolean overlayOnlyInShipyard()
	{
		return false;
	}

	@ConfigItem(
			keyName = "panelPosition",
			name = "Side panel position",
			description = "Specify where the Boat Upgrades panel appears in the sidebar (lower = higher up)",
			section = sidePanelSection
	)
	default int panelPosition()
	{
		return 5;
	}

	@ConfigItem(
			keyName = "showBaseHull",
			name = "Base/Hull",
			description = "Show base/hull upgrades",
			section = coreBoatPartsSection
	)
	default boolean showBaseHull() { return true; }

	@ConfigItem(
			keyName = "showHelm",
			name = "Helm",
			description = "Show helm upgrades",
			section = coreBoatPartsSection
	)
	default boolean showHelm() { return true; }

	@ConfigItem(
			keyName = "showSails",
			name = "Sails",
			description = "Show sails upgrades",
			section = coreBoatPartsSection
	)
	default boolean showSails() { return true; }

	@ConfigItem(
			keyName = "showKeel",
			name = "Keel",
			description = "Show keel upgrades",
			section = coreBoatPartsSection
	)
	default boolean showKeel() { return true; }

	@ConfigItem(
			keyName = "showSalvagingHook",
			name = "Salvaging hook",
			description = "Show Salvaging Hook upgrades",
			section = facilitiesSection
	)
	default boolean showSalvagingHook() { return false; }

	@ConfigItem(
			keyName = "showCargoHold",
			name = "Cargo hold",
			description = "Show Cargo hold upgrades",
			section = facilitiesSection
	)
	default boolean showCargoHold() { return false; }

	@ConfigItem(
			keyName = "showCannon",
			name = "Cannon",
			description = "Show Cannon upgrades",
			section = facilitiesSection
	)
	default boolean showCannon() { return false; }

	@ConfigItem(
			keyName = "showTeleportFocus",
			name = "Teleport focus",
			description = "Show Teleport focus upgrades",
			section = facilitiesSection
	)
	default boolean showTeleportFocus() { return false; }

	@ConfigItem(
			keyName = "showWindDevice",
			name = "Wind/Gale catcher",
			description = "Show Wind/Gale catcher upgrades",
			section = facilitiesSection
	)
	default boolean showWindDevice() { return false; }

	@ConfigItem(
			keyName = "showTrawlingNet",
			name = "Trawling net",
			description = "Show Trawling net upgrades",
			section = facilitiesSection
	)
	default boolean showTrawlingNet() { return false; }

	@ConfigItem(
			keyName = "showChumStation",
			name = "Chum station",
			description = "Show Chum station upgrades",
			section = facilitiesSection
	)
	default boolean showChumStation() { return false; }

	@ConfigItem(
			keyName = "showFathomDevice",
			name = "Fathom stone/pearl",
			description = "Show Fathom stone/pearl upgrades",
			section = facilitiesSection
	)
	default boolean showFathomDevice() { return false; }

	@ConfigItem(
			keyName = "showRange",
			name = "Range",
			description = "Show Range upgrades",
			section = facilitiesSection
	)
	default boolean showRange() { return false; }

	@ConfigItem(
			keyName = "showKeg",
			name = "Keg",
			description = "Show Keg upgrades",
			section = facilitiesSection
	)
	default boolean showKeg() { return false; }

	@ConfigItem(
			keyName = "showAnchor",
			name = "Anchor",
			description = "Show Anchor upgrades",
			section = facilitiesSection
	)
	default boolean showAnchor() { return false; }

	@ConfigItem(
			keyName = "showInoculationStation",
			name = "Inoculation station",
			description = "Show Inoculation station upgrades",
			section = facilitiesSection
	)
	default boolean showInoculationStation() { return false; }

	@ConfigItem(
			keyName = "showSalvagingStation",
			name = "Salvaging station",
			description = "Show Salvaging station upgrades",
			section = facilitiesSection
	)
	default boolean showSalvagingStation() { return false; }

	@ConfigItem(
			keyName = "showCrystalExtractor",
			name = "Crystal extractor",
			description = "Show Crystal extractor upgrades",
			section = facilitiesSection
	)
	default boolean showCrystalExtractor() { return false; }

	@ConfigItem(
			keyName = "showEternalBrazier",
			name = "Eternal brazier",
			description = "Show Eternal brazier upgrades",
			section = facilitiesSection
	)
	default boolean showEternalBrazier() { return false; }

	@ConfigItem(
			keyName = "comingSoon",
			name = "Schematic checks under development",
			description = "Schematic checks for text overlay under development",
			//position = 400,
			hidden = true
	)
	default boolean comingSoonNotice()
	{
		return true;
	}
	@ConfigItem(
			keyName = "lastSeenChangelogVersion",
			name = "lastSeenChangelogVersion",
			description = "",
			hidden = true
			//position = 800
	)
	default String lastSeenChangelogVersion()
	{
		return "";
	}

	@ConfigItem(
			keyName = "lastSeenChangelogVersion",
			name = "",
			description = "",
			hidden = true
	)
	void setLastSeenChangelogVersion(String value);
}
package com.boatupgrades;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class BoatUpgradesPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(BoatUpgradesPlugin.class);
		RuneLite.main(args);
	}
}
