package com.boatupgrades;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;

import javax.inject.Inject;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.*;

@Slf4j
public class ChangelogService
{
    private final Client client;
    @Inject
    private BoatUpgradesConfig config;

    @Inject
    public ChangelogService(Client client, BoatUpgradesConfig config)
    {
        this.client = client;
        this.config = config;
    }

    private static final String PLUGIN_VERSION = "1.0.0";
    private static final String CHANGELOG_RESOURCE = "/changelog.md";
    private boolean changelogShownThisSession = false;
    public void showChangelogIfNeeded()
    {
        if (changelogShownThisSession)
        {
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        String lastSeen = config.lastSeenChangelogVersion();

        if (lastSeen.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        if (PLUGIN_VERSION.equals(lastSeen))
        {
            changelogShownThisSession = true;
            return;
        }

        Map<String, List<String>> changelog = loadChangelogFromResource();
        if (changelog.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        List<String> toShowVersions = new ArrayList<>();
        for (String version : changelog.keySet())
        {
            if (version.equals(lastSeen))
            {
                break;
            }
            toShowVersions.add(version);
        }

        if (toShowVersions.isEmpty())
        {
            changelogShownThisSession = true;
            config.setLastSeenChangelogVersion(PLUGIN_VERSION);
            return;
        }

        client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "<col=0051c9>Boat Upgrades Updated", null);
        for (String version : toShowVersions)
        {
            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "<col=0051c9>v" + version + ":", null);
            List<String> lines = changelog.get(version);
            for (String line : lines)
            {
                client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "  <col=0051c9>" + line, null);
            }
        }

        changelogShownThisSession = true;
        config.setLastSeenChangelogVersion(PLUGIN_VERSION);
    }

    public Map<String, List<String>> loadChangelogFromResource()
    {
        Map<String, List<String>> out = new LinkedHashMap<>();
        try (InputStream is = getClass().getResourceAsStream(CHANGELOG_RESOURCE))
        {
            if (is == null)
            {
                log.debug("Changelog resource not found at {}", CHANGELOG_RESOURCE);
                return Collections.emptyMap();
            }

            BufferedReader r = new BufferedReader(new InputStreamReader(is, StandardCharsets.UTF_8));
            String line;
            String currentVersion = null;
            List<String> currentLines = null;

            while ((line = r.readLine()) != null)
            {
                line = line.trim();
                if (line.startsWith("## "))
                {
                    if (currentVersion != null && currentLines != null)
                    {
                        out.put(currentVersion, currentLines);
                    }
                    currentVersion = line.substring(3).trim();
                    currentLines = new ArrayList<>();
                }
                else
                {
                    if (currentVersion != null)
                    {
                        if (!line.isEmpty())
                        {
                            currentLines.add(line);
                        }
                    }
                }
            }

            if (currentVersion != null && currentLines != null)
            {
                out.put(currentVersion, currentLines);
            }
        }
        catch (IOException ex)
        {
            log.warn("Failed to read changelog resource", ex);
            return Collections.emptyMap();
        }

        return out;
    }
}
package com.boatupgrades;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

public final class UpgradeData
{
    private UpgradeData() {}

    public static final class Material
    {
        public final String name;
        public final int qty;

        public Material(String name, int qty)
        {
            this.name = name;
            this.qty = qty;
        }

        @Override
        public String toString()
        {
            return qty + " x " + name;
        }
    }

    public static final class UpgradeOption
    {
        public final String partName;       // "Base", "Hull", "Helm", "Sails", "Keel"
        public final int boatType;         // 0 - raft, 1 - skiff, 2 - sloop
        public final int targetTier;       // Tier varbit value
        public final int requiredLevel;    // Sailing level required
        public final String displayName;   // Display name of boat part/facility
        public final List<Material> materials;

        public UpgradeOption(String partName, int boatType, int targetTier, int requiredLevel, String displayName, List<Material> materials)
        {
            this.partName = partName;
            this.boatType = boatType;
            this.targetTier = targetTier;
            this.requiredLevel = requiredLevel;
            this.displayName = displayName;
            this.materials = materials == null ? Collections.emptyList() : materials;
        }
    }

    private static final List<UpgradeOption> OPTIONS = new ArrayList<>();

    static
    {
        // Wooden base/hull (tier 0)
        OPTIONS.add(new UpgradeOption("Base", 0, 0, 1, "Wooden base (raft)",
                Arrays.asList(new Material("Logs",10), new Material("Rope",6), new Material("Swamp tar",10))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 0, 1, "Wooden hull (skiff)",
                Arrays.asList(new Material("Wooden hull parts",10), new Material("Bronze nails",300), new Material("Swamp tar",20))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 0, 1, "Wooden hull (sloop)",
                Arrays.asList(new Material("Large wooden hull parts",16), new Material("Bronze nails",600), new Material("Swamp tar",25))));

        // Bronze helm (tier 0)
        OPTIONS.add(new UpgradeOption("Helm", 0, 0, 1, "Bronze helm (raft)",
                Arrays.asList(new Material("Plank",2), new Material("Bronze bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 0, 1, "Bronze helm (skiff)",
                Arrays.asList(new Material("Plank",3), new Material("Bronze bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 0, 1, "Bronze helm (sloop)",
                Arrays.asList(new Material("Plank",4), new Material("Bronze bar",8))));

        // Wooden sails (tier 0)
        OPTIONS.add(new UpgradeOption("Sails", 0, 0, 1, "Wooden mast & linen sails (raft)",
                Arrays.asList(new Material("Logs",5), new Material("Bronze nails",20), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 0, 1, "Wooden mast & linen sails (skiff)",
                Arrays.asList(new Material("Logs",10), new Material("Bronze nails",40), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 0, 1, "Wooden mast & linen sails (sloop)",
                Arrays.asList(new Material("Logs",15), new Material("Bronze nails",60), new Material("Bolt of linen",10))));

        // Bronze keel (tier 0)
        OPTIONS.add(new UpgradeOption("Keel", 1, 0, 1, "Bronze keel (skiff)",
                Arrays.asList(new Material("Bronze keel parts",10))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 0, 1, "Bronze keel (sloop)",
                Arrays.asList(new Material("Large bronze keel parts",16))));

        // Iron helm (tier 1)
        OPTIONS.add(new UpgradeOption("Helm", 0, 1, 17, "Iron helm (raft)",
                Arrays.asList(new Material("Oak plank",2), new Material("Iron bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 1, 17, "Iron helm (skiff)",
                Arrays.asList(new Material("Oak plank",3), new Material("Iron bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 1, 17, "Iron helm (sloop)",
                Arrays.asList(new Material("Oak plank",4), new Material("Iron bar",8))));

        // Oak base/hull (tier 1)
        OPTIONS.add(new UpgradeOption("Base", 0, 1, 20, "Oak base (raft)",
                Arrays.asList(new Material("Oak logs",10), new Material("Rope",6), new Material("Swamp tar",10))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 1, 20, "Oak hull (skiff)",
                Arrays.asList(new Material("Oak hull parts",10), new Material("Iron nails",300), new Material("Swamp tar",20))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 1, 20, "Oak hull (sloop)",
                Arrays.asList(new Material("Large oak hull parts",16), new Material("Iron nails",600), new Material("Swamp tar",25))));

        // Iron keel (tier 1)
        OPTIONS.add(new UpgradeOption("Keel", 1, 1, 22, "Iron keel (skiff)",
                Arrays.asList(new Material("Iron keel parts",10))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 1, 22, "Iron keel (sloop)",
                Arrays.asList(new Material("Large iron keel parts",16))));

        // Oak sails (tier 1)
        OPTIONS.add(new UpgradeOption("Sails", 0, 1, 24, "Oak mast & linen sails (raft)",
                Arrays.asList(new Material("Oak logs",5), new Material("Iron nails",20), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 1, 24, "Oak mast & linen sails (skiff)",
                Arrays.asList(new Material("Oak logs",10), new Material("Iron nails",40), new Material("Bolt of linen",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 1, 24, "Oak mast & linen sails (sloop)",
                Arrays.asList(new Material("Oak logs",15), new Material("Iron nails",60), new Material("Bolt of linen",10))));

        // Teak base/hull (tier 2)
        OPTIONS.add(new UpgradeOption("Base", 0, 2, 31, "Teak base (raft)",
                Arrays.asList(new Material("Teak logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 2, 31, "Teak hull (skiff)",
                Arrays.asList(new Material("Teak hull parts",10), new Material("Steel nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 2, 31, "Teak hull (sloop)",
                Arrays.asList(new Material("Large teak hull parts",16), new Material("Steel nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Teak sails (tier 2)
        OPTIONS.add(new UpgradeOption("Sails", 0, 2, 36, "Teak mast & canvas sails (raft)",
                Arrays.asList(new Material("Teak logs",5), new Material("Steel nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 2, 36, "Teak mast & canvas sails (skiff)",
                Arrays.asList(new Material("Teak logs",10), new Material("Steel nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 2, 36, "Teak mast & canvas sails (sloop)",
                Arrays.asList(new Material("Teak logs",15), new Material("Steel nails",60), new Material("Bolt of canvas",10))));

        // Steel helm (tier 2)
        OPTIONS.add(new UpgradeOption("Helm", 0, 2, 38, "Steel helm (raft)",
                Arrays.asList(new Material("Teak plank",2), new Material("Steel bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 2, 38, "Steel helm (skiff)",
                Arrays.asList(new Material("Teak plank",3), new Material("Steel bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 2, 38, "Steel helm (sloop)",
                Arrays.asList(new Material("Teak plank",4), new Material("Steel bar",8))));

        // Steel keel (tier 2)
        OPTIONS.add(new UpgradeOption("Keel", 1, 2, 39, "Steel keel (skiff)",
                Arrays.asList(new Material("Steel keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 2, 39, "Steel keel (sloop)",
                Arrays.asList(new Material("Large steel keel parts",16), new Material("Lead bar",5))));

        // Mahogany base/hull (tier 3)
        OPTIONS.add(new UpgradeOption("Base", 0, 3, 48, "Mahogany base (raft)",
                Arrays.asList(new Material("Mahogany logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 3, 48, "Mahogany hull (skiff)",
                Arrays.asList(new Material("Mahogany hull parts",10), new Material("Mithril nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 3, 48, "Mahogany hull (sloop)",
                Arrays.asList(new Material("Large mahogany hull parts",16), new Material("Mithril nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Mahogany sails (tier 3)
        OPTIONS.add(new UpgradeOption("Sails", 0, 3, 52, "Mahogany mast & canvas sails (raft)",
                Arrays.asList(new Material("Mahogany logs",5), new Material("Mithril nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 3, 52, "Mahogany mast & canvas sails (skiff)",
                Arrays.asList(new Material("Mahogany logs",10), new Material("Mithril nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 3, 52, "Mahogany mast & canvas sails (sloop)",
                Arrays.asList(new Material("Mahogany logs",15), new Material("Mithril nails",60), new Material("Bolt of canvas",10))));

        // Mithril keel (tier 3)
        OPTIONS.add(new UpgradeOption("Keel", 1, 3, 54, "Mithril keel (skiff)",
                Arrays.asList(new Material("Mithril keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 3, 54, "Mithril keel (sloop)",
                Arrays.asList(new Material("Large mithril keel parts",16), new Material("Lead bar",5))));

        // Mithril helm (tier 3)
        OPTIONS.add(new UpgradeOption("Helm", 0, 3, 55, "Mithril helm (raft)",
                Arrays.asList(new Material("Mahogany plank",2), new Material("Mithril bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 3, 55, "Mithril helm (skiff)",
                Arrays.asList(new Material("Mahogany plank",3), new Material("Mithril bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 3, 55, "Mithril helm (sloop)",
                Arrays.asList(new Material("Mahogany plank",4), new Material("Mithril bar",8))));

        // Adamant keel (tier 4)
        OPTIONS.add(new UpgradeOption("Keel", 1, 4, 66, "Adamant keel (skiff)",
                Arrays.asList(new Material("Adamant keel parts",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 4, 66, "Adamant keel (sloop)",
                Arrays.asList(new Material("Large adamant keel parts",16), new Material("Lead bar",5))));

        // Camphor base/hull (tier 4)
        OPTIONS.add(new UpgradeOption("Base", 0, 4, 67, "Camphor base (raft)",
                Arrays.asList(new Material("Camphor logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 4, 67, "Camphor hull (skiff)",
                Arrays.asList(new Material("Camphor hull parts",10), new Material("Adamantite nails",300), new Material("Swamp tar",20), new Material("Lead bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 4, 67, "Camphor hull (sloop)",
                Arrays.asList(new Material("Large camphor hull parts",16), new Material("Adamantite nails",600), new Material("Swamp tar",25), new Material("Lead bar",5))));

        // Camphor sails (tier 4)
        OPTIONS.add(new UpgradeOption("Sails", 0, 4, 68, "Camphor mast & canvas sails (raft)",
                Arrays.asList(new Material("Camphor logs",5), new Material("Adamantite nails",20), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 4, 68, "Camphor mast & canvas sails (skiff)",
                Arrays.asList(new Material("Camphor logs",10), new Material("Adamantite nails",40), new Material("Bolt of canvas",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 4, 68, "Camphor mast & canvas sails (sloop)",
                Arrays.asList(new Material("Camphor logs",15), new Material("Adamantite nails",60), new Material("Bolt of canvas",10))));

        // Adamant helm (tier 4)
        OPTIONS.add(new UpgradeOption("Helm", 0, 4, 72, "Adamant helm (raft)",
                Arrays.asList(new Material("Camphor plank",2), new Material("Adamantite bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 4, 72, "Adamant helm (skiff)",
                Arrays.asList(new Material("Camphor plank",3), new Material("Adamantite bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 4, 72, "Adamant helm (sloop)",
                Arrays.asList(new Material("Camphor plank",4), new Material("Adamantite bar",8))));

        // Ironwood base/hull (tier 5)
        OPTIONS.add(new UpgradeOption("Base", 0, 5, 81, "Ironwood base (raft)",
                Arrays.asList(new Material("Ironwood logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 5, 81, "Ironwood hull (skiff)",
                Arrays.asList(new Material("Ironwood hull parts",10), new Material("Rune nails",300), new Material("Swamp tar",20), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 5, 81, "Ironwood hull (sloop)",
                Arrays.asList(new Material("Large ironwood hull parts",16), new Material("Rune nails",600), new Material("Swamp tar",25), new Material("Cupronickel bar",5))));

        // Ironwood sails (tier 5)
        OPTIONS.add(new UpgradeOption("Sails", 0, 5, 83, "Ironwood mast & cotton sails (raft)",
                Arrays.asList(new Material("Ironwood logs",5), new Material("Rune nails",20), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 5, 83, "Ironwood mast & cotton sails (skiff)",
                Arrays.asList(new Material("Ironwood logs",10), new Material("Rune nails",40), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 5, 83, "Ironwood mast & cotton sails (sloop)",
                Arrays.asList(new Material("Ironwood logs",15), new Material("Rune nails",60), new Material("Bolt of cotton",10))));

        // Rune keel (tier 5)
        OPTIONS.add(new UpgradeOption("Keel", 1, 5, 85, "Rune keel (skiff)",
                Arrays.asList(new Material("Rune keel parts",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 5, 85, "Rune keel (sloop)",
                Arrays.asList(new Material("Large rune keel parts",16), new Material("Cupronickel bar",5))));

        // Rune helm (tier 5)
        OPTIONS.add(new UpgradeOption("Helm", 0, 5, 87, "Rune helm (raft)",
                Arrays.asList(new Material("Ironwood plank",2), new Material("Runite bar",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 5, 87, "Rune helm (skiff)",
                Arrays.asList(new Material("Ironwood plank",3), new Material("Runite bar",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 5, 87, "Rune helm (sloop)",
                Arrays.asList(new Material("Ironwood plank",4), new Material("Runite bar",8))));

        // Rosewood base/hull (tier 6)
        OPTIONS.add(new UpgradeOption("Base", 0, 6, 93, "Rosewood base (raft)",
                Arrays.asList(new Material("Rosewood logs",10), new Material("Rope",6), new Material("Swamp tar",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 1, 6, 93, "Rosewood hull (skiff)",
                Arrays.asList(new Material("Rosewood hull parts",10), new Material("Dragon nails",300), new Material("Swamp tar",20), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Hull", 2, 6, 93, "Rosewood hull (sloop)",
                Arrays.asList(new Material("Large rosewood hull parts",16), new Material("Dragon nails",600), new Material("Swamp tar",25), new Material("Cupronickel bar",5))));

        // Rosewood sails (tier 6)
        OPTIONS.add(new UpgradeOption("Sails", 0, 6, 94, "Rosewood mast & cotton sails (raft)",
                Arrays.asList(new Material("Rosewood logs",5), new Material("Dragon nails",20), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 1, 6, 94, "Rosewood mast & cotton sails (skiff)",
                Arrays.asList(new Material("Rosewood logs",10), new Material("Dragon nails",40), new Material("Bolt of cotton",5))));
        OPTIONS.add(new UpgradeOption("Sails", 2, 6, 94, "Rosewood mast & cotton sails (sloop)",
                Arrays.asList(new Material("Rosewood logs",15), new Material("Dragon nails",60), new Material("Bolt of cotton",10))));

        // Dragon helm (tier 6)
        OPTIONS.add(new UpgradeOption("Helm", 0, 6, 96, "Dragon helm (raft)",
                Arrays.asList(new Material("Rosewood plank",2), new Material("Dragon metal sheet",4))));
        OPTIONS.add(new UpgradeOption("Helm", 1, 6, 96, "Dragon helm (skiff)",
                Arrays.asList(new Material("Rosewood plank",3), new Material("Dragon metal sheet",6))));
        OPTIONS.add(new UpgradeOption("Helm", 2, 6, 96, "Dragon helm (sloop)",
                Arrays.asList(new Material("Rosewood plank",4), new Material("Dragon metal sheet",8))));

        // Dragon keel (tier 6)
        OPTIONS.add(new UpgradeOption("Keel", 1, 6, 97, "Dragon keel (skiff)",
                Arrays.asList(new Material("Dragon keel parts",10), new Material("Cupronickel bar",5))));
        OPTIONS.add(new UpgradeOption("Keel", 2, 6, 97, "Dragon keel (sloop)",
                Arrays.asList(new Material("Large dragon keel parts",16), new Material("Cupronickel bar",5))));
    }

    public static List<UpgradeOption> getAvailableOptions(int boatType, java.util.Map<String, Integer> currentTiers, int playerSailingLevel)
    {
        List<UpgradeOption> out = new ArrayList<>();
        for (UpgradeOption o : OPTIONS)
        {
            if (o.boatType != boatType) continue;

            Integer cur = currentTiers.get(o.partName);
            int curTier = cur == null ? -1 : cur;

            if (o.targetTier > curTier && playerSailingLevel >= o.requiredLevel)
            {
                out.add(o);
            }
        }
        return out;
    }
}
package com.boatupgrades;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.events.CommandExecuted;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.gameval.VarbitID;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import java.awt.*;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.StringSelection;

@Slf4j
@PluginDescriptor(
	name = "Boat Upgrades",
	description = "Display currently available upgrades for your boat",
	tags = {"sailing", "ship"}
)
public class BoatUpgradesPlugin extends Plugin
{
	@Inject
	private Client client;
	@Inject
	private BoatUpgradesConfig config;
	@Inject
	private BoatUpgradesOverlay boatUpgradesOverlay;
	@Inject
	private OverlayManager overlayManager;
	@Inject
	private ChangelogService changelogService;
	@Inject
	private ClientThread clientThread;

	private long lastAccountHash = -1;

	@Override
	protected void startUp() throws Exception
	{
		overlayManager.add(boatUpgradesOverlay);
		log.info("Boat Upgrades started");
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(boatUpgradesOverlay);
		log.info("Boat Upgrades stopped");
	}

	@Subscribe
	public void onCommandExecuted(CommandExecuted event)
	{
		if (event.getCommand().equalsIgnoreCase("boatvars"))
		{
			int[] values = new int[]
			{
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT0),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT1),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT2),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT3),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT4),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT5),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT6),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT7),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT8),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT9),
					client.getVarbitValue(VarbitID.SAILING_SIDEPANEL_FACILITY_HOTSPOT10)
			};

			StringBuilder sb = new StringBuilder();
			sb.append("Hotspot Varbits:");
			for (int i = 0; i < values.length; i++)
			{
				sb.append(System.lineSeparator()).append("Hotspot ").append(i).append(": ").append(values[i]);
			}

			final String output = sb.toString();

			try
			{
				StringSelection selection = new StringSelection(output);
				Clipboard clipboard = Toolkit.getDefaultToolkit().getSystemClipboard();
				clipboard.setContents(selection, selection);

				client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Hotspot varbits copied to clipboard!", null);
				log.info("Hotspot varbits copied to clipboard!");
				log.info("Hotspot varbits:\n{}", output);
			}
			catch (Throwable ex)
			{
				log.warn("Failed to copy hotspot varbits to clipboard", ex);
			}
		}
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (!"boatupgrades".equals(event.getGroup()))
		{
			return;
		}

		if ("persistMinutes".equals(event.getKey()))
		{
			boatUpgradesOverlay.refreshCacheExpiry();
		}
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged event)
	{
		GameState state = event.getGameState();

		if (state == GameState.LOGGED_IN && client.getAccountHash() != lastAccountHash)
		{
			clientThread.invokeLater(() ->
			{
				lastAccountHash = client.getAccountHash();
				changelogService.showChangelogIfNeeded();
			});
		}
	}

	@Provides
	BoatUpgradesConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(BoatUpgradesConfig.class);
	}
}
package com.boatupgrades;

import net.runelite.api.Client;
import net.runelite.api.Skill;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.LineComponent;
import net.runelite.client.ui.overlay.components.PanelComponent;
import net.runelite.client.ui.overlay.components.TitleComponent;

import javax.inject.Inject;
import java.awt.Dimension;
import java.awt.Graphics2D;
import java.util.ArrayList;
import java.util.List;

import static net.runelite.api.gameval.VarbitID.SAILING_BOARDED_BOAT;
import static net.runelite.api.gameval.VarbitID.SAILING_BOARDED_BOAT_TYPE;
import static net.runelite.api.gameval.VarbitID.SAILING_PREVIOUS_BOAT_TYPE_ID;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_SAIL;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_HELM;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_KEEL;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_FACILITY_HULL;
import static net.runelite.api.gameval.VarClientID.SAILING_SIDEPANEL_CAPTAIN_NAME;
import static net.runelite.api.gameval.VarbitID.SAILING_SIDEPANEL_SHIPYARD_MODE;


public class BoatUpgradesOverlay extends Overlay
{
    private final Client client;
    private final BoatUpgradesConfig config;
    private final PanelComponent panelComponent = new PanelComponent();

    private List<UpgradeData.UpgradeOption> cachedAvailable = new ArrayList<>();
    private long cacheExpiryMillis = 0L;
    private boolean prevActive = false;
    private String lastCaptainName = "";
    private int lastBoatTypeRaw = -1;

    @Inject
    public BoatUpgradesOverlay(Client client, BoatUpgradesConfig config)
    {
        this.client = client;
        this.config = config;
        setPosition(OverlayPosition.TOP_LEFT);
    }

    @Override
    public Dimension render(Graphics2D graphics)
    {
        panelComponent.getChildren().clear();

        final long now = System.currentTimeMillis();

        int boarded = client.getVarbitValue(SAILING_BOARDED_BOAT);
        int shipyardMode = client.getVarbitValue(SAILING_SIDEPANEL_SHIPYARD_MODE);

        boolean isBoarded = boarded != 0;
        boolean isInShipyard = shipyardMode != 0;

        boolean isActive = isBoarded || isInShipyard;

        String captain = client.getVarcStrValue(SAILING_SIDEPANEL_CAPTAIN_NAME);
        if (captain == null) captain = "";
        captain = captain.replace('\u00A0', ' ').trim();

        String localName = "";
        if (client.getLocalPlayer() != null)
        {
            localName = client.getLocalPlayer().getName();
            if (localName == null) localName = "";
        }

        boolean userIsCaptain = !localName.isEmpty() && !captain.isEmpty() && localName.equalsIgnoreCase(captain);
        if (isActive && !userIsCaptain)
        {
            prevActive = true;
            return panelComponent.render(graphics);
        }

        if (isActive)
        {
            int boatTypeRaw;
            if (isBoarded)
            {
                boatTypeRaw = client.getVarbitValue(SAILING_BOARDED_BOAT_TYPE);
            }
            else
            {
                boatTypeRaw = client.getVarbitValue(SAILING_PREVIOUS_BOAT_TYPE_ID);
            }

            int sailingLevel = client.getRealSkillLevel(Skill.SAILING);

            int sailTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_SAIL);
            int helmTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_HELM);
            int keelTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_KEEL);
            int hullTier = client.getVarbitValue(SAILING_SIDEPANEL_FACILITY_HULL);

            java.util.Map<String, Integer> currentTiers = new java.util.HashMap<>();
            currentTiers.put("Sails", sailTier);
            currentTiers.put("Helm", helmTier);
            currentTiers.put("Keel", keelTier);
            currentTiers.put("Hull", hullTier);
            currentTiers.put("Base", hullTier);

            java.util.List<UpgradeData.UpgradeOption> liveAvailable =
                    UpgradeData.getAvailableOptions(boatTypeRaw, currentTiers, sailingLevel);

            List<UpgradeData.UpgradeOption> toDisplayLive = filterHighestTiers(liveAvailable);

            if (!liveAvailable.isEmpty())
            {
                cachedAvailable = new ArrayList<>(liveAvailable);
                cacheExpiryMillis = Long.MAX_VALUE;
                lastCaptainName = captain;
                lastBoatTypeRaw = boatTypeRaw;
            }
            else
            {
                cachedAvailable.clear();
                cacheExpiryMillis = 0L;
                lastCaptainName = "";
                lastBoatTypeRaw = -1;
            }

            prevActive = true;

            if (liveAvailable.isEmpty())
            {
                return panelComponent.render(graphics);
            }

            renderHeaderAndOptions(graphics, boatTypeRaw, localName, captain, sailingLevel, toDisplayLive);

            return panelComponent.render(graphics);
        }
        else
        {
            if (prevActive)
            {
                if (!cachedAvailable.isEmpty())
                {
                    int minutes = Math.max(0, config.persistMinutes());
                    cacheExpiryMillis = now + (minutes * 60L * 1000L);
                }
                else
                {
                    cacheExpiryMillis = 0L;
                }
            }

            prevActive = false;

            if (!cachedAvailable.isEmpty() && now <= cacheExpiryMillis)
            {
                String showCaptain = lastCaptainName == null ? "" : lastCaptainName;
                int boatTypeToShow = lastBoatTypeRaw;

                if (showCaptain.isEmpty() || localName.isEmpty() || !localName.equalsIgnoreCase(showCaptain))
                {
                    return panelComponent.render(graphics);
                }

                List<UpgradeData.UpgradeOption> toDisplayCached = filterHighestTiers(cachedAvailable);
                renderHeaderAndOptions(graphics, boatTypeToShow, localName, showCaptain, client.getRealSkillLevel(Skill.SAILING), toDisplayCached);
                return panelComponent.render(graphics);
            }

            return panelComponent.render(graphics);
        }
    }

    private void renderHeaderAndOptions(Graphics2D graphics, int boatTypeRaw, String localName, String captain, int sailingLevel, List<UpgradeData.UpgradeOption> options)
    {
        String boatTypeName;
        switch (boatTypeRaw)
        {
            case 0: boatTypeName = "Raft"; break;
            case 1: boatTypeName = "Skiff"; break;
            case 2: boatTypeName = "Sloop"; break;
            default: boatTypeName = "Unknown(" + boatTypeRaw + ")"; break;
        }

        panelComponent.getChildren().add(TitleComponent.builder().text("Boat Upgrades").build());
        panelComponent.getChildren().add(LineComponent.builder().left("Current available upgrades:").build());
        panelComponent.getChildren().add(LineComponent.builder().left(" ").build());

        for (UpgradeData.UpgradeOption opt : options)
        {
            panelComponent.getChildren().add(LineComponent.builder()
                    .left(opt.displayName + ":")
                    .build());

            if (opt.materials.isEmpty())
            {
                panelComponent.getChildren().add(LineComponent.builder()
                        .left("  (no materials listed)")
                        .build());
            }
            else
            {
                StringBuilder mats = new StringBuilder();
                for (int i = 0; i < opt.materials.size(); i++)
                {
                    if (i > 0) mats.append(", ");
                    mats.append(opt.materials.get(i).toString());
                }

                panelComponent.getChildren().add(LineComponent.builder()
                        .left(mats.toString())
                        .build());
                panelComponent.getChildren().add(LineComponent.builder().left(" ").build());
            }
        }
    }

    public void refreshCacheExpiry()
    {
        if (cachedAvailable == null || cachedAvailable.isEmpty())
        {
            return;
        }

        if (cacheExpiryMillis == Long.MAX_VALUE)
        {
            return;
        }

        long now = System.currentTimeMillis();
        int minutes = Math.max(0, config.persistMinutes());
        cacheExpiryMillis = now + (minutes * 60L * 1000L);
    }

    private List<UpgradeData.UpgradeOption> filterHighestTiers(List<UpgradeData.UpgradeOption> options)
    {
        if (options == null || options.isEmpty() || !config.hideLowerTiers())
        {
            return options;
        }

        java.util.Map<String, UpgradeData.UpgradeOption> best = new java.util.LinkedHashMap<>();
        for (UpgradeData.UpgradeOption opt : options)
        {
            String key = opt.partName;
            UpgradeData.UpgradeOption existing = best.get(key);
            if (existing == null || opt.targetTier > existing.targetTier)
            {
                best.put(key, opt);
            }
        }

        java.util.List<UpgradeData.UpgradeOption> filtered = new ArrayList<>();
        java.util.Set<String> added = new java.util.HashSet<>();
        for (UpgradeData.UpgradeOption opt : options)
        {
            String key = opt.partName;
            if (added.contains(key))
            {
                continue;
            }
            UpgradeData.UpgradeOption bestOpt = best.get(key);
            if (bestOpt == opt)
            {
                filtered.add(opt);
                added.add(key);
            }
        }

        return filtered;
    }
}
package com.boatupgrades;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("boatupgrades")
public interface BoatUpgradesConfig extends Config
{
	@ConfigItem(
			keyName = "persistMinutes",
			name = "Persist overlay",
			description = "Number of minutes the overlay persists after disembarking your boat/leaving shipyard",
			position = 0
	)
	default int persistMinutes()
	{
		return 10;
	}

	@ConfigItem(
			keyName = "hideLowerTiers",
			name = "Hide lower tiers",
			description = "Hide lower tier upgrades from the overlay when a higher tier upgrade is available for the same boat part",
			position = 1
	)
	default boolean hideLowerTiers()
	{
		return false;
	}


	@ConfigItem(
			keyName = "comingSoon",
			name = "Boat facilities coming soon",
			description = "Boat facilities coming soon",
			position = 99
	)
	default boolean comingSoonNotice()
	{
		return true;
	}
	@ConfigItem(
			keyName = "lastSeenChangelogVersion",
			name = "lastSeenChangelogVersion",
			description = "",
			hidden = true
			//position = 800
	)
	default String lastSeenChangelogVersion()
	{
		return "";
	}

	@ConfigItem(
			keyName = "lastSeenChangelogVersion",
			name = "",
			description = "",
			hidden = true
	)
	void setLastSeenChangelogVersion(String value);
}
package com.boatupgrades;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class BoatUpgradesPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(BoatUpgradesPlugin.class);
		RuneLite.main(args);
	}
}
