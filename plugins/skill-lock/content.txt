package com.skilllock;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;
import net.runelite.client.config.Range;

@ConfigGroup("skilllock")
public interface SkillLockConfig extends Config
{

    @ConfigSection(
            name = "Lock Skills",
            description = "Lock or unlock skills by using the associated checkbox or in game menu right click menu on skill",
            position = 0
    )
    String lockSkills = "lockSkills";

    @ConfigItem(
            keyName = "agility",
            name = "Agility",
            description = "Lock or Unlock the Agility skill",
            section = lockSkills,
            position = 1
    )
    default boolean agility()
    {
        return false;
    }

    @ConfigItem(
            keyName = "attack",
            name = "Attack",
            description = "Lock or Unlock the Attack skill",
            section = lockSkills,
            position = 2
    )
    default boolean attack()
    {
        return false;
    }

    @ConfigItem(
            keyName = "construction",
            name = "Construction",
            description = "Lock or Unlock the Construction skill",
            section = lockSkills,
            position = 3
    )
    default boolean construction()
    {
        return false;
    }

    @ConfigItem(
            keyName = "cooking",
            name = "Cooking",
            description = "Lock or Unlock the Cooking skill",
            section = lockSkills,
            position = 4
    )
    default boolean cooking()
    {
        return false;
    }

    @ConfigItem(
            keyName = "crafting",
            name = "Crafting",
            description = "Lock or Unlock the Crafting skill",
            section = lockSkills,
            position = 5
    )
    default boolean crafting()
    {
        return false;
    }

    @ConfigItem(
            keyName = "defense",
            name = "Defense",
            description = "Lock or Unlock the Defense skill",
            section = lockSkills,
            position = 6
    )
    default boolean defense()
    {
        return false;
    }

    @ConfigItem(
            keyName = "farming",
            name = "Farming",
            description = "Lock or Unlock the Farming skill",
            section = lockSkills,
            position = 7
    )
    default boolean farming()
    {
        return false;
    }

    @ConfigItem(
            keyName = "firemaking",
            name = "Firemaking",
            description = "Lock or Unlock the Firemaking skill",
            section = lockSkills,
            position = 8
    )
    default boolean firemaking()
    {
        return false;
    }

    @ConfigItem(
            keyName = "fishing",
            name = "Fishing",
            description = "Lock or Unlock the Fishing skill",
            section = lockSkills,
            position = 9
    )
    default boolean fishing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "fletching",
            name = "Fletching",
            description = "Lock or Unlock the Fletching skill",
            section = lockSkills,
            position = 10
    )
    default boolean fletching()
    {
        return false;
    }

    @ConfigItem(
            keyName = "herblore",
            name = "Herblore",
            description = "Lock or Unlock the Herblore skill",
            section = lockSkills,
            position = 11
    )
    default boolean herblore()
    {
        return false;
    }

    @ConfigItem(
            keyName = "hitpoints",
            name = "Hitpoints",
            description = "Lock or Unlock the Hitpoints skill",
            section = lockSkills,
            position = 12
    )
    default boolean hitpoints()
    {
        return false;
    }

    @ConfigItem(
            keyName = "hunter",
            name = "Hunter",
            description = "Lock or Unlock the Hunter skill",
            section = lockSkills,
            position = 13
    )
    default boolean hunter()
    {
        return false;
    }

    @ConfigItem(
            keyName = "magic",
            name = "Magic",
            description = "Lock or Unlock the Magic skill",
            section = lockSkills,
            position = 14
    )
    default boolean magic()
    {
        return false;
    }

    @ConfigItem(
            keyName = "mining",
            name = "Mining",
            description = "Lock or Unlock the Mining skill",
            section = lockSkills,
            position = 15
    )
    default boolean mining()
    {
        return false;
    }

    @ConfigItem(
            keyName = "prayer",
            name = "Prayer",
            description = "Lock or Unlock the Prayer skill",
            section = lockSkills,
            position = 16
    )
    default boolean prayer()
    {
        return false;
    }

    @ConfigItem(
            keyName = "ranged",
            name = "Ranged",
            description = "Lock or Unlock the Ranged skill",
            section = lockSkills,
            position = 17
    )
    default boolean ranged()
    {
        return false;
    }

    @ConfigItem(
            keyName = "runecraft",
            name = "Runecraft",
            description = "Lock or Unlock the Runecraft skill",
            section = lockSkills,
            position = 18
    )
    default boolean runecraft()
    {
        return false;
    }

    @ConfigItem(
            keyName = "sailing",
            name = "Sailing",
            description = "Lock or Unlock the Sailing skill",
            section = lockSkills,
            position = 19
    )
    default boolean sailing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "slayer",
            name = "Slayer",
            description = "Lock or Unlock the Slayer skill",
            section = lockSkills,
            position = 20
    )
    default boolean slayer()
    {
        return false;
    }

    @ConfigItem(
            keyName = "smithing",
            name = "Smithing",
            description = "Lock or Unlock the Smithing skill",
            section = lockSkills,
            position = 21
    )
    default boolean smithing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "strength",
            name = "Strength",
            description = "Lock or Unlock the Strength skill",
            section = lockSkills,
            position = 22
    )
    default boolean strength()
    {
        return false;
    }

    @ConfigItem(
            keyName = "thieving",
            name = "Thieving",
            description = "Lock or Unlock the Thieving skill",
            section = lockSkills,
            position = 23
    )
    default boolean thieving()
    {
        return false;
    }

    @ConfigItem(
            keyName = "woodcutting",
            name = "Woodcutting",
            description = "Lock or Unlock the Woodcutting skill",
            section = lockSkills,
            position = 24
    )
    default boolean woodcutting()
    {
        return false;
    }

    @ConfigSection(
            name = "Set Levels",
            description = "Set a static level to be displayed in the skills menu, hold shift while hovering the skill to see your actual level",
            position = 25
    )
    String setLevels = "setLevels";

    @ConfigItem(
            keyName = "agility_level",
            name = "Agility Level",
            description = "Set a static Agility level",
            section = setLevels,
            position = 26
    )
    @Range(min = 0, max = 99)
    default int agility_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attack_level",
            name = "Attack Level",
            description = "Set a static Attack level",
            section = setLevels,
            position = 27
    )
    @Range(min = 0, max = 99)
    default int attack_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "construction_level",
            name = "Construction Level",
            description = "Set a static Construction level",
            section = setLevels,
            position = 28
    )
    @Range(min = 0, max = 99)
    default int construction_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "cooking_level",
            name = "Cooking Level",
            description = "Set a static Cooking level",
            section = setLevels,
            position = 29
    )
    @Range(min = 0, max = 99)
    default int cooking_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "crafting_level",
            name = "Crafting Level",
            description = "Set a static Crafting level",
            section = setLevels,
            position = 30
    )
    @Range(min = 0, max = 99)
    default int crafting_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defense_level",
            name = "Defense Level",
            description = "Set a static Defense level",
            section = setLevels,
            position = 31
    )
    @Range(min = 0, max = 99)
    default int defense_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "farming_level",
            name = "Farming Level",
            description = "Set a static Farming level",
            section = setLevels,
            position = 32
    )
    @Range(min = 0, max = 99)
    default int farming_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "firemaking_level",
            name = "Firemaking Level",
            description = "Set a static Firemaking level",
            section = setLevels,
            position = 33
    )
    @Range(min = 0, max = 99)
    default int firemaking_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "fishing_level",
            name = "Fishing Level",
            description = "Set a static Fishing level",
            section = setLevels,
            position = 34
    )
    @Range(min = 0, max = 99)
    default int fishing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "fletching_level",
            name = "Fletching Level",
            description = "Set a static Fletching level",
            section = setLevels,
            position = 35
    )
    @Range(min = 0, max = 99)
    default int fletching_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "herblore_level",
            name = "Herblore Level",
            description = "Set a static Herblore level",
            section = setLevels,
            position = 36
    )
    @Range(min = 0, max = 99)
    default int herblore_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "hitpoints_level",
            name = "Hitpoints Level",
            description = "Set a static Hitpoints level",
            section = setLevels,
            position = 37
    )
    @Range(min = 0, max = 99)
    default int hitpoints_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "hunter_level",
            name = "Hunter Level",
            description = "Set a static Hunter level",
            section = setLevels,
            position = 38
    )
    @Range(min = 0, max = 99)
    default int hunter_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "magic_level",
            name = "Magic Level",
            description = "Set a static Magic level",
            section = setLevels,
            position = 39
    )
    @Range(min = 0, max = 99)
    default int magic_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "mining_level",
            name = "Mining Level",
            description = "Set a static Mining level",
            section = setLevels,
            position = 40
    )
    @Range(min = 0, max = 99)
    default int mining_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "prayer_level",
            name = "Prayer Level",
            description = "Set a static Prayer level",
            section = setLevels,
            position = 41
    )
    @Range(min = 0, max = 99)
    default int prayer_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "ranged_level",
            name = "Ranged Level",
            description = "Set a static Ranged level",
            section = setLevels,
            position = 42
    )
    @Range(min = 0, max = 99)
    default int ranged_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "runecraft_level",
            name = "Runecraft Level",
            description = "Set a static Runecraft level",
            section = setLevels,
            position = 43
    )
    @Range(min = 0, max = 99)
    default int runecraft_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "sailing_level",
            name = "Sailing Level",
            description = "Set a static Sailing level",
            section = setLevels,
            position = 44
    )
    @Range(min = 0, max = 99)
    default int sailing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "slayer_level",
            name = "Slayer Level",
            description = "Set a static Slayer level",
            section = setLevels,
            position = 45
    )
    @Range(min = 0, max = 99)
    default int slayer_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "smithing_level",
            name = "Smithing Level",
            description = "Set a static Smithing level",
            section = setLevels,
            position = 46
    )
    @Range(min = 0, max = 99)
    default int smithing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "strength_level",
            name = "Strength Level",
            description = "Set a static Strength level",
            section = setLevels,
            position = 47
    )
    @Range(min = 0, max = 99)
    default int strength_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "thieving_level",
            name = "Thieving Level",
            description = "Set a static Thieving level",
            section = setLevels,
            position = 48
    )
    @Range(min = 0, max = 99)
    default int thieving_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "woodcutting_level",
            name = "Woodcutting Level",
            description = "Set a static Woodcutting level",
            section = setLevels,
            position = 49
    )
    @Range(min = 0, max = 99)
    default int woodcutting_level()
    {
        return 0;
    }

}

package com.skilllock;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.KeyCode;
import net.runelite.api.Point;
import net.runelite.api.widgets.Widget;
import net.runelite.client.ui.FontManager;
import net.runelite.client.ui.overlay.*;
import javax.imageio.ImageIO;
import javax.inject.Inject;
import java.awt.Dimension;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics2D;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Map;
import static java.util.Map.entry;


@Slf4j
public class SkillLockOverlay extends Overlay
{


    private Font skillFont;
    // Hashmap of skills to not render when key is hovered by cursor
    private Map<String, ArrayList<String>> hoverHideMap;

    private final SkillLockPlugin plugin;
    private BufferedImage lockImage;
    private BufferedImage backgroundImage;
    // Width and Height of Skills Widget
    public static final int RECT_WIDTH = 63;
    public static final int RECT_HEIGHT = 30;

    // Offsets to move image or rectangle over levels
    public static final int OFFSET_X = 31;
    public static final int OFFSET_Y = 5;

    private static final int RIGHT_SKILL_BOUNDARY_X = 684;
    private static final int LEFT_SKILL_BOUNDARY_X = 607;
    private static final int SKILL_BOUNDARY_Y = 19;

    private static final int TOOLTIP_ID = 20971553;

    private static final Color GREYSCALE_FILL = new Color(0, 0, 0, 128);

    @Inject
    private Client client;


    @Inject
    public SkillLockOverlay(final SkillLockPlugin plugin)
    {
        this.plugin = plugin;
        setPosition(OverlayPosition.DYNAMIC);
        setLayer(OverlayLayer.ABOVE_WIDGETS);

        loadLockImage();
        loadBackgroundImage();
    }


    @Override
    public Dimension render(Graphics2D graphics)
    {

        // Check to see if skillWidget is visible and assets are loaded
        Widget skillWidget = plugin.getSkillWidget();
        if ( skillWidget == null || skillWidget.isHidden() || skillWidget.getCanvasLocation() == null || lockImage == null || backgroundImage == null )
        {
            return null;
        }

        // Initialize empty HashMap for possible skill hover
        HashSet notRenderedSkills = new HashSet();

        // Check to see if a skill is hovered and whether the shift key is being pressed
        String hoverSkill = findHoverSkill();
        Rectangle skillTooltip = null;
        boolean shiftDown = client.isKeyPressed(KeyCode.KC_SHIFT);
        if (!hoverSkill.isEmpty())
        {
            // Get the bounds of the skillTooltip
            skillTooltip = getSkillExpTooltipBounds();
            // Make sure the skillTooltip is displayed before we calculate notRenderedSkills
            if (skillTooltip != null)
            {
                loadHoverHideMap(skillTooltip);
                // reset skillToolTip after loading HoverMap
                skillTooltip = null;
                notRenderedSkills.addAll(hoverHideMap.get(hoverSkill));
            }

        }



        for ( SkillLockPlugin.SkillLocation skillLocation : plugin.skillLocations )
        {

            // If skill is within notRenderedSkills skip the rendering of it
            if (notRenderedSkills.contains(skillLocation.name))
            {
                continue;
            }

            // If the hover skill is the current skill and the shift key is being pressed skip rendering
            if (hoverSkill.equals(skillLocation.name) && shiftDown)
            {
                continue;
            }


            int x = skillLocation.x;
            int y = skillLocation.y;


            if (skillLocation.isLocked)
            {
                // Draw background image to hide skill level
                Point canvasPoint = new Point(x+OFFSET_X,y+OFFSET_Y);
                OverlayUtil.renderImageLocation(graphics,canvasPoint,backgroundImage);
                // Greyscale the widget
                graphics.setColor(GREYSCALE_FILL);
                graphics.fillRect(x,y,RECT_WIDTH,RECT_HEIGHT);
                // Draw the lock image over the greyscale
                OverlayUtil.renderImageLocation(graphics,canvasPoint,lockImage);

            }
            else if ( skillLocation.level > 0 )
            {

                // Draw background image to hide skill level
                Point canvasPoint = new Point(x+OFFSET_X,y+OFFSET_Y);
                OverlayUtil.renderImageLocation(graphics,canvasPoint,backgroundImage);

                // Draw Level Text
                String text = String.valueOf(skillLocation.level);

                // Load the exact RS bold font for skill levels
                if (skillFont==null)
                {
                    skillFont = FontManager.getRunescapeBoldFont();
                }
                // Use the same font RuneLite uses for skill levels (looks native)
                graphics.setFont(skillFont);

                FontMetrics fm = graphics.getFontMetrics();
                int textWidth = fm.stringWidth(text);
                int textHeight = fm.getHeight();

                // Center the text inside the skill rectangle (63×30)
                int textX = x + ((RECT_WIDTH + OFFSET_X - textWidth) / 2);
                // Additional +2 for correct height can fine tune this later.
                int textY = y + ((RECT_HEIGHT - OFFSET_Y + 2 + textHeight) / 2) ;

                // Optional: slight shadow for better readability
                graphics.setColor(Color.BLACK);
                graphics.drawString(text, textX + 1, textY + 1);

                // Main text color - bright yellow like vanilla skills
                graphics.setColor(Color.YELLOW);
                graphics.drawString(text, textX, textY);

            }
        }

        return null;

    }

    private void loadLockImage()
    {
        try (InputStream is = SkillLockOverlay.class.getResourceAsStream("/com/skilllock/lock.png"))
        {
            if (is == null)
            {
                log.error("lock.png not found! Check: src/main/resources/com/skilllock/lock.png");
                lockImage = null;
                return;
            }

            BufferedImage original = ImageIO.read(is);
            log.debug("Lock image loaded: {}x{}", original.getWidth(), original.getHeight());


            // Choose a target size that covers the numbers
            final int TARGET_W = 50;   // you can tweak this
            final int TARGET_H = 31;   // keep it square, or change to 32×28 etc.
            final int OFF_X = -10;     // best offset to center on numbers
            final int OFF_Y = -5;      // best offset to center on numbers


            // Create a new BufferedImage with transparency
            lockImage = new BufferedImage(TARGET_W, TARGET_H, BufferedImage.TYPE_INT_ARGB);

            // Draw the original image scaled smoothly onto the new canvas
            Graphics2D g2d = lockImage.createGraphics();
            g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION,
                    RenderingHints.VALUE_INTERPOLATION_BILINEAR);
            g2d.setRenderingHint(RenderingHints.KEY_RENDERING,
                    RenderingHints.VALUE_RENDER_QUALITY);
            g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,
                    RenderingHints.VALUE_ANTIALIAS_ON);


            g2d.drawImage(original, OFF_X, OFF_Y, TARGET_W, TARGET_H, null);
            g2d.dispose();

            log.debug("Lock image loaded and resized to {}x{}", TARGET_W, TARGET_H);
        }
        catch (IOException e)
        {
            log.error("Failed to load or resize lock image", e);
            lockImage = null;
        }
    }

    private void loadBackgroundImage()
    {
        try (InputStream is = SkillLockOverlay.class.getResourceAsStream("/com/skilllock/background-sm.png"))
        {
            if (is == null)
            {
                log.error("lock.png not found! Check: src/main/resources/com/skilllock/background-sm.png");
                backgroundImage = null;
                return;
            }

            backgroundImage = ImageIO.read(is);
            log.debug("Background image loaded: {}x{}", backgroundImage.getWidth(), backgroundImage.getHeight());
        }
        catch (IOException e)
        {
            log.error("Failed to load or resize background image", e);
            backgroundImage = null;
        }
    }

    private String findHoverSkill()
    {
        Point mousePos = client.getMouseCanvasPosition();
        for (SkillLockPlugin.SkillLocation skillLocation : plugin.skillLocations)
        {
            //Precise skill box bounds
            Rectangle skillBox = new Rectangle( skillLocation.x, skillLocation.y, RECT_WIDTH, RECT_HEIGHT);
            if (skillBox.contains(mousePos.getX(), mousePos.getY()))
            {
                return skillLocation.name;
            }
        }
        return "";
    }

    private Rectangle getSkillExpTooltipBounds()
    {
        Widget tooltip = client.getWidget(TOOLTIP_ID);
        if (tooltip != null && !tooltip.isHidden())
        {
            return tooltip.getBounds();
        }
        return null;
    }

    private void loadHoverHideMap( Rectangle bounds)
    {
        int startX = bounds.x;
        int endX = bounds.x + bounds.width;
        int height = bounds.height;
        // Base hideHoverMap
        Map<String, ArrayList<String>> normal = Map.ofEntries(
                entry("attack", new ArrayList<>(Arrays.asList("strength", "agility", "defence", "herblore"))),
                entry("hitpoints", new ArrayList<>(Arrays.asList("agility", "smithing", "herblore", "fishing"))),
                entry("mining", new ArrayList<>(Arrays.asList("agility", "smithing", "herblore", "fishing"))),
                entry("strength", new ArrayList<>(Arrays.asList("defence", "herblore", "ranged", "thieving"))),
                entry("agility", new ArrayList<>(Arrays.asList("herblore", "fishing", "thieving", "cooking"))),
                entry("smithing", new ArrayList<>(Arrays.asList("herblore", "fishing", "thieving", "cooking"))),
                entry("defence", new ArrayList<>(Arrays.asList("ranged", "thieving", "prayer", "crafting"))),
                entry("herblore", new ArrayList<>(Arrays.asList("ranged", "thieving", "cooking", "prayer", "crafting", "firemaking"))),
                entry("fishing", new ArrayList<>(Arrays.asList("thieving", "cooking", "crafting", "firemaking"))),
                entry("ranged", new ArrayList<>(Arrays.asList("prayer", "crafting", "magic", "fletching"))),
                entry("thieving", new ArrayList<>(Arrays.asList("prayer", "crafting", "firemaking", "magic", "fletching", "woodcutting"))),
                entry("cooking", new ArrayList<>(Arrays.asList("crafting", "firemaking", "fletching", "woodcutting"))),
                entry("prayer", new ArrayList<>(Arrays.asList("magic", "fletching", "runecraft", "slayer"))),
                entry("crafting", new ArrayList<>(Arrays.asList("fletching", "woodcutting", "slayer", "farming"))),
                entry("firemaking", new ArrayList<>(Arrays.asList("fletching", "woodcutting", "slayer", "farming"))),
                entry("magic", new ArrayList<>(Arrays.asList("runecraft", "slayer", "construction", "hunter"))),
                entry("fletching", new ArrayList<>(Arrays.asList("runecraft", "slayer", "farming", "construction", "hunter", "sailing"))),
                entry("woodcutting", new ArrayList<>(Arrays.asList("slayer", "farming", "hunter", "sailing"))),
                entry("runecraft", new ArrayList<>(Arrays.asList("construction", "hunter"))),
                entry("slayer", new ArrayList<>(Arrays.asList("hunter", "sailing"))),
                entry("farming", new ArrayList<>(Arrays.asList("hunter", "sailing"))),
                entry("construction", new ArrayList<>(Arrays.asList("runecraft", "slayer", "farming", "magic", "fletching", "woodcutting"))),
                entry("hunter", new ArrayList<>(Arrays.asList("slayer", "farming", "fletching", "woodcutting"))),
                entry("sailing", new ArrayList<>(Arrays.asList("slayer", "farming", "fletching", "woodcutting")))
        );

        // Add additional skills for both right and left side of skill boundary
        if (endX >= RIGHT_SKILL_BOUNDARY_X)
        {
            normal.get("attack").addAll(Arrays.asList("smithing","fishing"));
            normal.get("strength").addAll(Arrays.asList("fishing", "cooking"));
            normal.get("defence").addAll(Arrays.asList("cooking", "firemaking"));
            normal.get("ranged").addAll(Arrays.asList("firemaking", "woodcutting"));
            normal.get("prayer").addAll(Arrays.asList("woodcutting", "farming"));
            normal.get("magic").addAll(Arrays.asList("farming","sailing"));
            normal.get("runecraft").add("sailing");
        }
        if ( startX <= LEFT_SKILL_BOUNDARY_X)
        {
            for ( String key : normal.keySet() )
            {
                switch (key)
                {
                    case "hitpoints":
                    case "mining":
                        normal.get(key).addAll(Arrays.asList("strength", "defence"));
                        break;
                    case "agility":
                    case "smithing":
                        normal.get(key).addAll(Arrays.asList("defence", "ranged"));
                        break;
                    case "fishing":
                        normal.get(key).addAll(Arrays.asList("ranged", "prayer"));
                        break;
                    case "cooking":
                        normal.get(key).addAll(Arrays.asList("prayer", "magic"));
                        break;
                    case "crafting":
                    case "firemaking":
                        normal.get(key).addAll(Arrays.asList("magic", "runecraft"));
                        break;
                    case "woodcutting":
                        normal.get(key).addAll(Arrays.asList("runecraft", "construction"));
                        break;
                    case "slayer":
                    case "farming":
                        normal.get(key).add("construction");
                        break;
                    case "hunter":
                    case "sailing":
                        normal.get(key).addAll(Arrays.asList("runecraft", "magic"));
                        break;
                    default:
                        break;

                }
            }
        }
        // Remove skills if height is below skill boundary
        if ( height <= SKILL_BOUNDARY_Y )
        {
            for ( String key : normal.keySet() )
            {
                switch(key)
                {
                    case "attack":
                    case "hitpoints":
                    case "mining":
                        normal.get(key).removeAll(Arrays.asList("defence", "herblore", "fishing"));
                        break;
                    case "strength":
                    case "agility":
                    case "smithing":
                        normal.get(key).removeAll(Arrays.asList("ranged", "thieving", "cooking"));
                        break;
                    case "defence":
                    case "herblore":
                    case "fishing":
                        normal.get(key).removeAll(Arrays.asList("prayer", "crafting", "firemaking"));
                        break;
                    case "ranged":
                    case "thieving":
                    case "cooking":
                        normal.get(key).removeAll(Arrays.asList("magic", "fletching", "woodcutting"));
                        break;
                    case "prayer":
                    case "crafting":
                    case "firemaking":
                        normal.get(key).removeAll(Arrays.asList("runecraft", "slayer", "farming"));
                        break;
                    case "magic":
                    case "fletching":
                    case "woodcutting":
                        normal.get(key).removeAll(Arrays.asList("construction", "hunter", "sailing"));
                        break;
                    case "construction":
                    case "hunter":
                    case "sailing":
                        normal.get(key).removeAll(Arrays.asList("magic", "fletching", "woodcutting"));
                        break;
                    default:
                        break;
                }
            }
        }
        hoverHideMap = normal;
    }
}

package com.skilllock;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.MenuAction;
import net.runelite.api.MenuEntry;
import net.runelite.api.WorldType;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.MenuOpened;
import net.runelite.api.events.WidgetLoaded;
import net.runelite.api.events.WorldChanged;
import net.runelite.api.widgets.ComponentID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.game.chatbox.ChatboxPanelManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import java.awt.Rectangle;
import java.util.ArrayList;
import java.util.EnumSet;
import java.util.concurrent.atomic.AtomicInteger;

@Slf4j
@PluginDescriptor(
	name = "Skill Lock"
)
public class SkillLockPlugin extends Plugin
{
	@Inject
	private Client client;

    @Inject
    private ChatboxPanelManager chatboxPanelManager;

    @Inject
    private ClientThread clientThread;

    @Inject
    private OverlayManager overlayManager;

    @Inject
    private SkillLockOverlay overlay;

    @Inject
    private ConfigManager configManager;

    private boolean skillsTabWasOpen = false;
    private boolean needsLocationUpdate = false;
    public ArrayList<SkillLocation> skillLocations =  new ArrayList<>();
    private final String[] SKILL_NAMES = {"attack","hitpoints","mining","strength","agility","smithing","defence","herblore","fishing","ranged","thieving","cooking","prayer","crafting","firemaking","magic","fletching","woodcutting","runecraft","slayer","farming","construction","hunter","sailing"};


    @Override
	protected void startUp() throws Exception
	{
		log.debug("Skill Lock started!");
        skillsTabWasOpen = false;
        needsLocationUpdate = false;
        skillLocations.clear();
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.debug("Skill Lock stopped!");
        overlayManager.remove(overlay);
	}

    private void checkAndUpdateOverlay()
    {
        boolean isOpen = isSkillsTabOpen();

        if (isOpen && !skillsTabWasOpen)
        {
            skillLocations = createSkillLocations(); // ← Recalculate fresh
            overlayManager.add(overlay);
            log.debug("Skills tab opened → overlay added + locations recalculated");
        }
        else if (!isOpen && skillsTabWasOpen)
        {
            overlayManager.remove(overlay);
            log.debug("Skills tab closed → overlay removed");
        }

        skillsTabWasOpen = isOpen;
    }

    public Widget getSkillWidget()
    {
        return client.getWidget(ComponentID.SKILLS_CONTAINER);
    }

    @Data
    public static class SkillLocation
    {
        public final String name;
        public final int x;
        public final int y;
        public final boolean isLocked;
        public final int level;
    }

    public ArrayList<SkillLocation> createSkillLocations() {


        final Widget skillContainer = getSkillWidget();
        // Make sure skillContainer is not null
        if (skillContainer == null || skillContainer.isHidden() || skillContainer.getCanvasLocation() == null)
        {
            return new  ArrayList<>();
        }


        // Define starting values for X and Y
        final int baseX = skillContainer.getCanvasLocation().getX();
        final int baseY = skillContainer.getCanvasLocation().getY() + 1;

        // Create an array list with the correct length
        ArrayList<SkillLocation> locations = new ArrayList<>(SKILL_NAMES.length);

        for (int i = 0; i< SKILL_NAMES.length; i++ )
        {
            String name =  SKILL_NAMES[i];
            String val = configManager.getConfiguration("skilllock",name,String.class);
            boolean locked = "true".equalsIgnoreCase(val);
            val = configManager.getConfiguration("skilllock",name+"_level",String.class);
            int level = Integer.parseInt(val);

            // 3 columns, 8 rows
            int col = i % 3;
            int row = i / 3;

            int RECT_WIDTH = SkillLockOverlay.RECT_WIDTH;
            int x = baseX + col * RECT_WIDTH;
            int RECT_HEIGHT = SkillLockOverlay.RECT_HEIGHT;
            int y = baseY + row * RECT_HEIGHT;

            locations.add(new SkillLocation(name, x, y, locked, level));
        }

        return locations;
    }

    private boolean isSkillsTabOpen()
    {
        Widget skillsRoot = getSkillWidget();
        return skillsRoot != null && !skillsRoot.isHidden();
    }

    private boolean getSkillLockState(String skill)
    {
        // Use ConfigManager directly — no switch needed!
        String value = configManager.getConfiguration("skilllock", skill, String.class);
        return "true".equalsIgnoreCase(value);
    }

    private void toggleSkillLock(String skill)
    {
        boolean current = getSkillLockState(skill);
        boolean newState = !current;

        // Update config
        configManager.setConfiguration("skilllock", skill, newState);

        // If the skill is being locked also update it's static level
        if (newState)
        {
            configManager.setConfiguration("skilllock", skill+"_level", 0);
        }

        // Force immediate update
        needsLocationUpdate = true;

        log.debug("Toggled {} lock: {}", skill, newState ? "LOCKED" : "UNLOCKED");
    }

    private void openLevelInputDialog( String skillName)
    {
        boolean isLocked = getSkillLockState(skillName);
        AtomicInteger updatedLevel = new AtomicInteger();

        // Only allow if the skill is unlocked
        if (!isLocked)
        {
            clientThread.invokeLater( () ->
                    chatboxPanelManager.openTextInput("<col=ff9040>SkillLock</col> - Set level for <col=ffff00>" + skillName + "</col>")
                            .prompt("Enter 1-99 (or 0 to disable)")
                            .onDone( inputText ->
                            {
                                clientThread.invokeLater( () ->
                                {
                                    String value = inputText.trim();
                                    if (value.isEmpty())
                                    {
                                        return;
                                    }
                                    else
                                    {
                                        try
                                        {
                                            int level  = Integer.parseInt(value);
                                            if (level < 0 || level > 99)
                                            {
                                                client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Level must be 0-99 for " + skillName, null);
                                                return;
                                            }
                                            updatedLevel.set(level);
                                            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", skillName.substring(0,1).toUpperCase() + skillName.substring(1) + " level set to " + level, null);
                                        }
                                        catch (NumberFormatException e)
                                        {
                                            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Invalid number for " + skillName, null);
                                            return;
                                        }

                                    }
                                    configManager.setConfiguration("skilllock", skillName+"_level", updatedLevel.get());
                                });
                            })
                            .build()
            );
        }
    }

    @Subscribe
    public void onMenuOpened (MenuOpened event)
    {
        // Make sure skills tab is open
        if (!isSkillsTabOpen()) return;

        // Get menu entries and make sure it is a skill we have right-clicked
        MenuEntry[] menuEntries = event.getMenuEntries();
        if (menuEntries[3] == null || !menuEntries[3].getOption().startsWith("View") || !menuEntries[3].getOption().endsWith("guide")) return;

        // Get the skill name from the menu entry
        String skillName = menuEntries[3].getOption().split(" ")[1].replaceAll("<col=\\w{6}>([^<]+)</col>", "$1");
        // Normalize it for the config name
        String configName = skillName.toLowerCase();

        // Create the custom menu entry
        MenuEntry toggle = client.createMenuEntry(0)
                .setOption(getSkillLockState(configName) ? "Unlock" : "Lock")
                .setTarget("<col=ff981f>" + skillName + "</col> level")
                .setType(MenuAction.RUNELITE)
                .onClick(e -> {
                    toggleSkillLock(configName);
                });

        MenuEntry setSkill = client.createMenuEntry(0)
                .setOption("Set")
                .setTarget("<col=ff981f>" + skillName + "</col> level")
                .setType(MenuAction.RUNELITE)
                .onClick(e -> {
                    openLevelInputDialog(configName);
                });

        boolean isLocked = getSkillLockState(configName);
        MenuEntry[] newMenuEntries = new MenuEntry[]{menuEntries[0], menuEntries[1],menuEntries[2],menuEntries[3]};

        // If the skill is locked only show the toggle button
        if (isLocked)
        {
            newMenuEntries = new MenuEntry[]{menuEntries[0], toggle, menuEntries[1], menuEntries[2], menuEntries[3]};
        }
        // Also show the set skill option
        else
        {
            newMenuEntries = new MenuEntry[]{menuEntries[0], setSkill, toggle, menuEntries[1], menuEntries[2], menuEntries[3]};
        }

        client.setMenuEntries(newMenuEntries);

    }


    @Subscribe
    public void onGameTick (GameTick event)
    {
        // First tick: safe to access client
        if (!skillsTabWasOpen && isSkillsTabOpen())
        {
            // First time skills tab is detected open
            skillLocations = createSkillLocations();
        }

        checkAndUpdateOverlay();

        if (needsLocationUpdate && isSkillsTabOpen())
        {
            skillLocations = createSkillLocations();
            needsLocationUpdate = false;
            //log.debug("Skill locations updated from config change: {}", skillLocations);
        }

    }

    @Subscribe
    public void onWidgetLoaded(WidgetLoaded event)
    {
        if (event.getGroupId() == ComponentID.SKILLS_CONTAINER)
        {
            skillLocations = createSkillLocations();
            //log.debug("skill locations {}", skillLocations);
        }
    }

    @Subscribe
    public void onConfigChanged(ConfigChanged event)
    {
        if ("skilllock".equals(event.getGroup()))
        {
            needsLocationUpdate = true;
            //log.debug("Config changed, scheduled to update skill locations");
        }
    }

	@Provides
    SkillLockConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(SkillLockConfig.class);
	}
}

package com.skilllock;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class SkillLockPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(SkillLockPlugin.class);
		RuneLite.main(args);
	}
}
