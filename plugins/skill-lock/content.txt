package com.skilllock;

import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class SkillLocation
{
    public final String name;
    public final int x;
    public final int y;
    public final int level;
    public final boolean isLocked;
}

package com.skilllock;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;
import net.runelite.client.config.Range;

@ConfigGroup("skilllock")
public interface SkillLockConfig extends Config
{

    @ConfigSection(
            name = "Lock Skills",
            description = "Lock or unlock skills by using the associated checkbox or in game menu right click menu on skill",
            position = 0
    )
    String lockSkills = "lockSkills";

    @ConfigItem(
            keyName = "agility",
            name = "Agility",
            description = "Lock or Unlock the Agility skill",
            section = lockSkills,
            position = 1
    )
    default boolean agility()
    {
        return false;
    }

    @ConfigItem(
            keyName = "attack",
            name = "Attack",
            description = "Lock or Unlock the Attack skill",
            section = lockSkills,
            position = 2
    )
    default boolean attack()
    {
        return false;
    }

    @ConfigItem(
            keyName = "construction",
            name = "Construction",
            description = "Lock or Unlock the Construction skill",
            section = lockSkills,
            position = 3
    )
    default boolean construction()
    {
        return false;
    }

    @ConfigItem(
            keyName = "cooking",
            name = "Cooking",
            description = "Lock or Unlock the Cooking skill",
            section = lockSkills,
            position = 4
    )
    default boolean cooking()
    {
        return false;
    }

    @ConfigItem(
            keyName = "crafting",
            name = "Crafting",
            description = "Lock or Unlock the Crafting skill",
            section = lockSkills,
            position = 5
    )
    default boolean crafting()
    {
        return false;
    }

    @ConfigItem(
            keyName = "defence",
            name = "Defence",
            description = "Lock or Unlock the Defense skill",
            section = lockSkills,
            position = 6
    )
    default boolean defence()
    {
        return false;
    }

    @ConfigItem(
            keyName = "farming",
            name = "Farming",
            description = "Lock or Unlock the Farming skill",
            section = lockSkills,
            position = 7
    )
    default boolean farming()
    {
        return false;
    }

    @ConfigItem(
            keyName = "firemaking",
            name = "Firemaking",
            description = "Lock or Unlock the Firemaking skill",
            section = lockSkills,
            position = 8
    )
    default boolean firemaking()
    {
        return false;
    }

    @ConfigItem(
            keyName = "fishing",
            name = "Fishing",
            description = "Lock or Unlock the Fishing skill",
            section = lockSkills,
            position = 9
    )
    default boolean fishing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "fletching",
            name = "Fletching",
            description = "Lock or Unlock the Fletching skill",
            section = lockSkills,
            position = 10
    )
    default boolean fletching()
    {
        return false;
    }

    @ConfigItem(
            keyName = "herblore",
            name = "Herblore",
            description = "Lock or Unlock the Herblore skill",
            section = lockSkills,
            position = 11
    )
    default boolean herblore()
    {
        return false;
    }

    @ConfigItem(
            keyName = "hitpoints",
            name = "Hitpoints",
            description = "Lock or Unlock the Hitpoints skill",
            section = lockSkills,
            position = 12
    )
    default boolean hitpoints()
    {
        return false;
    }

    @ConfigItem(
            keyName = "hunter",
            name = "Hunter",
            description = "Lock or Unlock the Hunter skill",
            section = lockSkills,
            position = 13
    )
    default boolean hunter()
    {
        return false;
    }

    @ConfigItem(
            keyName = "magic",
            name = "Magic",
            description = "Lock or Unlock the Magic skill",
            section = lockSkills,
            position = 14
    )
    default boolean magic()
    {
        return false;
    }

    @ConfigItem(
            keyName = "mining",
            name = "Mining",
            description = "Lock or Unlock the Mining skill",
            section = lockSkills,
            position = 15
    )
    default boolean mining()
    {
        return false;
    }

    @ConfigItem(
            keyName = "prayer",
            name = "Prayer",
            description = "Lock or Unlock the Prayer skill",
            section = lockSkills,
            position = 16
    )
    default boolean prayer()
    {
        return false;
    }

    @ConfigItem(
            keyName = "ranged",
            name = "Ranged",
            description = "Lock or Unlock the Ranged skill",
            section = lockSkills,
            position = 17
    )
    default boolean ranged()
    {
        return false;
    }

    @ConfigItem(
            keyName = "runecraft",
            name = "Runecraft",
            description = "Lock or Unlock the Runecraft skill",
            section = lockSkills,
            position = 18
    )
    default boolean runecraft()
    {
        return false;
    }

    @ConfigItem(
            keyName = "sailing",
            name = "Sailing",
            description = "Lock or Unlock the Sailing skill",
            section = lockSkills,
            position = 19
    )
    default boolean sailing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "slayer",
            name = "Slayer",
            description = "Lock or Unlock the Slayer skill",
            section = lockSkills,
            position = 20
    )
    default boolean slayer()
    {
        return false;
    }

    @ConfigItem(
            keyName = "smithing",
            name = "Smithing",
            description = "Lock or Unlock the Smithing skill",
            section = lockSkills,
            position = 21
    )
    default boolean smithing()
    {
        return false;
    }

    @ConfigItem(
            keyName = "strength",
            name = "Strength",
            description = "Lock or Unlock the Strength skill",
            section = lockSkills,
            position = 22
    )
    default boolean strength()
    {
        return false;
    }

    @ConfigItem(
            keyName = "thieving",
            name = "Thieving",
            description = "Lock or Unlock the Thieving skill",
            section = lockSkills,
            position = 23
    )
    default boolean thieving()
    {
        return false;
    }

    @ConfigItem(
            keyName = "woodcutting",
            name = "Woodcutting",
            description = "Lock or Unlock the Woodcutting skill",
            section = lockSkills,
            position = 24
    )
    default boolean woodcutting()
    {
        return false;
    }

    @ConfigSection(
            name = "Set Levels",
            description = "Set a static level to be displayed in the skills menu, hold shift while hovering the skill to see your actual level",
            position = 25
    )
    String setLevels = "setLevels";

    @ConfigItem(
            keyName = "agility_level",
            name = "Agility Level",
            description = "Set a static Agility level",
            section = setLevels,
            position = 26
    )
    @Range(min = 0, max = 99)
    default int agility_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attack_level",
            name = "Attack Level",
            description = "Set a static Attack level",
            section = setLevels,
            position = 27
    )
    @Range(min = 0, max = 99)
    default int attack_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "construction_level",
            name = "Construction Level",
            description = "Set a static Construction level",
            section = setLevels,
            position = 28
    )
    @Range(min = 0, max = 99)
    default int construction_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "cooking_level",
            name = "Cooking Level",
            description = "Set a static Cooking level",
            section = setLevels,
            position = 29
    )
    @Range(min = 0, max = 99)
    default int cooking_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "crafting_level",
            name = "Crafting Level",
            description = "Set a static Crafting level",
            section = setLevels,
            position = 30
    )
    @Range(min = 0, max = 99)
    default int crafting_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defence_level",
            name = "Defence Level",
            description = "Set a static Defense level",
            section = setLevels,
            position = 31
    )
    @Range(min = 0, max = 99)
    default int defence_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "farming_level",
            name = "Farming Level",
            description = "Set a static Farming level",
            section = setLevels,
            position = 32
    )
    @Range(min = 0, max = 99)
    default int farming_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "firemaking_level",
            name = "Firemaking Level",
            description = "Set a static Firemaking level",
            section = setLevels,
            position = 33
    )
    @Range(min = 0, max = 99)
    default int firemaking_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "fishing_level",
            name = "Fishing Level",
            description = "Set a static Fishing level",
            section = setLevels,
            position = 34
    )
    @Range(min = 0, max = 99)
    default int fishing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "fletching_level",
            name = "Fletching Level",
            description = "Set a static Fletching level",
            section = setLevels,
            position = 35
    )
    @Range(min = 0, max = 99)
    default int fletching_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "herblore_level",
            name = "Herblore Level",
            description = "Set a static Herblore level",
            section = setLevels,
            position = 36
    )
    @Range(min = 0, max = 99)
    default int herblore_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "hitpoints_level",
            name = "Hitpoints Level",
            description = "Set a static Hitpoints level",
            section = setLevels,
            position = 37
    )
    @Range(min = 0, max = 99)
    default int hitpoints_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "hunter_level",
            name = "Hunter Level",
            description = "Set a static Hunter level",
            section = setLevels,
            position = 38
    )
    @Range(min = 0, max = 99)
    default int hunter_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "magic_level",
            name = "Magic Level",
            description = "Set a static Magic level",
            section = setLevels,
            position = 39
    )
    @Range(min = 0, max = 99)
    default int magic_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "mining_level",
            name = "Mining Level",
            description = "Set a static Mining level",
            section = setLevels,
            position = 40
    )
    @Range(min = 0, max = 99)
    default int mining_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "prayer_level",
            name = "Prayer Level",
            description = "Set a static Prayer level",
            section = setLevels,
            position = 41
    )
    @Range(min = 0, max = 99)
    default int prayer_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "ranged_level",
            name = "Ranged Level",
            description = "Set a static Ranged level",
            section = setLevels,
            position = 42
    )
    @Range(min = 0, max = 99)
    default int ranged_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "runecraft_level",
            name = "Runecraft Level",
            description = "Set a static Runecraft level",
            section = setLevels,
            position = 43
    )
    @Range(min = 0, max = 99)
    default int runecraft_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "sailing_level",
            name = "Sailing Level",
            description = "Set a static Sailing level",
            section = setLevels,
            position = 44
    )
    @Range(min = 0, max = 99)
    default int sailing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "slayer_level",
            name = "Slayer Level",
            description = "Set a static Slayer level",
            section = setLevels,
            position = 45
    )
    @Range(min = 0, max = 99)
    default int slayer_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "smithing_level",
            name = "Smithing Level",
            description = "Set a static Smithing level",
            section = setLevels,
            position = 46
    )
    @Range(min = 0, max = 99)
    default int smithing_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "strength_level",
            name = "Strength Level",
            description = "Set a static Strength level",
            section = setLevels,
            position = 47
    )
    @Range(min = 0, max = 99)
    default int strength_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "thieving_level",
            name = "Thieving Level",
            description = "Set a static Thieving level",
            section = setLevels,
            position = 48
    )
    @Range(min = 0, max = 99)
    default int thieving_level()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "woodcutting_level",
            name = "Woodcutting Level",
            description = "Set a static Woodcutting level",
            section = setLevels,
            position = 49
    )
    @Range(min = 0, max = 99)
    default int woodcutting_level()
    {
        return 0;
    }

}

package com.skilllock;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.KeyCode;
import net.runelite.api.Point;
import net.runelite.api.widgets.ComponentID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.ui.FontManager;
import net.runelite.client.ui.overlay.*;
import javax.imageio.ImageIO;
import javax.inject.Inject;
import java.awt.BasicStroke;
import java.awt.Dimension;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics2D;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.InputStream;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

@Slf4j
public class SkillLockOverlay extends Overlay
{
    private final SkillLockPlugin plugin;
    private final Client client;
    // Font used for set skills and images + color used in overlay
    private Font skillFont;
    private BufferedImage lockImage;
    private BufferedImage backgroundImage;
    private static final Color GREYSCALE_FILL = new Color(0, 0, 0, 128);
    // Width and Height of Skills Widget and Total Level
    public static final int RECT_WIDTH = 63;
    public static final int RECT_HEIGHT = 30;
    private static final int TOTAL_LEVEL_WIDTH = 187;
    private static final int TOTAL_LEVEL_HEIGHT = 19;

    // Offsets to move image or rectangle over levels
    public static final int OFFSET_X = 31;
    public static final int OFFSET_Y = 5;

    // Glow constants
    public static final long GLOW_DURATION_MS = 1200;  // 1.2s to match audio
    private static final Color GLOW_COLOR = new Color(255, 255, 100);  // Bright yellow (adjust as needed)
    private static final float PULSE_SPEED = 2.5f;  // Higher = faster pulse
    private static final int RING_THICKNESS = 4;    // Thickness of the glowing ring
    private static final int INNER_PADDING = 2;     // Distance from edge (keeps it inside)

    // Boundaries for Tooltip logic
    private static final int SKILL_BOUNDARY_X = 132;
    private static final int SKILL_BOUNDARY_Y = 19;

    private static final int XP_TOOLTIP_ID = 20971553;

    private static final Map<String, List<String>> BASE_HIDE_MAP = new HashMap<>();
    static
    {
        BASE_HIDE_MAP.put("attack", List.of("strength", "agility", "defence", "herblore"));
        BASE_HIDE_MAP.put("hitpoints", List.of("agility", "smithing", "herblore", "fishing"));
        BASE_HIDE_MAP.put("mining", List.of("agility", "smithing", "herblore", "fishing"));
        BASE_HIDE_MAP.put("strength", List.of("defence", "herblore", "ranged", "thieving"));
        BASE_HIDE_MAP.put("agility", List.of("herblore", "fishing", "thieving", "cooking"));
        BASE_HIDE_MAP.put("smithing", List.of("herblore", "fishing", "thieving", "cooking"));
        BASE_HIDE_MAP.put("defence", List.of("ranged", "thieving", "prayer", "crafting"));
        BASE_HIDE_MAP.put("herblore", List.of("ranged", "thieving", "cooking", "prayer", "crafting", "firemaking"));
        BASE_HIDE_MAP.put("fishing", List.of("thieving", "cooking", "crafting", "firemaking"));
        BASE_HIDE_MAP.put("ranged", List.of("prayer", "crafting", "magic", "fletching"));
        BASE_HIDE_MAP.put("thieving", List.of("prayer", "crafting", "firemaking", "magic", "fletching", "woodcutting"));
        BASE_HIDE_MAP.put("cooking", List.of("crafting", "firemaking", "fletching", "woodcutting"));
        BASE_HIDE_MAP.put("prayer", List.of("magic", "fletching", "runecraft", "slayer"));
        BASE_HIDE_MAP.put("crafting", List.of("fletching", "woodcutting", "slayer", "farming"));
        BASE_HIDE_MAP.put("firemaking", List.of("fletching", "woodcutting", "slayer", "farming"));
        BASE_HIDE_MAP.put("magic", List.of("runecraft", "slayer", "construction", "hunter"));
        BASE_HIDE_MAP.put("fletching", List.of("runecraft", "slayer", "farming", "construction", "hunter", "sailing"));
        BASE_HIDE_MAP.put("woodcutting", List.of("slayer", "farming", "hunter", "sailing"));
        BASE_HIDE_MAP.put("runecraft", List.of("construction", "hunter"));
        BASE_HIDE_MAP.put("slayer", List.of("hunter", "sailing"));
        BASE_HIDE_MAP.put("farming", List.of("hunter", "sailing"));
        BASE_HIDE_MAP.put("construction", List.of("runecraft", "slayer", "farming", "magic", "fletching", "woodcutting"));
        BASE_HIDE_MAP.put("hunter", List.of("slayer", "farming", "fletching", "woodcutting"));
        BASE_HIDE_MAP.put("sailing", List.of("slayer", "farming", "fletching", "woodcutting"));
        BASE_HIDE_MAP.put("total", List.of("construction", "hunter"));
    }

    @Inject
    public SkillLockOverlay(final SkillLockPlugin plugin, final Client client)
    {
        this.plugin = plugin;
        this.client = client;
        setPosition(OverlayPosition.DYNAMIC);
        setLayer(OverlayLayer.ABOVE_WIDGETS);
        loadLockImage();
        loadBackgroundImage();
    }


    @Override
    public Dimension render(Graphics2D graphics)
    {
        Widget skillWidget = client.getWidget(ComponentID.SKILLS_CONTAINER);
        // Visibility check
        if(!plugin.isSkillsTabOpen() || skillWidget == null|| skillWidget.isHidden() || backgroundImage == null || lockImage == null)
        {
            return null;
        }

        // Get live location of the widget (updates when sidebar opens/resizes)
        Point basePoint = skillWidget.getCanvasLocation();
        int baseX = basePoint.getX();
        int baseY = basePoint.getY() + 1;

        String hoverSkill = findHoverSkill(baseX, baseY);
        Set<String> hiddenSkills = getHiddenSkills(hoverSkill);
        boolean shiftDown = client.isKeyPressed(KeyCode.KC_SHIFT);

        if (skillFont == null)
        {
            skillFont = FontManager.getRunescapeBoldFont();
        }
        graphics.setFont(skillFont);

        for( SkillLocation loc : plugin.skillLocations )
        {
            // Calculate the ACTUAL screen position for this time
            int screenX = baseX + loc.x;
            int screenY = baseY + loc.y;

            if (hiddenSkills.contains(loc.name) || (loc.name.equals(hoverSkill) && shiftDown))
            {
                continue;
            }

            renderSkill(graphics,loc, screenX, screenY);
        }
        return null;
    }

    private void loadLockImage()
    {
        try (InputStream is = SkillLockOverlay.class.getResourceAsStream("/com/skilllock/lock.png"))
        {
            if (is == null)
            {
                log.error("lock.png not found! Check: src/main/resources/com/skilllock/lock.png");
                lockImage = null;
                return;
            }

            BufferedImage original = ImageIO.read(is);
            log.debug("Lock image loaded: {}x{}", original.getWidth(), original.getHeight());


            // Choose a target size that covers the numbers
            final int TARGET_W = 50;   // you can tweak this
            final int TARGET_H = 31;   // keep it square, or change to 32×28 etc.
            final int OFF_X = -10;     // best offset to center on numbers
            final int OFF_Y = -5;      // best offset to center on numbers


            // Create a new BufferedImage with transparency
            lockImage = new BufferedImage(TARGET_W, TARGET_H, BufferedImage.TYPE_INT_ARGB);

            // Draw the original image scaled smoothly onto the new canvas
            Graphics2D g2d = lockImage.createGraphics();
            g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION,
                    RenderingHints.VALUE_INTERPOLATION_BILINEAR);
            g2d.setRenderingHint(RenderingHints.KEY_RENDERING,
                    RenderingHints.VALUE_RENDER_QUALITY);
            g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING,
                    RenderingHints.VALUE_ANTIALIAS_ON);


            g2d.drawImage(original, OFF_X, OFF_Y, TARGET_W, TARGET_H, null);
            g2d.dispose();

            log.debug("Lock image loaded and resized to {}x{}", TARGET_W, TARGET_H);
        }
        catch (IOException e)
        {
            log.error("Failed to load or resize lock image", e);
            lockImage = null;
        }
    }

    private void loadBackgroundImage()
    {
        try (InputStream is = SkillLockOverlay.class.getResourceAsStream("/com/skilllock/background.png"))
        {
            if (is == null)
            {
                log.error("lock.png not found! Check: src/main/resources/com/skilllock/background.png");
                backgroundImage = null;
                return;
            }

            backgroundImage = ImageIO.read(is);
            log.debug("Background image loaded: {}x{}", backgroundImage.getWidth(), backgroundImage.getHeight());
        }
        catch (IOException e)
        {
            log.error("Failed to load or resize background image", e);
            backgroundImage = null;
        }
    }

    private void drawPulsingRingGlow(Graphics2D g, Rectangle bounds, long startTime) {
        long elapsed = System.currentTimeMillis() - startTime;
        if (elapsed >= GLOW_DURATION_MS) return;

        // Progress from 0.0 to 1.0 over the duration
        float progress = elapsed / (float) GLOW_DURATION_MS;

        // Create a smooth pulsing alpha using sine wave (breathes in/out)
        float pulsePhase = elapsed / 1000.0f * PULSE_SPEED * (float) Math.PI * 2;
        float pulse = (float) Math.sin(pulsePhase);
        pulse = (pulse + 1) / 2;  // Convert -1..1 → 0..1

        // Base alpha starts strong and fades out over duration
        int baseAlpha = (int) (180 * (1 - progress));  // 180 → 0
        int alpha = (int) (baseAlpha * (0.6f + 0.4f * pulse));  // Pulse between ~60% and 100% of base

        if (alpha <= 0) return;

        g.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

        Color glowColor = new Color(
                GLOW_COLOR.getRed(),
                GLOW_COLOR.getGreen(),
                GLOW_COLOR.getBlue(),
                Math.max(10, alpha)  // Minimum 10 to avoid full vanish
        );

        g.setColor(glowColor);
        g.setStroke(new BasicStroke(RING_THICKNESS, BasicStroke.CAP_ROUND, BasicStroke.JOIN_ROUND));

        // Inset rectangle to keep glow strictly inside bounds
        int x = bounds.x + INNER_PADDING;
        int y = bounds.y + INNER_PADDING;
        int width = bounds.width - 2 * INNER_PADDING;
        int height = bounds.height - 2 * INNER_PADDING;

        // Draw rounded rectangle ring
        g.drawRoundRect(x, y, width, height, 8, 8);
    }

    private String findHoverSkill(int baseX, int baseY)
    {
        Point mousePos = client.getMouseCanvasPosition();
        int mx = mousePos.getX();
        int my = mousePos.getY();

        for (SkillLocation loc : plugin.skillLocations)
        {
            // Calculate the screen bounds for this specific skill relative to the anchor (Skill Container)
            int sx = baseX + loc.x;
            int sy = baseY + loc.y;

            int width = loc.name.equals("total") ? TOTAL_LEVEL_WIDTH : RECT_WIDTH;
            int height = loc.name.equals("total") ? TOTAL_LEVEL_HEIGHT : RECT_HEIGHT;

            //Precise skill box bounds
            if (mx >= sx && mx <= sx + width && my >= sy && my <= sy + height)
            {
                return loc.name;
            }
        }
        return "";
    }

    private void applyDynamicBounds(String hoverSkill, Set<String> hidden, Rectangle bounds)
    {
        // 1. Side Boundary (Addition Logic)
        if (bounds.width >= SKILL_BOUNDARY_X)
        {
            switch(hoverSkill)
            {
                case "attack":
                    hidden.addAll(List.of("smithing", "fishing"));
                    break;
                case "strength":
                    hidden.addAll(List.of("fishing", "cooking"));
                    break;
                case "defence":
                    hidden.addAll(List.of("cooking", "firemaking"));
                    break;
                case "ranged":
                    hidden.addAll(List.of("firemaking", "woodcutting"));
                    break;
                case "prayer":
                    hidden.addAll(List.of("woodcutting", "farming"));
                    break;
                case "magic":
                    hidden.addAll(List.of("farming", "sailing"));
                    break;
                case "runecraft":
                case "total":
                    hidden.add("sailing");
                    break;
                case "hitpoints":
                case "mining":
                    hidden.addAll(List.of("strength", "defence"));
                    break;
                case "agility":
                case "smithing":
                    hidden.addAll(List.of("defence", "ranged"));
                    break;
                case "fishing":
                    hidden.addAll(List.of("ranged", "prayer"));
                    break;
                case "cooking":
                    hidden.addAll(List.of("prayer", "magic"));
                    break;
                case "crafting":
                case "firemaking":
                    hidden.addAll(List.of("magic", "runecraft"));
                    break;
                case "woodcutting":
                    hidden.addAll(List.of("runecraft", "construction"));
                    break;
                case "slayer":
                case "farming":
                    hidden.add("construction");
                    break;
                case "hunter":
                case "sailing":
                    hidden.addAll(List.of("runecraft", "magic"));
                    break;
            }
        }
        // 2. Height Boundary (Removal Logic)
        if (bounds.height <= SKILL_BOUNDARY_Y )
        {
            switch (hoverSkill) {
                case "attack":
                case "hitpoints":
                case "mining":
                    hidden.removeAll(List.of("defence", "herblore", "fishing"));
                    break;
                case "strength":
                case "agility":
                case "smithing":
                    hidden.removeAll(List.of("ranged", "thieving", "cooking"));
                    break;
                case "defence":
                case "herblore":
                case "fishing":
                    hidden.removeAll(List.of("prayer", "crafting", "firemaking"));
                    break;
                case "ranged":
                case "thieving":
                case "cooking":
                    hidden.removeAll(List.of("magic", "fletching", "woodcutting"));
                    break;
                case "prayer":
                case "crafting":
                case "firemaking":
                    hidden.removeAll(List.of("runecraft", "slayer", "farming"));
                    break;
                case "magic":
                case "fletching":
                case "woodcutting":
                    hidden.removeAll(List.of("construction", "hunter", "sailing"));
                    break;
                case "construction":
                case "hunter":
                case "sailing":
                    hidden.removeAll(List.of("magic", "fletching", "woodcutting"));
                    break;
            }
        }
    }

    private void renderSkill(Graphics2D graphics, SkillLocation loc, int screenX, int screenY)
    {
        Point canvasPoint = new Point(screenX + OFFSET_X,screenY + OFFSET_Y);
        // Draw background
        if (loc.level > 0 || loc.isLocked)
        {
            OverlayUtil.renderImageLocation(graphics,canvasPoint,backgroundImage);
        }

        if (loc.isLocked)
        {
            // Greyscale the widget
            graphics.setColor(GREYSCALE_FILL);
            graphics.fillRect(screenX,screenY,RECT_WIDTH,RECT_HEIGHT);
            // Draw the lock image over the greyscale
            OverlayUtil.renderImageLocation(graphics,canvasPoint,lockImage);
        }
        else if (loc.level > 0)
        {
            // Text Calculation
            String text = String.valueOf(loc.level);
            FontMetrics fm = graphics.getFontMetrics();
            int textX = screenX + ((RECT_WIDTH + OFFSET_X - fm.stringWidth(text)) / 2);
            int textY = screenY + ((RECT_HEIGHT - OFFSET_Y + 2 + fm.getHeight()) / 2);

            // Shadow
            graphics.setColor(Color.BLACK);
            graphics.drawString(text, textX + 1, textY + 1);
            // Main Yellow Text
            graphics.setColor(Color.YELLOW);
            graphics.drawString(text, textX, textY);
        }

        // Glow logic
        Long startTime = plugin.getGlowingSkills().get(loc.name);
        if (startTime != null)
        {
            Rectangle bounds = new Rectangle(screenX, screenY, RECT_WIDTH, RECT_HEIGHT);
            drawPulsingRingGlow(graphics, bounds, startTime);
        }
    }

    private Set<String> getHiddenSkills(String hoverSkill)
    {
        if (hoverSkill.isEmpty() || client.isMenuOpen())
        {
            return Collections.emptySet();
        }

        Widget tooltip = client.getWidget(XP_TOOLTIP_ID);
        if (tooltip == null || tooltip.isHidden())
        {
            return Collections.emptySet();
        }

        // Initialize the set with base values
        Set<String> hidden = new HashSet<>(BASE_HIDE_MAP.getOrDefault(hoverSkill, Collections.emptyList()));

        // Apply the dynamic logic via helper function
        applyDynamicBounds(hoverSkill, hidden, tooltip.getBounds());

        return hidden;
    }
}

package com.skilllock;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.MenuAction;
import net.runelite.api.MenuEntry;
import net.runelite.api.Skill;
import net.runelite.api.events.ClientTick;
import net.runelite.api.events.MenuOpened;
import net.runelite.api.widgets.ComponentID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.game.chatbox.ChatboxPanelManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.util.Text;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

@Slf4j
@PluginDescriptor(
	name = "Skill Lock"
)
public class SkillLockPlugin extends Plugin
{
	@Inject
	private Client client;

    @Inject
    private ChatboxPanelManager chatboxPanelManager;

    @Inject
    private ClientThread clientThread;

    @Inject
    private OverlayManager overlayManager;

    @Inject
    private SkillLockOverlay overlay;

    @Inject
    private ConfigManager configManager;

    private boolean skillsTabWasOpen = false;
    private static final List<Skill> SKILLS_UI_ORDER = List.of(
            Skill.ATTACK, Skill.HITPOINTS, Skill.MINING,
            Skill.STRENGTH, Skill.AGILITY, Skill.SMITHING,
            Skill.DEFENCE, Skill.HERBLORE, Skill.FISHING,
            Skill.RANGED, Skill.THIEVING, Skill.COOKING,
            Skill.PRAYER, Skill.CRAFTING, Skill.FIREMAKING,
            Skill.MAGIC, Skill.FLETCHING, Skill.WOODCUTTING,
            Skill.RUNECRAFT, Skill.SLAYER, Skill.FARMING,
            Skill.CONSTRUCTION, Skill.HUNTER, Skill.SAILING);
    @Getter
    private final Map<String, Long> glowingSkills = new ConcurrentHashMap<>();
    public List<SkillLocation> skillLocations =  new ArrayList<>();

    @Override
	protected void startUp() throws Exception
	{
		log.debug("Skill Lock started!");
        skillsTabWasOpen = false;
        skillLocations.clear();
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.debug("Skill Lock stopped!");
        skillLocations.clear();
        overlayManager.remove(overlay);
	}

    @Subscribe
    public void onMenuOpened (MenuOpened event)
    {
        addMenuOptions(event);
    }

    @Subscribe
    public void onClientTick(ClientTick event)
    {
        boolean currentlyOpen = isSkillsTabOpen();

        // ONLY runs if the state just changed from closed to open
        if (currentlyOpen && !skillsTabWasOpen)
        {
            // We check the location. If it's 0,0, the UI isn't ready, so we wait for the next tick.
            Widget skillContainer = client.getWidget(ComponentID.SKILLS_CONTAINER);
            if (skillContainer == null || skillContainer.getCanvasLocation().getX() <= 0)
            {
                return;
            }

            // NOW we calculate, because we know the X is not 0
            skillLocations = createSkillLocations();
            overlayManager.add(overlay);
            skillsTabWasOpen = true;
        }
        // ONLY runs if the state just changed from open to closed
        else if (!currentlyOpen && skillsTabWasOpen)
        {
            overlayManager.remove(overlay);
            skillsTabWasOpen = false;
        }
        // Cleanup glow
        glowingSkills.entrySet().removeIf( entry -> System.currentTimeMillis() - entry.getValue() > SkillLockOverlay.GLOW_DURATION_MS);
    }

    @Subscribe
    public void onConfigChanged(ConfigChanged event)
    {
        if (!event.getGroup().equals("skilllock"))
        {
            return;
        }

        String key = event.getKey();

        // Trigger a location refresh if a level was changed
        if (key.endsWith("_level"))
        {
            clientThread.invokeLater(() -> {
                if (skillsTabWasOpen)
                {
                    skillLocations = createSkillLocations();
                }
            });
            return;
        }

        // Handle sound and glow logic for toggling locks
        if (isSkillKey(key))
        {
            // Fetch the new state from the config
            boolean isLocked = getSkillLockState(key);

            if (isLocked)
            {
                Integer currentLevel = configManager.getConfiguration("skilllock",key+"_level",Integer.class);
                if (currentLevel != null && currentLevel != 0)
                {
                    // Update config immediately so it is ready for the refresh
                    configManager.setConfiguration("skilllock", key+"_level", 0);
                }
            }

            clientThread.invokeLater(() -> {
                if (isSkillsTabOpen())
                {
                    skillLocations = createSkillLocations();

                    // Handle visuals/sounds
                    if (isLocked)
                    {
                        client.playSoundEffect(1351); // Locked
                    }
                    else
                    {
                        client.playSoundEffect(1493); // Unlocked
                        glowingSkills.put(key, System.currentTimeMillis());
                    }
                }
            });
        }
    }

	@Provides
    SkillLockConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(SkillLockConfig.class);
	}

    private List<SkillLocation> createSkillLocations()
    {
        // Create an array list with the correct length
        List<SkillLocation> locations = new ArrayList<>();

        for (int i = 0; i< SKILLS_UI_ORDER.size(); i++ )
        {
            Skill skill = SKILLS_UI_ORDER.get(i);
            String skillName =  skill.getName().toLowerCase();
            // Fetch config value
            Integer level = configManager.getConfiguration("skilllock", skillName + "_level", Integer.class);
            boolean isLocked = getSkillLockState(skillName);

            // 3 columns, 8 rows
            int col = i % 3;
            int row = i / 3;

            int offX = col * SkillLockOverlay.RECT_WIDTH;
            int offY = row * SkillLockOverlay.RECT_HEIGHT;

            locations.add(new SkillLocation(skillName, offX, offY, (level == null ? 0 : level), isLocked));
            // Add total level to list
            if (skill.equals(Skill.CONSTRUCTION))
            {
                locations.add(new SkillLocation("total",offX + 2,offY + 30,0, false));
            }
        }
        return locations;
    }

    public boolean isSkillsTabOpen()
    {
        Widget skillsRoot = client.getWidget(ComponentID.SKILLS_CONTAINER);
        return skillsRoot != null && !skillsRoot.isHidden();
    }

    private void addMenuOptions(MenuOpened event)
    {
        MenuEntry[] entries = event.getMenuEntries();
        if (entries.length == 0)
        {
            return;
        }

        // Get the last entry
        MenuEntry lastEntry = entries[entries.length - 1];


        // Get the text from the Option
        String optionText = lastEntry.getOption();


        // Check if it's actually a skill guide entry
        if (!optionText.startsWith("View") || !optionText.endsWith("guide"))
        {
            return;
        }

        // Clean the text to get just the skill name
        String skillName = Text.removeTags(optionText)
                .replace("View ", "")
                .replace(" guide", "")
                .trim()
                .toLowerCase();

        Skill skill = findSkill(skillName);

        if (skill == null)
        {
            return;
        }

        // Create new "Lock/Unlock" entry
        client.createMenuEntry(-1)
                .setOption(getSkillLockState(skillName) ? "Unlock" : "Lock")
                .setTarget("<col=ff981f>" + skill.getName() + "</col> level")
                .setType(MenuAction.RUNELITE)
                .onClick(e -> toggleSkillLock(skillName));
        // Only add set entry if the skill is unlocked
        if (!getSkillLockState(skillName))
        {
            // Create new "Set" entry
            client.createMenuEntry(-1)
                    .setOption("Set")
                    .setTarget("<col=ff981f>" + skill.getName() + "</col> level")
                    .setType(MenuAction.RUNELITE)
                    .onClick(e -> openLevelInputDialog(skillName));
        }


    }

    private boolean getSkillLockState(String skill)
    {
        Boolean value = configManager.getConfiguration("skilllock", skill, Boolean.class);
        return Boolean.TRUE.equals(value);
    }

    // Helper function to find the SKill enum based on the name
    private Skill findSkill(String name)
    {
        for (Skill skill : Skill.values())
        {
            if (skill.getName().equalsIgnoreCase(name))
            {
                return skill;
            }
        }
        return null;
    }

    // Helper function to ensure we are only reacting to actual skill names
    private boolean isSkillKey(String key)
    {
        for (Skill skill : Skill.values()) {
            if (skill.getName().toLowerCase().equals(key)) return true;
        }
        return false;
    }

    private void toggleSkillLock(String skill)
    {
        boolean isLocked = !getSkillLockState(skill);

        // Update config
        configManager.setConfiguration("skilllock", skill, isLocked);

        log.debug("Toggled {} lock: {}", skill, isLocked ? "LOCKED" : "UNLOCKED");
    }

    private void openLevelInputDialog( String skillName)
    {
        boolean isLocked = getSkillLockState(skillName);
        AtomicInteger updatedLevel = new AtomicInteger();

        // Only allow if the skill is unlocked
        if (!isLocked)
        {
            clientThread.invokeLater( () ->
                    chatboxPanelManager.openTextInput("<col=ff9040>SkillLock</col> - Set level for <col=ffff00>" + skillName + "</col>")
                            .prompt("Enter 1-99 (or 0 to disable)")
                            .onDone( inputText ->
                            {
                                clientThread.invokeLater( () ->
                                {
                                    String value = inputText.trim();
                                    if (value.isEmpty())
                                    {
                                        return;
                                    }
                                    else
                                    {
                                        try
                                        {
                                            int level  = Integer.parseInt(value);
                                            if (level < 0 || level > 99)
                                            {
                                                client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Level must be 0-99 for " + skillName, null);
                                                return;
                                            }
                                            updatedLevel.set(level);
                                            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", skillName.substring(0,1).toUpperCase() + skillName.substring(1) + " level set to " + level, null);
                                        }
                                        catch (NumberFormatException e)
                                        {
                                            client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", "Invalid number for " + skillName, null);
                                            return;
                                        }

                                    }
                                    configManager.setConfiguration("skilllock", skillName+"_level", updatedLevel.get());
                                });
                            })
                            .build()
            );
        }
    }
}

package com.skilllock;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class SkillLockPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(SkillLockPlugin.class);
		RuneLite.main(args);
	}
}
