package com.esp32tracker.xptracker;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;

@ConfigGroup("esp32tracker")
public interface ESP32TrackerConfig extends Config
{
	@ConfigItem(
			keyName = "esp32IpAddress",
			name = "ESP32 IP Address",
			description = "Local network IP address of your ESP32 device (shown on ESP32 screen at startup)",
			position = 1
	)
	default String esp32IpAddress()
	{
		return "";
	}

	@ConfigSection(
			name = "Ignored Skills",
			description = "Select skills to exclude from tracking (they won't be sent to the ESP32)",
			position = 2
	)
	String ignoredSkillsSection = "ignoredSkills";

	@ConfigItem(keyName = "ignoreAttack", name = "Ignore Attack", description = "Don't track Attack", section = "ignoredSkills", position = 1)
	default boolean ignoreAttack() { return false; }

	@ConfigItem(keyName = "ignoreStrength", name = "Ignore Strength", description = "Don't track Strength", section = "ignoredSkills", position = 2)
	default boolean ignoreStrength() { return false; }

	@ConfigItem(keyName = "ignoreDefence", name = "Ignore Defence", description = "Don't track Defence", section = "ignoredSkills", position = 3)
	default boolean ignoreDefence() { return false; }

	@ConfigItem(keyName = "ignoreRanged", name = "Ignore Ranged", description = "Don't track Ranged", section = "ignoredSkills", position = 4)
	default boolean ignoreRanged() { return false; }

	@ConfigItem(keyName = "ignorePrayer", name = "Ignore Prayer", description = "Don't track Prayer", section = "ignoredSkills", position = 5)
	default boolean ignorePrayer() { return false; }

	@ConfigItem(keyName = "ignoreMagic", name = "Ignore Magic", description = "Don't track Magic", section = "ignoredSkills", position = 6)
	default boolean ignoreMagic() { return false; }

	@ConfigItem(keyName = "ignoreRunecraft", name = "Ignore Runecraft", description = "Don't track Runecraft", section = "ignoredSkills", position = 7)
	default boolean ignoreRunecraft() { return false; }

	@ConfigItem(keyName = "ignoreConstruction", name = "Ignore Construction", description = "Don't track Construction", section = "ignoredSkills", position = 8)
	default boolean ignoreConstruction() { return false; }

	@ConfigItem(keyName = "ignoreHitpoints", name = "Ignore Hitpoints", description = "Don't track Hitpoints", section = "ignoredSkills", position = 9)
	default boolean ignoreHitpoints() { return false; }

	@ConfigItem(keyName = "ignoreAgility", name = "Ignore Agility", description = "Don't track Agility", section = "ignoredSkills", position = 10)
	default boolean ignoreAgility() { return false; }

	@ConfigItem(keyName = "ignoreHerblore", name = "Ignore Herblore", description = "Don't track Herblore", section = "ignoredSkills", position = 11)
	default boolean ignoreHerblore() { return false; }

	@ConfigItem(keyName = "ignoreThieving", name = "Ignore Thieving", description = "Don't track Thieving", section = "ignoredSkills", position = 12)
	default boolean ignoreThieving() { return false; }

	@ConfigItem(keyName = "ignoreCrafting", name = "Ignore Crafting", description = "Don't track Crafting", section = "ignoredSkills", position = 13)
	default boolean ignoreCrafting() { return false; }

	@ConfigItem(keyName = "ignoreFletching", name = "Ignore Fletching", description = "Don't track Fletching", section = "ignoredSkills", position = 14)
	default boolean ignoreFletching() { return false; }

	@ConfigItem(keyName = "ignoreSlayer", name = "Ignore Slayer", description = "Don't track Slayer", section = "ignoredSkills", position = 15)
	default boolean ignoreSlayer() { return false; }

	@ConfigItem(keyName = "ignoreHunter", name = "Ignore Hunter", description = "Don't track Hunter", section = "ignoredSkills", position = 16)
	default boolean ignoreHunter() { return false; }

	@ConfigItem(keyName = "ignoreMining", name = "Ignore Mining", description = "Don't track Mining", section = "ignoredSkills", position = 17)
	default boolean ignoreMining() { return false; }

	@ConfigItem(keyName = "ignoreSmithing", name = "Ignore Smithing", description = "Don't track Smithing", section = "ignoredSkills", position = 18)
	default boolean ignoreSmithing() { return false; }

	@ConfigItem(keyName = "ignoreFishing", name = "Ignore Fishing", description = "Don't track Fishing", section = "ignoredSkills", position = 19)
	default boolean ignoreFishing() { return false; }

	@ConfigItem(keyName = "ignoreCooking", name = "Ignore Cooking", description = "Don't track Cooking", section = "ignoredSkills", position = 20)
	default boolean ignoreCooking() { return false; }

	@ConfigItem(keyName = "ignoreFiremaking", name = "Ignore Firemaking", description = "Don't track Firemaking", section = "ignoredSkills", position = 21)
	default boolean ignoreFiremaking() { return false; }

	@ConfigItem(keyName = "ignoreWoodcutting", name = "Ignore Woodcutting", description = "Don't track Woodcutting", section = "ignoredSkills", position = 22)
	default boolean ignoreWoodcutting() { return false; }

	@ConfigItem(keyName = "ignoreFarming", name = "Ignore Farming", description = "Don't track Farming", section = "ignoredSkills", position = 23)
	default boolean ignoreFarming() { return false; }

	@ConfigItem(keyName = "ignoreSailing", name = "Ignore Sailing", description = "Don't track Sailing", section = "ignoredSkills", position = 24)
	default boolean ignoreSailing() { return false; }
}
package com.esp32tracker.xptracker;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.Skill;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.events.StatChanged;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDependency;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.plugins.xptracker.XpTrackerPlugin;
import net.runelite.client.plugins.xptracker.XpTrackerService;
import okhttp3.*;

import java.io.IOException;
import java.util.concurrent.TimeUnit;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@PluginDescriptor(
		name = "ESP32 XP Tracker",
		description = "Sends real-time XP tracking data to an ESP32 device with TFT display. Displays skill progress, XP/hour, actions/hour, and time to level on external hardware.",
		tags = {"xp", "tracker", "esp32", "display", "hardware", "iot"}
)
@PluginDependency(XpTrackerPlugin.class)
public class ESP32TrackerPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private ESP32TrackerConfig config;

	@Inject
	private XpTrackerService xpTrackerService;

	@Inject
	private OkHttpClient httpClient; // Injected

	@Inject
	private com.google.gson.Gson gson; // Injected

	private Skill lastSkill = null;
	private long lastUpdateTime = 0;
	private static final long UPDATE_DELAY_MS = 1000; // 1 per second
	private boolean pendingUpdate = false;
	private Skill pendingSkill = null;

	private final Map<Skill, Integer> skillStartXp = new HashMap<>();

	@Override
	protected void startUp() throws Exception
	{
		if (!config.esp32IpAddress().isEmpty())
		{
			testConnection();
		}
	}

	@Override
	protected void shutDown() throws Exception
	{
		lastSkill = null;
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged gameStateChanged)
	{
		if (gameStateChanged.getGameState() == GameState.LOGIN_SCREEN)
		{
			lastSkill = null;
			skillStartXp.clear();
		}
	}

	@Subscribe
	public void onStatChanged(StatChanged statChanged)
	{
		Skill skill = statChanged.getSkill();
		if (isSkillIgnored(skill))
		{
			return;
		}

		if (!skillStartXp.containsKey(skill))
		{
			skillStartXp.put(skill, client.getSkillExperience(skill));
		}

		lastSkill = skill;
		pendingUpdate = true;
		pendingSkill = skill;
	}

	private boolean isSkillIgnored(Skill skill)
	{
		switch (skill)
		{
			case ATTACK: return config.ignoreAttack();
			case STRENGTH: return config.ignoreStrength();
			case DEFENCE: return config.ignoreDefence();
			case RANGED: return config.ignoreRanged();
			case PRAYER: return config.ignorePrayer();
			case MAGIC: return config.ignoreMagic();
			case RUNECRAFT: return config.ignoreRunecraft();
			case CONSTRUCTION: return config.ignoreConstruction();
			case HITPOINTS: return config.ignoreHitpoints();
			case AGILITY: return config.ignoreAgility();
			case HERBLORE: return config.ignoreHerblore();
			case THIEVING: return config.ignoreThieving();
			case CRAFTING: return config.ignoreCrafting();
			case FLETCHING: return config.ignoreFletching();
			case SLAYER: return config.ignoreSlayer();
			case HUNTER: return config.ignoreHunter();
			case MINING: return config.ignoreMining();
			case SMITHING: return config.ignoreSmithing();
			case FISHING: return config.ignoreFishing();
			case COOKING: return config.ignoreCooking();
			case FIREMAKING: return config.ignoreFiremaking();
			case WOODCUTTING: return config.ignoreWoodcutting();
			case FARMING: return config.ignoreFarming();
			case SAILING: return config.ignoreSailing();
			default: return false;
		}
	}

	@Subscribe
	public void onGameTick(net.runelite.api.events.GameTick gameTick)
	{
		if (config.esp32IpAddress().isEmpty()) return;

		Skill skillToUpdate = pendingUpdate ? pendingSkill : lastSkill;
		if (skillToUpdate == null) return;

		long currentTime = System.currentTimeMillis();
		if (currentTime - lastUpdateTime < UPDATE_DELAY_MS) return;
		lastUpdateTime = currentTime;

		ESP32SkillData skillData = buildSkillData(skillToUpdate);
		sendToESP32(skillData);

		pendingUpdate = false;
	}

	private ESP32SkillData buildSkillData(Skill skill)
	{
		ESP32SkillData data = new ESP32SkillData();
		int currentXp = client.getSkillExperience(skill);
		int currentLevel = client.getRealSkillLevel(skill);

		data.skill = skill.getName();
		data.xp = currentXp;
		data.level = currentLevel;
		data.boosted_level = client.getBoostedSkillLevel(skill);

		data.xp_hr = xpTrackerService.getXpHr(skill);
		data.actions_hr = xpTrackerService.getActionsHr(skill);
		data.time_to_level = xpTrackerService.getTimeTilGoal(skill);

		Integer startXp = skillStartXp.get(skill);
		data.xp_gained = (startXp != null) ? currentXp - startXp : 0;

		if (currentLevel < 99)
		{
			int currentLevelMinXp = net.runelite.api.Experience.getXpForLevel(currentLevel);
			int nextLevelXp = net.runelite.api.Experience.getXpForLevel(currentLevel + 1);
			data.progress_percent = (float)(currentXp - currentLevelMinXp) / (nextLevelXp - currentLevelMinXp) * 100f;
		}
		else
		{
			data.progress_percent = 100f;
		}

		return data;
	}

	private void sendToESP32(ESP32SkillData data)
	{
		String url = String.format("http://%s/update", config.esp32IpAddress());
		String json = gson.toJson(data);

		// âœ… Corrected for OkHttp 4.x
		RequestBody body = RequestBody.create(
				MediaType.get("application/json"),
				json
		);

		Request request = new Request.Builder()
				.url(url)
				.post(body)
				.build();

		httpClient.newCall(request).enqueue(new Callback()
		{
			@Override
			public void onFailure(Call call, IOException e) { }

			@Override
			public void onResponse(Call call, Response response) { response.close(); }
		});
	}

	private void testConnection()
	{
		String url = String.format("http://%s/", config.esp32IpAddress());
		Request request = new Request.Builder().url(url).get().build();

		httpClient.newCall(request).enqueue(new Callback()
		{
			@Override
			public void onFailure(Call call, IOException e) { }

			@Override
			public void onResponse(Call call, Response response) { response.close(); }
		});
	}

	@Provides
	ESP32TrackerConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(ESP32TrackerConfig.class);
	}

	private static class ESP32SkillData
	{
		String skill;
		int xp;
		int level;
		int boosted_level;
		int xp_hr;
		int actions_hr;
		int xp_gained;
		String time_to_level;
		float progress_percent;
	}
}
package com.esp32tracker;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ExamplePluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(ESP32TrackerPlugin.class);
		RuneLite.main(args);
	}
}
