package soulflamehorn;

import net.runelite.client.config.*;

import java.awt.*;

@ConfigGroup("soulflamehorn")
public interface SoulflameHornConfig extends Config {

    // General Settings Section

    @ConfigSection(
            name = "General Settings",
            description = "General settings.",
            position = 0
    )
    String generalSettingsSection = "generalSettings";

    @ConfigItem(
            keyName = "enableBattlecry",
            name = "Enable Battlecry",
            description = "Display a message over the player using the horn special attack.",
            section = generalSettingsSection,
            position = 0
    )
    default boolean enableBattlecry() { return true; }

    @ConfigItem(
            keyName = "specShout",
            name = "Battlecry Text",
            description = "The displayed message when battlecry is enabled.",
            section = generalSettingsSection,
            position = 1
    )
    default String battlecryMessage() {return "Tuturu!";}

    // Overlay Settings Section

    @ConfigSection(
            name = "Overlay",
            description = "Overlay settings.",
            position = 1
    )
    String overlaySettingsSection = "overlaySettings";

    @ConfigItem(
            keyName = "displayInfobox",
            name = "Display Buff Infobox",
            description = "Show the Soulflame Horn infobox.",
            section = overlaySettingsSection,
            position = 0
    )
    default boolean displayInfobox() { return true; }

    @ConfigItem(
            keyName = "enableOverlay",
            name = "Display Buff Panel",
            description = "Show the Soulflame Horn buff panel. Doesn't flag the buff as used if you are on defensive stance.",
            section = overlaySettingsSection,
            position = 1
    )
    default boolean displayPanel() { return false; }

    @ConfigItem(
            keyName = "displayHornRadius",
            name = "Display Horn Radius",
            description = "Display the currently configured horn radius in the panel.",
            section = overlaySettingsSection,
            position = 2
    )
    default boolean displayHornRadius() { return false; }

    @ConfigItem(
            keyName = "displayMaxPlayers",
            name = "Display Max Players",
            description = "Display the currently configured max players in the panel.",
            section = overlaySettingsSection,
            position = 3
    )
    default boolean displayMaxPlayers() { return false; }

    @ConfigItem(
            keyName = "colour",
            name = "Colour",
            description = "Colour of the text in the panel.",
            section = overlaySettingsSection,
            position = 5
    )
    default Color messageColour() {return Color.GREEN;}

    @ConfigItem(
            keyName = "fontSize",
            name = "Font Size",
            description = "Size of the text in the panel.",
            section = overlaySettingsSection,
            position = 6
    )
    default int fontSize() {return 16;}

    @ConfigItem(
            keyName = "alwaysShowPanel",
            name = "Always Show Panel",
            description = "Always show the buff panel, even when the buff is not active.",
            section = overlaySettingsSection,
            position = 7
    )
    default boolean alwaysShowPanel() { return false; }

    // Sound Settings Section

    @ConfigSection(
            name = "Sound Settings",
            description = "Sound settings.",
            position = 2
    )
    String soundSettingsSection = "soundSettings";

    @ConfigItem(
            keyName = "enableSound",
            name = "Enable Sound",
            description = "Play a sound when the special attack is used.",
            section = soundSettingsSection,
            position = 0
    )
    default boolean enableSound() { return false; }

    @ConfigItem(
            keyName = "soundVolume",
            name = "Volume",
            description = "Volume of the horn sound.",
            section = soundSettingsSection,
            position = 1
    )
    @Range(max = 200)
    default int soundVolume() { return 50; }

    @ConfigItem(
            keyName = "enableCustomSound",
            name = "Enable Custom Sound",
            description = "Play a custom horn sound. Enable Sound must also be on.",
            section = soundSettingsSection,
            position = 2
    )
    default boolean enableCustomSound() { return false; }

    @ConfigItem(
            keyName = "customHornSoundFilename",
            name = "Custom Horn Sound Filename",
            description = "Name of a .wav file to play (must be placed in ~/.runelite/soulflamehorn). Include the .wav in the name when entering, for example hornsound.wav (name is case sensitive)",
            section = soundSettingsSection,
            position = 3
    )
    default String customHornSoundFilename() { return ""; }

    @ConfigItem(
            keyName = "enableSoundOnFail",
            name = "Enable Sound On Fail",
            description = "Play the horn sound even if the special attack fails, allowing you to test it out without other players around.",
            section = soundSettingsSection,
            position = 4
    )
    default boolean enableSoundOnFail() { return false; }
}

package soulflamehorn;

import net.runelite.client.ui.overlay.infobox.InfoBox;
import net.runelite.client.util.ColorUtil;

import javax.inject.Inject;
import java.awt.Color;
import java.awt.image.BufferedImage;

public class SoulflameHornInfobox extends InfoBox
{
    private final SoulflameHornPlugin plugin;
    private final SoulflameHornConfig config;

    @Inject
    SoulflameHornInfobox(BufferedImage image, SoulflameHornPlugin plugin, SoulflameHornConfig config)
    {
        super(image, plugin);
        this.plugin = plugin;
        this.config = config;
    }

    @Override
    public boolean render()
    {
        return config.displayInfobox() && (plugin.isEnticeBuffActive() || plugin.isSoulflameHornEquipped());
    }

    @Override
    public String getTooltip()
    {
        String buff = String.format("Soulflame Horn Buff: %s",
                plugin.isEnticeBuffActive()
                        ? ColorUtil.wrapWithColorTag("Active (" + plugin.getEnticeBuffTicks() + " ticks left)", Color.GREEN)
                        : ColorUtil.wrapWithColorTag("Inactive", Color.RED)
        );

        String radiusAndMaxPlayers = String.format("</br>Radius: %d</br>Max Players: %d",
                plugin.getRadius(),
                plugin.getMaxPlayers()
        );

        return String.format("%s%s", buff, plugin.isSoulflameHornEquipped() ? radiusAndMaxPlayers : "");
    }

    @Override
    public String getText()
    {
        if (plugin.isEnticeBuffActive())
        {
            return String.valueOf(plugin.getEnticeBuffTicks());
        }
        else
        {
            return "";
        }
    }

    @Override
    public Color getTextColor()
    {
        return Color.GREEN;
    }
}

package soulflamehorn;

import lombok.Setter;
import net.runelite.client.ui.overlay.OverlayPanel;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.LineComponent;

import javax.inject.Inject;
import java.awt.*;

@Setter
public class SoulflameHornOverlay extends OverlayPanel {
    private SoulflameHornPlugin plugin;
    private SoulflameHornConfig config;

    @Inject
    private SoulflameHornOverlay(SoulflameHornPlugin plugin, SoulflameHornConfig config)
    {
        super(plugin);
        this.plugin = plugin;
        this.config = config;
        setPosition(OverlayPosition.TOP_LEFT);
        setPriority(PRIORITY_MED);
    }

    @Override
    public Dimension render(Graphics2D graphics)
    {
        if (!config.displayPanel() || (!config.alwaysShowPanel() && !plugin.isEnticeBuffActive()))
        {
            return null;
        }
        Color colour = config.messageColour();

        graphics.setFont(new Font("Arial", Font.BOLD, config.fontSize()));

        panelComponent.getChildren().clear();

        // Soulflame Horn Buff Status
        panelComponent.getChildren().add(LineComponent.builder().left("Soulflame Horn").right(plugin.isEnticeBuffActive() ? String.valueOf(plugin.getEnticeBuffTicks()) : "").leftColor(colour).rightColor(colour).build());

        // Additional Info
        if (config.displayHornRadius())
        {
            panelComponent.getChildren().add(LineComponent.builder().left("Radius").right(String.valueOf(plugin.getRadius())).leftColor(colour).rightColor(colour).build());
        }

        if (config.displayMaxPlayers())
        {
            panelComponent.getChildren().add(LineComponent.builder().left("Max Players").right(String.valueOf(plugin.getMaxPlayers())).leftColor(colour).rightColor(colour).build());
        }

        return super.render(graphics);
    }
}

package soulflamehorn;

import com.google.inject.Provides;
import lombok.Getter;
import net.runelite.api.*;
import net.runelite.api.events.AnimationChanged;
import net.runelite.api.events.ChatMessage;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.StatChanged;
import net.runelite.api.gameval.AnimationID;
import net.runelite.api.gameval.VarbitID;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.game.ItemManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.ui.overlay.infobox.InfoBoxManager;
import net.runelite.client.audio.AudioPlayer;
import net.runelite.client.RuneLite;
import net.runelite.api.gameval.ItemID;
import net.runelite.api.gameval.InventoryID;

import javax.inject.Inject;
import javax.sound.sampled.LineUnavailableException;
import javax.sound.sampled.UnsupportedAudioFileException;

import lombok.extern.slf4j.Slf4j;

import java.io.*;

@PluginDescriptor(
        name = "Soulflame Horn Buff",
        description = "Shows a message and overlay for the Soulflame Horn special attack. Also plays a sound.",
        tags = {"combat", "buff", "special"}
)

@Slf4j
public class SoulflameHornPlugin extends Plugin
{
    @Inject
    private Client client;

    @Inject
    private InfoBoxManager infoboxManager;

    @Inject
    private OverlayManager overlayManager;

    @Inject
    private ItemManager itemManager;

    @Inject
    private SoulflameHornOverlay overlay;

    @Inject
    private SoulflameHornConfig config;

    @Inject
    private AudioPlayer audioPlayer;

    //directory for sounds
    private static final File SOULFLAME_HORN_DIR = new File(RuneLite.RUNELITE_DIR.getPath() + File.separator + "soulflamehorn");

    @Getter
    private int enticeBuffTicks = 0;

    @Getter
    private boolean enticeBuffActive = false;

    @Provides
    SoulflameHornConfig provideConfig(ConfigManager configManager)
    {
        return configManager.getConfig(SoulflameHornConfig.class);
    }

    @Override
    protected void startUp()
    {
        overlayManager.add(overlay);
        
        SoulflameHornInfobox infobox = new SoulflameHornInfobox(itemManager.getImage(ItemID.SOULFLAME_HORN), this, config);
        infoboxManager.addInfoBox(infobox);

        //create custom sound folder
        if (!SOULFLAME_HORN_DIR.exists() && !SOULFLAME_HORN_DIR.mkdirs())
        {
            log.warn("Failed to create sound directory at {}", SOULFLAME_HORN_DIR.getAbsolutePath());
        }
    }

    @Override
    protected void shutDown()
    {
        overlayManager.remove(overlay);
    }

    public boolean isSoulflameHornEquipped()
    {
        ItemContainer equipment = client.getItemContainer(InventoryID.WORN);
        if (equipment == null)
        {
            return false;
        }

        Item weapon = equipment.getItem(EquipmentInventorySlot.WEAPON.getSlotIdx());
        if (weapon == null)
        {
            return false;
        }

        return weapon.getId() == ItemID.SOULFLAME_HORN;
    }

    public int getRadius()
    {
        return client.getVarbitValue(VarbitID.YAMA_HORN_RADIUS);
    }

    public int getMaxPlayers()
    {
        return client.getVarbitValue(VarbitID.YAMA_HORN_MAX_PLAYERS);
    }

    @Subscribe
    public void onAnimationChanged(AnimationChanged event) {
        Actor actor = event.getActor();
        if (!(actor instanceof Player)) {
            return;
        }

        Player player = (Player) actor;

        if (player.equals(client.getLocalPlayer())) {
            return;
        }

        if (!config.enableBattlecry()) {
            return;
        }

        if (player.getAnimation() == AnimationID.SOULFLAME_HORN_BLOW_03) {
            player.setOverheadText(config.battlecryMessage());
            player.setOverheadCycle(120);
        }
    }

    @Subscribe
    public void onChatMessage(ChatMessage event)
    {
        if (event.getType() != ChatMessageType.GAMEMESSAGE) {
            return;
        }

        String specMessage = event.getMessage().toLowerCase();

        if (specMessage.contains("encourages you with their soulflame horn") || (specMessage.contains("you encourage nearby allies, which also empowers your next melee")))
        {
           enticeBuffActive = true;
           //10 ticks = 6 seconds
           enticeBuffTicks = 10;

            playHornSound();
        }

        if (specMessage.contains("you encourage nearby allies, which also empowers your next melee") && config.enableBattlecry())
        {
            Player player = client.getLocalPlayer();
            if (player != null)
            {
                player.setOverheadText(config.battlecryMessage());
                player.setOverheadCycle(120);
            }
        }

        if (specMessage.contains("you blow your horn into the wind. no-one nearby is able to listen") && config.enableSoundOnFail())
        {
            playHornSound();
        }
    }

    @Subscribe
    public void onStatChanged(StatChanged event) {
        if (!enticeBuffActive) {
            return;
        }
        Skill skill = event.getSkill();

        // clear buff on melee shit, not sure how to make it work for defensive. someone smarter than me can figure out how to clear the buff.
        if (skill == Skill.ATTACK || skill == Skill.STRENGTH){
            enticeBuffActive = false;
            enticeBuffTicks = 0;
        }
    }

    //countdown
    @Subscribe
    public void onGameTick(GameTick event)
    {
        if (enticeBuffActive)
        {
            enticeBuffTicks--;
            if (enticeBuffTicks <= 0)
            {
                enticeBuffActive = false;
            }
        }
    }


    private void playHornSound()
    {
        if (!config.enableSound())
        {
            return;
        }

        String defaultSoundFileName = "party-horn-68443.wav";
        String customSoundFileName = config.customHornSoundFilename().trim();
        float gain = 20f * (float) Math.log10(config.soundVolume() / 100f);

        if (!customSoundFileName.isEmpty() && config.enableCustomSound()) {
            playSound(customSoundFileName, gain);
        } else {
            playSound(defaultSoundFileName, gain);
        }
    }
    private void playSound(String fileName, float gain)
    {
        try {
            File soundFile = new File(SOULFLAME_HORN_DIR, fileName);
            audioPlayer.play(soundFile, gain);
        }
        catch (IOException | UnsupportedAudioFileException | LineUnavailableException e)
        {
            log.warn("Failed to play sound: {}", fileName, e);
        }
    }
}
package soulflamehorn;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class SoulflameHornTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(SoulflameHornPlugin.class);
		RuneLite.main(args);
	}
}
