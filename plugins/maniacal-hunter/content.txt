package com.maniacalhunter;

public enum DisplayMode
{
	SESSION_ONLY,
	AGGREGATE_ONLY,
	BOTH
}

package com.maniacalhunter;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;

@ConfigGroup("maniacalhunter")
public interface ManiacalHunterConfig extends Config
{
	@ConfigSection(
			name = "Display",
			description = "Configure which stats to display",
			position = 0
	)
	String displaySection = "display";


	@ConfigItem(
			keyName = "condensedMode",
			name = "Condensed Mode",
			description = "Display stats in an infobox.",
			section = displaySection
	)
	default boolean condensedMode()
	{
		return false;
	}

	@ConfigSection(
			name = "Auto Reset",
			description = "Automatically reset the session",
			position = 4
	)
	String autoResetSection = "autoReset";

	@ConfigItem(
			keyName = "autoResetMode",
			name = "Auto Reset Session",
			description = "Automatically reset the session upon entering or leaving the area",
			section = autoResetSection
	)
	default ResetMode autoResetMode()
	{
		return ResetMode.NEVER;
	}

	@ConfigItem(
			keyName = "showMonkeysCaught",
			name = "Show Monkeys Caught",
			description = "Show the total number of monkeys caught",
			section = displaySection
	)
	default boolean showMonkeysCaught()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showTrapsLaid",
			name = "Show Traps Laid",
			description = "Show the total number of traps laid",
			section = displaySection
	)
	default boolean showTrapsLaid()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showLastTrapStatus",
			name = "Show Last Trap Status",
			description = "Show the status of the last trap",
			section = displaySection
	)
	default boolean showLastTrapStatus()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showSuccessRate",
			name = "Show Success Rate",
			description = "Show the success rate of catching monkeys",
			section = displaySection
	)
	default boolean showSuccessRate()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showMonkeysPerHour",
			name = "Show Monkeys/Hour",
			description = "Show the number of monkeys caught per hour",
			section = displaySection
	)
	default boolean showMonkeysPerHour()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showPerfectTails",
			name = "Show Perfect Tails",
			description = "Show the number of perfect tails received",
			section = displaySection
	)
	default boolean showPerfectTails()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showDamagedTails",
			name = "Show Damaged Tails",
			description = "Show the number of damaged tails received",
			section = displaySection
	)
	default boolean showDamagedTails()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showLuck",
			name = "Show Luck",
			description = "Show your current luck in receiving a perfect tail",
			section = displaySection
	)
	default boolean showLuck()
	{
		return true;
	}

	@ConfigItem(
			keyName = "showAvgCatchTime",
			name = "Show Avg. Catch Time",
			description = "Show the average time to catch a monkey",
			section = displaySection
	)
	default boolean showAvgCatchTime()
	{
		return true;
	}

	@ConfigItem(
			keyName = "displayMode",
			name = "Display Mode",
			description = "Choose how to display stats in the overlay",
			position = 1,
			section = displaySection
	)
	default DisplayMode displayMode()
	{
		return DisplayMode.BOTH;
	}

	@ConfigSection(
			name = "Actions",
			description = "Perform actions on the session",
			position = 2
	)
	String actionsSection = "actions";

	@ConfigItem(
			keyName = "resetSessionButton",
			name = "Reset Session",
			description = "Reset the current session stats",
			section = actionsSection
	)
	default boolean resetSession()
	{
		return false;
	}

	@ConfigSection(
			name = "Notifications",
			description = "Configure notifications for milestones",
			position = 3
	)
	String notificationsSection = "notifications";

	@ConfigItem(
			keyName = "milestoneNotification",
			name = "Milestone Notification",
			description = "Notify when you reach a milestone of monkeys caught",
			section = notificationsSection
	)
	default boolean milestoneNotification()
	{
		return true;
	}

	@ConfigItem(
			keyName = "milestoneInterval",
			name = "Milestone Interval",
			description = "The interval at which to send a milestone notification",
			section = notificationsSection
	)
	default int milestoneInterval()
	{
		return 100;
	}

	@ConfigItem(
			keyName = "sessionStartTime",
			name = "Session Start Time",
			description = "The time the session started",
			hidden = true
	)
	default long getSessionStartTime()
	{
		return 0L;
	}

	@ConfigItem(
			keyName = "sessionStartTime",
			name = "Session Start Time",
			description = "The time the session started"
	)
	void setSessionStartTime(long time);

	@ConfigItem(
			keyName = "duration",
			name = "Duration",
			description = "The session duration in milliseconds",
			hidden = true
	)
	default long getDuration()
	{
		return 0L;
	}

	@ConfigItem(
			keyName = "duration",
			name = "Duration",
			description = "The session duration in milliseconds"
	)
	void setDuration(long time);

	@ConfigItem(
			keyName = "monkeysCaught",
			name = "Monkeys Caught",
			description = "The number of monkeys caught",
			hidden = true
	)
	default int getMonkeysCaught()
	{
		return 0;
	}

	@ConfigItem(
			keyName = "monkeysCaught",
			name = "Monkeys Caught",
			description = "The number of monkeys caught"
	)
	void setMonkeysCaught(int count);

	@ConfigItem(
			keyName = "trapsLaid",
			name = "Traps Laid",
			description = "The number of traps laid",
			hidden = true
	)
	default int getTrapsLaid()
	{
		return 0;
	}

	@ConfigItem(
			keyName = "trapsLaid",
			name = "Traps Laid",
			description = "The number of traps laid"
	)
	void setTrapsLaid(int count);

	@ConfigItem(
			keyName = "lastTrapStatus",
			name = "Last Trap Status",
			description = "The status of the last trap",
			hidden = true
	)
	default String getLastTrapStatus()
	{
		return "N/A";
	}

	@ConfigItem(
			keyName = "lastTrapStatus",
			name = "Last Trap Status",
			description = "The status of the last trap"
	)
	void setLastTrapStatus(String status);

	@ConfigItem(
			keyName = "perfectTails",
			name = "Perfect Tails",
			description = "The number of perfect tails",
			hidden = true
	)
	default int getPerfectTails()
	{
		return 0;
	}

	@ConfigItem(
			keyName = "perfectTails",
			name = "Perfect Tails",
			description = "The number of perfect tails"
	)
	void setPerfectTails(int count);

	@ConfigItem(
			keyName = "damagedTails",
			name = "Damaged Tails",
			description = "The number of damaged tails",
			hidden = true
	)
	default int getDamagedTails()
	{
		return 0;
	}

	@ConfigItem(
			keyName = "damagedTails",
			name = "Damaged Tails",
			description = "The number of damaged tails"
	)
	void setDamagedTails(int count);

	@ConfigItem(
			keyName = "damagedTailsSincePerfect",
			name = "Damaged Tails Since Perfect",
			description = "The number of damaged tails since the last perfect tail",
			hidden = true
	)
	default int getDamagedTailsSincePerfect()
	{
		return 0;
	}

	@ConfigItem(
			keyName = "damagedTailsSincePerfect",
			name = "Damaged Tails Since Perfect",
			description = "The number of damaged tails since the last perfect tail"
	)
	void setDamagedTailsSincePerfect(int count);
}

package com.maniacalhunter;

import com.google.common.collect.ImmutableSet;
import java.util.Set;

public class ManiacalHunterConstants
{
	// Item IDs
	public static final int DAMAGED_MONKEY_TAIL = 19665;
	public static final int PERFECT_MONKEY_TAIL = 19610;
	public static final int MANIACAL_ITEM_ID = 24864;

	// Object IDs
	public static final int UNSET_BOULDER_TRAP = 28824;
	public static final int SETTING_BOULDER_TRAP = 28825;
	public static final int SET_BOULDER_TRAP = 28827;
	public static final int TRIGGERED_BOULDER_TRAP_1 = 28828;
	public static final int TRIGGERED_BOULDER_TRAP_2 = 28829;
	public static final int CAUGHT_MONKEY_BOULDER_1 = 28830;
	public static final int CAUGHT_MONKEY_BOULDER_2 = 28831;
	public static final int LIFTED_BOULDER = 28833;

	// Region IDs
	public static final int MANIACAL_HUNTER_REGION = 11662;

	// Other
	public static final int MANIACAL_MONKEY_XP = 1000;

	public static final Set<Integer> BOULDER_TRAP_IDS = ImmutableSet.of(
		UNSET_BOULDER_TRAP,
		SETTING_BOULDER_TRAP,
		SET_BOULDER_TRAP,
		TRIGGERED_BOULDER_TRAP_1,
		TRIGGERED_BOULDER_TRAP_2,
		CAUGHT_MONKEY_BOULDER_1,
		CAUGHT_MONKEY_BOULDER_2,
		LIFTED_BOULDER
	);
}

package com.maniacalhunter;

public final class ManiacalHunterFormatting
{
	private ManiacalHunterFormatting()
	{
	}

	public static String formatStat(int session, int aggregate, DisplayMode displayMode)
	{
		switch (displayMode)
		{
			case SESSION_ONLY:
				return String.valueOf(session);
			case AGGREGATE_ONLY:
				return String.valueOf(aggregate);
			case BOTH:
			default:
				return String.format("%d (%d)", session, aggregate);
		}
	}

	public static String formatPercentage(double session, double aggregate, DisplayMode displayMode)
	{
		switch (displayMode)
		{
			case SESSION_ONLY:
				return String.format("%.2f%%", session);
			case AGGREGATE_ONLY:
				return String.format("%.2f%%", aggregate);
			case BOTH:
			default:
				return String.format("%.2f%% (%.2f%%)", session, aggregate);
		}
	}

	public static String formatDouble(double session, double aggregate, DisplayMode displayMode)
	{
		switch (displayMode)
		{
			case SESSION_ONLY:
				return String.format("%.2f", session);
			case AGGREGATE_ONLY:
				return String.format("%.2f", aggregate);
			case BOTH:
			default:
				return String.format("%.2f (%.2f)", session, aggregate);
		}
	}
}
package com.maniacalhunter;

import java.awt.Color;
import java.awt.image.BufferedImage;
import net.runelite.client.ui.overlay.infobox.InfoBox;

public class ManiacalHunterInfoBox extends InfoBox
{
	private final ManiacalHunterPlugin plugin;
	private final ManiacalHunterConfig config;

	public ManiacalHunterInfoBox(ManiacalHunterPlugin plugin, ManiacalHunterConfig config, BufferedImage image)
	{
		super(image, plugin);
		this.plugin = plugin;
		this.config = config;
	}

	@Override
	public String getText()
	{
		return String.valueOf(plugin.getSession().getMonkeysCaught());
	}

	@Override
	public Color getTextColor()
	{
		return Color.WHITE;
	}

	@Override
	public String getTooltip()
	{
		ManiacalHunterSession session = plugin.getSession();
		ManiacalHunterSession aggregateSession = plugin.getAggregateSession();
		StringBuilder sb = new StringBuilder();
		sb.append("Maniacal Hunter");

		if (config.showMonkeysCaught()) {
			sb.append("</br>");
			sb.append("Monkeys Caught: ").append(ManiacalHunterFormatting.formatStat(session.getMonkeysCaught(), aggregateSession.getMonkeysCaught(), config.displayMode()));
		}

		if (config.showTrapsLaid()) {
			sb.append("</br>");
			sb.append("Traps Laid: ").append(ManiacalHunterFormatting.formatStat(session.getTrapsLaid(), aggregateSession.getTrapsLaid(), config.displayMode()));
		}

		if (config.showLastTrapStatus()) {
			sb.append("</br>");
			sb.append("Last Trap Status: ").append(session.getLastTrapStatus());
		}

		if (config.showSuccessRate()) {
			sb.append("</br>");
			sb.append("Success Rate: ").append(ManiacalHunterFormatting.formatPercentage(session.getSuccessRate(), aggregateSession.getSuccessRate(), config.displayMode()));
		}

		if (config.showMonkeysPerHour()) {
			sb.append("</br>");
			sb.append("Monkeys/Hour: ").append(ManiacalHunterFormatting.formatDouble(session.getMonkeysPerHour(), aggregateSession.getMonkeysPerHour(), config.displayMode()));
		}

		if (config.showPerfectTails()) {
			sb.append("</br>");
			sb.append("Perfect Tails: ").append(ManiacalHunterFormatting.formatStat(session.getPerfectTails(), aggregateSession.getPerfectTails(), config.displayMode()));
		}

		if (config.showDamagedTails()) {
			sb.append("</br>");
			sb.append("Damaged Tails: ").append(ManiacalHunterFormatting.formatStat(session.getDamagedTails(), aggregateSession.getDamagedTails(), config.displayMode()));
		}

		if (config.showLuck()) {
			sb.append("</br>");
			sb.append("Luck: ").append(ManiacalHunterFormatting.formatPercentage(session.getLuckPercentage(), aggregateSession.getLuckPercentage(), config.displayMode()));
		}

		if (config.showAvgCatchTime()) {
			sb.append("</br>");
			sb.append("Avg. Catch Time: ").append(String.format("%.2fs", session.getAverageTimePerCatch()));
		}

		return sb.toString();
	}
}

package com.maniacalhunter;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics2D;
import javax.inject.Inject;

import net.runelite.api.Client;
import net.runelite.client.ui.overlay.OverlayPanel;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.LineComponent;
import net.runelite.client.ui.overlay.components.TitleComponent;

public class ManiacalHunterOverlay extends OverlayPanel
{
	private final ManiacalHunterPlugin plugin;
	private final ManiacalHunterConfig config;
	private final Client client;

	@Inject
	private ManiacalHunterOverlay(ManiacalHunterPlugin plugin, ManiacalHunterConfig config, Client client)
	{
		super(plugin);
		this.plugin = plugin;
		this.config = config;
		this.client = client;
		setPosition(OverlayPosition.TOP_LEFT);
	}

	private boolean isInManiacalHunterArea()
	{
		return client.getLocalPlayer() != null && client.getLocalPlayer().getWorldLocation().getRegionID() == ManiacalHunterConstants.MANIACAL_HUNTER_REGION;
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		if (!isInManiacalHunterArea())
		{
			return null;
		}
		ManiacalHunterSession session = plugin.getSession();
		ManiacalHunterSession aggregateSession = plugin.getAggregateSession();

		panelComponent.getChildren().clear();

		panelComponent.getChildren().add(TitleComponent.builder()
			.text("Maniacal Hunter")
			.color(Color.WHITE)
			.build());

		if (config.showMonkeysCaught()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Monkeys Caught:")
				.right(ManiacalHunterFormatting.formatStat(session.getMonkeysCaught(), aggregateSession.getMonkeysCaught(), config.displayMode()))
				.build());
		}

		if (config.showTrapsLaid()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Traps Laid:")
				.right(ManiacalHunterFormatting.formatStat(session.getTrapsLaid(), aggregateSession.getTrapsLaid(), config.displayMode()))
				.build());
		}

		if (config.showLastTrapStatus()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Last Trap Status:")
				.right(session.getLastTrapStatus())
				.build());
		}

		if (config.showSuccessRate()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Success Rate:")
				.right(ManiacalHunterFormatting.formatPercentage(session.getSuccessRate(), aggregateSession.getSuccessRate(), config.displayMode()))
				.build());
		}

		if (config.showMonkeysPerHour()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Monkeys/Hour:")
				.right(ManiacalHunterFormatting.formatDouble(session.getMonkeysPerHour(), aggregateSession.getMonkeysPerHour(), config.displayMode()))
				.build());
		}

		if (config.showPerfectTails()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Perfect Tails:")
				.right(ManiacalHunterFormatting.formatStat(session.getPerfectTails(), aggregateSession.getPerfectTails(), config.displayMode()))
				.build());
		}

		if (config.showDamagedTails()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Damaged Tails:")
				.right(ManiacalHunterFormatting.formatStat(session.getDamagedTails(), aggregateSession.getDamagedTails(), config.displayMode()))
				.build());
		}

		if (config.showLuck()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Luck:")
				.right(ManiacalHunterFormatting.formatPercentage(session.getLuckPercentage(), aggregateSession.getLuckPercentage(), config.displayMode()))
				.build());
		}

		if (config.showAvgCatchTime()) {
			panelComponent.getChildren().add(LineComponent.builder()
				.left("Avg. Catch Time:")
				.right(String.format("%.2fs", session.getAverageTimePerCatch()))
				.build());
		}

		return super.render(graphics);
	}
}

package com.maniacalhunter;

import com.google.inject.Provides;
import java.awt.image.BufferedImage;
import java.time.Duration;
import java.time.Instant;
import javax.inject.Inject;

import lombok.Getter;
import lombok.Setter;
import net.runelite.api.Client;
import net.runelite.api.GameObject;
import net.runelite.api.InventoryID;
import net.runelite.api.GameState;
import net.runelite.api.Skill;
import net.runelite.api.events.PlayerDespawned;
import net.runelite.api.events.PlayerSpawned;
import net.runelite.api.events.GameObjectSpawned;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.ItemContainerChanged;
import net.runelite.api.events.StatChanged;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.Notifier;
import net.runelite.client.game.ItemManager;
import net.runelite.client.ui.overlay.infobox.InfoBoxManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@PluginDescriptor(
	name = "Maniacal Hunter"
)
public class ManiacalHunterPlugin extends Plugin
{
	private static final Logger log = LoggerFactory.getLogger(ManiacalHunterPlugin.class);
	private static final String CONFIG_GROUP = "maniacalhunter";
	private static final String RESET_BUTTON_KEY = "resetSessionButton";
	private static final String CONDENSED_MODE_KEY = "condensedMode";

	@Getter
    private BufferedImage icon;

	@Inject
	private Client client;

	@Setter
    @Getter
    @Inject
	private Notifier notifier;

	@Inject
	private ManiacalHunterConfig config;

	@Inject
	private ConfigManager configManager;

    @Inject
    private ItemManager itemManager;

	@Inject
	private InfoBoxManager infoBoxManager;

	@Getter
	@Inject
	private ManiacalHunterSession session;

	@Getter
    private ManiacalHunterSession aggregateSession = new ManiacalHunterSession();

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private ManiacalHunterOverlay overlay;

	private ManiacalHunterInfoBox infoBox;

	private int lastPerfectTails = 0;
	private int lastDamagedTails = 0;
	private int catchesThisTick = 0;
	private int lastTick = 0;
	private int lastHunterXp = -1;
	private boolean inHunterArea = false;

	private void reset()
	{
		session.reset();
		catchesThisTick = 0;
		lastTick = 0;
        lastPerfectTails = 0;
        lastDamagedTails = 0;

		if (client.getGameState() == GameState.LOGGED_IN)
		{
			lastHunterXp = client.getSkillExperience(Skill.HUNTER);
		}
		else
		{
			lastHunterXp = -1;
		}
	}

	@Override
	protected void startUp() throws Exception
	{
		log.info("Maniacal Hunter started!");
		loadSession();
		icon = itemManager.getImage(ManiacalHunterConstants.MANIACAL_ITEM_ID);
		infoBox = new ManiacalHunterInfoBox(this, config, icon);
		updateDisplayMode();
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.info("Maniacal Hunter stopped!");
		infoBoxManager.removeInfoBox(infoBox);
		overlayManager.remove(overlay);
	}

	private void loadSession()
	{
		aggregateSession.setSessionStartTimeMillis(config.getSessionStartTime());
		aggregateSession.setDurationMillis(config.getDuration());
		aggregateSession.setMonkeysCaught(config.getMonkeysCaught());
		aggregateSession.setTrapsLaid(config.getTrapsLaid());
		aggregateSession.setLastTrapStatus(config.getLastTrapStatus());
		aggregateSession.setPerfectTails(config.getPerfectTails());
		aggregateSession.setDamagedTails(config.getDamagedTails());
		aggregateSession.setDamagedTailsSincePerfect(config.getDamagedTailsSincePerfect());
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged gameStateChanged)
	{
		if (gameStateChanged.getGameState() == GameState.LOGGED_IN)
		{
			lastHunterXp = client.getSkillExperience(Skill.HUNTER);
		}
	}

	@Subscribe
	public void onItemContainerChanged(ItemContainerChanged event)
	{
		if (!isInManiacalHunterArea() || event.getContainerId() != InventoryID.INVENTORY.getId())
		{
			return;
		}

		int currentPerfectTails = event.getItemContainer().count(ManiacalHunterConstants.PERFECT_MONKEY_TAIL);
		int currentDamagedTails = event.getItemContainer().count(ManiacalHunterConstants.DAMAGED_MONKEY_TAIL);

		int perfectTailsGained = currentPerfectTails - lastPerfectTails;
		int damagedTailsGained = currentDamagedTails - lastDamagedTails;

		if (catchesThisTick > 0 && (perfectTailsGained > 0 || damagedTailsGained > 0))
		{
			if (perfectTailsGained > 0)
			{
				handlePerfectTailGain();
			}
			if (damagedTailsGained > 0)
			{
				handleDamagedTailGain();
			}
			handleMonkeyCatch();
			catchesThisTick--;
		}

		lastPerfectTails = currentPerfectTails;
		lastDamagedTails = currentDamagedTails;
	}

	@Subscribe
	public void onGameTick(GameTick tick)
	{
  
        if (!isInManiacalHunterArea())
		{
			return;
		}
		if (client.getTickCount() != lastTick)
		{
			catchesThisTick = 0;
			lastTick = client.getTickCount();
        }
		if (session.getSessionStartTime() != null)
		{
			session.setDuration(Duration.between(session.getSessionStartTime(), Instant.now()));
		}
		if (aggregateSession.getSessionStartTime() != null)
		{
			aggregateSession.setDuration(Duration.between(aggregateSession.getSessionStartTime(), Instant.now()));
			config.setDuration(aggregateSession.getDurationMillis());
		}
	}

	@Subscribe
	public void onPlayerSpawned(PlayerSpawned event)
	{
		if (event.getPlayer() != client.getLocalPlayer())
		{
			return;
		}

		boolean currentlyInArea = isInManiacalHunterArea();
		if (currentlyInArea)
		{
			inHunterArea = true;
			if (config.autoResetMode() == ResetMode.ON_ENTER_AREA)
			{
				reset();
			}
		}
	}

	@Subscribe
	public void onPlayerDespawned(PlayerDespawned event)
	{
		if (event.getPlayer() != client.getLocalPlayer())
		{
			return;
		}

		if (inHunterArea)
		{
			if (config.autoResetMode() == ResetMode.ON_LEAVE_AREA)
			{
				reset();
			}
			inHunterArea = false;
		}
	}

	private boolean isInManiacalHunterArea()
	{
		return client.getLocalPlayer() != null && client.getLocalPlayer().getWorldLocation().getRegionID() == ManiacalHunterConstants.MANIACAL_HUNTER_REGION;
	}

	@Subscribe
	public void onStatChanged(StatChanged statChanged)
	{
		if (statChanged.getSkill() != Skill.HUNTER || !isInManiacalHunterArea())
		{
			return;
		}

		if (lastHunterXp == -1)
		{
			lastHunterXp = statChanged.getXp();
			return;
		}

		int currentXp = statChanged.getXp();
		int gainedXp = currentXp - lastHunterXp;

		if (gainedXp > 0 && gainedXp % ManiacalHunterConstants.MANIACAL_MONKEY_XP == 0)
		{
			catchesThisTick += gainedXp / ManiacalHunterConstants.MANIACAL_MONKEY_XP;
		}
		
		lastHunterXp = currentXp;

		if (gainedXp > 0)
		{
			if (session.getSessionStartTime() == null)
			{
				session.startSession();
			}

			if (aggregateSession.getSessionStartTime() == null)
			{
				aggregateSession.startSession();
				config.setSessionStartTime(aggregateSession.getSessionStartTimeMillis());
			}
		}
	}
  
	private static final int MAX_DISTANCE = 2;

	@Subscribe
	public void onGameObjectSpawned(GameObjectSpawned event)
	{
		if (!isInManiacalHunterArea())
		{
			return;
		}

		GameObject gameObject = event.getGameObject();
		if (gameObject == null
			|| !ManiacalHunterConstants.BOULDER_TRAP_IDS.contains(gameObject.getId())
			|| client.getLocalPlayer().getWorldLocation().distanceTo(gameObject.getWorldLocation()) > MAX_DISTANCE)
		{
			return;
		}
		int id = gameObject.getId();

		if (id == ManiacalHunterConstants.SET_BOULDER_TRAP)
		{
			handleTrapLaid();
		}
		else if (id == ManiacalHunterConstants.TRIGGERED_BOULDER_TRAP_1 || id == ManiacalHunterConstants.TRIGGERED_BOULDER_TRAP_2)
		{
			updateLastTrapStatus("Trap triggered");
		}
		else if (id == ManiacalHunterConstants.CAUGHT_MONKEY_BOULDER_1 || id == ManiacalHunterConstants.CAUGHT_MONKEY_BOULDER_2)
		{
			updateLastTrapStatus("Monkey caught");
		}
	}

	private void handleMonkeyCatch()
	{
		session.incrementMonkeysCaught();
		aggregateSession.incrementMonkeysCaught();
		config.setMonkeysCaught(aggregateSession.getMonkeysCaught());
		if (config.milestoneNotification() && session.getMonkeysCaught() > 0 && session.getMonkeysCaught() % config.milestoneInterval() == 0)
		{
			notifier.notify("Maniacal Hunter milestone: " + session.getMonkeysCaught() + " monkeys caught!");
		}
	}

	private void handlePerfectTailGain() {
		session.incrementPerfectTails();
		aggregateSession.incrementPerfectTails();
		config.setPerfectTails(aggregateSession.getPerfectTails());
		config.setDamagedTailsSincePerfect(aggregateSession.getDamagedTailsSincePerfect());
	}

	private void handleDamagedTailGain() {
		session.incrementDamagedTails();
		aggregateSession.incrementDamagedTails();
		config.setDamagedTails(aggregateSession.getDamagedTails());
		config.setDamagedTailsSincePerfect(aggregateSession.getDamagedTailsSincePerfect());
	}

	private void handleTrapLaid() {
		session.incrementTrapsLaid();
		aggregateSession.incrementTrapsLaid();
		config.setTrapsLaid(aggregateSession.getTrapsLaid());
		updateLastTrapStatus("Trap set");
	}

	private void updateLastTrapStatus(String status) {
		session.setLastTrapStatus(status);
		aggregateSession.setLastTrapStatus(status);
		config.setLastTrapStatus(aggregateSession.getLastTrapStatus());
	}

	@Provides
	ManiacalHunterConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(ManiacalHunterConfig.class);
	}

	@Provides
	ManiacalHunterSession provideSession()
	{
		return new ManiacalHunterSession();
	}

    @Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (!event.getGroup().equals(CONFIG_GROUP))
		{
			return;
		}
		if (event.getKey().equals(RESET_BUTTON_KEY))
		{
			if (config.resetSession())
			{
				reset();
				configManager.setConfiguration(CONFIG_GROUP, RESET_BUTTON_KEY, false);
			}
		}
		if (event.getKey().equals(CONDENSED_MODE_KEY))
		{
			updateDisplayMode();
		}
	}

	private void updateDisplayMode()
	{
		infoBoxManager.removeInfoBox(infoBox);
		overlayManager.remove(overlay);
		if (config.condensedMode())
		{
			infoBoxManager.addInfoBox(infoBox);
		}
		else
		{
			overlayManager.add(overlay);
		}
	}
}

package com.maniacalhunter;

import lombok.Getter;
import lombok.Setter;

import java.time.Duration;
import java.time.Instant;

public class ManiacalHunterSession
{
	private static final int PERFECT_TAIL_DROP_CHANCE = 5000;
	private static final double PERFECT_TAIL_DROP_RATE = 1.0 / PERFECT_TAIL_DROP_CHANCE;
	private static final double MILLIS_PER_HOUR = 3_600_000.0;
	private static final double MILLIS_PER_SECOND = 1_000.0;

    @Getter
	@Setter
    private long sessionStartTimeMillis;
	@Getter
	@Setter
    private long durationMillis;
	@Getter
	@Setter
    private int monkeysCaught;
	@Getter
	@Setter
    private int trapsLaid;
	@Getter
    @Setter
    private String lastTrapStatus;
	@Getter
	@Setter
    private int perfectTails;
	@Getter
	@Setter
    private int damagedTails;
	@Getter
	@Setter
	private int damagedTailsSincePerfect;

	public void startSession()
	{
		this.sessionStartTimeMillis = Instant.now().toEpochMilli();
	}

	public void reset()
	{
		this.sessionStartTimeMillis = 0;
		this.durationMillis = 0;
		this.monkeysCaught = 0;
		this.trapsLaid = 0;
		this.lastTrapStatus = "N/A";
		this.perfectTails = 0;
		this.damagedTails = 0;
		this.damagedTailsSincePerfect = 0;
	}

	public void incrementMonkeysCaught()
	{
		this.monkeysCaught++;
	}

	public void incrementTrapsLaid()
	{
		this.trapsLaid++;
	}

	public void incrementPerfectTails()
	{
		this.perfectTails++;
		this.damagedTailsSincePerfect = 0;
	}

	public void incrementDamagedTails()
	{
		this.damagedTails++;
		this.damagedTailsSincePerfect++;
	}

	public double getLuckPercentage()
	{
		if (damagedTailsSincePerfect == 0)
		{
			return 0;
		}
		// This calculates the probability of getting at least one perfect tail in N trials,
		// which is 1 minus the probability of getting zero perfect tails.
		return (1.0 - Math.pow(1.0 - PERFECT_TAIL_DROP_RATE, damagedTailsSincePerfect)) * 100;
	}

	public double getSuccessRate()
	{
		if (trapsLaid == 0)
		{
			return 0;
		}
		return (double) monkeysCaught / trapsLaid * 100;
	}

	public double getMonkeysPerHour()
	{
		if (durationMillis == 0)
		{
			return 0;
		}
		return (double) monkeysCaught / (durationMillis / MILLIS_PER_HOUR);
	}

	public double getAverageTimePerCatch()
	{
		if (monkeysCaught == 0 || durationMillis == 0)
		{
			return 0;
		}
		return (double) durationMillis / monkeysCaught / MILLIS_PER_SECOND;
	}

	public Instant getSessionStartTime()
	{
		return sessionStartTimeMillis == 0 ? null : Instant.ofEpochMilli(sessionStartTimeMillis);
	}

	public Duration getDuration()
	{
		return durationMillis == 0 ? null : Duration.ofMillis(durationMillis);
	}

	public void setDuration(Duration duration)
	{
		this.durationMillis = duration.toMillis();
	}
}

package com.maniacalhunter;

public enum ResetMode
{
	ON_ENTER_AREA,
	ON_LEAVE_AREA,
	NEVER
}

package com.maniacalhunter;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ManiacalHunterPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(ManiacalHunterPlugin.class);
		RuneLite.main(args);
	}
}
