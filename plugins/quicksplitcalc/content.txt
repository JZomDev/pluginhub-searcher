package com.QuickSplitCalc;

import net.runelite.api.Client;
import net.runelite.api.InventoryID;
import net.runelite.api.ItemID;
import net.runelite.api.MenuAction;
import net.runelite.api.events.MenuEntryAdded;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.chat.ChatMessageManager;
import net.runelite.client.chat.QueuedMessage;
import net.runelite.client.chat.ChatColorType;
import net.runelite.client.chat.ChatMessageBuilder;
import net.runelite.api.ChatMessageType;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.game.chatbox.ChatboxPanelManager;
import net.runelite.client.callback.ClientThread;
import com.google.inject.Provides;

import javax.inject.Inject;
import java.text.NumberFormat;
import java.util.Locale;


@PluginDescriptor(
        name = "QuickSplitCalc",
        description = "Calculate cash splits between multiple players",
        tags = {"cash", "split", "coins", "money"},
        configName = "QuickSplitCalc"
)
public class QuickSplitCalcPlugin extends Plugin {
    @Inject
    private Client client;

    @Inject
    private ChatMessageManager chatMessageManager;

    @Inject
    private QuickSplitCalcConfig config;

    @Inject
    private ChatboxPanelManager chatboxPanelManager;

    @Inject
    private ClientThread clientThread;

    @Provides
    QuickSplitCalcConfig provideConfig(ConfigManager configManager) {
        return configManager.getConfig(QuickSplitCalcConfig.class);
    }

    @Subscribe
    public void onMenuEntryAdded(MenuEntryAdded event) {
        if (event.getType() != MenuAction.CC_OP.getId() &&
                event.getType() != MenuAction.CC_OP_LOW_PRIORITY.getId()) {
            return;
        }

        // Check if it's the inventory interface (widget ID 149)
        if (event.getActionParam1() != 9764864) {
            return;
        }

        if (event.getItemId() == ItemID.COINS_995) {
            for (net.runelite.api.MenuEntry entry : client.getMenuEntries()) {
                if (entry.getOption().equals("Split")) {
                    return;
                }
            }

            net.runelite.api.Menu subMenu = client.createMenuEntry(-1)
                    .setOption("Split")
                    .setTarget(event.getTarget())
                    .setType(MenuAction.RUNELITE)
                    .setParam0(event.getActionParam0())
                    .setParam1(event.getActionParam1())
                    .createSubMenu();

            // Create quick split options
            createQuickSplitEntry(subMenu, 2, event);
            createQuickSplitEntry(subMenu, 3, event);
            createQuickSplitEntry(subMenu, 4, event);
            createQuickSplitEntry(subMenu, 5, event);

            // Create custom split option
            subMenu.createMenuEntry(0)
                    .setOption("X")
                    .setTarget("Players")
                    .setType(MenuAction.RUNELITE)
                    .onClick(menuEntry -> handleCustomSplit(menuEntry, event.getActionParam0()));
        }
    }


    private void createQuickSplitEntry(net.runelite.api.Menu parentMenu, int numPeople, MenuEntryAdded event) {
        parentMenu.createMenuEntry(0)
                .setOption(String.valueOf(numPeople))
                .setTarget("Players")
                .setType(MenuAction.RUNELITE)
                .onClick(menuEntry -> performSplit(event.getActionParam0(), numPeople));
    }

    private String formatNumber(int number, NumberFormat formatter, boolean isSplitAmount) {
        if (!config.roundedSplits() || !isSplitAmount) {
            return formatter.format(number);
        }

        if (number >= 1_000_000) {
            double millions = number / 1_000_000.0;
            return String.format("%.1fM", Math.floor(millions * 10) / 10);
        } else if (number >= 1_000) {
            double thousands = number / 1_000.0;
            return String.format("%.1fK", Math.floor(thousands * 10) / 10);
        }
        return formatter.format(number);
    }

    private void performSplit(int inventorySlot, int numPeople) {
        int stackSize = client.getItemContainer(InventoryID.INVENTORY).getItem(inventorySlot).getQuantity();
        NumberFormat formatter = NumberFormat.getInstance(Locale.US);

        int splitAmount = stackSize / numPeople;
        int remainder = stackSize % numPeople;

        // If rounding is enabled, calculate the actual remainder after rounding
        if (config.roundedSplits()) {
            // Calculate what the rounded display represents in actual coins
            int roundedValue;
            if (splitAmount >= 1_000_000) {
                // Round down to nearest 100K (0.1M)
                roundedValue = (splitAmount / 100_000) * 100_000;
            } else if (splitAmount >= 1_000) {
                // Round down to nearest 100 (0.1K)
                roundedValue = (splitAmount / 100) * 100;
            } else {
                roundedValue = splitAmount;
            }

            // The actual remainder is everything that can't be evenly distributed at the rounded amount
            remainder = stackSize - (roundedValue * numPeople);
        }

        String message = new ChatMessageBuilder()
                .append(ChatColorType. HIGHLIGHT)
                .append(formatNumber(stackSize, formatter, false))
                .append(ChatColorType.NORMAL)
                .append(" coins split between " + numPeople + " people: ")
                .append(ChatColorType.HIGHLIGHT)
                .append(formatNumber(splitAmount, formatter, true))
                .append(ChatColorType.NORMAL)
                .append(" coins each")
                .build();

        chatMessageManager.queue(QueuedMessage.builder()
                .type(ChatMessageType.CONSOLE)  // ← Changed from GAMEMESSAGE
                .runeLiteFormattedMessage(message)
                .build());

        if (remainder > 0) {
            String remainderMsg = new ChatMessageBuilder()
                    .append(ChatColorType.NORMAL)
                    .append("Remainder: ")
                    .append(ChatColorType.HIGHLIGHT)
                    .append(formatNumber(remainder, formatter, false) + " coins")
                    .build();

            chatMessageManager.queue(QueuedMessage.builder()
                    .type(ChatMessageType.CONSOLE)  // ← Changed from GAMEMESSAGE
                    .runeLiteFormattedMessage(remainderMsg)
                    .build());
        }
    }


    private void handleCustomSplit(net.runelite.api.MenuEntry menuEntry, int inventorySlot) {
        int stackSize = client.getItemContainer(InventoryID.INVENTORY).getItem(inventorySlot).getQuantity();
        NumberFormat formatter = NumberFormat.getInstance(Locale.US);

        clientThread.invokeLater(() -> {
            chatboxPanelManager.openTextInput("How many people to split between?")
                    .onDone((input) -> {
                        clientThread.invokeLater(() -> {
                            if (input == null || input.isEmpty()) {
                                return;
                            }

                            try {
                                int numPeople = Integer.parseInt(input);
                                if (numPeople > 0) {
                                    performSplit(inventorySlot, numPeople);
                                }
                            } catch (NumberFormatException e) {
                                // Invalid input
                            }
                        });
                        return true;
                    })
                    .build();
        });
    }
}

package com.QuickSplitCalc;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("cashsplit")
public interface QuickSplitCalcConfig extends Config
{

	@ConfigItem(
			keyName = "roundedSplits",
			name = "Rounded Splits",
			description = "Display split amounts in rounded format (e.g., 21.3M instead of 21,345,988)"
	)
	default boolean roundedSplits()
	{
		return false;
	}
}

package com.QuickSplitCalc;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class QuickSplitCalcTest
{
	public static void main(String[] args)
	{
		// Enable Java assertions for the system classloader before loading RuneLite classes.
		ClassLoader.getSystemClassLoader().setDefaultAssertionStatus(true);

		try
		{
			// Optional: set LWJGL native path if you know the natives location.
			// System.setProperty("org.lwjgl.librarypath", "C:\\path\\to\\lwjgl\\natives");

			ExternalPluginManager.loadBuiltin(QuickSplitCalcPlugin.class);
			RuneLite.main(args);
		}
		catch (Throwable t)
		{
			// Print full stacktrace so Gradle shows the cause.
			t.printStackTrace();
			// Do not call System.exit(1) here — let the test JVM exit normally so Gradle doesn't simply report a non-zero exit value.
		}
	}
}

