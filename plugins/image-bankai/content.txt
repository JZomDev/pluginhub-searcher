package com.imagebankai;

import com.google.inject.Provides;
import lombok.extern.slf4j.Slf4j;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import javax.inject.Inject;

@Slf4j
@PluginDescriptor(
		name = "Image Bankai"
)
public class ImageBankaiPlugin extends Plugin
{
	@Inject
	private OverlayManager overlayManager;

	@Inject
	private ImageOverlay overlay;

	@Override
	protected void startUp() throws Exception
	{
		overlayManager.add(overlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(overlay);
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (event.getGroup().equals("ImageBankai"))
		{
			overlay.onConfigChanged();
		}
	}

	@Provides
	ImageBankaiConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(ImageBankaiConfig.class);
	}
}

package com.imagebankai;

public enum OverlayMode
{
	Default("Default"),
	BehindInterface("Behind Interfaces"),
	AlwaysOnTop("Always On Top");

	private final String description;

	OverlayMode(String description)
	{
		this.description = description;
	}

	@Override
	public String toString()
	{
		return this.description;
	}
}

package com.imagebankai;

import net.runelite.client.RuneLite;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPanel;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.ComponentConstants;
import net.runelite.client.ui.overlay.components.ImageComponent;
import net.runelite.client.util.ImageUtil;

import javax.imageio.ImageIO;
import javax.inject.Inject;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.time.Instant;

public class ImageOverlay extends OverlayPanel
{
	private static final File CUSTOM_IMAGE_FILE = new File(RuneLite.RUNELITE_DIR, "profile.png");
	private static final File CUSTOM_IMAGE_FILE_FIX = new File(RuneLite.RUNELITE_DIR, "profile.png.png");

	private final ImageBankaiConfig _config;
	private final BufferedImage ErrorImage;

	private BufferedImage CustomImage;
	private BufferedImage Image;
	private Instant nextCheck;
	private boolean configChanged;

	@Inject
	private ImageOverlay(ImageBankaiPlugin plugin, ImageBankaiConfig config)
	{
		super(plugin);

		_config = config;

		setPriority(PRIORITY_LOW);
		setPosition(OverlayPosition.TOP_LEFT);
		setLayer(OverlayLayer.ABOVE_WIDGETS);

		ErrorImage = loadErrorImage();
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		if (shouldLoadCustomImage())
		{
			CustomImage = loadCustomImage();
			if (CustomImage == null)
			{
				if (nextCheck == null || configChanged)
				{
					Image = resizeImage(ErrorImage);
				}
				nextCheck = Instant.now().plusSeconds(1);
			} else
			{
				Image = resizeImage(CustomImage);
				nextCheck = null;
			}

			if (_config.transparentBackground())
			{
				panelComponent.setBackgroundColor(new Color(0, 0, 0, 0));
			} else
			{
				panelComponent.setBackgroundColor(ComponentConstants.STANDARD_BACKGROUND_COLOR);
			}

			switch (_config.overlayMode()) {
				case Default: {
					setLayer(OverlayLayer.ABOVE_WIDGETS);
					break;
				}
				case BehindInterface: {
					setLayer(OverlayLayer.ABOVE_SCENE);
					break;
				}
				case AlwaysOnTop: {
					setLayer(OverlayLayer.ALWAYS_ON_TOP);
					break;
				}
			}

			configChanged = false;
		}

		ImageComponent imageComponent = new ImageComponent(Image);

		panelComponent.getChildren().add(imageComponent);

		return super.render(graphics);
	}

	public void onConfigChanged()
	{
		configChanged = true;
	}

	private BufferedImage loadErrorImage()
	{
		return ImageUtil.loadImageResource(ImageBankaiPlugin.class, "/no_image.png");
	}

	private boolean shouldLoadCustomImage()
	{
		if (configChanged)
		{
			return true;
		}

		if (CustomImage != null)
		{
			return false;
		}

		var currentTime = Instant.now();
		return nextCheck == null || currentTime.isAfter(nextCheck);
	}

	private BufferedImage loadCustomImage()
	{
		try
		{
			var image = ImageIO.read(ImageOverlay.CUSTOM_IMAGE_FILE);
			if (image != null)
			{
				return image;
			}

			return ImageIO.read(ImageOverlay.CUSTOM_IMAGE_FILE_FIX);
		} catch (IOException e)
		{
			return null;
		}
	}

	private BufferedImage resizeImage(BufferedImage in)
	{
		var maxWidth = _config.minWidth();
		var maxHeight = _config.minHeight();

		return ImageUtil.resizeImage(in, maxWidth, maxHeight, true);
	}
}


package com.imagebankai;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("ImageBankai")
public interface ImageBankaiConfig extends Config
{
	@ConfigItem(
			keyName = "min",
			name = "Min Width",
			description = "The min width of the image, in pixels",
			position = 1
	)
	default int minWidth()
	{
		return 100;
	}

	@ConfigItem(
			keyName = "minHeight",
			name = "Min Height",
			description = "The min height of the image, in pixels",
			position = 2
	)
	default int minHeight()
	{
		return 100;
	}

	@ConfigItem(
			keyName = "transparentBackground",
			name = "Transparent Background",
			description = "If enabled, will have a transparent background. By default, uses Overlay color set in RuneLite plugin.",
			position = 3
	)
	default boolean transparentBackground() { return false; }

	@ConfigItem(
			keyName = "overlayMode",
			name = "Overlay Mode",
			description = "Behind Interfaces displays behind interfaces, i.e bank and map. Always On Top displays above everything.",
			position = 4
	)
	default OverlayMode overlayMode() { return OverlayMode.Default; }
}

package com.imagebankai;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ImageBankaiPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(ImageBankaiPlugin.class);
		RuneLite.main(args);
	}
}
