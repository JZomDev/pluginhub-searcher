package com.equipmentenforcer;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;

@ConfigGroup("equipmentenforcer")
public interface EquipmentEnforcerConfig extends Config
{

    @ConfigSection(
            name = "Attack Bonuses",
            description = "Set the minimum attack bonuses required for the item to be equipable. A value of 0 ignores the bonus.",
            position = 1
    )
    String attackBonuses = "attackBonuses";

	@ConfigItem(
		keyName = "attackCrush",
		name = "Crush",
		description = "The minimum crush attack bonus required for the item to be equipable.",
        section = attackBonuses,
        position = 2
	)
	default int attackCrush()
	{
		return 0;
	}

    @ConfigItem(
            keyName = "attackMagic",
            name = "Magic",
            description = "The minimum magic attack bonus required for the item to be equipable.",
            section = attackBonuses,
            position = 2
    )
    default int attackMagic()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attackRanged",
            name = "Ranged",
            description = "The minimum ranged attack bonus required for the item to be equipable.",
            section = attackBonuses,
            position = 3
    )
    default int attackRanged()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attackSlash",
            name = "Slash",
            description = "The minimum slash attack bonus required for the item to be equipable.",
            section = attackBonuses,
            position = 4
    )
    default int attackSlash()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attackSpeed",
            name = "Speed",
            description = "The minimum attack speed bonus required for the item to be equipable.",
            section = attackBonuses,
            position = 5
    )
    default int attackSpeed()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "attackStab",
            name = "Stab",
            description = "The minimum stab attack bonus required for the item to be equipable.",
            section = attackBonuses,
            position = 6
    )
    default int attackStab()
    {
        return 0;
    }

    @ConfigSection(
            name = "Defence Bonuses",
            description = "Set the minimum defence bonuses required for the item to be equipable. A value of 0 ignores the bonus.",
            position = 7
    )
    String defenceBonuses = "defenceBonuses";

    @ConfigItem(
            keyName = "defenceCrush",
            name = "Crush",
            description = "The minimum crush defence bonus required for the item to be equipable.",
            section = defenceBonuses,
            position = 8
    )
    default int defenceCrush()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defenceMagic",
            name = "Magic",
            description = "The minimum magic defence bonus required for the item to be equipable.",
            section = defenceBonuses,
            position = 9
    )
    default int defenceMagic()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defenceRanged",
            name = "Ranged",
            description = "The minimum ranged defence bonus required for the item to be equipable.",
            section = defenceBonuses,
            position = 10
    )
    default int defenceRanged()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defenceSlash",
            name = "Slash",
            description = "The minimum slash defence bonus required for the item to be equipable.",
            section = defenceBonuses,
            position = 11
    )
    default int defenceSlash()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "defenceStab",
            name = "Stab",
            description = "The minimum stab defence bonus required for the item to be equipable.",
            section = defenceBonuses,
            position = 12
    )
    default int defenceStab()
    {
        return 0;
    }

    @ConfigSection(
            name = "Strength Bonuses",
            description = "Set the minimum strength bonuses required for the item to be equipable. A value of 0 ignores the bonus.",
            position = 13
    )
    String strengthBonuses = "strengthBonuses";

    @ConfigItem(
            keyName = "magicDamage",
            name = "Magic",
            description = "The minimum magic damage bonus required for the item to be equipable.",
            section = strengthBonuses,
            position = 14
    )
    default double magicDamage()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "meleeStrength",
            name = "Melee",
            description = "The minimum melee strength bonus required for the item to be equipable.",
            section = strengthBonuses,
            position = 15
    )
    default int meleeStrength()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "rangedStrength",
            name = "Ranged",
            description = "The minimum ranged strength bonus required for the item to be equipable.",
            section = strengthBonuses,
            position = 14
    )
    default int rangedStrength()
    {
        return 0;
    }

    @ConfigSection(
            name = "Other",
            description = "Set the minimum bonuses required for the item to be equipable. A value of 0 ignores the bonus.",
            position = 15
    )
    String otherBonuses = "otherBonuses";

    @ConfigItem(
            keyName = "prayer",
            name = "Prayer",
            description = "The minimum prayer bonus required for the item to be equipable.",
            section = otherBonuses,
            position = 16
    )
    default int prayer()
    {
        return 0;
    }

    @ConfigItem(
            keyName = "weight",
            name = "Weight",
            description = "The minimum weight required for the item to be equipable.",
            section = otherBonuses,
            position = 16
    )
    default double weight()
    {
        return 0;
    }

}

package com.equipmentenforcer;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.MenuAction;
import net.runelite.api.MenuEntry;
import net.runelite.api.events.MenuEntryAdded;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.game.ItemEquipmentStats;
import net.runelite.client.game.ItemManager;
import net.runelite.client.game.ItemStats;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.util.Text;
import java.util.ArrayList;
import java.util.List;

@Slf4j
@PluginDescriptor(
	name = "Equipment Enforcer"
)
public class EquipmentEnforcerPlugin extends Plugin
{
	@Inject
	private Client client;

    @Inject
    private ItemManager itemManager;

	@Inject
	private EquipmentEnforcerConfig config;

	@Override
	protected void startUp() throws Exception
	{
		log.debug("Equipment Lock started!");
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.debug("Equipment Lock stopped!");
	}

    @Subscribe
    public void onMenuEntryAdded(MenuEntryAdded event)
    {

        // Make sure event is happening inside UI element like inventory, and it also has an itemID associated with it
        if (event.getType() != MenuAction.CC_OP.getId() || event.getItemId() == -1)
        {
            return;
        }

        // Check the text action after we know it's a valid item
        String option = Text.removeTags(event.getOption()).toLowerCase();
        boolean isEquipAction = option.equals("equip") || option.equals("wield") || option.equals("wear");

        if (isEquipAction)
        {
            // Get Item ID from the menu entry
            int itemId = event.getMenuEntry().getItemId();
            // Look up the item's stats
            ItemStats itemStats = itemManager.getItemStats(itemId);

            // If it is not a valid equipable item, remove the equip option from the menu and have "examine" as the left click option
            if (!isValidEquip(itemStats))
            {
                rewriteMenu(event.getMenuEntry());
            }
        }
    }


	@Provides
    EquipmentEnforcerConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(EquipmentEnforcerConfig.class);
	}

    // Checks all stats defined in config. Returns true if the item meets all requirements (or if requirements are 0). Returns false if item fails any check
    private boolean isValidEquip(ItemStats itemStats)
    {
        if (itemStats == null || !itemStats.isEquipable())
        {
            return true;
        }

        ItemEquipmentStats equipmentStats = itemStats.getEquipment();
        if (equipmentStats == null)
        {
            return true;
        }

        // Attack Bonuses
        if (failsCheck(config.attackCrush(), equipmentStats.getAcrush()))
        {
            log.debug("attackCrush failed check");
            return false;
        }
        if (failsCheck(config.attackMagic(), equipmentStats.getAmagic()))
        {
            log.debug("attackMagic failed check");
            return false;
        }
        if (failsCheck(config.attackRanged(), equipmentStats.getArange()))
        {
            log.debug("attackRanged failed check");
            return false;
        }
        if (failsCheck(config.attackSlash(), equipmentStats.getAslash()))
        {
            log.debug("attackSlash failed check");
            return false;
        }
        if (failsCheck(config.attackSpeed(), equipmentStats.getAspeed()))
        {
            log.debug("attackSpeed failed check");
            return false;
        }
        if (failsCheck(config.attackStab(), equipmentStats.getAstab()))
        {
            log.debug("attackStab failed check");
            return false;
        }

        // Defence Bonuses
        if (failsCheck(config.defenceCrush(), equipmentStats.getDcrush()))
        {
            log.debug("defenceCrush failed check");
            return false;
        }
        if (failsCheck(config.defenceMagic(), equipmentStats.getDmagic()))
        {
            log.debug("defenceMagic failed check");
            return false;
        }
        if (failsCheck(config.defenceRanged(), equipmentStats.getDrange()))
        {
            log.debug("defenceRanged failed check");
            return false;
        }
        if (failsCheck(config.defenceSlash(), equipmentStats.getDslash()))
        {
            log.debug("defenceSlash failed check");
            return false;
        }
        if (failsCheck(config.defenceStab(), equipmentStats.getDstab()))
        {
            log.debug("defenceStab failed check");
            return false;
        }

        // Strength Bonuses
        if (failsCheck(config.magicDamage(), equipmentStats.getMdmg()))
        {
            log.debug("magicDamage failed check");
            return false;
        }
        if (failsCheck(config.meleeStrength(), equipmentStats.getStr()))
        {
            log.debug("meleeStrength failed check");
            return false;
        }
        if (failsCheck(config.rangedStrength(), equipmentStats.getRstr()))
        {
            log.debug("rangedStrength failed check");
            return false;
        }

        // Other Bonuses
        if (failsCheck(config.prayer(), equipmentStats.getPrayer()))
        {
            log.debug("prayer failed check");
            return false;
        }
        if (failsCheck(config.weight(), itemStats.getWeight()))
        {
            log.debug("weight failed check");
            return false;
        }

        return true;
    }

    // Helper functions used to see if config check fails
    private boolean failsCheck(int required, int actual)
    {
        // "A value of 0 ignores the bonus."
        if (required == 0)
        {
            return false;
        }
        // Return true if actual stats are lower than required
        return actual < required;
    }

    private boolean failsCheck(double required, double actual)
    {
        // "A value of 0 ignores the bonus."
        if (required == 0)
        {
            return false;
        }
        // Return true if actual stats are lower than required
        return actual < required;
    }

    // Function to remove the "equip" option and replace the left click option with examine
    private void rewriteMenu(MenuEntry entryToRemove)
    {
        MenuEntry[] currentEntries = client.getMenuEntries();
        List<MenuEntry> newEntries = new ArrayList<>();
        MenuEntry examineEntry = null;

        for (MenuEntry entry : currentEntries)
        {
            if (entry == entryToRemove)
            {
                continue; // Skip the "Equip" option
            }

            String opt = Text.removeTags(entry.getOption()).toLowerCase();
            if (opt.equals("examine"))
            {
                examineEntry = entry; // Save examine for later
            }
            else
            {
                newEntries.add(entry);
            }
        }

        // Add Examine last (making it the default Left-Click)
        if (examineEntry != null)
        {
            newEntries.add(examineEntry);
        }

        client.setMenuEntries(newEntries.toArray(new MenuEntry[0]));

    }
}

package com.equipmentenforcer;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class EquipmentEnforcerPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(EquipmentEnforcerPlugin.class);
		RuneLite.main(args);
	}
}
