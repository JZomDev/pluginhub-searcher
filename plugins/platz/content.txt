package com.github.i.platz;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("platz")
public interface PlatzConfig extends Config
{
	@ConfigItem(
			keyName = "abbreviate",
			name = "Abbreviate large numbers values",
			description = "Abbreviate values (e.g. 2,147,483,647 is shown as 2.147B)"
	)
	default boolean abbreviate() { return false; }

	@ConfigItem(
			keyName = "threshold",
			name = "Abbreviation threshold",
			description = "Minimum value to abbreviate"
	)
	default Threshold threshold() { return Threshold._100m; }

	static enum Threshold {
		_1k,
		_10k,
		_100k,
		_1m,
		_10m,
		_100m,
		_1b,
		_max;

		long value() {
			switch (this) {
				case _1k: return 1000;
				case _10k: return 10_000;
				case _100k: return 100_000;
				case _1m: return 1_000_000;
				case _10m: return 10_000_000;
				case _100m: return 100_000_000;
				case _1b: return 1_000_000_000;
				case _max:
				default: return Integer.MAX_VALUE;
			}
		}

	}
}

package com.github.i.platz;

import com.google.common.annotations.VisibleForTesting;
import com.google.inject.Provides;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.InventoryID;
import net.runelite.api.Item;
import net.runelite.api.events.ItemContainerChanged;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.game.ItemManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;

import javax.inject.Inject;
import java.text.DecimalFormat;

@Slf4j
@PluginDescriptor(name = "platz")
public class PlatzPlugin extends Plugin {
	@Inject
	private Client client;

	@Inject
	private ItemManager itemManager;


	@Override
	protected void startUp() {
	}

	@Override
	protected void shutDown() {
	}

	@Inject
	PlatzConfig config;

	@Provides
	PlatzConfig provideConfig(ConfigManager configManager) {
		return configManager.getConfig(PlatzConfig.class);
	}

	private static final int MY_TRADE_VALUE_WIDGET_ID = 21954584;
	private static final int OTHER_TRADE_VALUE_WIDGET_ID = 21954587;
	private static final int PRICE_CHECKER_WIDGET_ID = 30408716;

	private boolean gePriceCheckOpen() {
		return client.getWidget(PRICE_CHECKER_WIDGET_ID) != null;
	}

	@Subscribe
	public void onItemContainerChanged(ItemContainerChanged event) {
		final int inventoryId = event.getContainerId();
		final int widgetIdToUpdate;
		final String template;

		if (gePriceCheckOpen() && inventoryId == InventoryID.TRADE.getId()) {
			widgetIdToUpdate = InterfaceID.GePricechecker.OUTPUT;
			template = PRICE_CHECK_TEMPLATE;
		} else if (inventoryId == InventoryID.TRADEOTHER.getId()) {
			widgetIdToUpdate = OTHER_TRADE_VALUE_WIDGET_ID;
			template = THEIR_OFFER_TEMPLATE;
		} else if (inventoryId == InventoryID.TRADE.getId()) {
			widgetIdToUpdate = MY_TRADE_VALUE_WIDGET_ID;
			template = YOUR_OFFER_TEMPLATE;
		} else {
			return;
		}

		var total = 0L;
		for (Item item : client.getItemContainer(inventoryId).getItems()) {
			total += (long) this.itemManager.getItemPrice(item.getId()) * (long) item.getQuantity();
		}

		setTradeValueText(widgetIdToUpdate, total, template);
	}

	private final String THEIR_OFFER_TEMPLATE = "Their offer:<br>(Value: <col=ffffff>%s</col> coins)";
	private final String YOUR_OFFER_TEMPLATE = "Your offer:<br>(Value: <col=ffffff>%s</col> coins)";
	private final String PRICE_CHECK_TEMPLATE = "Total guide price:<br><col=ffffff>%s</col>";

	private void setTradeValueText(int widgetId, long value, String template) {
		var formattedNumber = (this.config.abbreviate() && value > this.config.threshold().value())
				? abbreviateBigNumber(value)
				: String.format("%,d", value);

		var text = String.format(template, formattedNumber);
	 	client.getWidget(widgetId).setText(text);
	}

	private static String[] suffix = new String[]{"","K", "M", "B", "T"};
	private static final int MAX_SHORT_LENGTH = 4;

	@VisibleForTesting
	public static String abbreviateBigNumber(long number) {
		String r = new DecimalFormat("##0E0").format(number);
		r = r.replaceAll("E[0-9]", suffix[Character.getNumericValue(r.charAt(r.length() - 1)) / 3]);
		while (r.length() > MAX_SHORT_LENGTH || r.matches("[0-9]+\\.[a-z]")) {
			r = r.substring(0, r.length() - 2) + r.substring(r.length() - 1);
		}
		return r;
	}

}

package com.github.i.platz;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;
import org.junit.Assert;
import org.junit.Test;

public class AbbreviationTest {
	@Test
	public void testAbbreviations() {
		Assert.assertEquals("1", PlatzPlugin.abbreviateBigNumber(1L));
		Assert.assertEquals("12", PlatzPlugin.abbreviateBigNumber(12L));
		Assert.assertEquals("123", PlatzPlugin.abbreviateBigNumber(123L));
		Assert.assertEquals("1.23K", PlatzPlugin.abbreviateBigNumber(1_234L));
		Assert.assertEquals("12.3K", PlatzPlugin.abbreviateBigNumber(12_345L));
		Assert.assertEquals("123K", PlatzPlugin.abbreviateBigNumber(123_456L));
		Assert.assertEquals("1.23M", PlatzPlugin.abbreviateBigNumber(1_234_567L));
		Assert.assertEquals("12.3M", PlatzPlugin.abbreviateBigNumber(12_345_678L));
		Assert.assertEquals("123M", PlatzPlugin.abbreviateBigNumber(123_456_789L));
		Assert.assertEquals("1.23B", PlatzPlugin.abbreviateBigNumber(1_234_567_891L));
		Assert.assertEquals("12.3B", PlatzPlugin.abbreviateBigNumber(12_345_678_912L));
		Assert.assertEquals("123B", PlatzPlugin.abbreviateBigNumber(123_456_789_123L));
	}
}
package com.github.i.platz;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class PlatzPluginTest {
	public static void main(String[] args) throws Exception {
		ExternalPluginManager.loadBuiltin(PlatzPlugin.class);
		RuneLite.main(args);
	}
}
