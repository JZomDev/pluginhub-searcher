package info.sigterm.plugins.smevent;

import java.awt.Font;
import net.runelite.api.Player;
import net.runelite.api.RuneLiteObject;

public class SMPlayer
{
	Player player;
	PlayerConfig config;
	RuneLiteObject rlo;
	int rloHeight;
	Font font;
}

package info.sigterm.plugins.smevent;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("smevent")
public interface SMEventConfig extends Config
{
	@ConfigItem(
		keyName = "config",
		name = "Config",
		description = "Config"
	)
	default String config()
	{
		return "[]";
	}
}

package info.sigterm.plugins.smevent;

import java.awt.Color;

public class PlayerConfig
{
	String name;
	Color color;
	int textSize;
}

package info.sigterm.plugins.smevent;

import java.awt.Dimension;
import java.awt.Graphics2D;
import javax.inject.Inject;
import net.runelite.api.Client;
import net.runelite.api.JagexColor;
import net.runelite.api.Model;
import net.runelite.api.ModelData;
import net.runelite.api.Perspective;
import net.runelite.api.Player;
import net.runelite.api.Point;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.OverlayUtil;
import net.runelite.client.util.Text;

public class PlayerOverlay extends Overlay
{
	private final Client client;
	private final SMEvent plugin;

	@Inject
	private PlayerOverlay(Client client, SMEvent plugin)
	{
		this.client = client;
		this.plugin = plugin;
		setPosition(OverlayPosition.DYNAMIC);
		setPriority(PRIORITY_MED);
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		for (var entry : plugin.players.values())
		{
			render(graphics, entry);
		}
		return null;
	}

	private void render(Graphics2D graphics, SMPlayer p)
	{
		Player player = p.player;
		PlayerConfig config = p.config;

		updateRlo(p);
		updateFont(graphics, p);

		String name = player.getName();
		if (name == null)
		{
			return;
		}

		name = Text.sanitize(player.getName());
		int zOffset = player.getLogicalHeight() + 40;
		graphics.setFont(p.font);
		Point textLocation = player.getCanvasTextLocation(graphics, name, zOffset);
		if (textLocation != null)
		{
			OverlayUtil.renderTextLocation(graphics, textLocation, name, config.color);
		}
	}

	private void updateRlo(SMPlayer p)
	{
		Player player = p.player;
		PlayerConfig config = p.config;
		int animHeight = player.getAnimationHeightOffset();

		if (p.rlo != null && p.rloHeight == animHeight)
		{
			p.rlo.setLocation(player.getLocalLocation(), client.getPlane());
			return;
		}

		if (p.rlo != null)
		{
			p.rlo.setActive(false);
		}

		ModelData md = client.loadModelData(33196);
		if (md == null)
		{
			return;
		}

		var rlo = p.rlo = client.createRuneLiteObject();
		p.rloHeight = animHeight;
		rlo.setAnimation(client.loadAnimation(813));

		int h = player.getAnimationHeightOffset();
		h += 10;

		md.cloneVertices();
		md.translate(0, -h, 0);

		md.cloneColors();
		md.recolor((short) 939, JagexColor.rgbToHSL(config.color.getRGB(), 1.0d));

		Model m = md.light();
		rlo.setModel(m);
		rlo.setLocation(player.getLocalLocation(), client.getPlane());
		rlo.setActive(true);
	}

	private void updateFont(Graphics2D graphics, SMPlayer player)
	{
		if (player.font != null)
		{
			return;
		}

		player.font = graphics.getFont().deriveFont((float) player.config.textSize);
	}
}

package info.sigterm.plugins.smevent;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.google.inject.Provides;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.Player;
import net.runelite.api.events.PlayerDespawned;
import net.runelite.api.events.PlayerSpawned;
import net.runelite.api.events.WorldViewLoaded;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.util.Text;

@Slf4j
@PluginDescriptor(
	name = "SM Event"
)
public class SMEvent extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private ClientThread clientThread;

	@Inject
	private SMEventConfig config;

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private PlayerOverlay playerOverlay;

	@Inject
	private Gson gson;

	private final Map<String, PlayerConfig> configs = new HashMap<>();
	final Map<Player, SMPlayer> players = new HashMap<>();

	@Override
	protected void startUp()
	{
		overlayManager.add(playerOverlay);
		clientThread.invokeLater(this::loadConfig);
	}

	@Override
	protected void shutDown()
	{
		overlayManager.remove(playerOverlay);
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (event.getGroup().equals("smevent"))
		{
			clientThread.invokeLater(this::loadConfig);
		}
	}

	@Provides
	SMEventConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(SMEventConfig.class);
	}

	private void loadConfig()
	{
		List<PlayerConfig> c = config.config().isBlank() ? Collections.emptyList() : gson.fromJson(config.config(), new TypeToken<List<PlayerConfig>>()
		{
		}.getType());

		configs.clear();
		for (PlayerConfig pc : c)
		{
			configs.put(Text.sanitize(pc.name), pc);
		}

		for (SMPlayer p : players.values())
		{
			if (p.rlo != null)
			{
				p.rlo.setActive(false);
				p.rlo = null;
			}
		}
		players.clear();

		for (Player player : client.getPlayers())
		{
			PlayerConfig pc = configs.get(Text.sanitize(player.getName()));
			if (pc != null)
			{
				SMPlayer p = new SMPlayer();
				p.player = player;
				p.config = pc;
				players.put(p.player, p);
			}
		}
	}

	@Subscribe
	public void onWorldViewLoaded(WorldViewLoaded event)
	{
		if (event.getWorldView().isTopLevel())
		{
			for (SMPlayer p : players.values())
			{
				if (p.rlo != null)
				{
					p.rlo.setActive(false);
					p.rlo = null;
				}
			}
		}
	}

	@Subscribe
	public void onPlayerSpawned(PlayerSpawned event)
	{
		PlayerConfig pc = configs.get(Text.sanitize(event.getPlayer().getName()));
		if (pc != null)
		{
			SMPlayer p = new SMPlayer();
			p.player = event.getPlayer();
			p.config = pc;
			players.put(p.player, p);
		}
	}

	@Subscribe
	public void onPlayerDespawned(PlayerDespawned event)
	{
		SMPlayer p = players.get(event.getPlayer());
		if (p != null)
		{
			if (p.rlo != null)
			{
				p.rlo.setActive(false);
			}
			players.remove(event.getPlayer());
		}
	}
}

package info.sigterm.plugins.smevent;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ExamplePluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(SMEvent.class);
		RuneLite.main(args);
	}
}
