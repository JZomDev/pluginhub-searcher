package com.compost;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class DidICompostPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(DidICompostPlugin.class);
		RuneLite.main(args);
	}
}
package com.compost;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("didICompost")
public interface DidICompostConfig extends Config
{
        @ConfigItem(
                keyName = "iconSize",
                name = "Compost Icon Size",
                description = "Choose the size of the bucket icon",
                position = 1
        )
    default CompostIconSize iconSize()
        {
            return CompostIconSize.MEDIUM;
        }

}

package com.compost;

public enum CompostIconSize {

    LARGE,
    MEDIUM,
    SMALL

}

package com.compost;

import com.google.common.collect.ImmutableSet;
import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.*;
import net.runelite.api.coords.WorldPoint;
import net.runelite.api.events.ChatMessage;
import net.runelite.api.events.MenuOptionClicked;
import net.runelite.api.widgets.ComponentID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import java.awt.*;
import java.util.*;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static net.runelite.api.MenuAction.GAME_OBJECT_FIFTH_OPTION;
import static net.runelite.api.MenuAction.WIDGET_TARGET_ON_GAME_OBJECT;

@Slf4j
@PluginDescriptor(
	name = "Did I Compost?"
)
public class DidICompostPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private DidICompostConfig config;

	@Inject
	private PatchOverlay patchOverlay;

	@Inject
	private OverlayManager overlayManager;

	private static final Pattern COMPOST_USED_ON_PATCH = Pattern.compile(
			"You treat the .+ with (?<compostType>ultra|super|)compost\\.");
	private static final Pattern FERTILE_SOIL_CAST = Pattern.compile(
			"^The .+ has been treated with (?<compostType>ultra|super|)compost");
	private static final Pattern ALREADY_TREATED = Pattern.compile(
			"This .+ has already been (treated|fertilised) with (?<compostType>ultra|super|)compost(?: - the spell can't make it any more fertile)?\\.");
	private static final Pattern INSPECT_PATCH = Pattern.compile(
			"This is an? .+\\. The soil has been treated with (?<compostType>ultra|super|)compost\\..*");

	private static final Pattern INSPECT_PATCH_NONE = Pattern.compile(
			"This is an? .+\\. The soil has not been treated.*");

	private static final Pattern CLEAR_HERB = Pattern.compile("The herb patch is now empty.*");
	private static final Pattern CLEAR_PATCH = Pattern.compile("You have successfully cleared this patch for new crops.*");
	private static final Pattern CLEAR_TREE = Pattern.compile("You examine the tree for signs of disease and find that it is in perfect health.*");
	private static final Pattern CLEAR_ALLOTMENT = Pattern.compile("The allotment is now empty.*");
	private static final Pattern CLEAR_SEAWEED = Pattern.compile("You pick some giant seaweed.*");
	private static final Pattern CLEAR_BELLA = Pattern.compile("You pick some deadly nightshade.*");
	private static final Pattern CLEAR_MUSHROOM = Pattern.compile("You pick a Bittercap mushroom.*");
	
	private static final ImmutableSet<Integer> COMPOST_ITEMS = ImmutableSet.of(
			ItemID.COMPOST,
			ItemID.SUPERCOMPOST,
			ItemID.ULTRACOMPOST,
			ItemID.BOTTOMLESS_COMPOST_BUCKET_22997
	);
	private static final ArrayList<Integer> compostIds = new ArrayList<>(Arrays.asList(ItemID.COMPOST, ItemID.SUPERCOMPOST, ItemID.ULTRACOMPOST, ItemID.BOTTOMLESS_COMPOST_BUCKET_22997));

	int currentPatch = 0;
	@Subscribe
	public void onMenuOptionClicked(MenuOptionClicked menuClicked)
	{
		Boolean isCompost = false;
		MenuAction action = menuClicked.getMenuAction();
		if(action == WIDGET_TARGET_ON_GAME_OBJECT)
		{
			Widget w = client.getSelectedWidget();
			if(w != null){
				if(compostIds.contains(w.getItemId()))
				{
					isCompost = true;
				}

				if(w.getId() == ComponentID.SPELLBOOK_FERTILE_SOIL){
					isCompost = true;
				}

			}
		}
		if(action == GAME_OBJECT_FIFTH_OPTION)
		{
				isCompost = "Inspect".equals(menuClicked.getMenuOption());
		}

		ObjectComposition patchDef = client.getObjectDefinition(menuClicked.getId());
		//avoids swapping the id to random objects
		for(int i = 0; i < FarmingPatches.values().length; i++)
		{
			if(FarmingPatches.values()[i].patchId == patchDef.getId())
			{
				currentPatch = patchDef.getId();
			}
		}

	}
	@Subscribe
	public void onChatMessage(ChatMessage message)
	{
		String messageString = message.getMessage();
		String compostType = "";
		Matcher matcher;
		if((matcher = COMPOST_USED_ON_PATCH.matcher(messageString)).matches() ||
				(matcher = FERTILE_SOIL_CAST.matcher(messageString)).find() ||
				(matcher = ALREADY_TREATED.matcher(messageString)).matches() ||
				(matcher = INSPECT_PATCH.matcher(messageString)).matches() )
		{

				String compostGroup = matcher.group("compostType");

				switch(compostGroup){

					case "ultra":
						compostType = "ultra";
						break;

					case "super":
						compostType = "super";
						break;

					default:
						compostType = "compost";
						break;
				}

		}

		if(compostType == "ultra" || compostType == "super" || compostType == "compost")
		{
			addPatch(currentPatch);
		}

		if((matcher = CLEAR_PATCH.matcher(messageString)).matches() ||
				(matcher = CLEAR_HERB.matcher(messageString)).matches() ||
				(matcher = CLEAR_TREE.matcher(messageString)).matches() ||
				(matcher = INSPECT_PATCH_NONE.matcher(messageString)).matches() ||
				(matcher = CLEAR_ALLOTMENT.matcher(messageString)).matches() ||
				(matcher = CLEAR_SEAWEED.matcher(messageString)).matches() ||
				(matcher = CLEAR_MUSHROOM.matcher(messageString)).matches() ||
				(matcher = CLEAR_BELLA.matcher(messageString)).matches()){

			deletePatch(currentPatch);
		}

	}

	public void addPatch(int currentPatch)
	{
		FarmingPatches newPatch = FarmingPatches.fromPatchId(currentPatch);

		if(newPatch != null)
		{
			List<WorldPoint> currentTiles = patchOverlay.getWorldPoints();
			currentTiles.add(newPatch.tile);
			patchOverlay.setWorldPoints(currentTiles);
		}
	}

	public void deletePatch(int currentPatch)
	{
		FarmingPatches oldPatch = FarmingPatches.fromPatchId(currentPatch);
		if(oldPatch != null)
		{
			List<WorldPoint> currentTiles = patchOverlay.getWorldPoints();
			for(int i = 0; i < currentTiles.size(); i++)
			{
				if(currentTiles.get(i) == oldPatch.tile)
				{
					currentTiles.remove(i);
				}
			}
			patchOverlay.setWorldPoints(currentTiles);
		}
	}
	@Override
	protected void startUp() throws Exception
	{
		overlayManager.add(patchOverlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(patchOverlay);
	}

	@Provides
	DidICompostConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(DidICompostConfig.class);
	}
}

package com.compost;

import net.runelite.api.coords.WorldPoint;

import java.util.ArrayList;

public class FarmPatch
{

    public String farmPatch = "";

    public String compostType = "";
    public boolean didICompost = false;
    private static ArrayList<WorldPoint> compostIconTiles = new ArrayList<>();

    public FarmPatch(String patchName, boolean composted, ArrayList<WorldPoint> tiles, String compost)
    {
        farmPatch = patchName;
        didICompost = composted;
        compostIconTiles = tiles;
        compostType = compost;

    }
}

package com.compost;

import net.runelite.api.Perspective;
import net.runelite.api.Point;
import net.runelite.api.coords.LocalPoint;
import net.runelite.api.coords.WorldPoint;
import net.runelite.api.Client;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.OverlayPriority;
import net.runelite.client.util.ImageUtil;

import java.awt.Color;

import javax.imageio.ImageIO;
import javax.inject.Inject;
import java.awt.*;
import java.awt.geom.GeneralPath;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static net.runelite.api.Perspective.LOCAL_TILE_SIZE;


public class PatchOverlay extends Overlay
{
    private final Client client;
    private final DidICompostPlugin plugin;
    private final DidICompostConfig config;

    public List<WorldPoint> getWorldPoints()
    {
        return worldPoints;
    }

    public void setWorldPoints(List<WorldPoint> worldPoints)
    {
        this.worldPoints = worldPoints;
    }

    public List<WorldPoint> worldPoints = new ArrayList<WorldPoint>();
    Color defaultColor = Color.RED;

    @Inject
    private PatchOverlay(Client client, DidICompostConfig config, DidICompostPlugin plugin)
    {
        this.client = client;
        this.config = config;
        this.plugin = plugin;
        setPosition(OverlayPosition.DYNAMIC);
        setLayer(OverlayLayer.ABOVE_SCENE);
    }

    @Override
    public Dimension render(Graphics2D graphics)
    {
        for(int i = 0; i < worldPoints.size(); i++)
        {
            try
            {
                drawBucket(graphics,worldPoints.get(i));
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        }

        return null;
    }

    private void drawBucket(Graphics2D graphics, WorldPoint worldPoint) throws IOException
    {
        if(worldPoint.getPlane() != client.getPlane())
        {
            return;
        }

        LocalPoint lp = LocalPoint.fromWorld(client, worldPoint);
        if(lp == null)
        {
            return;
        }

        Polygon poly = Perspective.getCanvasTilePoly(client,lp);
        if(poly == null)
        {
            return;
        }


        BufferedImage img = ImageUtil.loadImageResource(DidICompostPlugin.class, "/Bottomless_compost_bucket.png");
        BufferedImage resizedImage = img;

        if(config.iconSize() == CompostIconSize.LARGE) {
            int newWidth = (int)(img.getWidth() * 1.3);
            int newHeight = (int)(img.getHeight() * 1.3);
            resizedImage = resizeImage(img, newWidth, newHeight);
        }
        else if(config.iconSize() == CompostIconSize.SMALL) {
            int newWidth = (int)(img.getWidth() * 0.7);
            int newHeight = (int)(img.getHeight() * 0.7);
            resizedImage = resizeImage(img, newWidth, newHeight);
        }

        net.runelite.api.Point point = XYToPoint(worldPoint.getX(),worldPoint.getY(),worldPoint.getPlane());
        graphics.drawImage(resizedImage, point.getX() , point.getY(), null);
    }

    private BufferedImage resizeImage(BufferedImage originalImage, int newWidth, int newHeight) {
        Image tmp = originalImage.getScaledInstance(newWidth, newHeight, Image.SCALE_SMOOTH);
        BufferedImage resizedImage = new BufferedImage(newWidth, newHeight, BufferedImage.TYPE_INT_ARGB);

        Graphics2D g2d = resizedImage.createGraphics();
        g2d.drawImage(tmp, 0, 0, null);
        g2d.dispose();

        return resizedImage;
    }
    private Point XYToPoint(int x, int y, int z)
    {
        LocalPoint localPoint = LocalPoint.fromWorld(client, x, y);

        if (localPoint == null)
        {
            return null;
        }

        return Perspective.localToCanvas(
                client,
                new LocalPoint(localPoint.getX() - LOCAL_TILE_SIZE / 2, localPoint.getY() - LOCAL_TILE_SIZE / 2),
                z);
    }


}

package com.compost;

import lombok.RequiredArgsConstructor;
import net.runelite.api.coords.WorldPoint;

import java.util.HashMap;
import java.util.Map;

@RequiredArgsConstructor
public enum FarmingPatches
{
    ARDY_ALLOTMENT_NORTH(8555, new WorldPoint(2667,3371,0)),
    ARDY_ALLOTMENT_SOUTH(8554, new WorldPoint(2667,3378,0)),
    ARDY_FLOWER(7849, new WorldPoint(2667,3374,0)),
    ARDY_HERB(8152, new WorldPoint(2670,3374,0)),

    FALLY_ALLOTMENT_EAST(8551, new WorldPoint(3055,3304,0)),
    FALLY_ALLOTMENT_WEST(8550, new WorldPoint(3051,3307,0)),
    FALLY_FLOWER(7847, new WorldPoint(3054,3307,0)),
    FALLY_HERB(8150, new WorldPoint(3058,3311,0)),

    MORY_ALLOTMENT_EAST(8557, new WorldPoint(3602,3522,0)),
    MORY_ALLOTMENT_WEST(8556, new WorldPoint(3598,3525,0)),
    MORY_FLOWER(7850, new WorldPoint(3602,3525,0)),
    MORY_HERB(8153, new WorldPoint(3605,3529,0)),

    CATHERBY_ALLOTMENT_NORTH(8552, new WorldPoint(2806,3466,0)),
    CATHERBY_ALLOTMENT_SOUTH(8553, new WorldPoint(2806,3461,0)),
    CATHERBY_FLOWER(7848, new WorldPoint(2810,3463,0)),
    CATHERBY_HERB(8151, new WorldPoint(2813,3463,0)),

    HOSIDIUS_ALLOTMENT_EAST(27113, new WorldPoint(1738,3554,0)),
    HOSIDIUS_ALLOTMENT_WEST(27114, new WorldPoint(1735,3551,0)),
    HOSIDIUS_FLOWER(27111, new WorldPoint(1735,3554,0)),
    HOSIDIUS_HERB(27115, new WorldPoint(1738,3551,0)),

    VALAMORE_ALLOTMENT_NORTH(50696, new WorldPoint(1582,3100,0)),
    VALAMORE_ALLOTMENT_SOUTH(50695, new WorldPoint(1586,3095,0)),
    VALAMORE_FLOWER(50693, new WorldPoint(1585,3098,0)),
    VALAMORE_HERB(50697, new WorldPoint(1582,3095,0)),

    HARMONY_HERB(9372, new WorldPoint(3790,2838,0)),
    HARMONY_ALLOTMENT(21950, new WorldPoint(3794,2837,0)),

    FARMING_GUILD_ALLOTMENT_NORTH(33694, new WorldPoint(1267,3732,0)),
    FARMING_GUILD_ALLOTMENT_SOUTH(33693, new WorldPoint(1267,3727,0)),
    FARMING_GUILD_FLOWER(33649, new WorldPoint(1260,3726,0)),
    FARMING_GUILD_HERB(33979, new WorldPoint(1239,3727,0)),

    PRIFF_ALLOTMENT_NORTH(34922, new WorldPoint(3289,6101,0)),
    PRIFF_ALLOTMENT_SOUTH(34921, new WorldPoint(3289,6098,0)),
    PRIFF_FLOWER(34919, new WorldPoint(3293,6100,0)),

    TROLL_HERB(18816, new WorldPoint(2827,3694,0)),
    WEISS_HERB(33176, new WorldPoint(2848,3935,0)),

    //hops
    CHAMPION_GUILD_HOP(8175, new WorldPoint(3231,3317,0)),
    MCGRUBOR_HOP(8176, new WorldPoint(2669,3523,0)),
    YANILLE_HOP(8173, new WorldPoint(2577,3106,0)),
    ENTRANA_HOP(8174, new WorldPoint(2812,3338,0)),

    //Bushes
    FARMING_GUILD_BUSH(34006, new WorldPoint(1260,3733,0)),
    CHAMPION_GUILD_BUSH(7577, new WorldPoint(3182,3358,0)),
    RIMMINGTON_BUSH(7578, new WorldPoint(2941,3222,0)),
    ARDY_BUSH(7580, new WorldPoint(2617,3226,0)),
    ETCETERA_BUSH(7579, new WorldPoint(2592,3863,0)),

    //trees
    FALLY_TREE(8389, new WorldPoint(3003,3374,0)),
    TALVERY_TREE(8388, new WorldPoint(2935,3439,0)),
    FARMING_GUILD_TREE(33732, new WorldPoint(1233,3735,0)),
    LUMBRIDGE_TREE(8391, new WorldPoint(3194,3232,0)),
    VARROCK_TREE(8390, new WorldPoint(3228,3458,0)),
    GNOME_STRONGHOLD_TREE(19147, new WorldPoint(2437,3416,0)),
    //fruit trees
    CATHERBY_FRUIT(7965, new WorldPoint(2860,3433,0)),
    FARMING_GUILD_FRUIT(34007, new WorldPoint(1243,3758,0)),
    GNOME_STRONGHOLD_FRUIT(7962, new WorldPoint(2475,3446,0)),
    GNOME_VILLIAGE_FRUIT(7963, new WorldPoint(2490,3180,0)),
    BRIMHAVEN_FRUIT(7964, new WorldPoint(2765,3212,0)),
    LLETYA_FRUIT(26579, new WorldPoint(2346,3162,0)),
    //spirit trees
    FARMING_GUILD_SPIRIT(33733, new WorldPoint(1252,3751,0)),
    ETCETERA_SPIRIT(8382, new WorldPoint(2612,3857,0)),
    PORT_SARIM_SPIRIT(8338, new WorldPoint(3059,3257,0)),
    BRIMHAVEN_SPIRIT(8383, new WorldPoint(2801,3204,0)),
    HOSIDIUS_SPIRIT(27116, new WorldPoint(1692,3541,0)),

    //Seaweed
    SEAWEED_NORTH(30500, new WorldPoint(3733,10273,1)),
    SEAWEED_SOUTH(30501, new WorldPoint(3733,10268,1)),

    //Hard(Kappa)wood
    HARDWOOD_WEST(30481, new WorldPoint(3703,3836,0)),
    HARDWOOD_SOUTH(30480, new WorldPoint(3707,3834,0)),
    HARDWOOD_EAST(30482, new WorldPoint(3714,3836,0)),
    VALAMORE_HARDWOOD(50692, new WorldPoint(1687,2973,0)),

    //special
    ALKHARID_CACTUS(7771, new WorldPoint(3315,3203,0)),
    FARMING_GUILD_CACTUS(33761, new WorldPoint(1264,3747,0)),
    FARMING_GUILD_CELSTRUS(34629, new WorldPoint(1245,3751,0)),
    FARMING_GUILD_REDWOOD(34059, new WorldPoint(1232,3753,0)),
    PRIFF_CRYSTAL_TREE(34906, new WorldPoint(3291,6118,0)),
    CANFIS_MUSHROOM(8337, new WorldPoint(3452,3472,0)),
    DRAYNOR_BELL(7572, new WorldPoint(3087,3354,0)),
    TAIBWO_CALQUAT(7807, new WorldPoint(2796,3100,0));

    public final int patchId;

    public final WorldPoint tile;
    private static final Map<Integer, FarmingPatches> PATCH_MAP = new HashMap<>();

    static {
        for (FarmingPatches e: values()) {
            PATCH_MAP.put(e.patchId, e);
        }
    }

    public static FarmingPatches fromPatchId(int itemId) {
        return PATCH_MAP.get(itemId);
    }

}

