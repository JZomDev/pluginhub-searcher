package com.potionstoragecustomizer;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import com.potionstoragecustomizer.PotionStorageCustomizerPlugin.PotionPositions;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Point;
import net.runelite.api.widgets.Widget;

@Slf4j
class PotionPanelWidget {
    List<PotionSectionWidget> potionSections;
    Widget panel;
    Widget vialCount;

    private final PotionStorageCustomizerPlugin plugin;

    public PotionPanelWidget(PotionStorageCustomizerPlugin plugin) {
        potionSections = new ArrayList<>();
        this.plugin = plugin;
    }

    public void enableDrag(boolean dragEnabled, Map<String, PotionPositions> savedPositions) {
        for (PotionSectionWidget section : potionSections) {
            for (PotionWidget potion : section.potions) {
                potion.setDraggable(dragEnabled, plugin, this, savedPositions);
            }
        }
    }

    public void updateDragDeadTime(int delay) {
        for (PotionSectionWidget section : potionSections) {
            for (PotionWidget potion : section.potions) {
                potion.changeDragDelay(delay);
            }
        }
    }

    public void hidePanel() {
        for (PotionSectionWidget section : potionSections) {
            for (PotionWidget potion : section.potions) {
                potion.hide();
            }
        }
    }

    public PotionWidget getPotionByName(String name) {
        for (PotionSectionWidget section : potionSections) {
            for (PotionWidget potion : section.potions) {
                if (potion.nameLabel.getText().equals(name)) {
                    return potion;
                }
            }
        }
        return null;
    }

    public void savePosition(PotionWidget potion, Map<String, PotionPositions> savedPositions) {
        PotionPositions pos = new PotionPositions();
        pos.container = new Point(potion.container.getOriginalX(), potion.container.getOriginalY());
        pos.icon = new Point(potion.icon.getOriginalX(), potion.icon.getOriginalY());
        pos.nameLabel = new Point(potion.nameLabel.getOriginalX(), potion.nameLabel.getOriginalY());
        pos.doseLabel = new Point(potion.doseLabel.getOriginalX(), potion.doseLabel.getOriginalY());
        pos.favButton = new Point(potion.favButton.getOriginalX(), potion.favButton.getOriginalY());
        if (potion.potionBar != null && potion.potionSubBar != null && potion.potionBarText != null) {
            pos.bar = new Point(potion.potionBar.getOriginalX(), potion.potionBar.getOriginalY());
            pos.subBar = new Point(potion.potionSubBar.getOriginalX(), potion.potionSubBar.getOriginalY());
            pos.barText = new Point(potion.potionBarText.getOriginalX(), potion.potionBarText.getOriginalY());
            log.info("saving potion bar");
        }
        pos.index = potion.index;
        pos.section = potion.section.category;

        savedPositions.put(potion.getName(), pos);
    }

    public void recalculateAllPositions(Map<String, PotionPositions> savedPositions) {
        for (PotionSectionWidget section : potionSections) {
            sortPotionsByCustomOrder(section, savedPositions);
            repositionSectionPotions(section, savedPositions);
        }
    }

    public void pruneMissingPotions(Map<String, PotionPositions> savedPositions) {
        Set<String> currentPotions = new HashSet<>();
        for (PotionSectionWidget section : potionSections) {
            for (PotionWidget potion : section.potions) {
                currentPotions.add(potion.getName());
            }
        }
        savedPositions.entrySet().removeIf(entry -> !currentPotions.contains(entry.getKey()));
    }

    public boolean detectLayoutChange(Map<PotionSectionWidget.Category, Integer> lastSectionCounts) {
        boolean changed = false;
        for (PotionSectionWidget section : potionSections) {
            Integer lastCount = lastSectionCounts.get(section.category);
            int currentCount = section.potions.size();
            if (lastCount == null || lastCount != currentCount) {
                changed = true;
            }
            lastSectionCounts.put(section.category, currentCount);
        }
        return changed;
    }

    public void applyCustomPositions(Map<String, PotionPositions> savedPositions) {
        for (PotionSectionWidget section : potionSections) {
            sortPotionsByCustomOrder(section, savedPositions);
            for (PotionWidget potion : section.potions) {
                String potionName = potion.getName();
                PotionPositions pos = savedPositions.get(potionName);

                if (pos == null)
                    continue;

                potion.container.setOriginalX(pos.container.getX());
                potion.container.setOriginalY(pos.container.getY());
                potion.icon.setOriginalX(pos.icon.getX());
                potion.icon.setOriginalY(pos.icon.getY());
                potion.nameLabel.setOriginalX(pos.nameLabel.getX());
                potion.nameLabel.setOriginalY(pos.nameLabel.getY());
                potion.doseLabel.setOriginalX(pos.doseLabel.getX());
                potion.doseLabel.setOriginalY(pos.doseLabel.getY());
                potion.favButton.setOriginalX(pos.favButton.getX());
                potion.favButton.setOriginalY(pos.favButton.getY());

                if (potion.potionBar != null && potion.potionSubBar != null && potion.potionBarText != null
                        && pos.bar != null && pos.subBar != null && pos.barText != null) {
                    potion.potionBar.setOriginalX(pos.bar.getX());
                    potion.potionBar.setOriginalY(pos.bar.getY());
                    potion.potionSubBar.setOriginalX(pos.subBar.getX());
                    potion.potionSubBar.setOriginalY(pos.subBar.getY());
                    potion.potionBarText.setOriginalX(pos.barText.getX());
                    potion.potionBarText.setOriginalY(pos.barText.getY());
                    potion.potionBar.revalidate();
                    potion.potionSubBar.revalidate();
                    potion.potionBarText.revalidate();
                }

                potion.index = pos.index;

                potion.container.revalidate();
                potion.icon.revalidate();
                potion.nameLabel.revalidate();
                potion.doseLabel.revalidate();
                potion.favButton.revalidate();
            }
        }
    }

    private void sortPotionsByCustomOrder(PotionSectionWidget section, Map<String, PotionPositions> savedPositions) {
        section.potions.sort((a, b) -> {
            PotionPositions posA = savedPositions.get(a.getName());
            PotionPositions posB = savedPositions.get(b.getName());

            int indexA = (posA != null && posA.section == section.category)
                    ? posA.index
                    : Integer.MAX_VALUE;
            int indexB = (posB != null && posB.section == section.category)
                    ? posB.index
                    : Integer.MAX_VALUE;
            return Integer.compare(indexA, indexB);
        });
    }

    private void repositionSectionPotions(PotionSectionWidget section, Map<String, PotionPositions> savedPositions) {
        if (section.potions.isEmpty())
            return;

        int baseX = Integer.MAX_VALUE;
        int baseY = Integer.MAX_VALUE;
        for (PotionWidget potion : section.potions) {
            baseX = Math.min(baseX, potion.container.getOriginalX());
            baseY = Math.min(baseY, potion.container.getOriginalY());
        }

        PotionWidget firstPotion = section.potions.get(0);
        int width = firstPotion.container.getOriginalWidth();
        int height = firstPotion.container.getOriginalHeight();

        for (int i = 0; i < section.potions.size(); i++) {
            PotionWidget potion = section.potions.get(i);
            int row = i / 2;
            int col = i % 2;
            int newX = baseX + (col * width);
            int newY = baseY + (row * height);

            int iconOffsetX = potion.icon.getOriginalX() - potion.container.getOriginalX();
            int iconOffsetY = potion.icon.getOriginalY() - potion.container.getOriginalY();
            int nameOffsetX = potion.nameLabel.getOriginalX() - potion.container.getOriginalX();
            int nameOffsetY = potion.nameLabel.getOriginalY() - potion.container.getOriginalY();
            int doseOffsetX = potion.doseLabel.getOriginalX() - potion.container.getOriginalX();
            int doseOffsetY = potion.doseLabel.getOriginalY() - potion.container.getOriginalY();
            int favOffsetX = potion.favButton.getOriginalX() - potion.container.getOriginalX();
            int favOffsetY = potion.favButton.getOriginalY() - potion.container.getOriginalY();

            int barOffsetX = 0, barOffsetY = 0;
            int subBarOffsetX = 0, subBarOffsetY = 0;
            int barTextOffsetX = 0, barTextOffsetY = 0;

            if (potion.potionBar != null && potion.potionSubBar != null && potion.potionBarText != null) {
                barOffsetX = potion.potionBar.getOriginalX() - potion.container.getOriginalX();
                barOffsetY = potion.potionBar.getOriginalY() - potion.container.getOriginalY();
                subBarOffsetX = potion.potionSubBar.getOriginalX() - potion.container.getOriginalX();
                subBarOffsetY = potion.potionSubBar.getOriginalY() - potion.container.getOriginalY();
                barTextOffsetX = potion.potionBarText.getOriginalX() - potion.container.getOriginalX();
                barTextOffsetY = potion.potionBarText.getOriginalY() - potion.container.getOriginalY();

                potion.potionBar.setOriginalX(newX + barOffsetX);
                potion.potionBar.setOriginalY(newY + barOffsetY);
                potion.potionSubBar.setOriginalX(newX + subBarOffsetX);
                potion.potionSubBar.setOriginalY(newY + subBarOffsetY);
                potion.potionBarText.setOriginalX(newX + barTextOffsetX);
                potion.potionBarText.setOriginalY(newY + barTextOffsetY);

                potion.potionBar.revalidate();
                potion.potionSubBar.revalidate();
                potion.potionBarText.revalidate();
            }

            potion.container.setOriginalX(newX);
            potion.container.setOriginalY(newY);
            potion.icon.setOriginalX(newX + iconOffsetX);
            potion.icon.setOriginalY(newY + iconOffsetY);
            potion.nameLabel.setOriginalX(newX + nameOffsetX);
            potion.nameLabel.setOriginalY(newY + nameOffsetY);
            potion.doseLabel.setOriginalX(newX + doseOffsetX);
            potion.doseLabel.setOriginalY(newY + doseOffsetY);
            potion.favButton.setOriginalX(newX + favOffsetX);
            potion.favButton.setOriginalY(newY + favOffsetY);

            potion.index = i;

            potion.container.revalidate();
            potion.icon.revalidate();
            potion.nameLabel.revalidate();
            potion.doseLabel.revalidate();
            potion.favButton.revalidate();

            savePosition(potion, savedPositions);
        }
    }
}

package com.potionstoragecustomizer;

import java.util.ArrayList;
import java.util.List;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.widgets.Widget;
import net.runelite.api.widgets.WidgetType;

@Slf4j
class PotionSectionWidget {
    enum Category {
        FAVOURITES,
        POTIONS,
        UNFINISHED_POTIONS
    }

    List<PotionWidget> potions;
    Category category;
    Widget boundary;

    public PotionSectionWidget(Category cat) {
        potions = new ArrayList<>();
        this.category = cat;
    }

    public PotionWidget getPositionByContainer(Widget container) {
        for (PotionWidget potion : potions) {
            if (potion.container == container) {
                return potion;
            }
        }
        return null;
    }

    public PotionWidget getPotionAtPosition(int x, int y) {
        for (PotionWidget potion : potions) {
            Widget container = potion.container;
            if (container.getBounds().contains(x, y)) {
                return potion;
            }
        }
        return null;
    }

    public void increaseBoundaryHeight(int count) {
        this.boundary.setOriginalHeight(
                this.boundary.getOriginalHeight() + potions.get(0).container.getOriginalHeight() * count);
    }

    public void createBoundary(int height, int y, Widget psItems) {
        this.boundary = psItems.createChild(WidgetType.RECTANGLE);
        this.boundary.setOriginalWidth(psItems.getWidth());
        this.boundary.setOriginalHeight(height);
        this.boundary.setOriginalY(y);
        this.boundary.setOriginalX(0);

        this.boundary.revalidate();
    }
}

package com.potionstoragecustomizer;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup(PotionStorageCustomizerPlugin.CONFIG_GROUP)
public interface PotionStorageCustomizerConfig extends Config {
    @ConfigItem(
        keyName = "disableDrag",
        name = "Disable drag",
        description = "Prevents potions from being dragged. Enable this to lock your configured potion positions and avoid accidental re-positioning",
        position = 1
    )
    default boolean disableDrag() {
        return false;
    }
}

package com.potionstoragecustomizer;

import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import com.google.inject.Provides;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;
import javax.inject.Inject;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.Point;
import net.runelite.api.ScriptID;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.events.ScriptPostFired;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.api.widgets.Widget;
import net.runelite.api.widgets.WidgetType;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.events.PluginChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDependency;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.plugins.antidrag.AntiDragConfig;
import net.runelite.client.plugins.antidrag.AntiDragPlugin;
import net.runelite.client.plugins.PluginManager;

@Slf4j
@PluginDescriptor(name = "Potion Storage Customizer")
@PluginDependency(AntiDragPlugin.class)
public class PotionStorageCustomizerPlugin extends Plugin {
    @Data
    static class PotionPositions {
        Point container;
        Point icon;
        Point nameLabel;
        Point doseLabel;
        Point favButton;
        Point bar;
        Point subBar;
        Point barText;
        int index;
        PotionSectionWidget.Category section;
    }

    static final String CONFIG_GROUP = "potionsstoragecustomizer";

    @Inject
    private Client client;

    @Inject
    ConfigManager configManager;

    @Inject
    private PotionStorageCustomizerConfig config;

    @Inject
    private PluginManager pluginManager;

    @Inject
    private AntiDragPlugin antiDragPlugin;

    @Inject
    private Gson gson;

    private Map<PotionSectionWidget.Category, Integer> lastSectionCounts = new HashMap<>();

    private final Map<String, PotionPositions> savedPositions = new HashMap<>();
    private PotionPanelWidget panel;

    public int getAntiDragDelay() {
        if (!isAntiDragActive()) {
            return 0;
        }
        return configManager.getConfig(AntiDragConfig.class).dragDelay();
    }

    @Subscribe
    public void onConfigChanged(ConfigChanged event) {
        if (panel == null)
            return;

        if ("antiDrag".equals(event.getGroup())) {
            int delay = getAntiDragDelay();
            panel.updateDragDeadTime(delay);
        }

        if (CONFIG_GROUP.equals(event.getGroup())) {
            panel.enableDrag(!config.disableDrag(), savedPositions);
        }
    }

    @Subscribe
    public void onPluginChanged(PluginChanged event) {
        if (event.getPlugin() != null &&
                event.getPlugin().getClass().equals(AntiDragPlugin.class) &&
                panel != null) {
            int delay = getAntiDragDelay();
            panel.updateDragDeadTime(delay);
        }
    }

    public Client getClient() {
        return client;
    }

    // ensure this runs after potion storage bars plugin
    @Subscribe(priority = -1)
    protected void onScriptPostFired(ScriptPostFired event) {
        if (event.getScriptId() == ScriptID.POTIONSTORE_BUILD) {
            rebuildPanel();
        }
    }

    @Override
    protected void startUp() {
        // configManager.unsetConfiguration("potionstoragecustomizer",
        // "potionPositions");
        loadPositionsFromConfig();
        loadSectionCountsFromConfig();
    }

    @Override
    protected void shutDown() throws Exception {
        log.debug("Potion Storage Customizer stopped!");
    }

    @Provides
    PotionStorageCustomizerConfig provideConfig(ConfigManager configManager) {
        return configManager.getConfig(PotionStorageCustomizerConfig.class);
    }

    private void rebuildPanel() {
        Widget psItems = client.getWidget(InterfaceID.Bankmain.POTIONSTORE_ITEMS);
        if (psItems == null)
            return;

        Widget[] potions = psItems.getDynamicChildren();
        if (potions.length == 0)
            return;

        panel = PotionStorageParser.parse(potions, psItems, this);

        panel.pruneMissingPotions(savedPositions);

        boolean layoutChanged = panel.detectLayoutChange(lastSectionCounts);
        if (layoutChanged) {
            panel.recalculateAllPositions(savedPositions);
        } else {
            panel.applyCustomPositions(savedPositions);
        }
        panel.enableDrag(!config.disableDrag(), savedPositions);

        savePositionsToConfig();
        saveSectionCountsToConfig();
    }

    private void savePositionsToConfig() {
        String json = gson.toJson(savedPositions);
        configManager.setConfiguration("potionstoragecustomizer", "potionPositions", json);
    }

    private void loadPositionsFromConfig() {
        String json = configManager.getConfiguration("potionstoragecustomizer", "potionPositions");
        if (json == null || json.isEmpty()) {
            return;
        }
        savedPositions
                .putAll(gson.fromJson(json, new TypeToken<Map<String, PotionPositions>>() {
                }.getType()));
        log.info("Loaded {} saved positions", savedPositions.size());
    }

    private void saveSectionCountsToConfig() {
        String json = gson.toJson(lastSectionCounts);
        configManager.setConfiguration("potionstoragecustomizer", "sectionCounts", json);
    }

    private void loadSectionCountsFromConfig() {
        String json = configManager.getConfiguration("potionstoragecustomizer", "sectionCounts");
        if (json == null || json.isEmpty()) {
            return;
        }
        lastSectionCounts.putAll(gson.fromJson(json,
                new TypeToken<Map<PotionSectionWidget.Category, Integer>>() {
                }.getType()));
        log.info("Loaded section counts: {}", lastSectionCounts);
    }

    private boolean isAntiDragActive() {
        return antiDragPlugin != null && pluginManager.isPluginEnabled(antiDragPlugin);
    }
}

package com.potionstoragecustomizer;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import com.potionstoragecustomizer.PotionSectionWidget.Category;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Point;
import net.runelite.api.widgets.Widget;
import net.runelite.api.widgets.WidgetType;

@Slf4j
class PotionStorageParser {
    static final int ICON_OFFSET = 1;
    static final int NAME_OFFSET = 2;
    static final int DOSE_OFFSET = 3;
    static final int FAV_OFFSET = 4;
    static final int NEXT_POTION_OFFSET = 5;
    static final int REMOVE_FAVOURITE_SPRITE_ID = 1340;
    static final int FAVOURITE_SPRITE_ID = 1341;

    static final int POTION_STORAGE_PLUGIN_BAR_OFFSET = 3;

    public static PotionPanelWidget parse(Widget[] flatArray, Widget psItems, PotionStorageCustomizerPlugin plugin) {
        PotionPanelWidget panel = new PotionPanelWidget(plugin);
        PotionSectionWidget favouritesSection = new PotionSectionWidget(Category.FAVOURITES);
        PotionSectionWidget potionsSection = new PotionSectionWidget(Category.POTIONS);
        PotionSectionWidget unfinishedSection = new PotionSectionWidget(Category.UNFINISHED_POTIONS);

        for (int i = 0; i < flatArray.length;) {
            if (flatArray[i].getText().contains("Vials")) {
                i++;
                continue;
            }

            if (flatArray[i].getType() == WidgetType.RECTANGLE && !flatArray[i].isHidden()
                    && flatArray[i].getHeight() < potionsSection.potions.get(0).container.getOriginalHeight()
                    && flatArray[i].getWidth() < psItems.getWidth() / 2) {
                List<PotionSectionWidget> sections = new ArrayList<PotionSectionWidget>();
                sections.add(favouritesSection);
                sections.add(potionsSection);
                sections.add(unfinishedSection);
                parsePotionStorageBars(i, flatArray, sections);
                i += POTION_STORAGE_PLUGIN_BAR_OFFSET;
                continue;
            }

            if (flatArray[i].getText().contains("Favourites")) {
                favouritesSection.createBoundary(flatArray[i + 1].getOriginalHeight(), flatArray[i + 1].getOriginalY(),
                        psItems);
                i += 2;
                continue;
            } else if (flatArray[i].getText().equals("Potions")) {
                potionsSection.createBoundary(flatArray[i + 1].getOriginalHeight(), flatArray[i + 1].getOriginalY(),
                        psItems);
                i += 2;
                continue;
            } else if (flatArray[i].getText().equals("Unfinished Potions")) {
                unfinishedSection.createBoundary(flatArray[i + 1].getOriginalHeight(), flatArray[i + 1].getOriginalY(),
                        psItems);
                i += 2;
                continue;
            } else if ((flatArray[i].isSelfHidden() || flatArray[i].isHidden()) && !Arrays
                    .asList(FAVOURITE_SPRITE_ID, REMOVE_FAVOURITE_SPRITE_ID)
                    .contains(flatArray[i].getSpriteId())) {
                i++;
            }

            if (i + FAV_OFFSET < flatArray.length) {
                Widget container = flatArray[i];
                Widget name = flatArray[i + NAME_OFFSET];
                Widget icon = flatArray[i + ICON_OFFSET];
                Widget dose = flatArray[i + DOSE_OFFSET];
                Widget favourite = flatArray[i + FAV_OFFSET];
                int favouriteSpriteId = flatArray[i + FAV_OFFSET].getSpriteId();

                if (favouriteSpriteId == REMOVE_FAVOURITE_SPRITE_ID) {
                    PotionWidget potion = new PotionWidget(container, name, icon, dose, favourite, favouritesSection,
                            favouritesSection.potions.size());
                    favouritesSection.potions.add(potion);
                    i += NEXT_POTION_OFFSET;
                    continue;
                } else if (favouriteSpriteId == FAVOURITE_SPRITE_ID) {
                    if (name.getText().contains("(unf)")) {
                        PotionWidget potion = new PotionWidget(container, name, icon, dose, favourite,
                                unfinishedSection, unfinishedSection.potions.size());
                        unfinishedSection.potions.add(potion);
                        i += NEXT_POTION_OFFSET;
                        continue;
                    } else {
                        PotionWidget potion = new PotionWidget(container, name, icon, dose, favourite,
                                potionsSection, potionsSection.potions.size());
                        potionsSection.potions.add(potion);
                        i += NEXT_POTION_OFFSET;
                        continue;
                    }
                }
            }
            i++;
        }

        panel.potionSections.add(favouritesSection);
        panel.potionSections.add(potionsSection);
        panel.potionSections.add(unfinishedSection);

        return panel;
    }

    private static void parsePotionStorageBars(int start, Widget[] flatArray, List<PotionSectionWidget> sections) {
        Widget bar = flatArray[start];
        Widget subBar = flatArray[start + 1];
        Widget barText = flatArray[start + 2];

        int barX = bar.getOriginalX();
        int barY = bar.getOriginalY();

        for (PotionSectionWidget section : sections) {
            for (PotionWidget potion : section.potions) {
                int doseX = potion.doseLabel.getOriginalX();
                int doseY = potion.doseLabel.getOriginalY();

                if (barX == doseX && barY == doseY) {
                    potion.setPotionBar(bar, subBar, barText);
                    return;
                }
            }
        }
    }
}

package com.potionstoragecustomizer;

import java.util.Map;

import com.potionstoragecustomizer.PotionStorageCustomizerPlugin.PotionPositions;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.gameval.VarbitID;
import net.runelite.api.widgets.JavaScriptCallback;
import net.runelite.api.widgets.Widget;
import net.runelite.api.widgets.WidgetConfig;

@Slf4j
class PotionWidget {
    Widget container;
    Widget icon;
    Widget nameLabel;
    Widget doseLabel;
    Widget favButton;

    Widget potionBar;
    Widget potionSubBar;
    Widget potionBarText;

    int index;
    PotionSectionWidget section;

    public PotionWidget(Widget container, Widget nameLabel, Widget icon, Widget doseLabel, Widget favButton,
            PotionSectionWidget favouritesSection, int index) {
        this.container = container;
        this.icon = icon;
        this.nameLabel = nameLabel;
        this.doseLabel = doseLabel;
        this.favButton = favButton;
        this.section = favouritesSection;
        this.index = index;
    }

    public void setDraggable(boolean draggable, PotionStorageCustomizerPlugin plugin, PotionPanelWidget panel,
            Map<String, PotionPositions> savedPositions) {
        int mask = container.getClickMask();
        Client client = plugin.getClient();
        if (draggable) {
            container.setDragParent(section.boundary);
            container.setClickMask(mask | WidgetConfig.DRAG | WidgetConfig.DRAG_ON);

            int antiDragDelay = plugin.getAntiDragDelay();
            container.setDragDeadTime(antiDragDelay);

            log.info("Set drag dead time to {} client ticks for {}", antiDragDelay, nameLabel.getText());

            container.setOnDragCompleteListener((JavaScriptCallback) event -> {
                log.info("Drag complete callback triggered");
                log.info("Mouse X: {}, Mouse Y: {}", client.getMouseCanvasPosition().getX(),
                        client.getMouseCanvasPosition().getY());

                PotionWidget target = section.getPotionAtPosition(client.getMouseCanvasPosition().getX(),
                        client.getMouseCanvasPosition().getY());

                if (target != null && target != this) {
                    log.info("Found target: {}", target.nameLabel.getText());
                    boolean isInsertMode = client.getVarbitValue(VarbitID.BANK_INSERTMODE) == 1;
                    log.info("insert mode: {}", isInsertMode);

                    if (isInsertMode) {
                        insert(section.getPositionByContainer(event.getSource()), target, plugin, panel,
                                savedPositions);
                    } else {
                        swap(section.getPositionByContainer(event.getSource()), target, plugin, panel, savedPositions);
                    }
                }
            });
        } else {
            container.setClickMask(mask & ~WidgetConfig.DRAG & ~WidgetConfig.DRAG_ON);
            container.setDragParent(null);
            container.setDragDeadTime(0);
            container.setOnDragCompleteListener((Object[]) null);
        }
    }

    public void changeDragDelay(int newDelay) {
        container.setDragDeadTime(newDelay);
    }

    public String getName() {
        String regex = "\\([0-9]+\\)";
        // trim dose text from name
        String trimmedName = nameLabel.getText().replaceAll(regex, "").trim();

        return trimmedName;
    }

    public void setPotionBar(Widget bar, Widget subBar, Widget barText) {
        potionBar = bar;
        potionSubBar = subBar;
        potionBarText = barText;
    }

    public void insert(PotionWidget source, PotionWidget target, PotionStorageCustomizerPlugin plugin,
            PotionPanelWidget panel, Map<String, PotionPositions> savedPositions) {
        if (source == null || target == null) {
            log.warn("source or target are null, cannot insert");
            return;
        }

        if (source.section != target.section) {
            log.warn("cannot insert potions from different sections");
            return;
        }

        int sourceListPos = section.potions.indexOf(source);
        int targetListPos = section.potions.indexOf(target);

        if (sourceListPos == -1 || targetListPos == -1) {
            log.warn("Could not find source or target in list");
            return;
        }

        log.info("INSERT MODE - source {} (list pos {}) | target {} (list pos {})",
                source.nameLabel.getText(), sourceListPos, target.nameLabel.getText(), targetListPos);

        section.potions.remove(sourceListPos);
        section.potions.add(targetListPos, source);

        for (int i = 0; i < section.potions.size(); i++) {
            section.potions.get(i).index = i;
        }

        for (PotionWidget potion : section.potions) {
            PotionPositions pos = savedPositions.get(potion.getName());
            if (pos == null) {
                log.warn("No saved position for {}, creating new entry", potion.getName());
                panel.savePosition(potion, savedPositions);
            } else {
                pos.index = potion.index;
            }
        }

        panel.recalculateAllPositions(savedPositions);
    }

    public void swap(PotionWidget source, PotionWidget target, PotionStorageCustomizerPlugin plugin,
            PotionPanelWidget panel, Map<String, PotionPositions> savedPositions) {
        if (source == null || target == null) {
            log.warn("source or target are null, cannot swap");
            return;
        }

        if (source.section != target.section) {
            log.warn("cannot swap potions from different sections");
            return;
        }

        log.info("source {} | target {}", source.nameLabel.getText(), target.nameLabel.getText());

        int sourceContainerX = source.container.getOriginalX();
        int sourceContainerY = source.container.getOriginalY();
        int sourceIconX = source.icon.getOriginalX();
        int sourceIconY = source.icon.getOriginalY();
        int sourceNameX = source.nameLabel.getOriginalX();
        int sourceNameY = source.nameLabel.getOriginalY();
        int sourceDoseX = source.doseLabel.getOriginalX();
        int sourceDoseY = source.doseLabel.getOriginalY();
        int sourceFavX = source.favButton.getOriginalX();
        int sourceFavY = source.favButton.getOriginalY();

        int targetContainerX = target.container.getOriginalX();
        int targetContainerY = target.container.getOriginalY();
        int targetIconX = target.icon.getOriginalX();
        int targetIconY = target.icon.getOriginalY();
        int targetNameX = target.nameLabel.getOriginalX();
        int targetNameY = target.nameLabel.getOriginalY();
        int targetDoseX = target.doseLabel.getOriginalX();
        int targetDoseY = target.doseLabel.getOriginalY();
        int targetFavX = target.favButton.getOriginalX();
        int targetFavY = target.favButton.getOriginalY();

        source.container.setOriginalX(targetContainerX);
        source.container.setOriginalY(targetContainerY);
        source.icon.setOriginalX(targetIconX);
        source.icon.setOriginalY(targetIconY);
        source.nameLabel.setOriginalX(targetNameX);
        source.nameLabel.setOriginalY(targetNameY);
        source.doseLabel.setOriginalX(targetDoseX);
        source.doseLabel.setOriginalY(targetDoseY);
        source.favButton.setOriginalX(targetFavX);
        source.favButton.setOriginalY(targetFavY);

        target.container.setOriginalX(sourceContainerX);
        target.container.setOriginalY(sourceContainerY);
        target.icon.setOriginalX(sourceIconX);
        target.icon.setOriginalY(sourceIconY);
        target.nameLabel.setOriginalX(sourceNameX);
        target.nameLabel.setOriginalY(sourceNameY);
        target.doseLabel.setOriginalX(sourceDoseX);
        target.doseLabel.setOriginalY(sourceDoseY);
        target.favButton.setOriginalX(sourceFavX);
        target.favButton.setOriginalY(sourceFavY);

        source.container.revalidate();
        source.icon.revalidate();
        source.nameLabel.revalidate();
        source.doseLabel.revalidate();
        source.favButton.revalidate();

        target.container.revalidate();
        target.icon.revalidate();
        target.nameLabel.revalidate();
        target.doseLabel.revalidate();

        if (source.potionBar != null && source.potionSubBar != null && source.potionBarText != null
                && target.potionBar != null && target.potionSubBar != null && target.potionBarText != null) {
            int sourceBarX = source.potionBar.getOriginalX();
            int sourceBarY = source.potionBar.getOriginalY();
            int sourceSubBarX = source.potionSubBar.getOriginalX();
            int sourceSubBarY = source.potionSubBar.getOriginalY();
            int sourceBarTextX = source.potionBarText.getOriginalX();
            int sourceBarTextY = source.potionBarText.getOriginalY();

            int targetBarX = target.potionBar.getOriginalX();
            int targetBarY = target.potionBar.getOriginalY();
            int targetSubBarX = target.potionSubBar.getOriginalX();
            int targetSubBarY = target.potionSubBar.getOriginalY();
            int targetBarTextX = target.potionBarText.getOriginalX();
            int targetBarTextY = target.potionBarText.getOriginalY();

            source.potionBar.setOriginalX(targetBarX);
            source.potionBar.setOriginalY(targetBarY);
            target.potionBar.setOriginalX(sourceBarX);
            target.potionBar.setOriginalY(sourceBarY);

            source.potionSubBar.setOriginalX(targetSubBarX);
            source.potionSubBar.setOriginalY(targetSubBarY);
            target.potionSubBar.setOriginalX(sourceSubBarX);
            target.potionSubBar.setOriginalY(sourceSubBarY);

            source.potionBarText.setOriginalX(targetBarTextX);
            source.potionBarText.setOriginalY(targetBarTextY);
            target.potionBarText.setOriginalX(sourceBarTextX);
            target.potionBarText.setOriginalY(sourceBarTextY);

            source.potionBar.revalidate();
            source.potionSubBar.revalidate();
            source.potionBarText.revalidate();

            target.potionBar.revalidate();
            target.potionSubBar.revalidate();
            target.potionBarText.revalidate();

            log.info("potion bars swapped!");
        }

        target.favButton.revalidate();

        int tempIndex = source.index;
        source.index = target.index;
        target.index = tempIndex;

        panel.savePosition(source, savedPositions);
        panel.savePosition(target, savedPositions);
    }

    public void hide() {
        container.setHidden(true);
        icon.setHidden(true);
        nameLabel.setHidden(true);
        doseLabel.setHidden(true);
        favButton.setHidden(true);
    }
}

package com.potionstoragecustomizer;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class PotionStorageCustomizerTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(PotionStorageCustomizerPlugin.class);
		RuneLite.main(args);
	}
}

