package com.itemnotification;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("itemnotification")
public interface ItemNotificationConfig extends Config {
	@ConfigItem(keyName = "onlyMyDrops", name = "Only My Drops", description = "Only notify for items dropped by NPCs you killed (useful for Ironman accounts)", position = 0)
	default boolean onlyMyDrops() {
		return false;
	}

	@ConfigItem(keyName = "highlightedItems", name = "Highlighted Items", description = "A list of items to notify on drop, comma separated", position = 1)
	default String highlightedItems() {
		return "";
	}

	@ConfigItem(keyName = "soundType", name = "Notification Sound", description = "The sound to play when a highlighted item is spawned")
	default SoundType soundType() {
		return SoundType.UNIQUE_JINGLE;
	}

	@net.runelite.client.config.Range(min = 0, max = 200)
	@ConfigItem(keyName = "soundVolume", name = "Sound Volume", description = "Volume of the custom sound (0-200%)")
	@net.runelite.client.config.Units(net.runelite.client.config.Units.PERCENT)
	default int soundVolume() {
		return 100;
	}
}

package com.itemnotification;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import javax.inject.Inject; // Keep Inject
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextField;
import javax.swing.border.EmptyBorder;
import lombok.extern.slf4j.Slf4j;
import net.runelite.client.ui.ColorScheme;
import net.runelite.client.ui.PluginPanel;

@Slf4j
public class ItemNotificationPanel extends PluginPanel {
    private final ItemNotificationConfig config;
    private final ItemNotificationPlugin plugin;

    private final JTextField searchBar = new JTextField();
    private final JPanel listContainer = new JPanel();

    @Inject
    public ItemNotificationPanel(ItemNotificationConfig config, ItemNotificationPlugin plugin) {
        super();
        this.config = config;
        this.plugin = plugin;

        setBorder(new EmptyBorder(10, 10, 10, 10));
        setLayout(new BorderLayout());

        // Search Bar
        JPanel searchContainer = new JPanel();
        searchContainer.setLayout(new BorderLayout());
        searchContainer.setBorder(new EmptyBorder(0, 0, 10, 0));

        searchBar.setPreferredSize(new Dimension(PluginPanel.PANEL_WIDTH - 20, 30));
        searchBar.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        searchBar.setToolTipText("Search for an item to add...");
        // Live search/filter
        searchBar.getDocument().addDocumentListener(new javax.swing.event.DocumentListener() {
            public void insertUpdate(javax.swing.event.DocumentEvent e) {
                search(searchBar.getText());
            }

            public void removeUpdate(javax.swing.event.DocumentEvent e) {
                search(searchBar.getText());
            }

            public void changedUpdate(javax.swing.event.DocumentEvent e) {
                search(searchBar.getText());
            }
        });
        searchBar.addActionListener(e -> addItem(searchBar.getText())); // Enter adds item

        JButton addButton = new JButton("Add");
        addButton.addActionListener(e -> addItem(searchBar.getText()));

        searchContainer.add(searchBar, BorderLayout.CENTER);
        searchContainer.add(addButton, BorderLayout.EAST);
        add(searchContainer, BorderLayout.NORTH);

        // List Container
        listContainer.setLayout(new javax.swing.BoxLayout(listContainer, javax.swing.BoxLayout.Y_AXIS));

        JScrollPane scrollPane = new JScrollPane(listContainer);
        scrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
        add(scrollPane, BorderLayout.CENTER);

        // Initial Update
        updateList();
    }

    public void updateList() {
        listContainer.removeAll();

        String highlightedItems = config.highlightedItems();
        if (highlightedItems != null && !highlightedItems.isEmpty()) {
            String[] items = highlightedItems.split(",");
            for (String item : items) {
                String trimmed = item.trim();
                if (!trimmed.isEmpty()) {
                    listContainer.add(createItemPanel(trimmed));
                }
            }
        }

        listContainer.revalidate();
        listContainer.repaint();
    }

    private JPanel createItemPanel(String itemName) {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBorder(new EmptyBorder(5, 5, 5, 5));
        panel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        panel.setMaximumSize(new Dimension(PluginPanel.PANEL_WIDTH, 40));

        JLabel nameLabel = new JLabel(itemName);
        panel.add(nameLabel, BorderLayout.CENTER);

        JButton removeBtn = new JButton("X");
        removeBtn.setPreferredSize(new Dimension(20, 20));
        removeBtn.addActionListener(e -> removeItem(itemName));
        panel.add(removeBtn, BorderLayout.EAST);

        return panel;
    }

    private void search(String query) {
        listContainer.removeAll();

        // 1. Show "Add New" button if we have text
        if (query != null && !query.isEmpty()) {
            JPanel addPanel = new JPanel(new BorderLayout());
            addPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
            addPanel.setBorder(new EmptyBorder(5, 5, 10, 5));
            addPanel.setMaximumSize(new Dimension(PluginPanel.PANEL_WIDTH, 40));

            JButton addBtn = new JButton("Add '" + query + "'");
            addBtn.addActionListener(e -> addItem(query));
            addPanel.add(addBtn, BorderLayout.CENTER);

            listContainer.add(addPanel);
        }

        // 2. Filter existing items
        String highlightedItems = config.highlightedItems();
        if (highlightedItems != null && !highlightedItems.isEmpty()) {
            String[] items = highlightedItems.split(",");

            for (String item : items) {
                String trimmed = item.trim();
                if (trimmed.isEmpty())
                    continue;

                // If query is empty, show all. If not, fuzzy match.
                if (query == null || query.isEmpty() || trimmed.toLowerCase().contains(query.toLowerCase())) {
                    listContainer.add(createItemPanel(trimmed));
                }
            }
        }

        listContainer.revalidate();
        listContainer.repaint();
    }

    private void addItem(String newItem) {
        String current = config.highlightedItems();
        if (current == null || current.isEmpty()) {
            plugin.updateConfig(newItem);
        } else {
            // Basic check to avoid dupes
            if (!Arrays.stream(current.split(",")).map(String::trim).anyMatch(s -> s.equalsIgnoreCase(newItem))) {
                plugin.updateConfig(current + "," + newItem);
            }
        }
        updateList();
        searchBar.setText("");
    }

    private void removeItem(String itemToRemove) {
        String current = config.highlightedItems();
        if (current == null)
            return;

        List<String> items = new ArrayList<>(Arrays.asList(current.split(",")));
        items.removeIf(s -> s.trim().equalsIgnoreCase(itemToRemove));

        plugin.updateConfig(String.join(",", items));
        updateList();
    }
}

package com.itemnotification;

import com.google.inject.Provides;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ItemComposition;
import net.runelite.api.events.ItemSpawned;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.NpcLootReceived;
import net.runelite.client.game.ItemManager;
import net.runelite.client.game.ItemStack;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;

@Slf4j
@PluginDescriptor(name = "Ground Item Notification")
public class ItemNotificationPlugin extends Plugin {

	@Inject
	private ItemNotificationConfig config;

	@Inject
	private ItemManager itemManager;

	@Inject
	private ConfigManager configManager;

	public void updateConfig(String newItems) {
		configManager.setConfiguration("itemnotification", "highlightedItems", newItems);
	}

	@Inject
	private net.runelite.client.audio.AudioPlayer audioPlayer;

	@Inject
	private net.runelite.client.ui.ClientToolbar clientToolbar;

	private ItemNotificationPanel panel;
	private net.runelite.client.ui.NavigationButton navButton;

	@Override
	protected void startUp() throws Exception {
		panel = new ItemNotificationPanel(config, this);

		// Use a standard icon (using a placeholder buffered image properly would need
		// ImageUtil but let's use a dummy runnable or load one)
		// For simplicity, we'll try to load the Ruby Item ID image.
		@SuppressWarnings("deprecation")
		final java.awt.image.BufferedImage icon = itemManager.getImage(net.runelite.api.ItemID.RUBY);

		navButton = net.runelite.client.ui.NavigationButton.builder()
				.tooltip("Item Notifications")
				.icon(icon)
				.priority(5)
				.panel(panel)
				.build();

		clientToolbar.addNavigation(navButton);

		log.info("Item Notification started!");
	}

	@Override
	protected void shutDown() throws Exception {
		clientToolbar.removeNavigation(navButton);
		log.info("Item Notification stopped!");
	}

	/**
	 * Handles ALL items spawning on the ground.
	 * Only used when "Only My Drops" is OFF - notifies for any highlighted item
	 * that appears on the ground, regardless of who dropped it.
	 */
	@Subscribe
	public void onItemSpawned(ItemSpawned itemSpawned) {
		// Skip if "Only My Drops" is enabled - we use NpcLootReceived instead
		if (config.onlyMyDrops()) {
			return;
		}

		final int itemId = itemSpawned.getItem().getId();
		final ItemComposition itemComposition = itemManager.getItemComposition(itemId);
		final String itemName = itemComposition.getName();

		if (isItemHighlighted(itemName, config.highlightedItems())) {
			log.info("Highlighted item spawned: {}", itemName);
			playSound(config.soundType());
		}
	}

	/**
	 * Handles loot from NPCs YOU killed - this event is ONLY fired for your own
	 * drops.
	 * Used when "Only My Drops" is ON - guaranteed to be loot from your kills only.
	 */
	@Subscribe
	public void onNpcLootReceived(NpcLootReceived event) {
		// Skip if "Only My Drops" is disabled - we use ItemSpawned instead
		if (!config.onlyMyDrops()) {
			return;
		}

		for (ItemStack item : event.getItems()) {
			final ItemComposition itemComposition = itemManager.getItemComposition(item.getId());
			final String itemName = itemComposition.getName();

			if (isItemHighlighted(itemName, config.highlightedItems())) {
				log.info("Highlighted item received from NPC kill: {}", itemName);
				playSound(config.soundType());
				// Only play sound once per loot event, even if multiple highlighted items drop
				return;
			}
		}
	}

	// Visible for testing
	boolean isItemHighlighted(String itemName, String highlightedItems) {
		if (highlightedItems == null || highlightedItems.isEmpty()) {
			return false;
		}

		List<String> itemsToNotify = Arrays.stream(highlightedItems.split(","))
				.map(String::trim)
				.map(String::toLowerCase)
				.collect(Collectors.toList());

		return itemsToNotify.contains(itemName.toLowerCase());
	}

	private void playSound(SoundType soundType) {
		if (soundType.getResourcePath() != null) {
			// Convert percentage to decibels
			// 100% = 0dB, 200% = ~6dB, 50% = ~-6dB
			float volume = config.soundVolume();
			// Prevent log(0) which is -infinity
			if (volume <= 0) {
				volume = 0.0001f;
			}
			float dB = (float) (20.0 * Math.log10(volume / 100.0));

			// Using RuneLite's AudioPlayer to avoid javax.sound usage
			try {
				audioPlayer.play(getClass(), soundType.getResourcePath(), dB);
			} catch (Exception e) {
				log.warn("Failed to play custom sound", e);
			}
		}
	}

	@Subscribe
	public void onConfigChanged(net.runelite.client.events.ConfigChanged event) {
		if (event.getGroup().equals("itemnotification")) {
			// Update the panel if the highlighted items config changes
			if (event.getKey().equals("highlightedItems")) {
				panel.updateList();
			}
		}
	}

	@Provides
	ItemNotificationConfig provideConfig(ConfigManager configManager) {
		return configManager.getConfig(ItemNotificationConfig.class);
	}
}

package com.itemnotification;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum SoundType {
    UNIQUE_JINGLE("Unique Jingle", "/Dt2Jingle.wav");

    private final String name;
    private final String resourcePath;

    @Override
    public String toString() {
        return name;
    }
}

package com.itemnotification;

import static org.junit.Assert.assertTrue;
import static org.junit.Assert.assertFalse;
import org.junit.Test;

public class ItemNotificationPluginTest
{
	private final ItemNotificationPlugin plugin = new ItemNotificationPlugin();

	@Test
	public void testItemMatching()
	{
		// Basic match
		assertTrue(plugin.isItemHighlighted("Bones", "Bones"));
		
		// Case insensitive
		assertTrue(plugin.isItemHighlighted("bones", "Bones"));
		assertTrue(plugin.isItemHighlighted("Bones", "bones"));

		// List matching
		assertTrue(plugin.isItemHighlighted("Ruby", "Bones, Ruby, Coin"));
		
		// Whitespace handling
		assertTrue(plugin.isItemHighlighted("Ruby", "Bones ,  Ruby  , Coin"));

		// Partial match should FAIL (we want exact matches only)
		assertFalse(plugin.isItemHighlighted("Ruby ring", "Ruby"));
		
		// Empty config
		assertFalse(plugin.isItemHighlighted("Anything", ""));
		assertFalse(plugin.isItemHighlighted("Anything", null));
	}
}

package com.itemnotification;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class PluginLauncher {
    @SuppressWarnings("unchecked")
    public static void main(String[] args) throws Exception {
        ExternalPluginManager.loadBuiltin(ItemNotificationPlugin.class);
        RuneLite.main(args);
    }
}

