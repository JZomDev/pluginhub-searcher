package clanrankupnotifier;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("clanrankupnotifier")
public interface ClanRankUpNotifierConfig extends Config
{
    // ClanRankNotifierConfig.java
    @ConfigItem(
            keyName = "eligibleRanks",
            name = "Eligible current ranks",
            description = "Only members whose CURRENT rank is in this list are checked. " +
                    "Use your clan's rank titles or numbers (-1..127) separated by comma ','. " +
                    "Examples:\nRecruit\nCorporal\n20\n100"
    )
    default String eligibleRanks()
    {
        return ""; // empty = no filtering (process all)
    }

    @ConfigItem(
            keyName = "rules",
            name = "Rank rules",
            description = "One rule per line: Days = Rank\n" +
                    "Rank can be a number (-1..127) or YOUR clan's rank title (case-insensitive).\n" +
                    "Examples:\n" +
                    "7=Recruit\n" +
                    "30=Corporal\n" +
                    "60=Sergeant\n" +
                    "Or numeric: 7=1, 30=10, 60=20"
    )
    default String rules()
    {
        return String.join("\n",
                "# Days = RankName or RankNumber",
                "7=Recruit",
                "30=Corporal",
                "60=Sergeant"
        );
    }

    @ConfigItem(
            keyName = "ignorelist",
            name = "Ignored users",
            description = "Ignored users (comma-separated). These names will be skipped."
    )
    default String ignoredUsers()
    {
        return "";
    }

    @ConfigItem(
            keyName = "notifyOnLogin",
            name = "Notify on login",
            description = "Notifies about rank-ups due on login."
    )
    default boolean notifyOnLogin() { return true; }
}

// ClanRankNotifierPanel.java
package clanrankupnotifier;

import net.runelite.client.ui.ColorScheme;
import net.runelite.client.ui.FontManager;
import net.runelite.client.ui.PluginPanel;

import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.util.List;

public class ClanRankUpNotifierPanel extends PluginPanel
{
    private static final int NAME_COLUMN_WIDTH = 65;
    private static final int DAYS_COLUMN_WIDTH = 40;
    private static final int CURRENT_RANK_COLUMN_WIDTH = 50;
    private static final int NEXT_RANK_COLUMN_WIDTH = 50;

    private final JPanel content = new JPanel();
    private final JLabel infoLabel = new JLabel();
    private final JButton runButton = new JButton("Update");

    public ClanRankUpNotifierPanel(Runnable onRunCheck)
    {
        setLayout(new BorderLayout(0, 4));
        setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));
        setBackground(ColorScheme.DARK_GRAY_COLOR);

        JPanel top = new JPanel(new BorderLayout());
        top.setOpaque(false);

        JLabel headerLabel = new JLabel("Clan Rank Up Notifier");
        headerLabel.setFont(headerLabel.getFont().deriveFont(Font.BOLD, 14f));
        headerLabel.setForeground(Color.WHITE);

        runButton.setFocusable(false);
        runButton.setMargin(new Insets(2, 8, 2, 8));
        runButton.addActionListener(e -> {
            setBusy(true);
            try {
                if (onRunCheck != null) onRunCheck.run();
            }
            finally { setBusy(false); }
        });

        top.add(headerLabel, BorderLayout.WEST);
        top.add(runButton, BorderLayout.EAST);
        add(top, BorderLayout.NORTH);

        infoLabel.setForeground(Color.LIGHT_GRAY);
        infoLabel.setFont(infoLabel.getFont().deriveFont(Font.PLAIN, 12f));
        infoLabel.setBorder(new EmptyBorder(2, 2, 2, 2));
        add(infoLabel, BorderLayout.CENTER);

        content.setLayout(new BoxLayout(content, BoxLayout.Y_AXIS));
        content.setBackground(ColorScheme.DARK_GRAY_COLOR);

        content.add(makeHeaderRow());

        content.setAlignmentX(0f);
        add(content, BorderLayout.SOUTH);
    }

    private JComponent makeWrappingNameCell(String text) {
        JTextArea ta = new JTextArea(text);
        ta.setFont(FontManager.getRunescapeSmallFont());
        ta.setForeground(Color.WHITE);
        ta.setOpaque(false);
        ta.setEditable(false);
        ta.setHighlighter(null);
        ta.setLineWrap(true);
        ta.setWrapStyleWord(true);
        ta.setBorder(new EmptyBorder(0, 4, 1, 4));
        ta.setSize(new Dimension(ClanRankUpNotifierPanel.NAME_COLUMN_WIDTH, Short.MAX_VALUE));
        Dimension pref = ta.getPreferredSize();
        Dimension fixed = new Dimension(ClanRankUpNotifierPanel.NAME_COLUMN_WIDTH, pref.height);
        ta.setMinimumSize(new Dimension(ClanRankUpNotifierPanel.NAME_COLUMN_WIDTH, 0));
        ta.setPreferredSize(fixed);
        ta.setMaximumSize(new Dimension(ClanRankUpNotifierPanel.NAME_COLUMN_WIDTH, Integer.MAX_VALUE));
        ta.setToolTipText(text);
        return ta;
    }

    public void setBusy(boolean busy) {
        SwingUtilities.invokeLater(() -> runButton.setEnabled(!busy));
    }

    public void setInfoText(String text) {
        SwingUtilities.invokeLater(() -> {
            infoLabel.setText(text == null ? "" : text);
            infoLabel.setVisible(text != null && !text.isBlank());
        });
    }

    public void setRows(List<String> lines)
    {
        SwingUtilities.invokeLater(() -> {
            content.removeAll();
            content.add(makeHeaderRow());

            if (lines == null || lines.isEmpty()) {
                content.add(makeInfoRow("No promotions due.\nSomething wrong? Please check the plugin configuration."));
            } else {
                for (String line : lines) content.add(createMemberRow(line));
            }

            content.revalidate();
            content.repaint();
        });
    }

    private JComponent makeInfoRow(String text) {
        JPanel row = new JPanel();
        row.setLayout(new BoxLayout(row, BoxLayout.X_AXIS));
        row.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        row.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createMatteBorder(0, 0, 1, 0, ColorScheme.DARK_GRAY_COLOR),
                new EmptyBorder(6, 8, 6, 8)));

        JLabel label = new JLabel(text);
        label.setForeground(Color.WHITE);
        row.add(label);
        row.setMaximumSize(new Dimension(Integer.MAX_VALUE, row.getPreferredSize().height));

        return row;
    }

    private JPanel makeHeaderRow() {
        JPanel row = new JPanel();
        row.setLayout(new BoxLayout(row, BoxLayout.X_AXIS));
        row.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        row.setBorder(BorderFactory.createCompoundBorder(
                BorderFactory.createMatteBorder(0, 0, 1, 0, ColorScheme.DARK_GRAY_COLOR),
                new EmptyBorder(6, 6, 6, 6)));

        row.add(makeHeaderLabel("Name", NAME_COLUMN_WIDTH));
        row.add(makeHeaderLabel("Days", DAYS_COLUMN_WIDTH));
        row.add(makeHeaderLabel("Curr", CURRENT_RANK_COLUMN_WIDTH));
        row.add(makeHeaderLabel("Next", NEXT_RANK_COLUMN_WIDTH));
        row.add(Box.createHorizontalGlue());
        row.setMaximumSize(new Dimension(Integer.MAX_VALUE, row.getPreferredSize().height));

        return row;
    }

    private JLabel makeHeaderLabel(String text, int width) {
        JLabel l = new JLabel(text);
        l.setFont(FontManager.getRunescapeSmallFont());
        l.setForeground(ColorScheme.PROGRESS_COMPLETE_COLOR.darker());
        l.setBorder(new EmptyBorder(0, 4, 0, 4));
        l.setToolTipText(text);
        fixWidth(l, width);
        return l;
    }

    private void fixWidth(JComponent c, int width) {
        Dimension d = new Dimension(width, c.getPreferredSize().height);
        c.setMinimumSize(new Dimension(width, d.height));
        c.setPreferredSize(new Dimension(width, d.height));
        c.setMaximumSize(new Dimension(width, Integer.MAX_VALUE));
    }

    private JPanel createMemberRow(String text)
    {
        String name = "";
        String days = "";
        String currentRank = "";
        String nextRank = "";

        String[] parts = text.split(",");
        name = parts.length > 0 ? parts[0].trim() : "?";
        days = parts.length > 1 ? parts[1].trim() : "?";
        nextRank =  parts.length > 2 ? parts[2].trim() : "?";
        currentRank = parts.length > 3 ? parts[3].trim() : "?";


        JPanel row = new JPanel();
        row.setLayout(new BoxLayout(row, BoxLayout.X_AXIS));
        row.setOpaque(true);
        row.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        row.setBorder(new EmptyBorder(4, 6, 4, 6));

        final Color base = row.getBackground();
        row.addMouseListener(new java.awt.event.MouseAdapter()
        {
            @Override public void mouseEntered(java.awt.event.MouseEvent e) { row.setBackground(base.brighter()); }
            @Override public void mouseExited (java.awt.event.MouseEvent e) { row.setBackground(base); }
        });

        JComponent nameLabel = makeWrappingNameCell(name);
        JLabel daysLabel = makeCell(days, DAYS_COLUMN_WIDTH, new Color(100, 225, 255));
        daysLabel.setHorizontalAlignment(SwingConstants.RIGHT);
        JLabel currentRankLabel = makeCell(currentRank, CURRENT_RANK_COLUMN_WIDTH, new Color(255, 230, 110));
        JLabel nextRankLabel = makeCell(nextRank, NEXT_RANK_COLUMN_WIDTH, new Color(140, 255, 160));

        row.add(nameLabel);
        row.add(daysLabel);
        row.add(currentRankLabel);
        row.add(nextRankLabel);
        row.add(Box.createHorizontalGlue());

        JPanel wrapper = new JPanel(new BorderLayout());
        wrapper.setOpaque(false);
        wrapper.add(row, BorderLayout.CENTER);
        wrapper.add(new JSeparator(JSeparator.HORIZONTAL), BorderLayout.SOUTH);
        wrapper.setMaximumSize(new Dimension(Integer.MAX_VALUE, wrapper.getPreferredSize().height));
        return wrapper;
    }

    private JLabel makeCell(String text, int width, Color fg) {
        JLabel l = new JLabel(text);
        l.setFont(FontManager.getRunescapeSmallFont());
        l.setForeground(fg);
        l.setBorder(new EmptyBorder(0, 4, 0, 4));
        fixWidth(l, width);
        l.setToolTipText(text);
        return l;
    }
}

package clanrankupnotifier;

import com.google.inject.Provides;
import net.runelite.api.Client;
import net.runelite.api.GameState;
import net.runelite.api.clan.*;
import net.runelite.api.events.ClanChannelChanged;
import net.runelite.api.events.GameStateChanged;
import net.runelite.client.Notifier;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.ClientToolbar;
import net.runelite.client.ui.NavigationButton;
import net.runelite.client.util.ImageUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import java.awt.image.BufferedImage;
import java.time.LocalDate;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.ScheduledFuture;

@PluginDescriptor(
        name = "Clan Rank Up Notifier",
        description = "Notifies when clan members hit time-in-clan thresholds (configurable)",
        tags = {"clan", "rank", "notify"}
)
public class ClanRankUpNotifierPlugin extends Plugin
{
    private static final Logger LOG = LoggerFactory.getLogger(ClanRankUpNotifierPlugin.class);

    @Inject private Client client;
    @Inject private ClientThread clientThread;
    @Inject private Notifier notifier;
    @Inject private ClientToolbar clientToolbar;
    @Inject private ClanRankUpNotifierConfig config;
    @Inject private ScheduledExecutorService scheduler;

    private ClanRankUpNotifierPanel panel;
    private NavigationButton navButton;

    private ScheduledFuture<?> task;

    private volatile NavigableMap<Integer, String> rules = new TreeMap<>();
    private final Map<String, String> notifiedToday = new HashMap<>();
    private volatile Set<String> eligibleRanksSet = Set.of();
    private volatile Set<String> ignoredUsersSet   = Set.of();
    private LocalDate lastNotificationDate = null;

    @Provides
    ClanRankUpNotifierConfig provideConfig(ConfigManager cm) { return cm.getConfig(ClanRankUpNotifierConfig.class); }

    @Override
    protected void startUp()
    {
        panel = new ClanRankUpNotifierPanel(this::runManualCheck);

        BufferedImage icon = null;
        try { icon = ImageUtil.loadImageResource(ClanRankUpNotifierPlugin.class, "icon.png"); }
        catch (Exception ignored) {}
        if (icon == null) icon = new BufferedImage(1, 1, BufferedImage.TYPE_INT_ARGB);

        navButton = NavigationButton.builder()
                .tooltip("Clan Rank Notifier")
                .icon(icon)
                .priority(5)
                .panel(panel)
                .build();

        clientToolbar.addNavigation(navButton);

        parseRules();
        clientThread.invokeLater(this::checkRosterAndNotify);
        LOG.info("[ClanRankNotifier] started");
    }

    @Override
    protected void shutDown()
    {
        if (task != null) { task.cancel(true); task = null; }
        if (navButton != null) { clientToolbar.removeNavigation(navButton); navButton = null; }
        panel = null;
        LOG.info("[ClanRankNotifier] stopped");
    }

    private void parseRules()
    {
        TreeMap<Integer, String> tmp = new TreeMap<>();
        for (String line : config.rules().split("\\R"))
        {
            String s = line.trim();
            if (s.isEmpty() || s.startsWith("#")) continue;
            String[] parts = s.split("=");
            if (parts.length != 2) continue;

            try {
                int days = Integer.parseInt(parts[0].trim());
                String rank = parts[1].trim();
                tmp.put(days, rank);
            } catch (NumberFormatException ignored) { }
        }
        rules = tmp;

        eligibleRanksSet = csvToLowerSet(config.eligibleRanks());
        ignoredUsersSet  = csvToLowerSet(config.ignoredUsers());
    }

    private static Set<String> csvToLowerSet(String s) {
        if (s == null) return Set.of();
        String[] parts = s.split(",");
        Set<String> out = new HashSet<>();
        for (String p : parts) {
               String t = p.trim().toLowerCase();
                if (!t.isEmpty()) out.add(t);
            }
        return out;
    }

    private ClanSettings getClan()
    {
        try {
            ClanSettings cs = client.getClanSettings(ClanID.CLAN);
            if (cs != null && cs.getMembers() != null) return cs;
        } catch (Throwable ignored) { }

        try {
            ClanSettings cs = client.getClanSettings();
            if (cs != null && cs.getMembers() != null) return cs;
        } catch (Throwable ignored) { }

        return null;
    }

    @Subscribe
    public void onGameStateChanged(GameStateChanged e)
    {
        if (e.getGameState() == GameState.LOGGED_IN)
            clientThread.invokeLater(this::checkRosterAndNotify);
    }

    @Subscribe
    public void onClanChannelChanged(ClanChannelChanged e)
    {
        clientThread.invokeLater(this::checkRosterAndNotify);
    }

    @Subscribe
    public void onConfigChanged(ConfigChanged e)
    {
        if (!"clanrankupnotifier".equals(e.getGroup())) return;
        parseRules();
        clientThread.invokeLater(this::checkRosterAndNotify);
    }

    private void checkRosterAndNotify()
    {
        if (client.getGameState() != GameState.LOGGED_IN) return;

        ClanSettings cs = getClan();
        if (cs == null || rules.isEmpty())
        {
            panel.setRows(List.of());
            return;
        }
        else
        {
            panel.setInfoText("");
        }

        LocalDate today = LocalDate.now();
        if (!today.equals(lastNotificationDate))
        {
            notifiedToday.clear();
            lastNotificationDate = today;
        }

        final List<String> due = new ArrayList<>();

        for (ClanMember member : cs.getMembers())
        {
            final String name = member.getName();
            if (name == null || name.isBlank()) continue;

            final LocalDate joined = getJoinDate(member);
            if (joined == null) continue;

            final long days = ChronoUnit.DAYS.between(joined, today);
            final Map.Entry<Integer, String> rule = rules.floorEntry((int) days);
            if (rule == null) continue;

            final String targetRankName = rule.getValue();
            final ClanRank currentRank = member.getRank();
            final ClanTitle currentClanRankTitle = cs.titleForRank(currentRank);
            final boolean noRank = currentClanRankTitle == null;
            final String currentRankName = noRank ? "Not ranked" : cs.titleForRank(currentRank).getName();

            final boolean eligibleRank = eligibleRanksSet.contains(currentRankName.toLowerCase());
            final boolean correctRank = targetRankName.trim().equalsIgnoreCase(currentRankName.trim());
            final boolean inIgnoreList = ignoredUsersSet.contains(name.toLowerCase());

            if (!eligibleRank || correctRank || noRank || inIgnoreList) continue;

            due.add(String.format("%s,%d,%s,%s", name, days, targetRankName, currentRankName));
            final String last = notifiedToday.get(name);
            if (!Objects.equals(last, targetRankName)) {
                notifier.notify(String.format(
                        "[Clan Rank] %s is %d days in clan â†’ due for %s (current: %s)",
                        name, days, targetRankName, currentRankName));
                notifiedToday.put(name, targetRankName);
            }
        }

        due.sort((a, b) -> {
                        int da = Integer.parseInt(a.split(",")[1].trim());
                        int db = Integer.parseInt(b.split(",")[1].trim());
                        return Integer.compare(db, da);
                    });

        panel.setInfoText("Members due: " + due.size());
        panel.setRows(due);
    }

    private void runManualCheck()
    {
        clientThread.invoke(() -> {
            try {
                panel.setBusy(true);
                checkRosterAndNotify();
            } finally {
                panel.setBusy(false);
            }
        });
    }

    private LocalDate getJoinDate(ClanMember member)
    {
        try {
            LocalDate date = member.getJoinDate();
            if (date != null) return date;
        } catch (Throwable ignored) { }

        return null;
    }
}

package clanrankupnotifier;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ClanRankUpNotifierTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(ClanRankUpNotifierPlugin.class);
		RuneLite.main(args);
	}
}
