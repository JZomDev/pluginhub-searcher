package com.runeccg;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;

@ConfigGroup("runeccg")
public interface RuneCCGConfig extends Config
{
	// Config is now stored per-character using ConfigManager directly
	// See RuneCCGPlugin for getCurrentXp(), setCurrentXp(), getTotalCoins(), setTotalCoins()
}

package com.runeccg;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Desktop;
import java.awt.Dimension;
import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.net.URI;
import java.util.function.Consumer;
import javax.imageio.ImageIO;
import javax.inject.Inject;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JEditorPane;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JProgressBar;
import javax.swing.JTextField;
import javax.swing.SwingConstants;
import javax.swing.border.EmptyBorder;
import javax.swing.event.HyperlinkEvent;
import lombok.extern.slf4j.Slf4j;
import net.runelite.client.ui.ColorScheme;
import net.runelite.client.ui.FontManager;
import net.runelite.client.ui.PluginPanel;

@Slf4j
public class RuneCCGPanel extends PluginPanel
{
    private static final int XP_PER_SILVER_COIN = 1000;
    private final JLabel xpLabel = new JLabel("XP: 0 / 1000");
    private final JLabel coinsLabel = new JLabel();
    private final JProgressBar progressBar = new JProgressBar(0, XP_PER_SILVER_COIN);
    private final JTextField lastCodeField = new JTextField();
    private BufferedImage coinIcon;
    private Consumer<Integer> cashOutCallback;
    private JPanel headerPanel;
    private JPanel contentPanel;
    private JPanel loggedOutPanel;

    @Inject
    public RuneCCGPanel()
    {
        setLayout(new BorderLayout());
        setBorder(new EmptyBorder(10, 10, 10, 10));
        setBackground(ColorScheme.DARK_GRAY_COLOR);

        // Load coin icon
        try
        {
            coinIcon = ImageIO.read(getClass().getResourceAsStream("panel_icon.png"));
        }
        catch (IOException e)
        {
            log.error("Failed to load coin icon", e);
        }

        // Header panel
        headerPanel = new JPanel();
        headerPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        headerPanel.setBorder(new EmptyBorder(10, 10, 10, 10));
        headerPanel.setLayout(new BorderLayout());

        JLabel title = new JLabel("RuneCCG");
        title.setForeground(ColorScheme.BRAND_ORANGE);
        title.setFont(FontManager.getRunescapeBoldFont());
        title.setHorizontalAlignment(SwingConstants.CENTER);
        headerPanel.add(title, BorderLayout.NORTH);

        add(headerPanel, BorderLayout.NORTH);

        // Content panel
        contentPanel = new JPanel();
        contentPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
        contentPanel.setBorder(new EmptyBorder(15, 10, 10, 10));
        contentPanel.setLayout(new BorderLayout(0, 10));

        // Coin display panel
        JPanel coinPanel = new JPanel();
        coinPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        coinPanel.setBorder(new EmptyBorder(15, 10, 15, 10));
        coinPanel.setLayout(new BorderLayout());

        if (coinIcon != null)
        {
            Image scaledIcon = coinIcon.getScaledInstance(48, 48, Image.SCALE_SMOOTH);
            JLabel iconLabel = new JLabel(new ImageIcon(scaledIcon));
            iconLabel.setHorizontalAlignment(SwingConstants.CENTER);
            coinPanel.add(iconLabel, BorderLayout.WEST);
        }

        coinsLabel.setText("0 Silver Coins");
        coinsLabel.setFont(FontManager.getRunescapeBoldFont());
        coinsLabel.setForeground(Color.YELLOW);
        coinsLabel.setHorizontalAlignment(SwingConstants.CENTER);
        coinPanel.add(coinsLabel, BorderLayout.CENTER);

        contentPanel.add(coinPanel, BorderLayout.NORTH);

        // Progress panel
        JPanel progressPanel = new JPanel();
        progressPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
        progressPanel.setLayout(new BorderLayout(0, 8));

        JLabel progressTitle = new JLabel("Progress to Next Silver Coin:");
        progressTitle.setHorizontalAlignment(SwingConstants.CENTER);
        progressTitle.setFont(FontManager.getRunescapeSmallFont());
        progressPanel.add(progressTitle, BorderLayout.NORTH);

        progressBar.setStringPainted(false);
        progressBar.setPreferredSize(new Dimension(0, 24));
        progressBar.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        progressBar.setForeground(new Color(255, 200, 0));
        progressPanel.add(progressBar, BorderLayout.CENTER);

        xpLabel.setHorizontalAlignment(SwingConstants.CENTER);
        xpLabel.setFont(FontManager.getRunescapeFont());
        xpLabel.setBorder(new EmptyBorder(5, 0, 0, 0));
        progressPanel.add(xpLabel, BorderLayout.SOUTH);

        contentPanel.add(progressPanel, BorderLayout.CENTER);

        // Bottom panel for cash out and debug
        JPanel bottomPanel = new JPanel();
        bottomPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
        bottomPanel.setLayout(new BoxLayout(bottomPanel, BoxLayout.Y_AXIS));
        bottomPanel.setBorder(new EmptyBorder(10, 0, 0, 0));

        // Cash out panel
        JPanel cashOutPanel = new JPanel();
        cashOutPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        cashOutPanel.setBorder(new EmptyBorder(10, 10, 10, 10));
        cashOutPanel.setLayout(new BorderLayout(0, 8));

        JLabel cashOutTitle = new JLabel("Cash Out Silver Coins:");
        cashOutTitle.setFont(FontManager.getRunescapeSmallFont());
        cashOutPanel.add(cashOutTitle, BorderLayout.NORTH);

        JPanel inputContainer = new JPanel();
        inputContainer.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        inputContainer.setLayout(new BorderLayout(0, 5));

        JTextField amountField = new JTextField();
        amountField.setPreferredSize(new Dimension(0, 30));
        inputContainer.add(amountField, BorderLayout.NORTH);

        JButton cashOutButton = new JButton("Generate Code");
        cashOutButton.setPreferredSize(new Dimension(0, 30));
        cashOutButton.addActionListener(e -> {
            try
            {
                int amount = Integer.parseInt(amountField.getText().trim());
                if (amount <= 0)
                {
                    JOptionPane.showMessageDialog(this, "Please enter a positive number", "Invalid Amount", JOptionPane.ERROR_MESSAGE);
                    return;
                }
                if (cashOutCallback != null)
                {
                    cashOutCallback.accept(amount);
                    amountField.setText("");
                }
            }
            catch (NumberFormatException ex)
            {
                JOptionPane.showMessageDialog(this, "Please enter a valid number", "Invalid Input", JOptionPane.ERROR_MESSAGE);
            }
        });
        inputContainer.add(cashOutButton, BorderLayout.SOUTH);

        cashOutPanel.add(inputContainer, BorderLayout.CENTER);

        // Last generated code display
        JPanel codeDisplayPanel = new JPanel();
        codeDisplayPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        codeDisplayPanel.setLayout(new BorderLayout(0, 5));

        JLabel codeLabel = new JLabel("Last Generated Code:");
        codeLabel.setFont(FontManager.getRunescapeSmallFont());
        codeDisplayPanel.add(codeLabel, BorderLayout.NORTH);

        lastCodeField.setPreferredSize(new Dimension(0, 30));
        lastCodeField.setEditable(false);
        codeDisplayPanel.add(lastCodeField, BorderLayout.CENTER);

        cashOutPanel.add(codeDisplayPanel, BorderLayout.SOUTH);

        bottomPanel.add(cashOutPanel);

        bottomPanel.add(Box.createVerticalStrut(10));

        // Instructions panel
        JPanel instructionsPanel = new JPanel();
        instructionsPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        instructionsPanel.setBorder(new EmptyBorder(10, 10, 10, 10));
        instructionsPanel.setLayout(new BorderLayout());

        JEditorPane instructionsPane = new JEditorPane();
        instructionsPane.setContentType("text/html");
        instructionsPane.setEditable(false);
        instructionsPane.setOpaque(false);
        instructionsPane.setFocusable(false);

        String instructions = "<html><body style='font-family: sans-serif; font-size: 10px; color: #b8b8b8;'>"
                + "<p style='margin-top: 0; margin-bottom: 8px;'><b style='color: #ff981f;'>Where do I open packs?</b><br>"
                + "To give the best graphical experience, pack openings are done on a dedicated website - navigate to "
                + "<a href='https://www.runeccg.com'>RuneCCG.com</a> to buy and open packs!</p>"
                + "<p style='margin-bottom: 8px;'><b style='color: #ff981f;'>How do I move my coins from here to RuneCCG?</b><br>"
                + "1) Specify how many coins you want to cash out in the dialogue box<br>"
                + "2) Click the \"Generate Code\" button. This will deduct that amount from your balance<br>"
                + "3) Navigate to <a href='https://www.runeccg.com'>RuneCCG.com</a><br>"
                + "4) Click the currency button in the top right to open the Add Currency interface<br>"
                + "5) Paste the code in that you copied, you will be granted your coins</p>"
                + "<p style='color: #ff0000; font-weight: bold; margin-bottom: 0;'>DO NOT LOSE YOUR CODE OR YOU WILL NOT BE ABLE TO CLAIM YOUR COINS</p>"
                + "</body></html>";

        instructionsPane.setText(instructions);

        // Add hyperlink listener
        instructionsPane.addHyperlinkListener(e -> {
            if (e.getEventType() == HyperlinkEvent.EventType.ACTIVATED)
            {
                try
                {
                    Desktop.getDesktop().browse(new URI(e.getURL().toString()));
                }
                catch (Exception ex)
                {
                    log.error("Failed to open URL", ex);
                }
            }
        });

        instructionsPanel.add(instructionsPane, BorderLayout.CENTER);
        bottomPanel.add(instructionsPanel);

        contentPanel.add(bottomPanel, BorderLayout.SOUTH);

        add(contentPanel, BorderLayout.CENTER);

        // Start with panel disabled (user not logged in)
        setContentEnabled(false);
    }

    public void setCashOutCallback(Consumer<Integer> callback)
    {
        this.cashOutCallback = callback;
    }

    public void showCodeDialog(String code)
    {
        lastCodeField.setText(code);
        JOptionPane.showMessageDialog(this,
                "Code generated and copied to clipboard:\n\n" + code + "\n\nPaste this code on the website to redeem your Silver Coins!",
                "Cash Out Code",
                JOptionPane.INFORMATION_MESSAGE);
    }

    public void updateProgress(int currentXp, int totalCoins)
    {
        progressBar.setValue(currentXp);
        xpLabel.setText(String.format("XP: %d / %d", currentXp, XP_PER_SILVER_COIN));
        coinsLabel.setText(String.format("%d Silver Coins", totalCoins));
    }

    public void showEventWorldWarning(Runnable onConfirm)
    {
        // Clear content panel
        contentPanel.removeAll();
        contentPanel.setLayout(new BoxLayout(contentPanel, BoxLayout.Y_AXIS));

        contentPanel.add(Box.createVerticalStrut(20));

        // Warning message
        JEditorPane warningPane = new JEditorPane();
        warningPane.setContentType("text/html");
        warningPane.setEditable(false);
        warningPane.setOpaque(false);
        warningPane.setFocusable(false);
        warningPane.setBackground(ColorScheme.DARK_GRAY_COLOR);

        String warningText = "<html><body style='font-family: sans-serif; font-size: 12px; color: #ffffff; text-align: center;'>"
                + "<p style='margin: 10px; line-height: 1.5;'><b style='color: #ff0000; font-size: 14px;'>EVENT WORLD DETECTED</b></p>"
                + "<p style='margin: 10px; color: #ffcc00; line-height: 1.5;'>This is not a main game world. XP may be boosted here causing you to gain more coins than you normally would.</p>"
                + "<p style='margin: 10px; line-height: 1.5;'>Would you still like to track XP anyway?</p>"
                + "</body></html>";

        warningPane.setText(warningText);
        warningPane.setAlignmentX(CENTER_ALIGNMENT);
        contentPanel.add(warningPane);

        contentPanel.add(Box.createVerticalStrut(20));

        // Confirm button
        JButton confirmButton = new JButton("Yes Please!");
        confirmButton.setMaximumSize(new Dimension(200, 40));
        confirmButton.setAlignmentX(CENTER_ALIGNMENT);
        confirmButton.setBackground(new Color(70, 130, 70));
        confirmButton.setForeground(Color.WHITE);
        confirmButton.setFont(FontManager.getRunescapeBoldFont());
        confirmButton.addActionListener(e -> onConfirm.run());

        contentPanel.add(confirmButton);
        contentPanel.add(Box.createVerticalGlue());

        revalidate();
        repaint();
    }

    public void setContentEnabled(boolean enabled)
    {
        if (!enabled)
        {
            // Hide content panel and show "logged out" message
            contentPanel.setVisible(false);

            loggedOutPanel = new JPanel();
            loggedOutPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
            loggedOutPanel.setLayout(new BoxLayout(loggedOutPanel, BoxLayout.Y_AXIS));

            JLabel messageLabel = new JLabel("Please log in to see silver and track XP");
            messageLabel.setFont(FontManager.getRunescapeFont());
            messageLabel.setForeground(Color.GRAY);
            messageLabel.setAlignmentX(CENTER_ALIGNMENT);
            messageLabel.setBorder(new EmptyBorder(10, 0, 0, 0));

            loggedOutPanel.add(Box.createVerticalGlue());
            loggedOutPanel.add(messageLabel);
            loggedOutPanel.add(Box.createVerticalGlue());

            add(loggedOutPanel, BorderLayout.CENTER);
        }
        else
        {
            // Remove logged out panel and show content panel
            if (loggedOutPanel != null)
            {
                remove(loggedOutPanel);
                loggedOutPanel = null;
            }
            add(contentPanel, BorderLayout.CENTER);
            contentPanel.setVisible(true);
        }
        revalidate();
        repaint();
    }

    public void rebuildNormalUI()
    {
        // Clear content panel
        contentPanel.removeAll();
        contentPanel.setLayout(new BorderLayout(0, 10));

        // Coin display panel
        JPanel coinPanel = new JPanel();
        coinPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        coinPanel.setBorder(new EmptyBorder(15, 10, 15, 10));
        coinPanel.setLayout(new BorderLayout());

        if (coinIcon != null)
        {
            Image scaledIcon = coinIcon.getScaledInstance(48, 48, Image.SCALE_SMOOTH);
            JLabel iconLabel = new JLabel(new ImageIcon(scaledIcon));
            iconLabel.setHorizontalAlignment(SwingConstants.CENTER);
            coinPanel.add(iconLabel, BorderLayout.WEST);
        }

        coinsLabel.setFont(FontManager.getRunescapeBoldFont());
        coinsLabel.setForeground(Color.YELLOW);
        coinsLabel.setHorizontalAlignment(SwingConstants.CENTER);
        coinPanel.add(coinsLabel, BorderLayout.CENTER);

        contentPanel.add(coinPanel, BorderLayout.NORTH);

        // Progress panel
        JPanel progressPanel = new JPanel();
        progressPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
        progressPanel.setLayout(new BorderLayout(0, 8));

        JLabel progressTitle = new JLabel("Progress to Next Silver Coin:");
        progressTitle.setHorizontalAlignment(SwingConstants.CENTER);
        progressTitle.setFont(FontManager.getRunescapeSmallFont());
        progressPanel.add(progressTitle, BorderLayout.NORTH);

        progressBar.setStringPainted(false);
        progressBar.setPreferredSize(new Dimension(0, 24));
        progressBar.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        progressBar.setForeground(new Color(255, 200, 0));
        progressPanel.add(progressBar, BorderLayout.CENTER);

        xpLabel.setHorizontalAlignment(SwingConstants.CENTER);
        xpLabel.setFont(FontManager.getRunescapeFont());
        xpLabel.setBorder(new EmptyBorder(5, 0, 0, 0));
        progressPanel.add(xpLabel, BorderLayout.SOUTH);

        contentPanel.add(progressPanel, BorderLayout.CENTER);

        // Bottom panel for cash out and debug
        JPanel bottomPanel = new JPanel();
        bottomPanel.setBackground(ColorScheme.DARK_GRAY_COLOR);
        bottomPanel.setLayout(new BoxLayout(bottomPanel, BoxLayout.Y_AXIS));
        bottomPanel.setBorder(new EmptyBorder(10, 0, 0, 0));

        // Cash out panel
        JPanel cashOutPanel = new JPanel();
        cashOutPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        cashOutPanel.setBorder(new EmptyBorder(10, 10, 10, 10));
        cashOutPanel.setLayout(new BorderLayout(0, 8));

        JLabel cashOutTitle = new JLabel("Cash Out Silver Coins:");
        cashOutTitle.setFont(FontManager.getRunescapeSmallFont());
        cashOutPanel.add(cashOutTitle, BorderLayout.NORTH);

        JPanel inputContainer = new JPanel();
        inputContainer.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        inputContainer.setLayout(new BorderLayout(0, 5));

        JTextField amountField = new JTextField();
        amountField.setPreferredSize(new Dimension(0, 30));
        inputContainer.add(amountField, BorderLayout.NORTH);

        JButton cashOutButton = new JButton("Generate Code");
        cashOutButton.setPreferredSize(new Dimension(0, 30));
        cashOutButton.addActionListener(e -> {
            try
            {
                int amount = Integer.parseInt(amountField.getText().trim());
                if (amount <= 0)
                {
                    JOptionPane.showMessageDialog(this, "Please enter a positive number", "Invalid Amount", JOptionPane.ERROR_MESSAGE);
                    return;
                }
                if (cashOutCallback != null)
                {
                    cashOutCallback.accept(amount);
                    amountField.setText("");
                }
            }
            catch (NumberFormatException ex)
            {
                JOptionPane.showMessageDialog(this, "Please enter a valid number", "Invalid Input", JOptionPane.ERROR_MESSAGE);
            }
        });
        inputContainer.add(cashOutButton, BorderLayout.SOUTH);

        cashOutPanel.add(inputContainer, BorderLayout.CENTER);

        // Last generated code display
        JPanel codeDisplayPanel = new JPanel();
        codeDisplayPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        codeDisplayPanel.setLayout(new BorderLayout(0, 5));

        JLabel codeLabel = new JLabel("Last Generated Code:");
        codeLabel.setFont(FontManager.getRunescapeSmallFont());
        codeDisplayPanel.add(codeLabel, BorderLayout.NORTH);

        lastCodeField.setPreferredSize(new Dimension(0, 30));
        lastCodeField.setEditable(false);
        codeDisplayPanel.add(lastCodeField, BorderLayout.CENTER);

        cashOutPanel.add(codeDisplayPanel, BorderLayout.SOUTH);

        bottomPanel.add(cashOutPanel);

        bottomPanel.add(Box.createVerticalStrut(10));

        // Instructions panel
        JPanel instructionsPanel = new JPanel();
        instructionsPanel.setBackground(ColorScheme.DARKER_GRAY_COLOR);
        instructionsPanel.setBorder(new EmptyBorder(10, 10, 10, 10));
        instructionsPanel.setLayout(new BorderLayout());

        JEditorPane instructionsPane = new JEditorPane();
        instructionsPane.setContentType("text/html");
        instructionsPane.setEditable(false);
        instructionsPane.setOpaque(false);
        instructionsPane.setFocusable(false);

        String instructions = "<html><body style='font-family: sans-serif; font-size: 10px; color: #b8b8b8;'>"
                + "<p style='margin-top: 0; margin-bottom: 8px;'><b style='color: #ff981f;'>Where do I open packs?</b><br>"
                + "To give the best graphical experience, pack openings are done on a dedicated website - navigate to "
                + "<a href='https://www.runeccg.com'>RuneCCG.com</a> to buy and open packs!</p>"
                + "<p style='margin-bottom: 8px;'><b style='color: #ff981f;'>How do I move my coins from here to RuneCCG?</b><br>"
                + "1) Specify how many coins you want to cash out in the dialogue box<br>"
                + "2) Click the \"Generate Code\" button. This will deduct that amount from your balance<br>"
                + "3) Navigate to <a href='https://www.runeccg.com'>RuneCCG.com</a><br>"
                + "4) Click the currency button in the top right to open the Add Currency interface<br>"
                + "5) Paste the code in that you copied, you will be granted your coins</p>"
                + "<p style='color: #ff0000; font-weight: bold; margin-bottom: 0;'>DO NOT LOSE YOUR CODE OR YOU WILL NOT BE ABLE TO CLAIM YOUR COINS</p>"
                + "</body></html>";

        instructionsPane.setText(instructions);

        // Add hyperlink listener
        instructionsPane.addHyperlinkListener(e -> {
            if (e.getEventType() == HyperlinkEvent.EventType.ACTIVATED)
            {
                try
                {
                    Desktop.getDesktop().browse(new URI(e.getURL().toString()));
                }
                catch (Exception ex)
                {
                    log.error("Failed to open URL", ex);
                }
            }
        });

        instructionsPanel.add(instructionsPane, BorderLayout.CENTER);
        bottomPanel.add(instructionsPanel);

        contentPanel.add(bottomPanel, BorderLayout.SOUTH);

        revalidate();
        repaint();
    }
}

package com.runeccg;

import java.awt.Toolkit;
import java.awt.datatransfer.StringSelection;
import java.awt.image.BufferedImage;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.SecureRandom;
import java.util.Base64;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.Map;
import javax.crypto.Mac;
import javax.crypto.spec.SecretKeySpec;
import javax.inject.Inject;
import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.Skill;
import net.runelite.api.WorldType;
import net.runelite.api.events.StatChanged;
import net.runelite.api.events.GameStateChanged;
import net.runelite.api.GameState;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.ClientToolbar;
import net.runelite.client.ui.NavigationButton;
import net.runelite.client.util.ImageUtil;

@Slf4j
@PluginDescriptor(
		name = "RuneCCG"
)
public class RuneCCGPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private ConfigManager configManager;

	@Inject
	private ClientToolbar clientToolbar;

	private RuneCCGPanel panel;
	private NavigationButton navButton;
	private final Map<Skill, Integer> previousXpMap = new HashMap<>();
	private boolean userConfirmedEventWorld = false;

	// Secret key for HMAC signing - KEEP THIS SECRET
	// In production, this should match the key on your backend
	private static final String SECRET_KEY = "RuneCCG_Secret_Key_2026_Change_This_In_Production";
	private static final String CONFIG_GROUP = "runeccg";
	private static final String CONFIG_KEY_CURRENT_XP = "currentXp";
	private static final String CONFIG_KEY_TOTAL_COINS = "totalCoins";

	// Helper methods for per-character config storage
	private int getCurrentXp()
	{
		Integer xp = configManager.getRSProfileConfiguration(CONFIG_GROUP, CONFIG_KEY_CURRENT_XP, int.class);
		return xp != null ? xp : 0;
	}

	private void setCurrentXp(int xp)
	{
		configManager.setRSProfileConfiguration(CONFIG_GROUP, CONFIG_KEY_CURRENT_XP, xp);
	}

	private int getTotalCoins()
	{
		Integer coins = configManager.getRSProfileConfiguration(CONFIG_GROUP, CONFIG_KEY_TOTAL_COINS, int.class);
		return coins != null ? coins : 0;
	}

	private void setTotalCoins(int coins)
	{
		configManager.setRSProfileConfiguration(CONFIG_GROUP, CONFIG_KEY_TOTAL_COINS, coins);
	}

	@Override
	protected void startUp() throws Exception
	{
		log.info("RuneCCG plugin started!");

		panel = injector.getInstance(RuneCCGPanel.class);

		final BufferedImage icon = ImageUtil.loadImageResource(getClass(), "panel_icon.png");

		navButton = NavigationButton.builder()
				.tooltip("RuneCCG")
				.icon(icon)
				.priority(5)
				.panel(panel)
				.build();

		clientToolbar.addNavigation(navButton);

		// Initialize the panel with current values
		panel.updateProgress(getCurrentXp(), getTotalCoins());

		// Set up callbacks
		panel.setCashOutCallback(this::cashOutSilverCoins);
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.info("RuneCCG plugin stopped!");
		clientToolbar.removeNavigation(navButton);
		userConfirmedEventWorld = false;
	}

	@Subscribe
	public void onGameStateChanged(GameStateChanged gameStateChanged)
	{
		if (gameStateChanged.getGameState() == GameState.LOGGED_IN)
		{
			// Enable panel and refresh data for current character
			SwingUtilities.invokeLater(() -> {
				panel.setContentEnabled(true);
				panel.updateProgress(getCurrentXp(), getTotalCoins());
			});
			checkEventWorld();
		}
		else if (gameStateChanged.getGameState() == GameState.LOGIN_SCREEN ||
				 gameStateChanged.getGameState() == GameState.HOPPING)
		{
			userConfirmedEventWorld = false;
			previousXpMap.clear(); // Clear XP tracking when changing worlds

			// Disable panel when logged out
			if (gameStateChanged.getGameState() == GameState.LOGIN_SCREEN)
			{
				SwingUtilities.invokeLater(() -> panel.setContentEnabled(false));
			}
		}
	}

	@Subscribe
	public void onStatChanged(StatChanged statChanged)
	{
		if (isEventWorld() && !userConfirmedEventWorld)
		{
			return;
		}

		Skill skill = statChanged.getSkill();
		int currentXp = statChanged.getXp();

		// Get previous XP for this skill
		Integer previousXp = previousXpMap.get(skill);

		if (previousXp == null)
		{
			// First time seeing this skill, initialize it
			previousXpMap.put(skill, currentXp);
			return;
		}

		// Calculate actual XP gained
		int xpGained = currentXp - previousXp;

		if (xpGained <= 0)
		{
			return;
		}

		// Update the previous XP tracker
		previousXpMap.put(skill, currentXp);

		// Add XP to current progress
		int progressXp = getCurrentXp() + xpGained;
		int coinsEarned = progressXp / 1000;

		if (coinsEarned > 0)
		{
			// Award coins
			setTotalCoins(getTotalCoins() + coinsEarned);
			// Keep remaining XP
			progressXp = progressXp % 1000;
		}

		setCurrentXp(progressXp);

		// Update panel
		SwingUtilities.invokeLater(() ->
				panel.updateProgress(getCurrentXp(), getTotalCoins())
		);
	}

	private void cashOutSilverCoins(int amount)
	{
		int currentCoins = getTotalCoins();

		if (amount > currentCoins)
		{
			SwingUtilities.invokeLater(() ->
					JOptionPane.showMessageDialog(panel,
							"Insufficient Silver Coins!\nYou have: " + currentCoins + "\nRequested: " + amount,
							"Insufficient Funds",
							JOptionPane.ERROR_MESSAGE)
			);
			return;
		}

		// Generate code
		String code = encodeCoins(amount);

		// Deduct coins
		setTotalCoins(currentCoins - amount);
		panel.updateProgress(getCurrentXp(), getTotalCoins());

		// Copy to clipboard
		StringSelection selection = new StringSelection(code);
		Toolkit.getDefaultToolkit().getSystemClipboard().setContents(selection, null);

		// Show dialog
		SwingUtilities.invokeLater(() -> panel.showCodeDialog(code));

		log.info("Cashed out {} Silver Coins. Code: {}", amount, code);
	}

	private String encodeCoins(int amount)
	{
		try
		{
			// Generate a random nonce (8 bytes)
			SecureRandom random = new SecureRandom();
			byte[] nonce = new byte[8];
			random.nextBytes(nonce);

			// Get current timestamp (seconds since epoch)
			long timestamp = System.currentTimeMillis() / 1000;

			// Create payload: nonce (8 bytes) + timestamp (8 bytes) + amount (4 bytes)
			ByteBuffer buffer = ByteBuffer.allocate(20);
			buffer.put(nonce);
			buffer.putLong(timestamp);
			buffer.putInt(amount);
			byte[] payload = buffer.array();

			// Calculate HMAC-SHA256 signature
			Mac hmac = Mac.getInstance("HmacSHA256");
			SecretKeySpec secretKeySpec = new SecretKeySpec(SECRET_KEY.getBytes(StandardCharsets.UTF_8), "HmacSHA256");
			hmac.init(secretKeySpec);
			byte[] signature = hmac.doFinal(payload);

			// Take first 16 bytes of signature for compactness
			byte[] signatureTruncated = new byte[16];
			System.arraycopy(signature, 0, signatureTruncated, 0, 16);

			// Final code: payload (20 bytes) + signature (16 bytes) = 36 bytes
			ByteBuffer finalBuffer = ByteBuffer.allocate(36);
			finalBuffer.put(payload);
			finalBuffer.put(signatureTruncated);

			// Base64 encode (36 bytes -> 48 characters)
			return Base64.getEncoder().encodeToString(finalBuffer.array());
		}
		catch (Exception e)
		{
			log.error("Error encoding coins", e);
			return null;
		}
	}

	private boolean isEventWorld()
	{
		EnumSet<WorldType> worldType = client.getWorldType();
		return worldType.stream()
				.anyMatch(type -> type == WorldType.SEASONAL ||
						type == WorldType.DEADMAN ||
						type == WorldType.QUEST_SPEEDRUNNING ||
						type == WorldType.TOURNAMENT_WORLD ||
						type == WorldType.FRESH_START_WORLD ||
						type == WorldType.BETA_WORLD ||
						type == WorldType.NOSAVE_MODE);
	}

	private void checkEventWorld()
	{
		if (isEventWorld())
		{
			SwingUtilities.invokeLater(() ->
					panel.showEventWorldWarning(() -> {
						userConfirmedEventWorld = true;
						previousXpMap.clear(); // Clear the map so XP tracking starts fresh
						panel.rebuildNormalUI();
						panel.updateProgress(getCurrentXp(), getTotalCoins());
					})
			);
		}
		else
		{
			userConfirmedEventWorld = true;
		}
	}
}
package com.runeccg;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class RuneCCGPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(RuneCCGPlugin.class);
		RuneLite.main(args);
	}
}
