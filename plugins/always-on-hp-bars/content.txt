package com.hpbar;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.events.GameTick;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.EventBus;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayManager;
import net.runelite.client.ui.overlay.OverlayPosition;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics2D;
import javax.inject.Singleton;
import net.runelite.api.Perspective;
import net.runelite.api.Point;
import net.runelite.api.Skill;
import net.runelite.api.coords.LocalPoint;


@Slf4j
@PluginDescriptor(
	name = "Always On HP Bars"
)
public class HPBarPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private HPBarConfig config;

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private HPBarOverlay overlay;

	@Inject
	private EventBus eventBus;

	@Override
	protected void startUp() throws Exception
	{
		overlayManager.add(overlay);

		eventBus.register(overlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
		overlayManager.remove(overlay);

		eventBus.unregister(overlay);
	}

	@Provides
	HPBarConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(HPBarConfig.class);
	}
}

@Singleton
class HPBarOverlay extends Overlay
{
	private static final Color BAR_FILL_COLOR = Color.green;
	private static final Color BAR_BG_COLOR = Color.red;
	private static final Dimension HP_BAR_SIZE = new Dimension(30, 5);

	private final Client client;
	private HPBarConfig config;

	private boolean showHPBar;

	@Inject
	private HPBarOverlay(final Client client, final HPBarConfig config)
	{
		this.client = client;
		this.config = config;

		setPosition(OverlayPosition.DYNAMIC);
		setPriority(PRIORITY_HIGH);
		setLayer(OverlayLayer.ABOVE_SCENE);
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		if (!showHPBar || !config.showLocalPlayer())
		{
			return null;
		}

		final int height = client.getLocalPlayer().getLogicalHeight() + 28;
		final LocalPoint localLocation = client.getLocalPlayer().getLocalLocation();
		final Point canvasPoint = Perspective.localToCanvas(client, localLocation, client.getPlane(), height);

		final float ratio = (float) client.getBoostedSkillLevel(Skill.HITPOINTS) / client.getRealSkillLevel(Skill.HITPOINTS);

		// Draw bar
		final int barX = canvasPoint.getX() - 15;
		final int barY = canvasPoint.getY();
		final int barWidth = HP_BAR_SIZE.width;
		final int barHeight = HP_BAR_SIZE.height;

		// Restricted by the width to prevent the bar from being too long while you are boosted above your real HP level.
		final int progressFill = (int) Math.ceil(Math.min((barWidth * ratio), barWidth));

		graphics.setColor(BAR_BG_COLOR);
		graphics.fillRect(barX, barY, barWidth, barHeight);
		graphics.setColor(BAR_FILL_COLOR);
		graphics.fillRect(barX, barY, progressFill, barHeight);

		return null;
	}

	@Subscribe
	public void onGameTick(GameTick tick)
	{
		// Hide bar by default
		showHPBar = false;

		// If the OG Vanilla HP bar isn't currently being shown
		if (client.getLocalPlayer().getHealthScale() == -1)
		{
			// Show this one
			showHPBar = true;
		}
	}

	@Provides
	HPBarConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(HPBarConfig.class);
	}
}

package com.hpbar;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("hp bar")
public interface HPBarConfig extends Config
{
	@ConfigItem(
		keyName = "Show your HP Bar",
		name = "Show your HP Bar",
		description = "Whether to show the HP bar for your character."
	)
	default boolean showLocalPlayer()
	{
		return true;
	}
}

package com.hpbar;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class HPBarPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(HPBarPlugin.class);
		RuneLite.main(args);
	}
}
