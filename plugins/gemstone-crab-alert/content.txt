package com.gemstonecrab;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics2D;
import javax.inject.Inject;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;

public class GemstoneCrabOverlay extends Overlay
{
	private final GemstoneCrabPlugin plugin;
	private final GemstoneCrabConfig config;

	@Inject
	private GemstoneCrabOverlay(GemstoneCrabPlugin plugin, GemstoneCrabConfig config)
	{
		this.plugin = plugin;
		this.config = config;
		setPosition(OverlayPosition.DYNAMIC);
		setLayer(OverlayLayer.ABOVE_SCENE);
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		if (plugin.isShouldFlash() && plugin.getFlashStartTime() > 0)
		{
			long elapsedTime = System.currentTimeMillis() - plugin.getFlashStartTime();
			int flashInterval = config.flashInterval();
			int cyclePosition = (int) (elapsedTime % (flashInterval * 2));
			boolean flashOn = cyclePosition < flashInterval;
			
			if (flashOn)
			{
				java.awt.Rectangle clipBounds = graphics.getClipBounds();
				if (clipBounds != null)
				{
					Color flashColor = config.flashColor();
					graphics.setColor(flashColor);
					graphics.fillRect(0, 0, clipBounds.width, clipBounds.height);
				}
			}
		}

		return null;
	}
}

package com.gemstonecrab;

import java.awt.Color;
import net.runelite.client.config.Alpha;
import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.Range;

@ConfigGroup("gemstonecrabalert")
public interface GemstoneCrabConfig extends Config
{
	@Alpha
	@ConfigItem(
		keyName = "flashColor",
		name = "Flash Color",
		description = "Color of the screen flash",
		position = 1
	)
	default Color flashColor()
	{
		return new Color(255, 0, 0, 100);
	}

	@Range(min = 1, max = 99)
	@ConfigItem(
		keyName = "healthThreshold",
		name = "Health Threshold %",
		description = "Alert triggers when health is at or below this percentage",
		position = 2
	)
	default int healthThreshold()
	{
		return 5;
	}

	@Range(min = 1, max = 30)
	@ConfigItem(
		keyName = "flashDuration",
		name = "Flash Duration (seconds)",
		description = "Total duration of the flash alert",
		position = 3
	)
	default int flashDuration()
	{
		return 5;
	}

	@Range(min = 100, max = 1000)
	@ConfigItem(
		keyName = "flashInterval",
		name = "Flash Interval (ms)",
		description = "On/off cycle speed in milliseconds (lower = faster)",
		position = 4
	)
	default int flashInterval()
	{
		return 250;
	}
}

package com.gemstonecrab;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.Getter;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.NPC;
import net.runelite.api.events.GameTick;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

@Slf4j
@PluginDescriptor(
	name = "Gemstone Crab Alert",
	description = "Flashes the screen when Gemstone Crab health is at or below threshold",
	tags = {"crab", "gemstone", "alert", "flash", "pvm"}
)
public class GemstoneCrabPlugin extends Plugin
{
	@Inject
	private Client client;

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private GemstoneCrabOverlay overlay;

	@Inject
	private GemstoneCrabConfig config;

	@Getter
	private boolean shouldFlash = false;
	
	@Getter
	private long flashStartTime = 0;
	
	private boolean isFlashing = false;

	@Override
	protected void startUp() throws Exception
	{
		log.info("Gemstone Crab Alert started!");
		overlayManager.add(overlay);
	}

	@Override
	protected void shutDown() throws Exception
	{
		log.info("Gemstone Crab Alert stopped!");
		overlayManager.remove(overlay);
		shouldFlash = false;
		isFlashing = false;
		flashStartTime = 0;
	}

	@Subscribe
	public void onGameTick(GameTick event)
	{
		shouldFlash = false;
		boolean foundCrabBelowThreshold = false;

		for (NPC npc : client.getNpcs())
		{
			if (npc == null || npc.getName() == null)
			{
				continue;
			}

			if (npc.getName().equals("Gemstone Crab"))
			{
				int healthRatio = npc.getHealthRatio();
				int healthScale = npc.getHealthScale();

				if (healthScale > 0)
				{
					double healthPercent = (double) healthRatio / healthScale * 100.0;
					log.debug("Gemstone Crab health: {}%", String.format("%.2f", healthPercent));
					
					int threshold = config.healthThreshold();
					if (healthPercent <= threshold && healthPercent > 0)
					{
						foundCrabBelowThreshold = true;
						
						if (!isFlashing)
						{
							isFlashing = true;
							flashStartTime = System.currentTimeMillis();
							int duration = config.flashDuration();
							log.info("ALERT: Gemstone Crab health at or below {}%! Starting {}-second flash.", threshold, duration);
						}
						
						long flashDurationMs = config.flashDuration() * 1000L;
						long elapsedTime = System.currentTimeMillis() - flashStartTime;
						if (elapsedTime < flashDurationMs)
						{
							shouldFlash = true;
						}
						else
						{
							log.debug("Flash duration completed ({} seconds).", config.flashDuration());
						}
						
						break;
					}
				}
			}
		}
		
		if (!foundCrabBelowThreshold)
		{
			if (isFlashing)
			{
				log.debug("Crab health recovered above {}%. Resetting flash state.", config.healthThreshold());
			}
			isFlashing = false;
			flashStartTime = 0;
		}
	}

	@Provides
	GemstoneCrabConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(GemstoneCrabConfig.class);
	}
}

package com.gemstonecrab;

import net.runelite.client.RuneLite;

public class GemstoneCrabPluginTest
{
	public static void main(String[] args) throws Exception
	{
		// Plugin is loaded from sideloaded-plugins folder, no need to load it here
		// This prevents duplicate plugin entries
		RuneLite.main(args);
	}
}

