package org.fccount;

import com.google.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.FriendsChatManager;
import net.runelite.api.FriendsChatMember;
import net.runelite.api.events.FriendsChatChanged;
import net.runelite.api.events.FriendsChatMemberJoined;
import net.runelite.api.events.FriendsChatMemberLeft;
import net.runelite.api.events.GameTick;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

import java.util.HashMap;
import java.util.Map;

@PluginDescriptor(
        name = "FC World Populations",
        description = "Counts FC members per world and shows top 3 popular worlds.",
        tags = {"fc", "friend", "chat", "world", "count", "population"}
)
@Slf4j
public class WorldCountPlugin extends Plugin
{
    @Inject
    private Client client;

    @Inject
    private OverlayManager overlayManager;

    @Inject
    private WorldCountOverlay overlay;

    @Inject
    private net.runelite.client.callback.ClientThread clientThread;

    private final Map<Integer, Integer> worldCounts = new HashMap<>();
    private int tickCounter = 0;

    @Override
    protected void startUp()
    {
        log.info("WorldCountPlugin started");
        overlayManager.add(overlay);
        updateCounts();
    }

    @Override
    protected void shutDown()
    {
        overlayManager.remove(overlay);
        worldCounts.clear();
    }

    @Subscribe
    public void onFriendsChatChanged(FriendsChatChanged event)
    {
        clientThread.invokeLater(this::updateCounts);
    }

    @Subscribe
    public void onFriendsChatMemberJoined(FriendsChatMemberJoined event)
    {
        updateCounts();
    }

    @Subscribe
    public void onFriendsChatMemberLeft(FriendsChatMemberLeft event)
    {
        updateCounts();
    }

    @Subscribe
    public void onGameTick(GameTick event)
    {
        tickCounter++;
        if (tickCounter >= 10)
        {
            tickCounter = 0;
            updateCounts();
        }
    }

    private void updateCounts()
    {
        worldCounts.clear();
        FriendsChatManager fc = client.getFriendsChatManager();
        if (fc == null || fc.getMembers() == null)
            return;

        for (FriendsChatMember member : fc.getMembers())
        {
            if (member == null) continue;
            int world = member.getWorld();
            if (world == 0) continue;
            worldCounts.put(world, worldCounts.getOrDefault(world, 0) + 1);
        }

        overlay.setWorldCounts(worldCounts);
    }
}

package org.fccount;

import net.runelite.api.Client;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.components.ComponentOrientation;
import net.runelite.client.ui.overlay.components.LineComponent;
import net.runelite.client.ui.overlay.components.PanelComponent;
import net.runelite.client.ui.overlay.components.TitleComponent;
import net.runelite.api.FriendsChatManager;

import javax.inject.Inject;
import java.awt.*;
import java.util.Map;

public class WorldCountOverlay extends Overlay
{
    private final Client client;
    private final PanelComponent panel = new PanelComponent();
    private Map<Integer, Integer> worldCounts;

    @Inject
    public WorldCountOverlay(Client client)
    {
        this.client = client;
        setPosition(OverlayPosition.TOP_LEFT);
        setLayer(OverlayLayer.ABOVE_WIDGETS);

        //panel.setBackgroundColor(new Color(0, 0, 0, 150));
        //panel.setBorder(new Rectangle(0, 0, 0, 0)); // optional: remove default border
    }

    public void setWorldCounts(Map<Integer, Integer> worldCounts)
    {
        this.worldCounts = worldCounts;
    }

    @Override
    public Dimension render(Graphics2D graphics)
    {
        if (worldCounts == null || worldCounts.isEmpty())
            return null;

        // Set panel properties for proper sizing
        panel.setPreferredSize(new Dimension(165, 0));
        // Ensure proper spacing between components
        panel.setGap(new Point(0, 4));

        panel.getChildren().clear();
        panel.setBackgroundColor(new Color(18, 18, 18, 180)); // Dark background

        // Get Friends Chat manager
        FriendsChatManager fc = client.getFriendsChatManager();
        String fcName = (fc != null) ? fc.getName() : "No Friends Chat";

        // Add title
        panel.getChildren().add(TitleComponent.builder()
                //.text("Friends Chat Population:")
                .text("FC World Populations:")
                .color(Color.WHITE)
                .build());

        int minPlayers = 0; // hard-coded threshold

        // Add top 3 worlds
        worldCounts.entrySet().stream()
                .filter(entry -> entry.getValue() >= minPlayers)
                .sorted((a, b) -> b.getValue().compareTo(a.getValue()))
                .limit(3)
                .forEach(entry -> panel.getChildren().add(LineComponent.builder()
                                .left("World " + entry.getKey())
                                .right(entry.getValue() + " members")
                                .leftColor(Color.WHITE)
                                .rightColor(Color.GREEN)
                                .build()
                ));

        // Padding
        //panel.getChildren().add(LineComponent.builder().build());
        //panel.getChildren().add(LineComponent.builder()
                //.left(" ")
                //.build());

        // Keep main panel in vertical orientation for the rest of the overlay
        panel.setOrientation(ComponentOrientation.VERTICAL);

        return panel.render(graphics);
    }
}

package org.fccount;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class PluginLauncher
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(WorldCountPlugin.class);
		RuneLite.main(args);
	}
}
