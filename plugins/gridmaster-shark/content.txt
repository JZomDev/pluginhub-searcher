package com.gmshark;

import java.awt.Color;
import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("gm_shark")
public interface SharkConfig extends Config
{
	@ConfigItem(
		keyName = "void",
		name = "<html>IMPORTANT: make sure you check the<br>bottom two fields to make sure they<br>match the in-game text exactly or the<br>plugin won't work!</html>",
		description = "",
		position = 0
	)
	default void v() {}

	@ConfigItem(
		keyName = "sharkItemName",
		name = "Corrupted shark item name",
		description = "The exact name of the item",
		position = 1
	)
	default String sharkItemName()
	{
		return "Corrupted shark";
	}

	@ConfigItem(
		keyName = "sharkEatChatMessage",
		name = "Eating chat message",
		description = "",
		position = 2
	)
	default String sharkEatChatMessage()
	{
		return "You eat the corrupted shark.";
	}

	@ConfigItem(
		name = "Show times eaten on item",
		keyName = "showTimesEatenOnItem",
		description = "",
		position = 3
	)
	default boolean showTimesEatenOnItem()
	{
		return true;
	}

	@ConfigItem(
		name = "Color",
		keyName = "showTimesEatenOnItemColor",
		description = "",
		position = 4
	)
	default Color showTimesEatenOnItemColor()
	{
		return new Color(0xFFDCC4);
	}

	@ConfigItem(
		name = "Show hp healed on item",
		keyName = "showHpHealedOnItem",
		description = "",
		position = 5
	)
	default boolean showHpHealedOnItem()
	{
		return true;
	}

	@ConfigItem(
		name = "Color",
		keyName = "showHpHealedOnItemColor",
		description = "",
		position = 6
	)
	default Color showHpHealedOnItemColor()
	{
		return new Color(0xFFDCC4);
	}

	@ConfigItem(
		name = "Show stats on examine",
		keyName = "showStatsOnExamine",
		description = "",
		position = 7
	)
	default boolean showStatsOnExamine()
	{
		return true;
	}
}

package com.gmshark;

import com.google.inject.Provides;
import javax.inject.Inject;
import lombok.extern.slf4j.Slf4j;
import net.runelite.api.ChatMessageType;
import net.runelite.api.Client;
import net.runelite.api.EquipmentInventorySlot;
import net.runelite.api.HitsplatID;
import net.runelite.api.InventoryID;
import net.runelite.api.Item;
import net.runelite.api.ItemContainer;
import net.runelite.api.Skill;
import net.runelite.api.Varbits;
import net.runelite.api.events.ChatMessage;
import net.runelite.api.events.GameTick;
import net.runelite.api.events.HitsplatApplied;
import net.runelite.api.events.MenuOptionClicked;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.game.ItemManager;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

@Slf4j
@PluginDescriptor(
	name = "Corrupted shark tracker",
	tags = {"gridmaster", "gm", "stat", "league"}
)
public class SharkPlugin extends Plugin
{
	@Inject Client client;
	@Inject ItemManager itemManager;
	@Inject ConfigManager configManager;
	@Inject OverlayManager overlayManager;
	@Inject SharkOverlay overlay;
	@Inject SharkConfig config;

	int hpLastTick = 0;
	boolean eatenSharkThisTick = false;
	int totalDamageTaken = 0;

	@Override protected void startUp() throws Exception
	{
		overlayManager.add(overlay);
	}

	@Override protected void shutDown() throws Exception
	{
		overlayManager.remove(overlay);
	}

	@Subscribe public void onChatMessage(ChatMessage e) {
		if (e.getType() != ChatMessageType.SPAM) return;

		if (e.getMessage().equalsIgnoreCase(config.sharkEatChatMessage().trim())) {
			increment("timesEaten", 1);
			eatenSharkThisTick = true;
		}
	}

	private Integer increment(String key, int a)
	{
		Integer i = getConfig(key);
		configManager.setRSProfileConfiguration("gm_shark", key, i + a);
//		System.out.println(key + " " + i + " + " + a + " = " + (i + a));
		return i;
	}

	Integer getConfig(String key)
	{
		Integer i = configManager.getRSProfileConfiguration("gm_shark", key, Integer.class);
		return i == null ? 0 : i;
	}

	@Subscribe public void onHitsplatApplied(HitsplatApplied e) {
		if (e.getActor() != client.getLocalPlayer()) return;
		int type = e.getHitsplat().getHitsplatType();
		if (type != HitsplatID.DAMAGE_ME && type != HitsplatID.POISON && type != HitsplatID.VENOM && type != HitsplatID.DAMAGE_MAX_ME) return;
		totalDamageTaken += e.getHitsplat().getAmount();
	}

	@Subscribe public void onGameTick(GameTick e) {
		int hpThisTick = client.getBoostedSkillLevel(Skill.HITPOINTS);

		if (eatenSharkThisTick) {
			eatenSharkThisTick = false;
			int gained = hpThisTick - (hpLastTick - totalDamageTaken);
			int baseHpLevel = client.getRealSkillLevel(Skill.HITPOINTS);
			int overheal = Math.max(0, hpThisTick - baseHpLevel);
			gained -= overheal;

			boolean bracers = glovesSlotItemName().equalsIgnoreCase("Sunlit bracers");
			int meleeMastery = client.getVarbitValue(Varbits.LEAGUES_MELEE_COMBAT_MASTERY_LEVEL);
			int rangedMastery = client.getVarbitValue(Varbits.LEAGUES_RANGED_COMBAT_MASTERY_LEVEL);
			int magicMastery = client.getVarbitValue(Varbits.LEAGUES_MAGIC_COMBAT_MASTERY_LEVEL);
			boolean hasMastery = meleeMastery >= 2 || rangedMastery >= 2 || magicMastery >= 2;
			int sharkHeals = (hasMastery ? 24 : 20) * (bracers ? 2 : 1);

			gained = Math.min(gained, sharkHeals);
//			System.out.println("mastery: " + hasMastery + " bracers: " + bracers);
//			System.out.println(hpLastTick + " -> " + hpThisTick + " gained " + gained);
			increment("hpHealed", gained);
		}

		hpLastTick = hpThisTick;
		totalDamageTaken = 0;

		if (sharkExamine && config.showStatsOnExamine()) {
			sharkExamine = false;

			int timesEaten = getConfig("timesEaten");
			int hpHealed = getConfig("hpHealed");
			int average = hpHealed / timesEaten;
			client.addChatMessage(ChatMessageType.GAMEMESSAGE, "", addCommas(timesEaten) + " bites taken for " + addCommas(hpHealed) + " hitpoints healed (avg: " + average + ")", "");
		}
	}

	String glovesSlotItemName() {
		ItemContainer equipment = client.getItemContainer(InventoryID.EQUIPMENT);
		if (equipment == null) return "";
		Item item = equipment.getItem(EquipmentInventorySlot.GLOVES.getSlotIdx());
		if (item == null) return "";
		return itemManager.getItemComposition(item.getId()).getName();
	}

	public String addCommas(int i) {
		String s = "" + i;
		if (s.length() >= 7) {
			s = s.substring(0, s.length() - 6) + "," + s.substring(s.length() - 6);
		}
		if (s.length() >= 4) {
			s = s.substring(0, s.length() - 3) + "," + s.substring(s.length() - 3);
		}
		return s;
	}

	boolean sharkExamine = false;
	@Subscribe public void onMenuOptionClicked(MenuOptionClicked e) {
		if (e.getItemId() != -1 && e.getMenuOption().equals("Examine") && itemManager.getItemComposition(e.getItemId()).getMembersName().equalsIgnoreCase(config.sharkItemName().trim())) {
			sharkExamine = true;
		}
	}

	@Provides
	SharkConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(SharkConfig.class);
	}
}

package com.gmshark;

import java.awt.Color;
import java.awt.Graphics2D;
import javax.inject.Inject;
import net.runelite.api.widgets.WidgetItem;
import net.runelite.client.game.ItemManager;
import net.runelite.client.ui.overlay.WidgetItemOverlay;

public class SharkOverlay extends WidgetItemOverlay
{
	@Inject ItemManager itemManager;
	@Inject SharkPlugin plugin;

	public SharkOverlay() {
		showOnInventory();
	}

	@Override
	public void renderItemOverlay(Graphics2D graphics, int itemId, WidgetItem widgetItem)
	{
		if (itemManager.getItemComposition(itemId).getMembersName().equalsIgnoreCase(plugin.config.sharkItemName().trim())) {
			boolean showCount = plugin.config.showTimesEatenOnItem();
			int yOffset = (int) widgetItem.getCanvasBounds().getY() + 10;
			int x = (int) widgetItem.getCanvasBounds().getX();
			if (showCount) {
				drawTextWithDropShadow("" + plugin.getConfig("timesEaten"), x, yOffset, graphics, plugin.config.showTimesEatenOnItemColor());
				yOffset += 22;
			}
			if (plugin.config.showHpHealedOnItem()) {
				drawTextWithDropShadow("" + plugin.getConfig("hpHealed"), x, yOffset, graphics, plugin.config.showHpHealedOnItemColor());
			}
		}
	}

	void drawTextWithDropShadow(String s, int x, int y, Graphics2D graphics, Color c) {
		graphics.setColor(Color.BLACK);
		graphics.drawString(s, x + 1, y + 1);
		graphics.setColor(c);
		graphics.drawString(s, x, y);
	}
}

package com.gmshark;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class ExamplePluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(SharkPlugin.class);
		RuneLite.main(args);
	}
}
