package com.prestigemode;

import lombok.extern.slf4j.Slf4j;
import net.runelite.api.Client;
import net.runelite.api.Skill;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.api.widgets.Widget;
import net.runelite.api.widgets.WidgetPositionMode;
import net.runelite.api.widgets.WidgetType;

import javax.inject.Inject;

@Slf4j
class PrestigeSkill {
    private static final int XP_FOR_99 = 13034431;
    private static final int MAX_PRESTIGE = 15;
    private static final int PRESTIGE_SPRITE_BASE = -5000;
    private final Client client;
    private boolean enabled;
    private final boolean isCombatSkill;
    private boolean showBanners;
    private boolean enableCombatUsability;

    public final Skill skill;
    private Widget borderWidget;
    private final int skillWidgetId;

    @Inject
    public PrestigeSkill(
            Client client,
            int skillWidgetId,
            Skill skill,
            Boolean enabled,
            Boolean isCombatSkill,
            Boolean showBanners,
            Boolean enableCombatUsability
        )
    {
        this.client = client;
        this.skill = skill;
        this.skillWidgetId = skillWidgetId;
        this.enabled = enabled;
        this.isCombatSkill = isCombatSkill;
        this.showBanners = showBanners;
        this.enableCombatUsability = enableCombatUsability;
    }

    public void disable() {
        if (!this.enabled) {
            return;
        }

        this.enabled = false;
        this.destroy();
    }

    public void enable() {
        if (this.enabled) {
            return;
        }

        this.enabled = true;
        this.update();
    }

    public void configChanged(Boolean showBanners, Boolean enableCombatUsability) {
        this.showBanners = showBanners;
        if (!showBanners && this.borderWidget != null) {
            borderWidget.setSpriteId(0);
            borderWidget.setHidden(true);
            borderWidget = null;
        }

        this.enableCombatUsability = enableCombatUsability;
        client.queueChangedSkill(skill);

        this.update();
    }

    public void destroy() {
        if (borderWidget != null) {
            borderWidget.setSpriteId(0);
            borderWidget.setHidden(true);
            borderWidget = null;
        }

        client.queueChangedSkill(skill);
    }

    public void update() {
        if (!this.enabled) {
            return;
        }

        Widget skillWidget = client.getWidget(this.skillWidgetId);
        if (skillWidget == null) {
            return;
        }

        int totalSkillXp = client.getSkillExperience(this.skill);
        int prestige = getPrestige(totalSkillXp);
        int level = getLevel(totalSkillXp, prestige);

        Widget activeLevel = skillWidget.getChild(3);
        boolean shouldReplaceNumerator = !this.isCombatSkill || !this.enableCombatUsability;
        if (activeLevel != null && shouldReplaceNumerator) {
            activeLevel.setText(String.valueOf(level));
        }

        Widget actualLevel = skillWidget.getChild(4);
        if (actualLevel != null) {
            actualLevel.setText(String.valueOf(level));
        }

        if (this.showBanners) {
            int spriteId = PRESTIGE_SPRITE_BASE + prestige;
            if (this.borderWidget != null) {
                this.borderWidget.setSpriteId(spriteId);
            } else {
                this.borderWidget = skillWidget.createChild(WidgetType.GRAPHIC);
                borderWidget.getId();
                borderWidget.setSpriteId(spriteId);
                borderWidget.setOriginalWidth(skillWidget.getWidth());
                borderWidget.setOriginalHeight(skillWidget.getHeight());
                borderWidget.setXPositionMode(WidgetPositionMode.ABSOLUTE_LEFT);
                borderWidget.setYPositionMode(WidgetPositionMode.ABSOLUTE_TOP);
                borderWidget.setOriginalX(0);
                borderWidget.setOriginalY(0);
            }
        }

        Widget skillsPage = client.getWidget(InterfaceID.Stats.UNIVERSE);
        if (skillsPage != null) {
            skillsPage.revalidate();
            skillWidget.revalidate();
            if (borderWidget != null) {
                borderWidget.revalidate();
            }
        }

//        if (skillsPage != null && !skillsPage.isHidden()) {
//            skillsPage.setHidden(true);
//            skillsPage.setHidden(false);
//            skillsPage.invalidate
//        }
    }

    private int getPrestige(int totalSkillXp) {
        return Math.min((int) Math.floor((double) totalSkillXp / XP_FOR_99), MAX_PRESTIGE);
    }

    private int getLevel(int totalSkillXp, int prestige) {
        int adjustedXp = totalSkillXp - prestige * XP_FOR_99;
        if (prestige == MAX_PRESTIGE) {
            adjustedXp = totalSkillXp;
        }

        return net.runelite.api.Experience.getLevelForXp(adjustedXp);
    }
}
package com.prestigemode;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;
import net.runelite.client.config.ConfigSection;

@ConfigGroup("prestigeMode")
public interface PrestigeModeConfig extends Config
{
    @ConfigSection(
            name = "Options",
            description = "Common options for Prestige Mode.",
            position = 0,
            closedByDefault = false
    )
    String SECTION_OPTIONS = "Options";

    @ConfigItem(
            keyName = "combatUsability",
            section = SECTION_OPTIONS,
            name = "Combat Usability",
            description = "Only replace the denominator for combat skills to avoid replacing current HP, prayer points, or stat boots/drains."
    )
    default boolean combatUsability()
    {
        return true;
    }

    @ConfigItem(
            keyName = "showBanners",
            section = SECTION_OPTIONS,
            name = "Show prestige banners",
            description = "Toggle rendering of prestige banners. Disabling will still replace level numbers, but won't show any indication of current prestige level."
    )
    default boolean showBanners()
    {
        return true;
    }
    @ConfigSection(
            name = "Skills",
            description = "Select which skills to enable.",
            position = 1,
            closedByDefault = false
    )
    String SECTION_SKILLS = "Skills";

    @ConfigItem(
            keyName = "attackEnabled",
            section = SECTION_SKILLS,
            name = "Attack",
            description = "Enable prestige mode for the Attack skill"
    )
    default boolean attackEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "strengthEnabled",
            section = SECTION_SKILLS,
            name = "Strength",
            description = "Enable prestige mode for the Strength skill"
    )
    default boolean strengthEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "defenceEnabled",
            section = SECTION_SKILLS,
            name = "Defence",
            description = "Enable prestige mode for the Defence skill"
    )
    default boolean defenceEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "rangedEnabled",
            section = SECTION_SKILLS,
            name = "Ranged",
            description = "Enable prestige mode for the Ranged skill"
    )
    default boolean rangedEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "prayerEnabled",
            section = SECTION_SKILLS,
            name = "Prayer",
            description = "Enable prestige mode for the Prayer skill"
    )
    default boolean prayerEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "magicEnabled",
            section = SECTION_SKILLS,
            name = "Magic",
            description = "Enable prestige mode for the Magic skill"
    )
    default boolean magicEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "runecraftEnabled",
            section = SECTION_SKILLS,
            name = "Runecraft",
            description = "Enable prestige mode for the Runecraft skill"
    )
    default boolean runecraftEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "constructionEnabled",
            section = SECTION_SKILLS,
            name = "Construction",
            description = "Enable prestige mode for the Construction skill"
    )
    default boolean constructionEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "hitpointsEnabled",
            section = SECTION_SKILLS,
            name = "Hitpoints",
            description = "Enable prestige mode for the Hitpoints skill"
    )
    default boolean hitpointsEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "agilityEnabled",
            section = SECTION_SKILLS,
            name = "Agility",
            description = "Enable prestige mode for the Agility skill"
    )
    default boolean agilityEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "herbloreEnabled",
            section = SECTION_SKILLS,
            name = "Herblore",
            description = "Enable prestige mode for the Herblore skill"
    )
    default boolean herbloreEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "thievingEnabled",
            section = SECTION_SKILLS,
            name = "Thieving",
            description = "Enable prestige mode for the Thieving skill"
    )
    default boolean thievingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "craftingEnabled",
            section = SECTION_SKILLS,
            name = "Crafting",
            description = "Enable prestige mode for the Crafting skill"
    )
    default boolean craftingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "fletchingEnabled",
            section = SECTION_SKILLS,
            name = "Fletching",
            description = "Enable prestige mode for the Fletching skill"
    )
    default boolean fletchingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "slayerEnabled",
            section = SECTION_SKILLS,
            name = "Slayer",
            description = "Enable prestige mode for the Slayer skill"
    )
    default boolean slayerEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "hunterEnabled",
            section = SECTION_SKILLS,
            name = "Hunter",
            description = "Enable prestige mode for the Hunter skill"
    )
    default boolean hunterEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "miningEnabled",
            section = SECTION_SKILLS,
            name = "Mining",
            description = "Enable prestige mode for the Mining skill"
    )
    default boolean miningEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "smithingEnabled",
            section = SECTION_SKILLS,
            name = "Smithing",
            description = "Enable prestige mode for the Smithing skill"
    )
    default boolean smithingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "fishingEnabled",
            section = SECTION_SKILLS,
            name = "Fishing",
            description = "Enable prestige mode for the Fishing skill"
    )
    default boolean fishingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "cookingEnabled",
            section = SECTION_SKILLS,
            name = "Cooking",
            description = "Enable prestige mode for the Cooking skill"
    )
    default boolean cookingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "firemakingEnabled",
            section = SECTION_SKILLS,
            name = "Firemaking",
            description = "Enable prestige mode for the Firemaking skill"
    )
    default boolean firemakingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "woodcuttingEnabled",
            section = SECTION_SKILLS,
            name = "Woodcutting",
            description = "Enable prestige mode for the Woodcutting skill"
    )
    default boolean woodcuttingEnabled()
    {
        return true;
    }

    @ConfigItem(
            keyName = "farmingEnabled",
            section = SECTION_SKILLS,
            name = "Farming",
            description = "Enable prestige mode for the Farming skill"
    )
    default boolean farmingEnabled()
    {
        return true;
    }
}
package com.prestigemode;

import lombok.extern.slf4j.Slf4j;
import com.google.inject.Provides;
import net.runelite.api.*;
import net.runelite.api.events.*;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.callback.ClientThread;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.util.ImageUtil;

import javax.inject.Inject;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.Map;
import javax.imageio.ImageIO;

@Slf4j
@PluginDescriptor(
	name = "Prestige Mode",
    description = "Visual only! Adds a 'Prestige Mode' to the skills tab. Resets skills to 1 once you reach 99, and each time you reach 99 a higher tier prestige banner is displayed.",
    tags = {"skills", "stats", "levels", "goals", "prestige", "max"}
)
public class PrestigeModePlugin extends Plugin
{
    private static final int MAX_PRESTIGE = 15;
    private static final int PRESTIGE_SPRITE_BASE = -5000;

    private final Map<Skill, PrestigeSkill> prestigeSkills = new HashMap<>();
    private boolean isSkillsVisible = false;

    @Inject
    private Client client;

    @Inject
    private ClientThread clientThread;

    @Inject
    private PrestigeModeConfig config;

    @Provides
    PrestigeModeConfig provideConfig(ConfigManager configManager)
    {
        return configManager.getConfig(PrestigeModeConfig.class);
    }

    @Override
    protected void startUp()
    {
        prestigeSkills.put(Skill.ATTACK, new PrestigeSkill(client, InterfaceID.Stats.ATTACK, Skill.ATTACK, this.isSkillEnabled(Skill.ATTACK), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.STRENGTH, new PrestigeSkill(client, InterfaceID.Stats.STRENGTH, Skill.STRENGTH, this.isSkillEnabled(Skill.STRENGTH), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.DEFENCE, new PrestigeSkill(client, InterfaceID.Stats.DEFENCE, Skill.DEFENCE, this.isSkillEnabled(Skill.DEFENCE), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.RANGED, new PrestigeSkill(client, InterfaceID.Stats.RANGED, Skill.RANGED, this.isSkillEnabled(Skill.RANGED), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.PRAYER, new PrestigeSkill(client, InterfaceID.Stats.PRAYER, Skill.PRAYER, this.isSkillEnabled(Skill.PRAYER), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.MAGIC, new PrestigeSkill(client, InterfaceID.Stats.MAGIC, Skill.MAGIC, this.isSkillEnabled(Skill.MAGIC), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.RUNECRAFT, new PrestigeSkill(client, InterfaceID.Stats.RUNECRAFT, Skill.RUNECRAFT, this.isSkillEnabled(Skill.RUNECRAFT), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.CONSTRUCTION, new PrestigeSkill(client, InterfaceID.Stats.CONSTRUCTION, Skill.CONSTRUCTION, this.isSkillEnabled(Skill.CONSTRUCTION), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.HITPOINTS, new PrestigeSkill(client, InterfaceID.Stats.HITPOINTS, Skill.HITPOINTS, this.isSkillEnabled(Skill.HITPOINTS), true, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.AGILITY, new PrestigeSkill(client, InterfaceID.Stats.AGILITY, Skill.AGILITY, this.isSkillEnabled(Skill.AGILITY), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.HERBLORE, new PrestigeSkill(client, InterfaceID.Stats.HERBLORE, Skill.HERBLORE, this.isSkillEnabled(Skill.HERBLORE), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.THIEVING, new PrestigeSkill(client, InterfaceID.Stats.THIEVING, Skill.THIEVING, this.isSkillEnabled(Skill.THIEVING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.CRAFTING, new PrestigeSkill(client, InterfaceID.Stats.CRAFTING, Skill.CRAFTING, this.isSkillEnabled(Skill.CRAFTING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.FLETCHING, new PrestigeSkill(client, InterfaceID.Stats.FLETCHING, Skill.FLETCHING, this.isSkillEnabled(Skill.FLETCHING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.SLAYER, new PrestigeSkill(client, InterfaceID.Stats.SLAYER, Skill.SLAYER, this.isSkillEnabled(Skill.SLAYER), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.HUNTER, new PrestigeSkill(client, InterfaceID.Stats.HUNTER, Skill.HUNTER, this.isSkillEnabled(Skill.HUNTER), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.MINING, new PrestigeSkill(client, InterfaceID.Stats.MINING, Skill.MINING, this.isSkillEnabled(Skill.MINING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.SMITHING, new PrestigeSkill(client, InterfaceID.Stats.SMITHING, Skill.SMITHING, this.isSkillEnabled(Skill.SMITHING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.FISHING, new PrestigeSkill(client, InterfaceID.Stats.FISHING, Skill.FISHING, this.isSkillEnabled(Skill.FISHING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.COOKING, new PrestigeSkill(client, InterfaceID.Stats.COOKING, Skill.COOKING, this.isSkillEnabled(Skill.COOKING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.FIREMAKING, new PrestigeSkill(client, InterfaceID.Stats.FIREMAKING, Skill.FIREMAKING, this.isSkillEnabled(Skill.FIREMAKING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.WOODCUTTING, new PrestigeSkill(client, InterfaceID.Stats.WOODCUTTING, Skill.WOODCUTTING, this.isSkillEnabled(Skill.WOODCUTTING), false, this.config.showBanners(), this.config.combatUsability()));
        prestigeSkills.put(Skill.FARMING, new PrestigeSkill(client, InterfaceID.Stats.FARMING, Skill.FARMING, this.isSkillEnabled(Skill.FARMING), false, this.config.showBanners(), this.config.combatUsability()));

        for (int i = 1; i <= MAX_PRESTIGE; i++)
        {
            String path = "/borders/prestige-" + i + ".png";
            try
            {
                InputStream iStream = getClass().getResourceAsStream(path);
                if (iStream == null) {
                    continue;
                }

                BufferedImage image = ImageIO.read(iStream);
                SpritePixels sprite = ImageUtil.getImageSpritePixels(image, client);
                int spriteId = PRESTIGE_SPRITE_BASE + i;
                client.getSpriteOverrides().put(spriteId, sprite);
            }
            catch (IOException e)
            {
                String err = "Error loading prestige image " + path;
                log.error(err);
            }
        }

        clientThread.invoke(() ->
        {
            renderPrestigeOverlays();
            Widget skillsPage = client.getWidget(InterfaceID.Stats.UNIVERSE);
            if (skillsPage != null) {
                skillsPage.revalidate();
            }
        });
    }

    @Subscribe
    public void onConfigChanged(ConfigChanged event) {
        clientThread.invoke(() ->
        {
            for (PrestigeSkill prestigeSkill : prestigeSkills.values()) {
                boolean isEnabled = this.isSkillEnabled(prestigeSkill.skill);
                if (isEnabled) {
                    prestigeSkill.enable();
                } else {
                    prestigeSkill.disable();
                }
                prestigeSkill.configChanged(this.config.showBanners(), this.config.combatUsability());
            }
        });
    }

    @Override
    protected void shutDown()
    {
        for (PrestigeSkill prestigeSkill : prestigeSkills.values()) {
            prestigeSkill.destroy();
        }
        prestigeSkills.clear();


        for (int i = 1; i <= MAX_PRESTIGE; i++)
        {
            int spriteId = PRESTIGE_SPRITE_BASE + i;
            client.getSpriteOverrides().remove(spriteId);
        }
    }

    private boolean isSkillEnabled(Skill skill) {
        String skillName = skill.getName();
        boolean isEnabled = false;
        switch (skillName) {
            case("Attack"):
                isEnabled = this.config.attackEnabled();
                break;
            case("Defence"):
                isEnabled = this.config.defenceEnabled();
                break;
            case("Strength"):
                isEnabled = this.config.strengthEnabled();
                break;
            case("Hitpoints"):
                isEnabled = this.config.hitpointsEnabled();
                break;
            case("Ranged"):
                isEnabled = this.config.rangedEnabled();
                break;
            case("Prayer"):
                isEnabled = this.config.prayerEnabled();
                break;
            case("Magic"):
                isEnabled = this.config.magicEnabled();
                break;
            case("Cooking"):
                isEnabled = this.config.cookingEnabled();
                break;
            case("Woodcutting"):
                isEnabled = this.config.woodcuttingEnabled();
                break;
            case("Fletching"):
                isEnabled = this.config.fletchingEnabled();
                break;
            case("Fishing"):
                isEnabled = this.config.fishingEnabled();
                break;
            case("Firemaking"):
                isEnabled = this.config.firemakingEnabled();
                break;
            case("Crafting"):
                isEnabled = this.config.craftingEnabled();
                break;
            case("Smithing"):
                isEnabled = this.config.smithingEnabled();
                break;
            case("Mining"):
                isEnabled = this.config.miningEnabled();
                break;
            case("Herblore"):
                isEnabled = this.config.herbloreEnabled();
                break;
            case("Agility"):
                isEnabled = this.config.agilityEnabled();
                break;
            case("Thieving"):
                isEnabled = this.config.thievingEnabled();
                break;
            case("Slayer"):
                isEnabled = this.config.slayerEnabled();
                break;
            case("Farming"):
                isEnabled = this.config.farmingEnabled();
                break;
            case("Runecraft"):
                isEnabled = this.config.runecraftEnabled();
                break;
            case("Hunter"):
                isEnabled = this.config.hunterEnabled();
                break;
            case("Construction"):
                isEnabled = this.config.constructionEnabled();
                break;
        }

        return isEnabled;
    }

    private void renderPrestigeOverlays() {
        for (PrestigeSkill prestigeSkill : prestigeSkills.values()) {
            prestigeSkill.update();
        }
    }

    @Subscribe
    public void onPostClientTick(PostClientTick event)
    {
        Widget skillsPage = client.getWidget(InterfaceID.Stats.UNIVERSE);
        if (skillsPage == null) {
            isSkillsVisible = false;
            return;
        }

        if (skillsPage.isHidden()) {
            isSkillsVisible = false;
            return;
        }

        boolean isVisibilityChanged = !isSkillsVisible;
        isSkillsVisible = true;
        if (isVisibilityChanged) {
            renderPrestigeOverlays();
        }
    }

    @Subscribe
    public void onGameTick(GameTick event)
    {
        if (isSkillsVisible) {
            renderPrestigeOverlays();
        }
    }
}


package com.prestigemode;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class PrestigeModePluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(PrestigeModePlugin.class);
		RuneLite.main(args);
	}
}
