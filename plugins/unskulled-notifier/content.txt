package com.unskullednotifier;

import java.awt.Dimension;
import java.awt.Graphics2D;
import java.awt.image.BufferedImage;
import javax.inject.Inject;
import net.runelite.client.ui.overlay.Overlay;
import net.runelite.client.ui.overlay.OverlayLayer;
import net.runelite.client.ui.overlay.OverlayPosition;
import net.runelite.client.ui.overlay.OverlayPriority;
import net.runelite.client.ui.overlay.components.ImageComponent;
import net.runelite.client.util.ImageUtil;

class UnskulledNotifierOverlay extends Overlay
{
	private final UnskulledNotifierPlugin plugin;
	private final UnskulledNotifierConfig config;
	private final BufferedImage baseIcon;
	private BufferedImage icon;

	@Inject
	private UnskulledNotifierOverlay(UnskulledNotifierPlugin plugin, UnskulledNotifierConfig config)
	{
		super(plugin);
		this.plugin = plugin;
		this.config = config;

		setLayer(OverlayLayer.ALWAYS_ON_TOP);
		setPosition(OverlayPosition.BOTTOM_LEFT);
		setPriority(OverlayPriority.HIGH);

		this.baseIcon = loadIcon();
		updateConfig();
	}

	@Override
	public Dimension render(Graphics2D graphics)
	{
		if (!plugin.shouldShowOverlay())
		{
			return null;
		}

		return new ImageComponent(icon).render(graphics);
	}

	public void updateConfig()
	{
		int scale = Math.max(1, config.scale());
		icon = ImageUtil.resizeImage(baseIcon, baseIcon.getWidth() * scale, baseIcon.getHeight() * scale);
	}

	private static BufferedImage loadIcon()
	{
		BufferedImage icon = ImageUtil.loadImageResource(UnskulledNotifierPlugin.class, "icon.png");
		if (icon == null)
		{
			throw new IllegalStateException("Unable to load icon.png resource for Unskulled Notifier overlay");
		}

		return icon;
	}
}

package com.unskullednotifier;

import net.runelite.client.config.Config;
import net.runelite.client.config.ConfigGroup;
import net.runelite.client.config.ConfigItem;

@ConfigGroup("unskullednotifier")
public interface UnskulledNotifierConfig extends Config
{
	@ConfigItem(
		keyName = "scale",
		name = "Scale",
		description = "Size multiplier that is applied to the overlay icon"
	)
	default int scale()
	{
		return 1;
	}

	@ConfigItem(
		keyName = "revenantCavesOnly",
		name = "Revenant caves only",
		description = "Only show the overlay while you are inside the Revenant Caves"
	)
	default boolean revenantCavesOnly()
	{
		return false;
	}
}

package com.unskullednotifier;

import com.google.common.collect.ImmutableSet;
import com.google.inject.Provides;
import java.util.Set;
import javax.inject.Inject;
import net.runelite.api.Client;
import net.runelite.api.Player;
import net.runelite.api.SkullIcon;
import net.runelite.api.coords.WorldPoint;
import net.runelite.api.gameval.InterfaceID;
import net.runelite.api.widgets.Widget;
import net.runelite.client.config.ConfigManager;
import net.runelite.client.eventbus.Subscribe;
import net.runelite.client.events.ConfigChanged;
import net.runelite.client.plugins.Plugin;
import net.runelite.client.plugins.PluginDescriptor;
import net.runelite.client.ui.overlay.OverlayManager;

@PluginDescriptor(
	name = "Unskulled Notifier",
	description = "Displays a reminder when you are unskulled so you can re-skull before fighting.",
	tags = { "pvp", "wilderness", "overlay" }
)
public class UnskulledNotifierPlugin extends Plugin
{
	private static final Set<Integer> REVENANT_CAVE_REGION_IDS = ImmutableSet.of(
		12445, 12446, 12447, 12448,
		12701, 12702, 12703, 12704,
		12957, 12958, 12959, 12960,
		13213, 13214, 13215, 13216
	);

	@Inject
	private Client client;

	@Inject
	private OverlayManager overlayManager;

	@Inject
	private UnskulledNotifierOverlay overlay;

	@Inject
	private UnskulledNotifierConfig config;

	@Override
	protected void startUp()
	{
		overlay.updateConfig();
		overlayManager.add(overlay);
	}

	@Override
	protected void shutDown()
	{
		overlayManager.remove(overlay);
	}

	boolean shouldShowOverlay()
	{
		if (!isPlayerUnskulled())
		{
			return false;
		}

		if (!isInterfaceVisible())
		{
			return false;
		}

		return !config.revenantCavesOnly() || isInRevenantCaves();
	}

	private boolean isInterfaceVisible()
	{
		Widget welcomeScreen = client.getWidget(InterfaceID.WELCOME_SCREEN, 0);
		if (welcomeScreen != null && !welcomeScreen.isHidden())
		{
			return false;
		}

		Widget fixedViewport = client.getWidget(InterfaceID.Toplevel.OVERLAY_HUD);
		Widget resizableClassic = client.getWidget(InterfaceID.ToplevelOsrsStretch.HUD_CONTAINER_FRONT);
		Widget resizableModern = client.getWidget(InterfaceID.ToplevelPreEoc.HUD_CONTAINER_FRONT);

		return (fixedViewport != null && !fixedViewport.isHidden())
			|| (resizableClassic != null && !resizableClassic.isHidden())
			|| (resizableModern != null && !resizableModern.isHidden());
	}

	private boolean isPlayerUnskulled()
	{
		Player player = client.getLocalPlayer();
		return player != null && player.getSkullIcon() == SkullIcon.NONE;
	}

	private boolean isInRevenantCaves()
	{
		Player player = client.getLocalPlayer();
		if (player == null)
		{
			return false;
		}

		WorldPoint location = player.getWorldLocation();
		return location != null && REVENANT_CAVE_REGION_IDS.contains(location.getRegionID());
	}

	@Provides
	UnskulledNotifierConfig provideConfig(ConfigManager configManager)
	{
		return configManager.getConfig(UnskulledNotifierConfig.class);
	}

	@Subscribe
	public void onConfigChanged(ConfigChanged event)
	{
		if (!event.getGroup().equals("unskullednotifier"))
		{
			return;
		}

		if (event.getKey().equals("scale"))
		{
			overlay.updateConfig();
		}
	}
}
package com.unskullednotifier;

import net.runelite.client.RuneLite;
import net.runelite.client.externalplugins.ExternalPluginManager;

public class UnskulledNotifierPluginTest
{
	public static void main(String[] args) throws Exception
	{
		ExternalPluginManager.loadBuiltin(UnskulledNotifierPlugin.class);
		RuneLite.main(args);
	}
}
